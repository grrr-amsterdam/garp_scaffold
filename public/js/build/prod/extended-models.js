Garp.dataTypes.Chapter.on("init",function(){}),Garp.dataTypes.ClusterClearCacheJob.on("init",function(){}),Garp.dataTypes.ClusterRecurringJob.on("init",function(){}),Garp.dataTypes.ClusterServer.on("init",function(){}),Garp.dataTypes.Document.on("init",function(){}),Ext.ns("Garp.dataTypes"),Garp.dataTypes.Image.on("init",function(){this.iconCls="icon-img",this.insertColumn(0,{header:'<span class="hidden">'+__("Image")+"</span>",dataIndex:"id",width:84,fixed:!0,renderer:Garp.renderers.imageRelationRenderer,hidden:!1}),this.addListener("loaddata",function(a,b){function c(){if(a.get("filename")&&(b.preview.update(Garp.renderers.imagePreviewRenderer(a.get("filename"),null,a)),b.download.update({filename:a.get("filename")})),"function"==typeof b.center){var c=new Image;c.onload=function(){b&&b.el&&b.el.dom&&(b.setHeight(440),b.center())},c.src=b.preview.getEl().child("img")?b.preview.getEl().child("img").dom.src:""}}b.rendered?c():b.on("show",c,null,{single:!0})},!0),this.removeField("filename"),this.removeField("id");var a=this.getField("filename_info");a?this.removeField("filename_info"):a={xtype:"box",cls:"garp-notification-boxcomponent",name:"filename_info",html:__("Only {1} and {2} files with a maximum of {3} MB are accepted","jpg, png","gif","20"),fieldLabel:" "},this.insertField(0,{xtype:"fieldset",style:"margin: 0;padding:0;",items:[{name:"id",hideFieldLabel:!0,disabled:!0,xtype:"numberfield",hidden:!0,ref:"../../../../_id"},{name:"filename",fieldLabel:__("Filename"),xtype:"uploadfield",allowBlank:!1,emptyText:__("Drag image here, or click browse button"),uploadURL:BASE+"g/content/upload/type/image",ref:"../../../../filename",listeners:{change:function(a,b){if(this.refOwner._id.getValue()){var c=BASE+"admin?"+Ext.urlEncode({model:Garp.currentModel,id:this.refOwner._id.getValue()});DEBUG&&(c+="#DEBUG"),this.refOwner.formcontent.on("loaddata",function(){var a=new Ext.LoadMask(Ext.getBody());a.show(),document.location.href=c}),this.refOwner.fireEvent("save-all")}else this.refOwner.preview.update(Garp.renderers.uploadedImagePreviewRenderer(b)),this.refOwner.get(0).get(0).fireEvent("loaddata",this.refOwner.rec,this.refOwner),this.refOwner.download.update({filename:b});return!0}}},a,{xtype:"box",ref:"../../../../preview",fieldLabel:__("Preview"),cls:"preview",html:""},{xtype:"box",hidden:!1,ref:"../../../../download",fieldLabel:" ",hideFieldLabel:!1,tpl:new Ext.XTemplate('<tpl if="filename">','<a href="'+IMAGES_CDN+'{filename}" target="_blank">'+__("View original file")+"</a>","</tpl>")}]}),this.Wysiwyg=Ext.extend(Garp.WysiwygAbstract,{model:"Image",idProperty:"id",settingsMenu:!0,margin:0,getData:function(){return{id:this._data.id,caption:this._data.caption}},filterHtml:function(){return!0},setCaption:function(a){this._data.caption=a,this.el.child(".caption").update(a),this.el.child(".caption").setDisplayed(a?!0:!1)},showCaptionEditor:function(a){this.captionEditor||(this.captionEditor=new Ext.Editor({alignment:"tl",autoSize:!0,field:{selectOnFocus:!0,xtype:"textfield",width:"100%",anchor:"99%"}})),this.el.child(".caption").setDisplayed(!0),a||this.el.child(".caption").setStyle("position","static"),this.captionEditor.startEdit(this.el.child(".caption"),this._data.caption),this.captionEditor.on("complete",function(a,b){this.setCaption(b),this.el.child(".caption").setStyle("position","absolute")},this)},getMenuOptions:function(){return[]},pickerHandler:function(a,b){this._data={id:a.data.id,caption:a.data.caption};var c=Array.prototype.slice.call(arguments);c.shift(),b.call(this,c)},beforeInit:function(a){var b=arguments;if(this._data&&this._data[this.idProperty])return void a.call(this,b);var c=new Garp.ModelPickerWindow({model:this.model,listeners:{select:function(b){b.selected?this.pickerHandler(b.selected,a):this.destroy(),c.close()},scope:this}});c.show()},resizeContent:function(a){var b=this._data,c=b.height/b.width,d=a*c-this.margin;return this.contentEditableEl.setHeight(d),this.contentEditableEl.child(".img")&&this.contentEditableEl.child(".img").setHeight(d),d},setContent:function(){this.contentEditableEl=this.el.child(".contenteditable"),this.contentEditableEl.update(""),this.contentEditableEl.dom.setAttribute("contenteditable",!1);var a=new Image,b=this,c=IMAGES_CDN+"scaled/cms_preview/"+this._data[this.idProperty];a.onerror=function(){b.contentEditableEl.setStyle({position:"relative",padding:0}),b.contentEditableEl.update('<div class="img">'+__("Image not found")+"</div>")},a.onload=function(){Ext.apply(b._data,{width:a.width,height:a.height}),b.contentEditableEl.setStyle({position:"relative",padding:0}),b.contentEditableEl.update('<div class="img"></div><p class="caption"></p>'),b.contentEditableEl.child(".img").setStyle({backgroundImage:'url("'+c+'")'}),b.resizeContent(b.contentEditableEl.getWidth()),b.ownerCt&&b.ownerCt.doLayout()},a.src=c,a.complete&&a.onload()},initComponent:function(){this.html+='<div class="contenteditable"></div>',this.addClass("wysiwyg-image"),this.addClass("wysiwyg-box"),this.col&&this.addClass(this.col),this.on("user-resize",function(a,b){this.setHeight(this.resizeContent(b))}),this.on("afterrender",this.setContent,this),Garp.dataTypes.Image.Wysiwyg.superclass.initComponent.call(this,arguments)}})}),Garp.dataTypes.Info.on("init",function(){}),Garp.dataTypes.Location.on("init",function(){}),Ext.ns("Garp.dataTypes"),Garp.dataTypes.Snippet.on("init",function(){this.disableDelete=!0,this.disableCreate=!0,this.getField("text").height=300,this.getField("html").height=300,this.addListener("loaddata",function(a,b){function c(){Ext.each(e,function(b){d.findField(b).setVisible("1"==a.data["has_"+b])}),b.ImagePreview_image_id.setVisible(1==a.data.has_image),"undefined"!=typeof a.data.variables&&d.findField("variables")&&d.findField("variables").setVisible(a.data.variables&&a.data.variables.length)}var d=b.getForm(),e=["name","html","text"];if(b.rendered?c():b.on("show",c,null,{single:!0}),b.ImagePreview_image_id.setText(Garp.renderers.imageRelationRenderer(a.get("image_id"),null,a)||__("Add image")),b.variables_box&&a.data.variables){var f=a.data.variables.split(",");f="<ul><li>%"+f.join("%</li><li>%")+"%</li></ul>",b.variables_box.update(f)}}),this.getColumn("image_id").header="",Ext.each(["identifier","uri"],function(a){var b=this.getField(a);Ext.apply(b,{disabled:!0,xtype:"textfield",allowBlank:!0})},this),this.getField("variables")&&(this.removeField("variables"),this.addField({ref:"../../../variables_box",allowBlank:!0,fieldLabel:__("Variables"),name:"variables",xtype:"box",hidden:!1,disabled:!1,cls:"garp-notification-boxcomponent",style:"margin-top: 20px;",html:""}),this.addField({xtype:"box",html:__("Variables will be replaced with dynamic content at the frontend."),fieldLabel:" "})),Ext.each(["has_text","has_name","has_image","has_html"],function(a){this.getField(a).hidden=!0},this)}),Garp.dataTypes.Text.on("init",function(){this.iconCls="icon-text",this.Wysiwyg=Ext.extend(Garp.WysiwygAbstract,{allowedTags:["a","b","i","br","p","div","ul","ol","li"],_data:{description:null,name:null},getTagNames:function(a){var b=[];return a.childNodes?(Array.prototype.slice.call(a.childNodes).forEach(function(a){a&&a.tagName&&b.push(a.tagName)}),b):void 0},fixParagraphs:function(){var a,b=this.contentEditableEl.dom;if(b.childNodes&&(Ext.DomQuery.jsSelect("DIV",b).reverse().forEach(function(b){var c=b.childNodes;a=document.createElement("P"),Array.prototype.slice.call(c).forEach(function(b){a.appendChild(b.clone?b.clone():b)}),b.parentNode.replaceChild(a,b)}),-1==this.getTagNames(b).indexOf("P"))){var c=document.createRange();a=document.createElement("P"),c.selectNodeContents&&c.selectNodeContents(b),c.surroundContents(a),c.collapse(!0),c.detach()}},filterHtml:function(){function a(c){Ext.each(c,function(c){if(c){if(c.normalize(),c.tagName){var d=c.tagName.toLowerCase();if(-1==b.allowedTags.indexOf(d))if(c.childNodes.length>0)for(;c.childNodes.length>0&&c.parentNode;){var e=c.childNodes[c.childNodes.length-1],f=e.cloneNode(!0);c.parentNode.insertBefore(f,c),c.removeChild(e),c.parentNode.removeChild(c),a(b.contentEditableEl.dom.childNodes)}else c.parentNode&&c.parentNode.removeChild(c)}c.childNodes&&a(c.childNodes)}})}var b=this;a(this.contentEditableEl.dom.childNodes),this.fixParagraphs()},getData:function(){return this.contentEditableEl?{description:this.contentEditableEl.dom.innerHTML,name:this._data.name||!1}:""},setTitle:function(a){this._data.name=a,this.titleEl.update(a),this.titleEl.setDisplayed(a?!0:!1)},showTitleDialog:function(){this.titleEditor||(this.titleEditor=new Ext.Editor({alignment:"tl",autoSize:!0,field:{selectOnFocus:!0,xtype:"textfield",width:"100%",anchor:"99%"}})),this.titleEl.setDisplayed(!0),this.titleEditor.startEdit(this.titleEl,this._data.name),this.titleEditor.on("complete",function(a,b){this.setTitle(b)},this)},getMenuOptions:function(){return[{group:"",text:__("Add / remove title"),handler:this.showTitleDialog},{group:"",text:__("Add / remove animation classes"),handler:this.showAnimClassesDialog}]},initComponent:function(){this.html+='<div class="vertical-content"><h4 class="contenttitle"></h4><div class="contenteditable">'+__("Enter text")+"</div></div>",this.on("afterrender",function(){this.addClass("wysiwyg-box"),this.col&&this.addClass(this.col),this.el.select(".dd-handle, .target").each(function(a){a.dom.setAttribute(id,Ext.id())}),this.contentEditableEl=this.el.select(".contenteditable").first(),this.contentEditableEl.dom.setAttribute("contenteditable",!0),this.contentEditableEl.removeAllListeners(),this.contentEditableEl.on("focus",this.filterHtml,this),this.contentEditableEl.on("click",this.filterHtml,this),this.contentEditableEl.on("blur",this.filterHtml,this),this.titleEl=this.el.select(".contenttitle").first(),this.titleEl.removeAllListeners(),this.titleEl.on("click",this.showTitleDialog,this),this.type&&this.el.addClass(this.type),this._data&&this._data.description&&(this.contentEditableEl.update(this._data.description),this.titleEl.update(this._data.name||"")),this.titleEl.setDisplayed(this._data&&this._data.name||!1)},this),Garp.dataTypes.Text.Wysiwyg.superclass.initComponent.call(this,arguments)}})}),Garp.dataTypes.User.on("init",function(){Ext.apply(this.getColumn("fullname"),{virtualSortField:"first_name"}),this.addColumn({dataIndex:"password",header:"Password",renderer:Ext.emptyFn,hidden:!0,virtual:!0}),this.addField({hidden:!0,ref:"../../../passwordField",name:"password"}),this.addField({allowBlank:!0,xtype:"passwordfieldset",ref:"../../../changePassword",callback:function(a,b){var c=a.refOwner.refOwner.passwordField,d=a.refOwner.refOwner.getForm().findField("email");b||d._keepRequired?(d.allowBlank=!1,d.label.addClass("required-field"),c.setValue(b)):(d.allowBlank=!0,d.label.removeClass("required-field"),c.setValue("")),a.refOwner.refOwner.getForm().items.each(function(){this.validate&&this.validate()})}}),this.addListener("loaddata",function(a,b){b.changePassword.collapseAndHide(),a.get("image_id")&&b.ImagePreview_image_id.setText(Garp.renderers.imageRelationRenderer(a.get("image_id"),null,a)||__("Add image"));var c=b.getForm().findField("role");if(c){var d=Garp.localUser.role||"User";Ext.each(Garp.ACL[d].children,function(a){var b=c.store.find("field1",a);c.store.removeAt(b)})}var e=b.getForm().findField("email");e&&e.allowBlank===!1?e._keepRequired=!0:e&&(e._keepRequired=!1)})}),Ext.ns("Garp.dataTypes"),Garp.dataTypes.Video.on("init",function(){this.insertColumn(0,{header:'<span class="hidden">'+__("Thumbnail")+"</span>",width:84,fixed:!0,dataIndex:"thumbnail",renderer:Garp.renderers.imageRenderer});var a=this.getField("url");this.removeField("url"),this.insertField(1,Ext.apply(a,{ref:"urlField"})),this.insertField(2,{xtype:"box",cls:"garp-notification-boxcomponent",html:__("YouTube and Vimeo Url's are supported"),fieldLabel:" "}),this.insertField(3,{xtype:"button",ref:"../../../uploadBtn",hidden:!0,width:120,allowBlank:!0,anchor:null,fieldLabel:" ",handler:function(){this.ownerCt.urlField.clearInvalid();var a=new Garp.YouTubeUploadWindow({listeners:{uploadComplete:function(b){a.close(),this.ownerCt.urlField.setValue("http://youtu.be/watch?v="+b.data.videoId),Garp.formPanel.fireEvent("save-all")},scope:this}});a.show()},text:__("Upload a new video to YouTube")}),this.addFields([{xtype:"box",ref:"../../../preview",fieldLabel:__("Preview"),_data:{player:"",width:0,height:0},tpl:Garp.videoTpl},{xtype:"box",cls:"separator"},{name:"tags",fieldLabel:__("Tags"),xtype:"displayfield",allowBlank:!0,style:"max-height: 18px;overflow:hidden;"},{name:"video_author",fieldLabel:__("Author"),allowBlank:!0,xtype:"displayfield"}]),this.getField("player").hidden=!0,this.addListener("loaddata",function(a,b){function c(){if(a.phantom)b.uploadBtn.show(),b.preview.update({width:0,height:0,player:""});else{b.uploadBtn.hide();var c=b.preview.getWidth(),d=Math.floor(9*c/16);a.get("player")&&b.preview.update({width:c,height:d,player:a.get("player")})}}b.rendered?c.defer(500):b.on("show",c,null,{single:!0})}),Garp.dataTypes.Image&&Garp.dataTypes.Image.Wysiwyg&&(this.Wysiwyg=Ext.extend(Garp.dataTypes.Image.Wysiwyg,{model:"Video",idProperty:"id",pickerHandler:function(a,b){this._data={id:a.data.id,image:a.data.image};var c=Array.prototype.slice.call(arguments);c.shift(),b.call(this,c)},getData:function(){return{id:this._data.id,image:this._data.image}},initComponent:function(){this.html+='<div class="contenteditable"></div>',this.addClass("wysiwyg-image"),this.addClass("wysiwyg-box"),this.col&&this.addClass(this.col),this.on("user-resize",function(a,b){this.setHeight(this.resizeContent(b))}),this.on("afterrender",function(){this.contentEditableEl=this.el.child(".contenteditable"),this.contentEditableEl.update(""),this.contentEditableEl.dom.setAttribute("contenteditable",!1);var a=new Image,b=this,c=this._data.image;a.onload=function(){Ext.apply(b._data,{width:a.width,height:a.height}),b.contentEditableEl.setStyle({position:"relative",padding:0}),b.contentEditableEl.update('<div class="img"></div>'),b.contentEditableEl.child(".img").setStyle({backgroundImage:'url("'+c+'")'}),b.resizeContent(b.contentEditableEl.getWidth()),b.ownerCt&&b.ownerCt.doLayout()},a.src=c,a.complete&&a.onload()},this),Garp.dataTypes.Image.Wysiwyg.superclass.initComponent.call(this,arguments)}}))});