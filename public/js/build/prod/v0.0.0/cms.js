function __(e){if(arguments.length>1){var t=[].slice.call(arguments);return t.unshift("undefined"!=typeof Garp.locale[e]?Garp.locale[e]:e),String.format.apply(String,t)}return"undefined"!=typeof Garp.locale[e]?Garp.locale[e]:e}Ext.ns("Garp"),function(){var e=/(^mailto:(\w+)([\-+.][\w]+)*@(\w[\-\w]*))|((((^https?)|(^ftp)):\/\/)?([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i;Ext.apply(Ext.form.VTypes,{mailtoOrUrl:function(t){return e.test(t)},mailtoOrUrlText:"Not a valid Url"})}(),Garp.mailtoOrUrlPlugin={init:function(e){var t=/(^mailto:(\w+)([\-+.][\w]+)*@(\w[\-\w]*))|(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i;e.on({change:function(e,i){!t.test(i)&&i&&e.setValue("http://"+i)}})}},Ext.apply(Ext.form.BasicForm.prototype,{updateRecord:function(e){e.beginEdit();var t,i,s=e.fields;return s.each(function(s){if(t=this.findField(s.name)){if("undefined"!=typeof t.isDirty&&!t.isDirty())return;i=t.getValue(),Ext.type(i)!==!1&&i.getGroupValue?i=i.getGroupValue():t.eachItem&&(i=[],t.eachItem(function(e){i.push(e.getValue())})),e.set(s.name,i)}},this),e.endEdit(),this}}),Ext.apply(Ext.form.FieldSet.prototype,{border:!1,buttonAlign:"left",collapsible:!0,defaults:{anchor:"-30",msgTarget:"under"},hideCollapseTool:!0,labelWidth:120,labelSeparator:" ",titleCollapse:!0}),Ext.apply(Ext.form.ComboBox.prototype,{triggerAction:"all",typeAhead:!1}),Ext.apply(Ext.grid.GridPanel.prototype,{loadMask:!0}),Ext.apply(Ext.form.BasicForm.prototype,{add:function(){var e=this;return e.items.addAll(Array.prototype.slice.call(arguments,0)),Ext.each(arguments,function(t){t.form=e,t.on("change",e.onFieldChange,e)}),e},onFieldChange:function(){this.fireEvent("change",this)},unDirty:function(){Ext.each(this.items.items,function(){("richtexteditor"===this.xtype||"htmleditor"===this.xtype)&&this.on({beforepush:{fn:function(){return!1},single:!0}}),this.originalValue=this.getValue()})}}),Ext.override(Ext.data.Store,{load:function(e){if(e=Ext.apply({},e),this.storeOptions(e),this.sortInfo&&this.remoteSort){var t=this.paramNames;e.params=Ext.apply({},e.params),e.params[t.sort]=this.sortInfo.field+" "+this.sortInfo.direction,delete e.params[t.dir]}try{return this.execute("read",null,e)}catch(i){return this.handleException(i),!1}}}),Ext.isIE||Ext.apply(Ext.menu.Menu.prototype,{listeners:{show:function(){if(!this.parentMenu){var e=this.getEl(),t={duration:.2};e.fadeIn(t),e.shadow&&e.shadow.el&&e.shadow.el.fadeIn(t)}return!0}}}),Ext.apply(Ext.grid.GridPanel.prototype,{listeners:{containerclick:function(){this.getSelectionModel().clearSelections()},viewready:function(){if(this.getView()&&this.getView().hmenu){var e=this.getView().hmenu.get("columns");e.menu.on("beforeshow",function(){var t=this.items;t.each(function(t){t.text||e.menu.remove(t.itemId)})})}}}}),Garp.imageTpl=new Ext.XTemplate(['<tpl if="caption">','<tpl if="align">','<figure class="figure" style="float: {align};">',"</tpl>",'<tpl if="!align">','<figure class="figure" style="float: none;">',"</tpl>",'<img src="{path}" draggable="false"> ',"<figcaption>{caption}</figcaption>","</figure>","</tpl>",'<tpl if="!caption">','<tpl if="align">','<img class="figure {align}" src="{path}">',"</tpl>",'<tpl if="!align">','<img class="figure" src="{path}">',"</tpl>","</tpl>"]),Garp.videoTpl=new Ext.XTemplate('<figure class="video-embed"><iframe width="{width}" height="{height}" src="{player}" frameborder="0"></iframe></figure>'),Ext.override(Ext.Panel,{setTitle:function(e,t){return this.tabEl&&(e=Ext.util.Format.ellipsis(e,25,!0)),this.title=e,this.header&&this.headerAsText&&this.header.child("span").update(e),t&&this.setIconClass(t),this.fireEvent("titlechange",this,e),this}}),Ext.apply(Ext.BasicForm.prototype,{getFieldValues:function(e){var t,i,s,a={};return this.items.each(function(n){function r(n){if(!n.disabled&&(e!==!0||n.isDirty())){if(t=n.getName(),!t)return;i=a[t],s=n.getValue(),Ext.isDefined(i)?Ext.isArray(i)?a[t].push(s):a[t]=[i,s]:a[t]=s}}"tweetfield"==n.xtype&&n.items?n.items.each(function(e){r(e)}):r(n)}),a}}),Ext.override(Ext.grid.Column,{virtual:!1}),Ext.override(Ext.form.Field,{enableKeyEvents:!0,getCountBox:function(){var e;return this.refOwner?e=this.refOwner[this.countBox]:this.ownerCt.ownerCt&&(e=this.ownerCt.ownerCt.ownerCt.ownerCt[this.countBox]),e},updateCountBox:function(){var e=this.maxLength-(this.getValue()?this.getValue().length:0);0>e?this.getCountBox().getEl().addClass("negative"):this.getCountBox().getEl().removeClass("negative"),this.getCountBox().update(e+" "+__("left"))},hideCountBox:function(){return this.getCountBox().update(""),!0},initComponent:function(){return Ext.form.Field.superclass.initComponent.call(this),this.xtype&&"superboxselect"==this.xtype?!0:(this.on("blur",function(){return this.getValue()&&this.getValue()===String(this.getValue())&&this.setValue(String(this.getValue()).trim()),!0},this),this.on("afterrender",function(){this.countBox&&this.maxLength&&(this.getEl().on({keypress:{fn:this.updateCountBox,buffer:50,scope:this}}),this.on("focus",this.updateCountBox,this),this.on("blur",this.hideCountBox,this),this.on("change",this.updateCountBox,this)),!this.allowBlank&&this.label&&this.label.addClass("required-field"),"numberfield"==this.xtype&&this.label&&(this.label.addClass("number-field"),this.width||(this.setWidth(50),delete this.anchor))},this),void this.addEvents("focus","blur","specialkey","change","invalid","valid"))}}),Ext.override(Ext.Button,{initComponent:function(){this.menu&&(this.menu=Ext.menu.MenuMgr.get(this.menu),this.menu.ownerCt=this),Ext.Button.superclass.initComponent.call(this),this.allowBlank!==!0&&this.on("afterrender",function(){this.label&&this.label.addClass("required-field")},this),this.addEvents("click","toggle","mouseover","mouseout","menushow","menuhide","menutriggerover","menutriggerout"),this.menu&&(this.menu.ownerCt=void 0),Ext.isString(this.toggleGroup)&&(this.enableToggle=!0)}}),Ext.override(Ext.form.DisplayField,{setValue:function(e){return this.renderer&&(e=this.renderer(e)),this.setRawValue(e),this}}),Ext.override(Ext.form.TimeField,{format:"H:i",getValue:function(){var e=Ext.form.TimeField.superclass.getValue.call(this);return this.formatDate(this.parseDate(e))||null}}),Ext.override(Ext.form.DateField,{getValue:function(){return this.parseDate(Ext.form.DateField.superclass.getValue.call(this))||null},setValue:function(e){return e&&(e.getFullYear&&e.getFullYear()>-1||this.parseDate(e))?Ext.form.DateField.superclass.setValue.call(this,this.formatDate(this.parseDate(e))):Ext.form.DateField.superclass.setValue.call(this,null)}}),Ext.override(Ext.PagingToolbar,{initComponent:function(){var e=Ext.Toolbar;this.first=new e.Button({}),this.last=new e.Button({}),this.refresh=new e.Button({});var t=[this.prev=new e.Button({tooltip:this.prevText,overflowText:this.prevText,iconCls:"x-tbar-page-prev",disabled:!0,handler:this.movePrevious,scope:this}),this.beforePageText,this.inputItem=new Ext.form.NumberField({cls:"x-tbar-page-number",allowDecimals:!1,allowNegative:!1,enableKeyEvents:!0,selectOnFocus:!0,submitValue:!1,listeners:{scope:this,keydown:this.onPagingKeyDown,blur:this.onPagingBlur}}),this.afterTextItem=new e.TextItem({text:String.format(this.afterPageText,1)}),this.next=new e.Button({tooltip:this.nextText,overflowText:this.nextText,iconCls:"x-tbar-page-next",disabled:!0,handler:this.moveNext,scope:this})],i=this.items||this.buttons||[];this.items=this.prependButtons?i.concat(t):t.concat(i),delete this.buttons,this.displayInfo&&(this.items.push("->"),this.items.push(this.displayItem=new e.TextItem({}))),Ext.PagingToolbar.superclass.initComponent.call(this),this.addEvents("change","beforechange"),this.on("afterlayout",this.onFirstLayout,this,{single:!0}),this.cursor=0,this.bindStore(this.store,!0)}}),Ext.override(Ext.grid.PropertyGrid,{initComponent:function(){this.customRenderers=this.customRenderers||{},this.customEditors=this.customEditors||{},this.lastEditRow=null;var e=new Ext.grid.PropertyStore(this);this.propStore=e;var t=new Ext.grid.PropertyColumnModel(this,e);this.addEvents("propertychange"),this.cm=t,this.ds=e.store,Ext.grid.PropertyGrid.superclass.initComponent.call(this),this.mon(this.selModel,"beforecellselect",function(e,t,i){return 0===i?(this.startEditing.defer(200,this,[t,1]),!1):void 0},this)}}),Ext.override(Ext.grid.PropertyColumnModel,{constructor:function(e,t){var i=Ext.grid,s=Ext.form;this.grid=e,i.PropertyColumnModel.superclass.constructor.call(this,[{header:this.nameText,width:50,sortable:!1,dataIndex:"name",id:"name",menuDisabled:!0},{header:this.valueText,width:50,resizable:!1,dataIndex:"value",id:"value",menuDisabled:!0}]),this.store=t;var a=new s.Field({autoCreate:{tag:"select",children:[{tag:"option",value:"true",html:this.trueText},{tag:"option",value:"false",html:this.falseText}]},getValue:function(){return"true"==this.el.dom.value}});this.editors={date:new i.GridEditor(new s.DateField({selectOnFocus:!0})),string:new i.GridEditor(new s.TextField({selectOnFocus:!0})),number:new i.GridEditor(new s.NumberField({selectOnFocus:!0,style:"text-align:left;"})),"boolean":new i.GridEditor(a,{autoSize:"both"})},this.renderCellDelegate=this.renderCell.createDelegate(this),this.renderPropDelegate=this.renderProp.createDelegate(this)},requiredPropertyRenderer:function(e,t,i){var s=this.grid.customEditors;return s[i.id]&&s[i.id].field&&s[i.id].field.allowBlank===!1&&(t.css="required-property"),this.renderProp(e)},getRenderer:function(e){return 0===e?this.requiredPropertyRenderer.createDelegate(this):this.renderCellDelegate||this.renderPropDelegate}}),Ext.ns("Garp"),Garp.SMALLSCREENWIDTH=640,"undefined"==typeof Garp.locale&&(Garp.locale={});var maxItems=Math.floor((window.innerHeight-100-34)/20)-1;Ext.applyIf(Garp,{pageSize:2*maxItems,localUser:{},confirmMsg:__("Changes will get lost. Continue?")}),Ext.apply(Ext.Ajax,{timeout:0}),Ext.ns("Garp.renderers"),Ext.apply(Garp.renderers,{fullNameConverter:function(e,t){var i=[];return Ext.each(["first_name","last_name_prefix","last_name"],function(e){t[e]&&i.push(t[e])}),i||(i=t.name),i.join(" ")},geocodeAddressRenderer:function(e){e=e.address_components;var t,i,s,a,n,r="";return Ext.each(e,function(e){e.types.indexOf("country")>-1&&(t=e.long_name,i=e.short_name),e.types.indexOf("locality")>-1&&(s=e.short_name),e.types.indexOf("route")>-1&&(a=e.short_name),e.types.indexOf("street_number")>-1&&(n=e.short_name)}),n?r=a+" "+n:a&&(r=a),s&&(r+=", "+s),"NL"!=i&&(r+=", "+t),r},htmlRenderer:function(){return""},shortDateTimeRenderer:function(e){var t="d M Y H:i";return Ext.isDate(e)?e.format(t):e&&"undefined"!=typeof Date.parseDate(e,"Y-m-d H:i:s")?Date.parseDate(e,"Y-m-d H:i:s").format(t):"-"},dateTimeRenderer:function(e){var t="d F Y H:i";return Ext.isDate(e)?e.format(t):e&&"undefined"!=typeof Date.parseDate(e,"Y-m-d H:i:s")?Date.parseDate(e,"Y-m-d H:i:s").format(t):"-"},metaPanelDateRenderer:function(e){return e&&"0000"==e.substr(0,4)?"<i>"+__("Invalid date")+"</i>":e?Garp.renderers.intelliDateTimeRenderer(e):"<i>"+__("No date specified")+"</i>"},dateRenderer:function(e){var t="d F Y";if(Ext.isDate(e)){var i=e.format(t);return i}return e&&"undefined"!=typeof Date.parseDate(e,"Y-m-d")?Date.parseDate(e,"Y-m-d").format(t):e&&"undefined"!=typeof Date.parseDate(e,"d F Y")?Date.parseDate(e,"d F Y").format(t):"-"},timeRenderer:function(e){var t="H:i";if(Ext.isDate(e)){var i=e.format(t);return i}return e&&"undefined"!=typeof Date.parseDate(e,"H:i:s")?Date.parseDate(e,"H:i:s").format(t):e&&"undefined"!=typeof Date.parseDate(e,"H:i")?Date.parseDate(e,"H:i").format(t):"-"},yearRenderer:function(e){var t="Y";return Ext.isDate(e)?e.format(t):e&&"undefined"!=typeof Date.parseDate(e,"Y")?Date.parseDate(e,"Y").format(t):"-"},intelliDateTimeRenderer:function(e){var t=new Date,i=(new Date).add(Date.DAY,-1);return(e=Date.parseDate(e,"Y-m-d H:i:s"))?e.getYear()==t.getYear()&&e.getMonth()==t.getMonth()?e.getDate()==i.getDate()?__("Yesterday at")+" "+e.format("H:i"):e.getDate()==t.getDate()?__("Today at")+" "+e.format("H:i"):e.format("j M"):e.format("j M Y"):void 0},imageRenderer:function(e,t,i,s){i||(i={id:0}),Ext.isObject(s)||(s={size:64});var a=new Ext.Template('<div class="garp-image-renderct"><img src="'+IMAGES_CDN+"scaled/cms_list/"+i.id+'" width="'+s.size+'" alt="{0}" /></div>',{compile:!1,disableFormats:!0}),n=new Ext.Template('<div class="garp-image-renderct"><img src="{0}" width="'+s.size+'" alt="{0}" /></div>',{compile:!1,disableFormats:!0});if("undefined"==typeof i)return __("New Image");var r=e?/^https?:\/\//.test(e)?n.apply([e]):a.apply([e]):__("No Image uploaded");return r},imageRelationRenderer:function(e,t){var i='<img src="'+IMAGES_CDN+"scaled/cms_list/"+e+'" width="64" alt="" />';return t?(e||(i='<div class="no-img"></div>'),'<div class="garp-image-renderct">'+i+"</div>"):e?i:null},imagePreviewRenderer:function(e,t,i){var s=new Ext.Template('<div class="garp-image-renderct"><img src="'+IMAGES_CDN+"scaled/cms_preview/"+i.id+'" alt="{0}" /></div>',{compile:!0,disableFormats:!0});"undefined"==typeof i&&(i={phantom:!0});var a=e?s.apply([e]):__(i.phantom===!0?"New Image":"No Image uploaded");return a},uploadedImagePreviewRenderer:function(e){var t=new Ext.Template('<div class="garp-image-renderct"><img src="'+IMAGES_CDN+e+'" /></div>',{compile:!0,disableFormats:!0});return t.apply(e)},cropPreviewRenderer:function(e,t,i){if(i.get("w")&&i.get("h")){var s=32,a=i.get("w")/i.get("h")*s,n=i.get("h")/i.get("w")*s;a>s&&(n*=s/a,a=s),n>s&&(a*=s/n,n=s),n==a&&(a=n=.75*s);var r=(s-n)/2,o=(s-a)/2;return n=Math.ceil(n),a=Math.ceil(a),r=Math.floor(r),o=Math.floor(o),'<div style="background: #aaa; width: '+s+"px; height: "+s+'px; border: 1px #888 solid;"><div style="width: '+a+"px; height: "+n+"px; background-color: #eee;margin: "+r+"px "+o+'px;"></div></div>'}return""},checkVisible:function(e,t,i){return i.getRow(e)?Ext.get(i.getCell(e,t)).isVisible(!0):!1},remoteDisplayFieldRenderer:function(e,t,i,s,a,n,r,o){return o&&e?(r.on("refresh",function(){Garp.renderers.checkVisible(s,a,r)&&Garp[o].fetch({query:{id:e}},function(e){if(e.rows&&e.rows[0]){e.rows[0].get=function(e){return this[e]||""};var t=Garp.dataTypes[o].displayFieldRenderer(e.rows[0]);Ext.get(r.getCell(s,a))&&Ext.get(r.getCell(s,a)).update('<div unselectable="on" class="x-grid3-cell-inner x-grid3-col-0">'+t+"</div>")}})},{buffer:200,scope:this}),'<div class="remoteDisplayFieldSpinner"></div>'):void 0},checkboxRenderer:function(e){return __("1"==e?"yes":"no")},i18nRenderer:function(e){return e&&"object"==typeof e&&e[DEFAULT_LANGUAGE]?e[DEFAULT_LANGUAGE]:"object"!=typeof e?e:"-"}}),Ext.ns("Ext.ux"),Ext.ux.Searchbar=Ext.extend(Ext.Toolbar,{height:27,grid:null,makeQuery:function(e){if(e){var t=this.grid.getStore().baseParams?this.grid.getStore().baseParams.query:"",i=new Ext.util.MixedCollection;i.addAll(Garp.dataTypes);var s={};Ext.isObject(t)&&i.eachKey(function(e){var i=e+".id";t[i]&&(s[i]=t[i]);var a=e+".id <>";t[a]&&(s[a]=t[a])});var a=this.getSelectedSearchFields();!a.length&&this.getAllSearchFields().length&&(a=this.searchableFields);var n=Ext.apply(this.convertQueryString(e,a),s);this.grid.getStore().setBaseParam("query",n),this.grid.getStore().setBaseParam("pageSize",Garp.pageSize)}else this.grid.getStore().baseParams=Ext.apply({},this.originalBaseParams);this.fireEvent("search",this),this.grid.getStore().load()},convertQueryString:function(e,t){if(""===e)return{};var i="%"+e+"%";if(t&&t.length){var s={};return Ext.each(t,function(e){s[e+" like"]=i}),{or:s}}},getSelectedSearchFields:function(){var e=[];return this.searchOptionsMenu&&Ext.each(this.searchOptionsMenu.items.items,function(t){"menucheckitem"===t.xtype&&t.checked&&t._dataIndex&&e.push(t._dataIndex)}),e},getAllSearchFields:function(){var e=[];if(this.grid)return Ext.each(this.grid.getColumnModel().config,function(t){t.searchable!==!1&&(t.searchable||"relationMetadata"!==t.dataIndex)&&e.push(t)}),e},searchOptionsMenu:new Ext.menu.Menu({items:{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:Ext.PagingToolbar.prototype.emptyMsg}}),buildSearchOptionsMenu:function(){var e=this.getAllSearchFields(),t=[{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:__("Search in:")},{xtype:"menucheckitem",ref:"selectAll",hideOnClick:!1,checked:!1,text:__("Select All"),checkHandler:function(e,t){e.parentMenu&&e.parentMenu.items.each(function(){this._dataIndex&&this.setChecked(t,!0)})}},"-"];this.searchableFields=[],Ext.each(e,function(e){t.push({text:e.header,checked:e.searchable||!e.hidden,_dataIndex:e.dataIndex}),(e.searchable||!e.hidden)&&this.searchableFields.push(e.dataIndex)},this),this.searchOptionsMenu=new Ext.menu.Menu({defaults:{xtype:"menucheckitem",hideOnClick:!1},items:t})},setBaseParams:function(){this.originalBaseParams=Ext.apply({},this.store.baseParams)},initComponent:function(){this.addEvents("search"),this.store.on({load:{scope:this,single:!0,fn:function(){this.grid||(this.grid=this.ownerCt),this.grid&&(this.grid.getColumnModel().on("hiddenchange",function(){this.buildSearchOptionsMenu()},this),this.buildSearchOptionsMenu())}}});var e=this;this.layout="hbox",this.items=[{xtype:"tbbutton",ref:"searchoptionsbtn",iconCls:"icon-searchoptions",tooltip:__("Zoekopties"),width:22,flex:0,scope:this,handler:function(e){this.searchOptionsMenu.show(e.el)}},this.searchField=new Ext.ux.form.SearchField({xtype:"twintrigger",flex:1,store:this.store,value:Ext.isObject(this.store.baseParams.query)?"":this.store.baseParams.query,listeners:{change:function(){var e=this.getValue();e.length<1?this.removeClass("has-search"):this.addClass("has-search")}},onTrigger1Click:function(){this.hasSearch&&(this.triggers[0].hide(),this.el.dom.value="",e.makeQuery(""),this.removeClass("has-search"))},onTrigger2Click:function(){var t=this.getRawValue();return t.length<1?void this.onTrigger1Click():(this.triggers[0].show(),this.hasSearch=!0,void e.makeQuery(t))}})],Ext.ux.Searchbar.superclass.initComponent.call(this)},blur:function(){this.searchField.blur(),Ext.ux.Searchbar.superclass.blur.call(this)},searchById:function(e){var t=this,i=this.searchField,s=this.searchOptionsMenu;i.setValue(e),i.triggers[0].show(),i.hasSearch=!0,i.fireEvent("change"),s.items.each(function(e){e.setChecked&&e.setChecked("id"==e.text?!0:!1)}),t.fireEvent("change")},afterRender:function(){new Ext.KeyNav(this.getEl(),{esc:function(){this.blur(),this.fireEvent("defocus")},scope:this});this.setBaseParams(),Ext.ux.Searchbar.superclass.afterRender.call(this)}}),Ext.reg("searchbar",Ext.ux.Searchbar),Ext.ns("Ext.ux.form"),Ext.ux.form.DateTime=Ext.extend(Ext.form.Field,{dateValidator:null,defaultAutoCreate:{tag:"input",type:"hidden"},dtSeparator:" ",hiddenFormat:"Y-m-d H:i:s",otherToNow:!0,timePosition:"right",timeValidator:null,timeWidth:100,dateFormat:"m/d/y",timeFormat:"g:i A",initComponent:function(){Ext.ux.form.DateTime.superclass.initComponent.call(this);var e=Ext.apply({},{id:this.id+"-date",format:this.dateFormat||Ext.form.DateField.prototype.format,width:this.timeWidth,hidden:this.hidden,selectOnFocus:this.selectOnFocus,validator:this.dateValidator,enableKeyEvents:!0,listeners:{blur:{scope:this,fn:this.onBlur},keypress:{scope:this,fn:this.onBlur},focus:{scope:this,fn:this.onFocus}}},this.dateConfig);this.df=new Ext.form.DateField(e),this.df.ownerCt=this,delete this.dateFormat;var t=Ext.apply({},{id:this.id+"-time",format:this.timeFormat||Ext.form.TimeField.prototype.format,width:this.timeWidth,hidden:this.hidden,selectOnFocus:this.selectOnFocus,validator:this.timeValidator,enableKeyEvents:!0,listeners:{blur:{scope:this,fn:this.onBlur},keypress:{scope:this,fn:this.onBlur},focus:{scope:this,fn:this.onFocus}}},this.timeConfig);this.tf=new Ext.form.TimeField(t),this.tf.ownerCt=this,delete this.timeFormat,this.relayEvents(this.df,["focus","specialkey","invalid","valid"]),this.relayEvents(this.tf,["focus","specialkey","invalid","valid"]),this.on("specialkey",this.onSpecialKey,this)},onRender:function(e,t){if(!this.isRendered){Ext.ux.form.DateTime.superclass.onRender.call(this,e,t);var i;if(i="below"===this.timePosition||"bellow"===this.timePosition?Ext.DomHelper.append(e,{tag:"table",style:"border-collapse:collapse",children:[{tag:"tr",children:[{tag:"td",style:"padding-bottom:1px",cls:"ux-datetime-date"}]},{tag:"tr",children:[{tag:"td",cls:"ux-datetime-time"}]}]},!0):Ext.DomHelper.append(e,{tag:"table",style:"border-collapse:collapse",children:[{tag:"tr",children:[{tag:"td",style:"padding-right:4px",cls:"ux-datetime-date"},{tag:"td",cls:"ux-datetime-time"}]}]},!0),this.tableEl=i,this.wrap=i.wrap({cls:"x-form-field-wrap"}),this.wrap.on("mousedown",this.onMouseDown,this,{delay:10}),this.df.render(i.child("td.ux-datetime-date")),this.tf.render(i.child("td.ux-datetime-time")),this.df.el.swallowEvent(["keydown","keypress"]),this.tf.el.swallowEvent(["keydown","keypress"]),"side"===this.msgTarget){var s=this.el.findParent(".x-form-element",10,!0);s&&(this.errorIcon=s.createChild({cls:"x-form-invalid-icon"}));var a={errorIcon:this.errorIcon,msgTarget:"side",alignErrorIcon:this.alignErrorIcon.createDelegate(this)};Ext.apply(this.df,a),Ext.apply(this.tf,a)}this.el.dom.name=this.hiddenName||this.name||this.id,this.df.el.dom.removeAttribute("name"),this.tf.el.dom.removeAttribute("name"),this.isRendered=!0,this.updateHidden()}},adjustSize:Ext.BoxComponent.prototype.adjustSize,alignErrorIcon:function(){this.errorIcon.alignTo(this.tableEl,"tl-tr",[2,0])},initDateValue:function(){this.dateValue=this.otherToNow?new Date:new Date(1970,0,1,0,0,0)},clearInvalid:function(){this.df.clearInvalid(),this.tf.clearInvalid()},markInvalid:function(e){this.df.markInvalid(e),this.tf.markInvalid(e)},beforeDestroy:function(){this.isRendered&&(this.wrap.removeAllListeners(),this.wrap.remove(),this.tableEl.remove(),this.df.destroy(),this.tf.destroy())},disable:function(){return this.isRendered&&(this.df.disabled=this.disabled,this.df.onDisable(),this.tf.onDisable()),this.disabled=!0,this.df.disabled=!0,this.tf.disabled=!0,this.fireEvent("disable",this),this},enable:function(){return this.rendered&&(this.df.onEnable(),this.tf.onEnable()),this.disabled=!1,this.df.disabled=!1,this.tf.disabled=!1,this.fireEvent("enable",this),this},focus:function(){this.df.focus()},getPositionEl:function(){return this.wrap},getResizeEl:function(){return this.wrap},getValue:function(){return this.dateValue?new Date(this.dateValue):""},isValid:function(){return this.df.isValid()&&this.tf.isValid()},isVisible:function(){return this.df.rendered&&this.df.getActionEl().isVisible()},onBlur:function(e){this.wrapClick&&(e.focus(),this.wrapClick=!1),e===this.df?this.updateDate():this.updateTime(),this.updateHidden(),this.validate(),function(){if(!this.df.hasFocus&&!this.tf.hasFocus){var e=this.getValue();String(e)!==String(this.startValue)&&this.fireEvent("change",this,e,this.startValue),this.hasFocus=!1,this.fireEvent("blur",this)}}.defer(100,this)},onFocus:function(){this.hasFocus||(this.hasFocus=!0,this.startValue=this.getValue(),this.fireEvent("focus",this))},onMouseDown:function(e){this.disabled||(this.wrapClick="td"===e.target.nodeName.toLowerCase())},onSpecialKey:function(e,t){var i=t.getKey();i===t.TAB&&(e!==this.df||t.shiftKey||(t.stopEvent(),this.tf.focus()),e===this.tf&&t.shiftKey&&(t.stopEvent(),this.df.focus()),this.updateValue()),i===t.ENTER&&(this.tf.setValue(this.tf.getRawValue()),this.updateValue())},reset:function(){},setDate:function(e){this.df.setValue(e)},setTime:function(e){this.tf.setValue(e)},setSize:function(e,t){e&&("below"===this.timePosition?(this.df.setSize(e,t),this.tf.setSize(e,t),Ext.isIE&&(this.df.el.up("td").setWidth(e),this.tf.el.up("td").setWidth(e))):(this.df.setSize(e-this.timeWidth-4,t),this.tf.setSize(this.timeWidth,t),Ext.isIE&&(this.df.el.up("td").setWidth(e-this.timeWidth-4),this.tf.el.up("td").setWidth(this.timeWidth))))},setValue:function(e){if(!e&&!0===this.emptyToNow)return void this.setValue(new Date);if(!e)return this.setDate(""),this.setTime(""),void this.updateValue();"number"==typeof e?e=new Date(e):"string"==typeof e&&this.hiddenFormat&&(e=Date.parseDate(e,this.hiddenFormat)),e=e?e:new Date(1970,0,1,0,0,0);var t;e instanceof Date?(this.setDate(e),this.setTime(e),this.dateValue=new Date(Ext.isIE?e.getTime():e)):(t=e.split(this.dtSeparator),this.setDate(t[0]),t[1]&&(t[2]&&(t[1]+=t[2]),this.setTime(t[1]))),this.updateValue()},setVisible:function(e){return e?(this.df.show(),this.tf.show()):(this.df.hide(),this.tf.hide()),this},show:function(){return this.setVisible(!0)},hide:function(){return this.setVisible(!1)},updateDate:function(){var e=this.df.getValue();e?(this.dateValue instanceof Date||(this.initDateValue(),this.tf.getValue()||this.setTime(this.dateValue)),this.dateValue.setMonth(0),this.dateValue.setFullYear(e.getFullYear()),this.dateValue.setMonth(e.getMonth(),e.getDate())):(this.dateValue="",this.setTime(""))},updateTime:function(){var e=this.tf.getValue();!e||e instanceof Date||(e=Date.parseDate(e,this.tf.format)),e&&!this.df.getValue()&&(this.initDateValue(),this.setDate(this.dateValue)),this.dateValue instanceof Date&&(e?(this.dateValue.setHours(e.getHours()),this.dateValue.setMinutes(e.getMinutes()),this.dateValue.setSeconds(e.getSeconds())):(this.dateValue.setHours(0),this.dateValue.setMinutes(0),this.dateValue.setSeconds(0)))},updateHidden:function(){if(this.isRendered){var e=this.dateValue instanceof Date?this.dateValue.format(this.hiddenFormat):"";this.el.dom.value=e}},updateValue:function(){this.updateDate(),this.updateTime(),this.updateHidden()},validate:function(){return this.df.validate()&&this.tf.validate()},renderer:function(e){var t=e.editor.dateFormat||Ext.ux.form.DateTime.prototype.dateFormat;t+=" "+(e.editor.timeFormat||Ext.ux.form.DateTime.prototype.timeFormat);var i=function(e){var i=Ext.util.Format.date(e,t);return i};return i}}),Ext.reg("xdatetime",Ext.ux.form.DateTime),Ext.apply(Ext.ux.form.DateTime.prototype,{dateFormat:"d F Y",timeFormat:"H:i:s"}),Garp.MapWindow=Ext.extend(Ext.Window,{width:800,height:440,modal:!0,iconCls:"icon-map",maximizable:!0,frame:!0,title:__("Map"),buttonAlign:"left",lat:null,"long":null,address:null,fieldRef:null,map:null,pointer:null,latlng:null,buildPointer:function(){this.pointer=new google.maps.Marker({position:this.latlng,animation:google.maps.Animation.DROP,draggable:!0});var e=this;google.maps.event.addListener(this.pointer,"dragend",function(t){e.latlng=t.latLng,e.map.setCenter(t.latLng)}),this.pointer.setMap(this.map)},addLocation:function(){this.latlng=this.map.getCenter(),this.buildPointer(),this.pointer.setMap(this.map),this.addLocationBtn.hide(),this.removeLocationBtn.show()},removeLocation:function(){this.pointer&&this.pointer.setMap(null),this.addLocationBtn.show(),this.removeLocationBtn.hide()},drawMap:function(){if(this.map=new google.maps.Map(this.body.dom,{mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:11}),this.pointer)this.map.setCenter(this.latlng),this.pointer.setMap(this.map),this.removeLocationBtn.show(),this.addLocationBtn.hide();else{this.addLocationBtn.show(),this.removeLocationBtn.hide();var e=this.fieldRef.find("name",this.lat)[0].getValue(),t=this.fieldRef.find("name",this["long"])[0].getValue();e&&t?(this.latlng=new google.maps.LatLng(e,t),this.map.setCenter(this.latlng),this.buildPointer()):this.map.setCenter(new google.maps.LatLng(52.3650012,5.0692639))}},initComponent:function(){this.on({afterrender:{scope:this,fn:function(){"undefined"==typeof google?Garp.lazyLoad("//maps.googleapis.com/maps/api/js?sensor=false",this.drawMap.createDelegate(this)):this.drawMap()}}},{resize:{fn:function(){this.map&&google.maps.event.trigger(this.map,"resize")}}}),Ext.apply(this,{buttons:[{text:__("Add Location"),ref:"../addLocationBtn",hidden:!0,handler:this.addLocation.createDelegate(this)},{text:__("Remove Location"),ref:"../removeLocationBtn",hidden:!0,handler:this.removeLocation.createDelegate(this)},{text:__("Address Lookup"),iconCls:"icon-search",scope:this,handler:function(){var e=this;Ext.Msg.prompt(__("Address Lookup"),__("Please enter the address to lookup:"),function(t,i){if("ok"==t&&i){var s=new google.maps.Geocoder;s.geocode({address:i},function(t,i){"OK"==i&&t.length?(e.latlng=t[0].geometry.location,e.buildPointer(),e.drawMap(),e.addLocationBtn.hide(),e.removeLocationBtn.show()):Ext.Msg.alert(e.title,__("Address not found"))})}})}},"->",{text:__("Ok"),scope:this,handler:function(){this.fieldRef.find("name",this.lat)[0].setValue(""+this.latlng.lat()),this.fieldRef.find("name",this["long"])[0].setValue(""+this.latlng.lng()),this.fieldRef.find("name",this.lat)[0].fireEvent("change"),this.fieldRef.find("name",this["long"])[0].fireEvent("change"),this.close()}},{text:__("Cancel"),scope:this,handler:this.close}]}),Garp.MapWindow.superclass.initComponent.call(this)}}),Ext.ns("Garp"),Garp.MapField=Ext.extend(Ext.form.FieldSet,{latFieldname:"location_lat",longFieldname:"location_long",addressRef:"location_address",fieldLabel:__("Location"),anchor:-30,layout:"hbox",msgTarget:"under",style:"padding: 0;",updateAddress:function(){function e(){var e=new google.maps.Geocoder;i.getValue()&&s.getValue()?e.geocode({latLng:new google.maps.LatLng(i.getValue(),s.getValue())},function(e,t){a.update(t==google.maps.GeocoderStatus.OK?e[0]?Garp.renderers.geocodeAddressRenderer(e[0]):__("Location set, but unknown"):t==google.maps.GeocoderStatus.ZERO_RESULTS?__("Location set, but unknown"):__("Unknown error occurred."))}):a.update(__("No location specified"))}var t=this.refOwner.refOwner,i=t.getForm().findField(this.latFieldname),s=t.getForm().findField(this.longFieldname),a=t.formcontent[this.addressRef];"undefined"==typeof google?Garp.lazyLoad("http://maps.googleapis.com/maps/api/js?sensor=false",e):e(),i.on("change",e)},initComponent:function(e){this.items=[{xtype:"button",iconCls:"icon-map",text:__("Map"),flex:0,margins:"0 20 0 0",handler:function(){new Garp.MapWindow({fieldRef:this.ownerCt,lat:this.latFieldname,"long":this.longFieldname}).show()},scope:this},{name:this.latFieldname,fieldLabel:__("Location lat"),disabled:!1,hidden:!0,allowBlank:!0,xtype:"textfield"},{name:this.longFieldname,fieldLabel:__("Location long"),disabled:!1,hidden:!0,allowBlank:!0,xtype:"textfield"},{xtype:"box",ref:"../../"+this.addressRef,flex:0,margins:"4 20 0 0"}],Garp.MapField.superclass.initComponent.call(this,e),this.on("show",this.updateAddress,this)}}),Ext.reg("mapfield",Garp.MapField),Ext.ux.form.RederedDisplayField=Ext.extend(Ext.form.DisplayField,{renderer:function(e){return e},setRawValue:function(e){return e=this.renderer(e),this.htmlEncode&&(e=Ext.util.Format.htmlEncode(e)),this.rendered?this.el.dom.innerHTML=Ext.isEmpty(e)?"":e:this.value=e}}),Ext.reg("rendereddisplayfield",Ext.ux.form.RederedDisplayField),Ext.ns("Ext.ux.form"),Ext.ux.form.FileUploadField=Ext.extend(Ext.form.TextField,{buttonText:__("Browse&hellip;"),buttonOnly:!1,buttonOffset:3,readOnly:!0,autoSize:Ext.emptyFn,initComponent:function(){Ext.ux.form.FileUploadField.superclass.initComponent.call(this),this.addEvents("fileselected")},onRender:function(e,t){Ext.ux.form.FileUploadField.superclass.onRender.call(this,e,t),this.wrap=this.el.wrap({cls:"x-form-field-wrap x-form-file-wrap"}),this.el.addClass("x-form-file-text"),this.el.dom.removeAttribute("name"),this.createFileInput();var i=Ext.applyIf(this.buttonCfg||{},{text:this.buttonText});this.button=new Ext.Button(Ext.apply(i,{renderTo:this.wrap,cls:"x-form-file-btn"+(i.iconCls?" x-btn-icon":"")})),this.buttonOnly&&(this.el.hide(),this.wrap.setWidth(this.button.getEl().getWidth())),this.bindListeners(),this.resizeEl=this.positionEl=this.wrap},bindListeners:function(){this.fileInput.on({scope:this,mouseenter:function(){this.button.addClass(["x-btn-over","x-btn-focus"])},mouseleave:function(){this.button.removeClass(["x-btn-over","x-btn-focus","x-btn-click"])},mousedown:function(){this.button.addClass("x-btn-click")},mouseup:function(){this.button.removeClass(["x-btn-over","x-btn-focus","x-btn-click"])},change:function(){var e=this.fileInput.dom.value;
this.setValue(e),this.fireEvent("fileselected",this,e)}})},createFileInput:function(){this.fileInput=this.wrap.createChild({id:this.getFileInputId(),name:this.name||this.getId(),cls:"x-form-file",tag:"input",type:"file",size:1})},reset:function(){this.fileInput&&(this.fileInput.remove(),this.createFileInput(),this.bindListeners()),Ext.ux.form.FileUploadField.superclass.reset.call(this)},getFileInputId:function(){return this.id+"-file"},onResize:function(e,t){Ext.ux.form.FileUploadField.superclass.onResize.call(this,e,t),this.wrap.setWidth(e),this.buttonOnly||(e=this.wrap.getWidth()-this.button.getEl().getWidth()-this.buttonOffset,this.el.setWidth(e))},onDestroy:function(){Ext.ux.form.FileUploadField.superclass.onDestroy.call(this),Ext.destroy(this.fileInput,this.button,this.wrap)},onDisable:function(){Ext.ux.form.FileUploadField.superclass.onDisable.call(this),this.doDisable(!0)},onEnable:function(){Ext.ux.form.FileUploadField.superclass.onEnable.call(this),this.doDisable(!1)},doDisable:function(e){this.fileInput.dom.disabled=e,this.button.setDisabled(e)},preFocus:Ext.emptyFn,alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,"tl-tr",[2,0])}}),Ext.reg("fileuploadfield",Ext.ux.form.FileUploadField),Ext.form.FileUploadField=Ext.ux.form.FileUploadField,Ext.ns("Ext.ux.form"),Ext.ux.form.UploadCombo=Ext.extend(Ext.form.TriggerField,{title:__("Upload"),fieldLabel:__("File"),iconCls:"icon-image",emptyText:__("Select file"),previewTpl:new Ext.Template('<img src="{0}uploads/images/{1}" title="{1}" style="max-width:400px;max-height:260px;" /><br><a href="{0}uploads/images/{1}" target="_blank">'+__("Download")+"&hellip;</a>"),uploadURL:BASE+"g/content/upload",showUploadDialog:function(){var e={ref:"previewBox",hideMode:"visibility",frame:!0,hidden:!0};this.getValue()&&Ext.apply(e,{html:this.previewTpl.apply([BASE,this.getValue()]),style:"overflow: auto;margin-bottom: 10px;text-align:center;",height:290,hidden:!1}),this.win=new Ext.Window({modal:!0,title:this.title,iconCls:this.iconCls,width:450,height:this.getValue()?420:130,border:!1,items:[{xtype:"form",ref:"formpanel",fileUpload:!0,border:!1,frame:!0,bodyStyle:"padding: 10px 10px 0 10px",items:[e,{anchor:"95%",value:this.value,height:40,name:"file",fieldLabel:this.fieldLabel,allowBlank:!1,buttonText:__("Browse&hellip;"),hideFieldLabel:!0,emptyText:this.emptyText,listeners:{fileselected:this.performUpload.createDelegate(this)},xtype:"fileuploadfield"}]}],buttons:[{text:__("Cancel"),scope:this,handler:function(){this.win.close()}}]}),this.win.show(),this.setupFileDrop()},performUpload:function(){var e=this.win.formpanel.getForm();if(e.isDirty()){var t=new Ext.LoadMask(Ext.getBody(),{msg:__("Uploading...")});t.show();e.submit({clientValidation:!1,url:this.uploadURL,success:this.uploadCallback.createSequence(function(){t.hide()}).createDelegate(this),failure:function(e,i){t.hide();var s="";i&&i.result&&i.result.messages&&i.result.messages.length&&(s=i.result.messages.join("<br />")),Ext.Msg.alert(__("Error"),"<b>"+__("Error uploading file")+"</b>:<br />"+s)}})}else this.win.close()},uploadCallback:function(e,t){this.win.close(),t.result.file&&this.setValue(t.result.file),this.fireEvent("change",this,t.result.file,"")},setupFileDrop:function(){function e(e){return e.stopPropagation(),e.preventDefault(),!1}function t(t){function i(e){for(var t="",i=0;e>i;i++)t+=""+Math.floor(10*Math.random());return t}e(t),t=t.browserEvent;var a=new Ext.LoadMask(s.win.getEl(),__("Uploading..."));if(t.dataTransfer&&t.dataTransfer.files){var n=t.dataTransfer.files[0],r=new FileReader;r.onload=function(e){var t=e.target.result,r=new XMLHttpRequest,o="",l="",d="\r\n";r.addEventListener("load",function(e){a.hide();var t=Ext.decode(e.target.responseText),i={result:t};s.uploadCallback.call(s,null,i)},!1);var h="---------------------------"+i(13);r.open("POST",s.uploadURL,!0),r.setRequestHeader("Content-Type","multipart/form-data; boundary="+h),r.setRequestHeader("Content-Length",n.fileSize),o+="--"+h+d,o+='Content-Disposition: form-data; name="file"; filename="'+n.fileName+'"'+d+d,l=d+"--"+h+"--"+d,r.sendAsBinary(o+""+t+l),a.show()},r.readAsBinaryString(n)}return!1}var i=this.win.getEl(),s=this;Ext.EventManager.on(i,"dragenter",function(t){i.highlight(),e(t)}),Ext.EventManager.on(i,"dragexit",e),Ext.EventManager.on(i,"dragover",e),Ext.EventManager.on(i,"drop",t)},onTriggerClick:function(){this.showUploadDialog()},getValue:function(){var e=Ext.ux.form.UploadCombo.superclass.getValue.call(this);return e||(e=null),e},initComponent:function(){Ext.ux.form.UploadCombo.superclass.initComponent.call(this,arguments)}}),Ext.reg("uploadcombo",Ext.ux.form.UploadCombo),Ext.ns("Ext.ux.form"),Ext.ux.form.UploadField=Ext.extend(Ext.ux.form.FileUploadField,{maxSurface:6e6,uploadURL:BASE+"g/content/upload",supportedExtensions:["gif","jpg","jpeg","png"],getValue:function(){var e=Ext.ux.form.UploadCombo.superclass.getValue.call(this);return e||(e=null),e},validateExtension:function(e){var t=e.split(".");if(!t)return!1;t=t[t.length-1];var i=t[0];return i.length?this.supportedExtensions.indexOf(t.toLowerCase())>-1:!1},validateResolution:function(e,t){if("function"!=typeof FileReader)return void t(!0);var i=new FileReader,s=this;i.onload=function(){var e=new Image;e.onload=function(){var i=e.width*e.height,a=i<=s.maxSurface;t(a)},e.src=i.result},i.readAsDataURL(e)},handleFileDrop:function(e){return this.wrap.removeClass("x-focus"),e.dataTransfer&&e.dataTransfer.files&&1==e.dataTransfer.files.length&&this.performUpload(e.dataTransfer.files[0]),!1},handleFileSelect:function(){this.performUpload(this.fileInput)},isImage:function(e){var t=e.name.split(".").pop();if(!t)return!1;for(var i=["jpg","jpeg","png","gif"],s=0,a=i.length;a>s;++s)if(i[s]===t)return!0;return!1},performUpload:function(e){var t=this;if(Ext.isIE){var i=new Ext.LoadMask(Ext.getBody(),{msg:__("Loading")});i.show();var s=Ext.DomHelper,a=Ext.get(s.insertHtml("beforeEnd",Ext.getBody().dom,'<iframe src="javscript:false;" name="uploadFrame" style="display:none;"></iframe>')),n=Ext.get(s.insertHtml("beforeEnd",Ext.getBody().dom,'<form method="post" target="uploadFrame" action="'+this.uploadURL+'" enctype="multipart/form-data"></form>'));Ext.get(e).appendTo(n),a.on("load",function(){var e=Ext.decode(a.dom.contentDocument.body.innerHTML);e&&e.success?(t.setValue(e.filename),t.fireEvent("change",t,e.filename)):Ext.Msg.alert(__("Garp"),__("Error uploading file.")),n.remove(),a.remove(),i.hide()}),n.dom.submit()}else{var r;if(r=e.dom&&e.dom.files?e.dom.files[0]:e,!r||!r.name)return;var o=function(e,i){t.setValue(t.originalValue),Ext.Msg.alert(e||__("Garp"),i||__("Error uploading file."))},l=function(e){if(e)if(t.validateExtension(r.name)){var i=new FormData,s=new XMLHttpRequest;t.uploadDialog=Ext.Msg.progress(__("Upload"),__("Initializing upload")),i.append("filename",r),s.addEventListener("load",function(){var e=Ext.decode(s.responseText);t.uploadDialog.hide(),e.success?(t.setValue(e.filename),t.fireEvent("change",t,e.filename)):o()},!1),s.addEventListener("error",function(){t.uploadDialog.hide(),o()},!1),s.upload.addEventListener("progress",function(e){e.lengthComputable&&(t.uploadDialog.updateProgress(e.loaded/e.total),t.uploadDialog.updateText(__("Uploading")+" "+Math.ceil(e.loaded/e.total*100)+"%"))},!1),s.open("POST",t.uploadURL),t.uploadDialog.updateText(__("Uploading&hellip;")),setTimeout(function(){s.send(i)},350)}else o(__("Error"),"<b>"+__("Extension not supported")+"</b><br /><br />"+__("Supported extensions are:")+"<br /> "+t.supportedExtensions.join(" "));else{var a=Ext.util.Format.number(t.maxSurface,"1000.000/i"),n=Math.floor(Math.sqrt(t.maxSurface));n=1e3*Math.round((n+500)/1e3);var l=Math.floor(t.maxSurface/n);o(__("Error"),"<b>"+__("Resolution too high. Please make sure the image's surface area does not exceed "+a)+" pixels. <br>For instance: "+n+" x "+l+" pixels.</b>")}};this.isImage(r)?this.validateResolution(r,l):l(!0)}},setupDnD:function(){var e={normalized:!1,preventDefault:!0,stopPropagation:!0};this.wrap.on("dragenter",function(){this.wrap.addClass("x-focus")},this,e),this.wrap.on("dragexit",function(){this.wrap.removeClass("x-focus")},this,e),this.wrap.on("dragover",function(){},this,e),this.wrap.on("drop",function(e){this.handleFileDrop(e)},this,e)},onDestroy:function(){this.uploadDialog&&this.uploadDialog.hide(),Ext.ux.form.UploadField.superclass.onDestroy.call(this)},initComponent:function(){this.on("fileselected",this.handleFileSelect,this),Ext.ux.form.UploadField.superclass.initComponent.call(this,arguments),this.on("afterrender",this.setupDnD,this)}}),Ext.reg("uploadfield",Ext.ux.form.UploadField),Ext.ns("Ext.ux"),Ext.ux.PagingSearchBar=Ext.extend(Ext.PagingToolbar,{height:27,displayInfo:!0,enableOverflow:!0,grid:null,_resizeSearchFieldWidth:function(){var e=this.getWidth();if(this.searchField){var t=this.displayInfo?460:230;this.searchField.setWidth(e-t),320>e?this.searchoptionsbtn.hide():this.searchoptionsbtn.show()}},makeQuery:function(e){var t=this.grid.store.baseParams.query,i=new Ext.util.MixedCollection;i.addAll(Garp.dataTypes);var s={};Ext.isObject(t)&&i.eachKey(function(e){e+=".id",t[e]&&(s[e]=t[e])}),this.grid.store.baseParams.query=Ext.apply(this.convertQueryString(e,this.getSelectedSearchFields()),s),this.moveFirst()},convertQueryString:function(e,t){if(""===e)return{};var i="%"+e+"%",s={};return Ext.each(t,function(e){s[e+" like"]=i}),{or:s}},getSelectedSearchFields:function(){var e=[];return this.searchOptionsMenu&&Ext.each(this.searchOptionsMenu.items.items,function(t){"menucheckitem"===t.xtype&&t.checked&&t._dataIndex&&e.push(t._dataIndex)}),e},getAllSearchFields:function(){var e=[];if(this.grid)return Ext.each(this.grid.getColumnModel().config,function(t){"relationMetadata"!==t.dataIndex&&e.push(t)}),e},searchOptionsMenu:new Ext.menu.Menu({items:{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:Ext.PagingToolbar.prototype.emptyMsg}}),buildSearchOptionsMenu:function(){var e=this.getAllSearchFields(),t=[{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:__("Zoeken in:")},"-"];Ext.each(e,function(e){t.push({text:e.header,_dataIndex:e.dataIndex})}),this.searchOptionsMenu=new Ext.menu.Menu({defaults:{xtype:"menucheckitem",hideOnClick:!1,checked:!0},items:t})},initComponent:function(){this.store.on({load:{scope:this,single:!0,fn:function(){this.grid||(this.grid=this.ownerCt),this.buildSearchOptionsMenu()}}});var e=this;this.items=["->"," ",{xtype:"tbbutton",ref:"searchoptionsbtn",iconCls:"icon-searchoptions",cls:"garp-searchoptions",tooltip:__("Zoekopties"),scope:this,handler:function(e){this.searchOptionsMenu.show(e.el)}},this.searchField=new Ext.ux.form.SearchField({xtype:"twintrigger",style:"paddingLeft: 22px;",store:this.store,value:this.store.baseParams.query,listeners:{change:function(){var e=this.getValue();e.length<1?this.removeClass("has-search"):this.addClass("has-search")}},onTrigger1Click:function(){this.hasSearch&&(this.triggers[0].hide(),this.el.dom.value="",e.makeQuery(""))},onTrigger2Click:function(){var t=this.getRawValue();return t.length<1?void this.onTrigger1Click():(this.triggers[0].show(),this.hasSearch=!0,void e.makeQuery(t))},width:80})],this.on({resize:this._resizeSearchFieldWidth,afterlayout:this._resizeSearchFieldWidth},this),Ext.ux.PagingSearchBar.superclass.initComponent.call(this)},blur:function(){this.searchField.blur(),Ext.ux.PagingSearchBar.superclass.blur.call(this)},afterRender:function(){new Ext.KeyNav(this.getEl(),{esc:function(){this.blur(),this.fireEvent("defocus")},scope:this});Ext.ux.PagingSearchBar.superclass.afterRender.call(this)}}),Ext.reg("pagingsearchbar",Ext.ux.PagingSearchBar),Ext.ns("Ext.ux.form"),Ext.ux.form.SearchField=Ext.extend(Ext.form.TwinTriggerField,{initComponent:function(){Ext.ux.form.SearchField.superclass.initComponent.call(this),this.on("specialkey",function(e,t){t.getKey()==t.ENTER&&(this.onTrigger2Click(),t.stopEvent())},this)},xtype:"twintrigger",validationEvent:!1,validateOnBlur:!1,trigger1Class:"x-form-clear-trigger",trigger2Class:"x-form-search-trigger",hideTrigger1:!0,hasSearch:!1,paramName:"query",blur:function(){this.getEl().removeClass("x-form-focus"),Ext.ux.form.SearchField.superclass.blur.call(this)},onTrigger1Click:function(){if(this.hasSearch){this.el.dom.value="";var e={start:0};this.store.baseParams=this.store.baseParams||{},this.store.baseParams[this.paramName]="",this.store.reload({params:e}),this.triggers[0].hide(),this.hasSearch=!1}},onTrigger2Click:function(){var e=this.getRawValue();if(e.length<1)return void this.onTrigger1Click();var t={start:0};this.store.baseParams=this.store.baseParams||{},this.store.baseParams[this.paramName]=e,this.store.reload({params:t}),this.hasSearch=!0,this.triggers[0].show()}}),Ext.reg("twintrigger",Ext.ux.form.SearchField),Ext.ns("Ext.ux.form"),Ext.isIE?Ext.ux.form.RichTextEditor=Ext.extend(Ext.form.HtmlEditor,{enableAlignments:!1,enableBlockQuote:!0,enableColors:!1,enableEmbed:!0,enableFont:!1,enableFontSize:!1,enableFormat:!0,enableHeading:!0,enableLists:!0,enableDefinitionList:!0,enableMedia:!0,enableLinks:!0,enableUnderline:!1,enableSourceEdit:!0,defaultHeadingTag:"h2",defaultValue:"<p>&#8203;</p>",setValue:function(e){e||(e=this.defaultValue),Ext.ux.form.RichTextEditor.superclass.setValue.call(this,e)},isDirty:function(){return!this.disabled&&this.rendered&&this.isVisible()&&this.getWin()?String(this.getValue())!==String(this.originalValue):!1},getDocMarkup:function(){return'<html><head><link rel="stylesheet" href="'+BASE+'/css/garp/garp-richtexteditor.css" type="text/css"></head><body style="padding:0 !important;"></body></html>'},onRender:function(e,t){Ext.ux.form.RichTextEditor.superclass.onRender.call(this,e,t),this.statusbar=new Ext.Component({renderTo:this.wrap.dom,cls:"x-toolbar garp-richtexteditor-statusbar",html:__("Internet Explorer mode: Not all options are available")})},blur:function(e,t){if(this.initialized&&this.hasFocus){var i=this.getToolbar();i.items.each(function(e){e.toggle&&e.toggle(!1)}),(!t||!Ext.WindowMgr.getActive()&&this.getEl().parent(".garp-formpanel")&&!this.getEl().parent().contains(Ext.get(t).dom.id))&&(this.hasFocus=!1,this.fireEvent("blur",this),this.wrap.removeClass("x-focus"),this.cleanupHtml(),this.hideMediaToolbar(),this.updateStatusbar(""))}},initComponent:function(){this.addEvents("toolbarupdated"),Ext.ux.form.RichTextEditor.superclass.initComponent.call(this),this.on("initialize",function(){this.execCmd("styleWithCSS",!1),this.execCmd("insertBrOnReturn",!1,!1),this.execCmd("enableObjectResizing",!1),this.updateStatusbar(""),this.setupImageHandling(),this.getDoc().body.style.backgroundColor="transparent"},this),this.on("editmodechange",function(e,t){t?this.addClass("garp-richtexteditor-source-edit"):this.removeClass("garp-richtexteditor-source-edit")},this)},destroy:function(){Ext.getBody().un("click",this.blur,this)},pushValue:function(){if(this.initialized){var e=this.el.dom.value;if(!this.activated&&e.length<1&&(e=this.defaultValue),this.sourceEditMode)return;this.getEditorBody().innerHTML=e,this.fireEvent("push",this,e),Ext.EventManager.on(this.getDoc(),"keydown",function(e){return e.getKey()==e.TAB?(this.blur(e,!1),!1):void 0},this)}}}):(Ext.ux.form.RichTextEditor=Ext.extend(Ext.form.HtmlEditor,{enableAlignments:!1,enableBlockQuote:!0,enableColors:!1,enableEmbed:!0,enableFont:!1,enableFontSize:!1,enableFormat:!0,enableHeading:!0,enableLists:!0,enableDefinitionList:!0,enableMedia:!0,enableLinks:!1,enableLink:!0,enableUnderline:!1,enableSourceEdit:!0,defaultHeadingTag:"h2",maxLength:null,iframePad:5,height:500,showStatusbar:!0,showCharCount:!0,hasFocus:!1,defaultValue:"<p>&#8203;</p>",getValue:function(){var e=Ext.ux.form.RichTextEditor.superclass.getValue.call(this);return"<p>â€‹</p>"==e?null:e},setValue:function(e){e||(e=this.defaultValue),Ext.ux.form.RichTextEditor.superclass.setValue.call(this,e)},getRange:function(){var e,t,i=this.getWin(),s=this.getDoc();return t=i.getSelection(),t.getRangeAt?t.rangeCount>0&&(e=t.getRangeAt(0)):(e=s.createRange(),e.setStart(t.anchorNode,t.anchorOffset),e.setEnd(t.focusNode,t.focusOffset),e.collapsed!==t.isCollapsed&&(e.setStart(t.focusNode,t.focusOffset),e.setEnd(t.anchorNode,t.anchorOffset))),e},getSelection:function(){var e=this.getWin(),t="undefined"!=typeof e.selection?e.selection.createRange().text:"function"==typeof e.getSelection?e.getSelection():!1;return t},findNode:function(e){e=e.toUpperCase();var t=this.getRange();if(t){var i=null;return Ext.each(["commonAncestorContainer","startContainer","endContainer"],function(s){var a=t[s];return a.tagName&&a.tagName===e?void(i=a):a.parentNode&&a.parentNode.tagName===e?void(i=a.parentNode):a.previousSibling&&a.previousSibling.tagName===e?void(i=a.previousSibling):a.children&&(Ext.each(a.children,function(t){return t.tagName&&t.tagName===e?void(i=t):void 0}),i)?i:void 0}),i}},createOrRemoveTag:function(e){var t=this.getRange(),i=this.getSelection();if(t&&i){var s,a=this.findNode(e);if(a){t.selectNode(a);var n=t.toString();s=this.getDoc().createTextNode(n),t.deleteContents(),t.insertNode(s),t.selectNodeContents(s)}else s=this.getDoc().createElement(e),s.appendChild(t.extractContents()),t.insertNode(s),t.selectNode(s);i.removeAllRanges(),i.addRange(t),this.focus.defer(20,this)}},addHeading:function(e){e||(e=this.defaultHeadingTag),e=e.toUpperCase(),this.createOrRemoveTag(e)},addBlockQuote:function(){var e=this.getSelection(),t=this.filterTagsOnly(this.walk(e.focusNode,!0)),i=!1;Ext.each(t,function(e){"BLOCKQUOTE"==e.tagName.toUpperCase()&&(i=!0)}),i?this.relayCmd("outdent"):this.relayCmd("formatblock","blockquote")},addLink:function(){var e=null,t=null,i=null,s=!1,a=this.getSelection().toString(),n=this.walk(this.getRange().endContainer,!0);Ext.each(n,function(n){return"A"==n.tagName?(e=decodeURIComponent(n.href),t=""!==n.target?!0:null,i=n.title,a||(a=n.textContent),s=n,!1):void 0});var r=new Ext.Window({title:__("Add link"),iconCls:"icon-richtext-add-link",width:445,modal:!0,height:240,border:!0,layout:"fit",defaultButton:"_url",items:[{xtype:"fieldset",bodyCssClass:"garp-dialog-fieldset",labelWidth:160,items:[{xtype:"textfield",fieldLabel:__("Url"),name:"url",id:"_url",vtype:"mailtoOrUrl",allowBlank:!1,plugins:[Garp.mailtoOrUrlPlugin],value:e||""},{xtype:"textfield",fieldLabel:__("Title"),name:"title",value:i},{xtype:"checkbox",allowBlank:!0,fieldLabel:__("Open in new window"),name:"target",checked:t!==!0?!0:!1}]}],buttonAlign:"right",buttons:[{text:__("Cancel"),handler:function(){r.close()}},{text:__("Ok"),ref:"../ok",handler:function(){var e=r.find("name","url")[0].getValue(),t=r.find("name","title")[0].getValue(),i="1"==r.find("name","target")[0].getValue();if(e)if(a||(a=e),s)s.setAttribute("href",e),i?s.setAttribute("target","_blank"):s.removeAttribute("target"),s.setAttribute("title",t);else{var n=this.getSelection(),o=this.getRange(),l=this.getDoc().createElement("a");l.setAttribute("href",e),i&&l.setAttribute("target","_blank"),l.setAttribute("title",t),l.appendChild(this.getDoc().createTextNode(a)),o.deleteContents(),o.insertNode(l),o.selectNodeContents(l),n.removeAllRanges(),n.addRange(o)}r.close()},scope:this}]});r.show(),r.items.get(0).items.get(0).clearInvalid();new Ext.KeyMap([r.find("name","url")[0].getEl(),r.find("name","title")[0].getEl()],{key:[10,13],fn:function(){r.ok.handler.call(this)},scope:this});this.tb.items.map.createlink.toggle(!1)},removeSelection:function(e){this.getWin().focus();var t=this.getSelection(),i=this.getRange();i||(i=this.getDoc().createRange()),i.selectNode(e.dom),t.removeAllRanges(),t.addRange(i),this.execCmd("delete")},showMediaToolbar:function(e){function t(e){var t=i.getStyle("float")==e?"":e;i.setStyle("float",t),this.mediaToolbar.left.toggle("left"==t),this.mediaToolbar.right.toggle("right"==t)}var i=Ext.get(e),s=Ext.get(this.iframe),a=Garp.viewport?this.ownerCt.ownerCt.el.getTop():0;this.hideMediaToolbar(),this.mediaToolbarLayer=new Ext.Layer({shadow:"frame",shadowOffset:4});var n=5;this.mediaToolbarLayer.setWidth("IFRAME"==e.nodeName||"OBJECT"==e.nodeName?100:132),this.mediaToolbarLayer.setHeight(28),this.mediaToolbarLayer.setX(Math.max(0,i.getX())+Math.max(0,s.getBox(!1,!1).x)+n),this.mediaToolbarLayer.setY(Math.max(a,Math.max(0,i.getY())+Math.max(0,s.getBox(!1,!1).y)+n)),this.mediaToolbarLayer.show();var r=[];r.push({iconCls:"icon-richtext-edit-image",tooltip:__("Edit image"),scope:this,hidden:"IFRAME"==e.nodeName||"OBJECT"==e.nodeName,handler:this.hideMediaToolbar.createSequence(this.editImage.createDelegate(this,[i]))},{iconCls:"icon-richtext-remove-image",tooltip:__("Remove image"),scope:this,handler:this.hideMediaToolbar.createSequence(this.removeSelection.createDelegate(this,[i]))},"-",{iconCls:"icon-richtext-align-left",tooltip:"Align left",pressed:"left"==i.getStyle("float"),enableToggle:!0,ref:"left",handler:t.createDelegate(this,["left"])},{iconCls:"icon-richtext-align-right",tooltip:"Align right",pressed:"right"==i.getStyle("float"),enableToggle:!0,ref:"right",handler:t.createDelegate(this,["right"])}),this.mediaToolbar=new Ext.Toolbar({renderTo:this.mediaToolbarLayer,items:[r]}),this.mediaToolbar.show()},hideMediaToolbar:function(){this.mediaToolbarLayer&&this.mediaToolbarLayer.remove(),this.mediaToolbar&&this.mediaToolbar.destroy()},setupImageHandling:function(){var e=this,t=Ext.DomQuery.select("dl.figure img, dl.figure dd",this.getDoc().body);Ext.each(t,function(e){e.draggable=!1}),this.getWin().addEventListener("mousedown",function(t){if("IMG"==t.target.nodeName){var i=t.target.parentNode.parentNode;if(Ext.get(i).hasClass("figure")){var s=e.getSelection();s.removeAllRanges();var a=document.createRange();a.selectNodeContents(i),a.setStartBefore(i),a.setEndAfter(i),s.addRange(a)}}return!0},!1),this.getWin().addEventListener("mouseover",function(t){if(t&&t.target){var i=t.target;return"figure"==i.className||"IFRAME"==i.nodeName||"OBJECT"==i.nodeName?e.getSelection().focusNode!==e.getDoc().getElementsByTagName("body")[0]&&e.showMediaToolbar(i):i.parentNode&&i.parentNode.parentNode&&"figure"==i.parentNode.parentNode.className?e.getSelection().focusNode!==e.getDoc().getElementsByTagName("body")[0]&&e.showMediaToolbar(i.parentNode.parentNode):e.hideMediaToolbar(),!0}},!1)},putImage:function(e){{var t=Garp.imageTpl,i=this.getSelection();i.anchorNode,i.anchorOffset,i.focusNode,i.focusOffset}this.insertAtCursor(t.apply({path:e.src,width:e.template.get("w"),height:e.template.get("h"),align:e.align,caption:e.caption||!1}));var s=this;setTimeout(function(){var e=Ext.select(".figure",null,s.getDoc()).last().dom,t=s.getDoc().getElementsByTagName("body")[0].children;if(t[t.length-1].isSameNode(e)){var i=document.createElement("p"),a=document.createTextNode(" â€‹ ");i.appendChild(a),s.getDoc().getElementsByTagName("body")[0].appendChild(i)}setTimeout(function(){var e=s.getSelection(),t=s.getDoc().body.children;t=t[t.length-1],e.removeAllRanges();var i=s.getDoc().createRange();i.setStart(t,0),i.setStartBefore(t),i.setEnd(t,0),i.setEndAfter(t),i.collapse(!1),e.addRange(i),e.selectAllChildren(t),e.collapse(t,1)},100)},100)},addImage:function(){var e=new Garp.ImagePickerWindow({});e.on("select",this.putImage,this),e.show()},editImage:function(e){var t=e.child("img")?e.child("img").getAttribute("src"):e.getAttribute("src");t=t.split("/"),""===t[t.length-1]&&t.splice(t.length-1,1);var i=t[t.length-1],s=t[t.length-2],a=e.getStyle("float"),n=e.child("dd")?e.child("dd").dom.innerHTML:null,r=new Garp.ImagePickerWindow({imgGridQuery:{id:i},cropTemplateName:s,captionValue:n,alignValue:"none"==a?"":a});r.on("select",function(t){r.close(),this.removeSelection(e),this.putImage(t)},this),r.show()},addVideo:function(){var e=new Garp.ModelPickerWindow({model:"Video",listeners:{select:function(e){var t=e.selected;this.insertAtCursor("<p></p>"+Garp.videoTpl.apply({player:t.get("player"),width:VIDEO_WIDTH,height:VIDEO_HEIGHT})+"<p></p>")},scope:this}});e.show()},pastePlainText:function(){var e=new Ext.form.TextArea,t=new Ext.Window({width:480,height:320,modal:!0,layout:"fit",title:__("Paste as plain text"),iconCls:"icon-richtext-paste-plain-text",defaultButton:e,items:[e],buttons:[{text:__("Cancel"),ref:"../cancel",scope:this,handler:function(){t.close()}},{text:__("Ok"),ref:"../ok",scope:this,handler:function(){var i=e.getValue();this.insertAtCursor(i),t.close()}}]});t.show(),t.keymap=new Ext.KeyMap(t.getEl(),[{key:Ext.EventObject.ENTER,ctrl:!0,scope:this,fn:function(){t.ok.handler.call(this)}},{key:Ext.EventObject.ESC,scope:this,fn:function(e){t.cancel.handler.call(this),e.stopEvent()}}]),t.keymap.stopEvent=!0},addEmbed:function(){var e=new Ext.form.TextArea,t=new Ext.Window({width:480,height:320,modal:!0,layout:"fit",title:__("Embed HTML"),iconCls:"icon-richtext-add-embed",defaultButton:e,items:[e],buttons:[{text:__("Ok"),ref:"../ok",scope:this,handler:function(){var i=e.getValue();this.insertAtCursor("<p></p>"),this.execCmd("InsertHTML",i),this.insertAtCursor("<p></p>"),t.close()}},{text:__("Cancel"),ref:"../cancel",scope:this,handler:function(){t.close()}}]});t.show(),t.keymap=new Ext.KeyMap(t.getEl(),[{key:Ext.EventObject.ENTER,ctrl:!0,scope:this,fn:function(){t.ok.handler.call(this)}},{key:Ext.EventObject.ESC,scope:this,fn:function(e){t.cancel.handler.call(this),e.stopEvent()}}]),t.keymap.stopEvent=!0},walk:function(e,t,i){return i||(i=[]),!t==!1&&(t=!0),t?(i.push(e),e&&e.parentNode&&"HTML"!==e.nodeName&&(e=e.parentNode,this.walk(e,t,i))):(i.push(e),e&&e.childNodes&&e.childNodes[0]&&(e=e.childNodes[0],this.walk(e,t,i))),i},filterTagsOnly:function(e){for(var t=[],i=0;i<e.length;i++){var s=e[i];s.tagName&&t.push(s)}return t},getCurrentTagName:function(){var e=this.getSelection().focusNode;if(e)return e=e.tagName?e.tagName:e.parentNode.tagName?e.parentNode.tagName:"",e.toLowerCase()},getCurrentClassList:function(){var e=this.getSelection().focusNode;if(e){var t=e.className?e.className:e.parentNode.className?e.parentNode.className:"";return t.toLowerCase()}},buildStatusbar:function(){this.statusbar=new Ext.Component({renderTo:this.wrap.dom,cls:"x-toolbar garp-richtexteditor-statusbar",html:"&nbsp;"});var e=null;this.statusbar.el.on("mouseover",function(t,i){var s=Number(i.className.substr(1,i.className.length));if(!isNaN(s)){var a=this.getSelection(),n=this.filterTagsOnly(this.walk(a.focusNode,!0).reverse());e=n[s],e&&Ext.get(e).addClass("garp-richtexteditor-highlight")}},this),this.statusbar.el.on("mouseout",function(){e&&Ext.get(e).removeClass("garp-richtexteditor-highlight")},this)},updateStatusbar:function(e){if(this.statusbar){if(""!==e){var t=this.getSelection();if(!t)return;var i=this.walk(t.focusNode,!0).reverse();e="";for(var s=1,a=i.length;a>s;s++){var n=i[s];e+=n.tagName?'<span class="_'+s+'">'+n.tagName+"</span> &gt; ":'<span class="_'+s+'">"'+Ext.util.Format.ellipsis(n.nodeValue,20,!0)+'"</span>'}}else e="&nbsp;";this.maxLength?e+='<span class="count">'+(this.maxLength-this.getCharCount()||"")+"</span>":this.showCharCount&&(e+='<span class="count">'+(this.getCharCount()||"")+"</span>"),this.statusbar.update(e)}},getCharCount:function(){if(this.initialized&&this.getDoc()&&this.getDoc().body){var e=this.getDoc().body.textContent;return 8203==e.charCodeAt(0)?e.length-1:e.length}return 0},isValid:function(){return this.maxLength&&this.getCharCount()>=this.maxLength?(this.wrap.addClass(this.invalidClass),!1):(this.wrap&&this.wrap.removeClass(this.invalidClass),!0)},isDirty:function(){return!this.disabled&&this.rendered&&this.isVisible()&&this.getWin()?"<p>&#8203;</p>"===String(this.originalValue)&&null===this.getValue()?!1:String(this.getValue())!==String(this.originalValue):!1},getDocMarkup:function(){return'<html><head><link rel="stylesheet" href="'+BASE+'/css/garp/garp-richtexteditor.css" type="text/css"></head><body></body></html>'},onEditorEvent:function(){this.execCmd("styleWithCSS",!1),this.hasFocus=!0,this.wrap.addClass("x-focus");var e=this.getSelection();e&&this.updateToolbar()},_insertTag:function(e){var t=this.getRange(),i=document.createElement(e?e.toUpperCase():"DIV");return t.insertNode(i)},addDefinitionList:function(){var e=this.getCurrentTagName().toLowerCase();switch(e){case"dl":this.insertAtCursor("</dl><p>");break;case"dt":this.insertAtCursor("</dt></dl><p>");break;case"dd":this.insertAtCursor(Ext.isChrome||Ext.isWebkit?"</dd><dt>&hellip;</dt><dd>&hellip;</dd>":"</dd><dt>");break;default:var t=this.getSelection(),i=Ext.id(),s=t.toString()||"&hellip;",a=this.getRange();a.deleteContents(),this.insertAtCursor(Ext.isChrome||Ext.isWebkit?'<dl><dt id="'+i+'">'+s+"</dt><dd>"+s+"</dd></dl><p>&nbsp;</p>":'<dl><dt id="'+i+'">'+s+"</dt>");var n=this.getDoc().getElementById(i);a.selectNodeContents(n),t.removeAllRanges(),t.addRange(a)}this.deferFocus(),this.updateToolbar.defer(100,this)},updateToolbar:function(){if(!this.readOnly&&this.hasFocus){if(!this.activated&&this.onFirstFocus)return void this.onFirstFocus();var e=this.tb.items.map,t=this.getDoc();if(this.enableFont&&!Ext.isSafari2){var i=(t.queryCommandValue("FontName")||this.defaultFont).toLowerCase();i!=this.fontSelect.dom.value&&(this.fontSelect.dom.value=i)}this.enableFormat&&(e.bold.toggle(t.queryCommandState("bold")),e.italic.toggle(t.queryCommandState("italic")),this.enableUnderline&&e.underline.toggle(t.queryCommandState("underline"))),this.enableAlignments&&(e.justifyleft.toggle(t.queryCommandState("justifyleft")),e.justifycenter.toggle(t.queryCommandState("justifycenter")),e.justifyright.toggle(t.queryCommandState("justifyright"))),!Ext.isSafari2&&this.enableLists&&(e.insertorderedlist.toggle(t.queryCommandState("insertorderedlist")),e.insertunorderedlist.toggle(t.queryCommandState("insertunorderedlist")));var s=t.queryCommandValue("formatblock"),a=["h1","h2","h3","h4","h5","h6"];e.addheading.toggle(s&&a.indexOf(s.toLowerCase())>-1?!0:!1);var n=this.getCurrentTagName(),r=this.getCurrentClassList();e.createlink.toggle("a"==n),r&&r.indexOf&&-1==r.indexOf("figure")&&e.definitionlist.toggle("dl"==n||"dt"==n||"dd"==n),Ext.menu.MenuMgr.hideAll(),this.statusbar&&this.updateStatusbar(),this.syncValue(),this.fireEvent("toolbarupdated",this)}},onRender:function(e,t){Ext.ux.form.RichTextEditor.superclass.onRender.call(this,e,t),this.showStatusbar&&this.buildStatusbar(),Ext.each(["bold","italic","underline","insertorderedlist","insertunorderedlist","addheading","justifyleft","justifycenter","justifyright"],function(e){this.tb.items.map[e]&&this.tb.items.map[e].on("click",function(){this.pressed&&this.toggle.defer(100,this,[!0])})},this)},afterRender:function(){Ext.ux.form.RichTextEditor.superclass.afterRender.call(this);var e=this.getToolbar();if(!this.enableUnderline){var t=e.find("itemId","underline")[0];e.remove(t)}this.enableLists&&this.enableUnderline&&e.insert(3,"-"),e.insert(3,{tooltip:__("<b>Add Blockquote</b><br>Convert selected text into a blockquote."),iconCls:"icon-richtext-add-blockquote",hidden:!this.enableBlockQuote,itemId:"addblockquote",handler:this.addBlockQuote.createDelegate(this),tabIndex:-1,scope:this}),e.insert(4,{tooltip:__("<b>Add Heading</b><br>Convert selected text into a heading."),iconCls:"icon-richtext-add-heading",enableToggle:!0,hidden:!this.enableHeading,itemId:"addheading",handler:this.addHeading.createDelegate(this,[this.defaultHeadingTag]),tabIndex:-1,scope:this}),e.insert(8,{tooltip:__("<b>Add Glossary</b><br>Creates a list of terms."),iconCls:"icon-richtext-add-dl",enableToggle:!0,itemId:"definitionlist",hidden:!this.enableDefinitionList,handler:this.addDefinitionList,tabIndex:-1,scope:this}),e.insert(9,{tooltip:__("<b>Add Link</b><br>Convert selected text into a hyperlink."),iconCls:"icon-richtext-add-link",enableToggle:!0,itemId:"createlink",hidden:!this.enableLink,handler:this.addLink,tabIndex:-1,scope:this}),e.insert(10,{tooltip:__("<b>Image</b><br>Insert image."),iconCls:"icon-richtext-add-image",itemId:"addImage",hidden:!this.enableMedia,handler:this.addImage,tabIndex:-1,scope:this}),e.insert(11,{tooltip:__("<b>Video</b><br>Insert a video."),iconCls:"icon-richtext-add-video",itemId:"addVideo",hidden:!this.enableMedia,handler:this.addVideo,tabIndex:-1,scope:this}),e.insert(12,"-"),e.insert(13,{tooltip:__("<b>Paste as plain text</b><br>Removes styling."),iconCls:"icon-richtext-paste-plain-text",enableToggle:!1,itemId:"pastePlainText",handler:this.pastePlainText,tabIndex:-1,scope:this}),e.insert(14,{tooltip:__("<b>Add Embed</b>"),iconCls:"icon-richtext-add-embed",enableToggle:!1,itemId:"addEmbed",hidden:!this.enableEmbed,handler:this.addEmbed,tabIndex:-1,scope:this})
},onResize:function(e,t){if(Ext.form.HtmlEditor.superclass.onResize.apply(this,arguments),this.el&&this.iframe){if(Ext.isNumber(e)){var i=e-this.wrap.getFrameWidth("lr");this.el.setWidth(i),this.tb.setWidth(i),this.iframe.style.width=Math.max(i,0)+"px"}if(Ext.isNumber(t)){var s=t-this.wrap.getFrameWidth("tb")-this.tb.el.getHeight()-(this.statusbar?this.statusbar.el.getHeight():0);this.el.setHeight(s),this.iframe.style.height=Math.max(s,0)+"px";var a=this.getEditorBody();a&&(a.style.height=Math.max(s-2*this.iframePad,0)+"px")}}},unwrap:function(e,t){for(;Ext.DomQuery.select(e,t).length>0;){var i=Ext.DomQuery.selectNode(e,t);for(i.normalize();i.childNodes.length>0;){var s=i.childNodes[i.childNodes.length-1],a=s.cloneNode(!0);i.parentNode.insertBefore(a,i),i.removeChild(s)}i.parentNode.removeChild(i)}},replaceTag:function(e,t,i){var s=Ext.DomQuery.select(e,i);Ext.DomHelper.useDom=!1,Ext.each(s,function(e){var i=Ext.get(e);if(t){var s=i.dom.innerHTML;Ext.DomHelper.insertBefore(e,{tag:t,html:s})}i.remove()})},wrapFragment:function(e,t){var i=t.ownerDocument.createElement(e),s=t.cloneNode(!0);i.appendChild(s),t.parentNode.insertBefore(i,t),t.parentNode.removeChild(t)},fixInlineElements:function(e){var t=["#text","B","BIG","I","SMALL","TT","ABBR","ACRONYM","CITE","CODE","DFN","KBD","STRONG","SAMP","VAR","A","BDO","IMG","MAP","OBJECT","Q","SCRIPT","SPAN","SUB","SUP","BUTTON","INPUT","LABEL","SELECT","TEXTAREA"],i=!1;if(Ext.each(e.childNodes,function(e){t.indexOf(e.nodeName)>-1&&(i||(i=e),lastChild=e)},this),i){var s=e.ownerDocument.createElement("p");if(i!=lastChild){var a=e.ownerDocument.createRange();a.setStart(i,0),a.setEnd(lastChild,lastChild.length),s.appendChild(a.extractContents())}else s.appendChild(i.cloneNode(!0));i.parentNode.replaceChild(s,i)}e.normalize()},fixBrs:function(e){Ext.each(Ext.DomQuery.select("br",e),function(e){var t=Ext.get(e);return t.parent("p")&&t.parent("p").dom.childNodes[0]==e?void t.remove():t.dom.nextSibling&&"BR"==t.dom.nextSibling.nodeName?void t.remove():void 0})},cleanupHtml:function(){this.suspendEvents();var e=this.getDoc(),t=e.body,i=["&nbsp;","&#8203;"],s=this.getValue();if(!s)return!0;Ext.each(i,function(e){s=s.replace(e," ")}),this.setValue(s),this.unwrap("span",t),this.unwrap("div",t),this.replaceTag("strong","b",t),this.replaceTag("em","i",t),t.normalize();var a=Ext.DomQuery.jsSelect("[id]",t);return Ext.each(a,function(e){e.removeAttribute("id")},this),this.resumeEvents(),!0},cleanupHtmlOld:function(){this.suspendEvents();for(var e=this.getDoc(),t=e.body;Ext.DomQuery.select("span",t).length>0;){var i=Ext.DomQuery.selectNode("span",t);for(i.normalize();i.childNodes.length>0;){var s=i.childNodes[0],a=s.cloneNode(!0);i.parentNode.insertBefore(a,i),i.removeChild(s)}i.parentNode.removeChild(i)}t.normalize(),1==t.children.length&&"BR"==t.children[0].tagName&&t.removeChild(t.children[0]);var n=["&nbsp;","&#8203;"],r=this.getValue();if(!r)return!0;Ext.each(n,function(e){r=r.replace(e," ")}),this.setValue(r),Ext.each(t.childNodes,function(i){if("#text"==i.nodeName&&i.nodeValue){var s=e.createElement("p"),a=e.createTextNode(i.nodeValue);s.appendChild(a),t.insertBefore(s,i),t.removeChild(i)}});Ext.each(Ext.DomQuery.select("br",t),function(e){var t=Ext.get(e);if(t.parent("p"))return 1==t.parent("p").dom.childNodes.length?void t.remove():t.parent("p").dom.childNodes[0]==e?void t.remove():t.dom.nextSibling&&"BR"==t.dom.nextSibling.nodeName?void t.remove():void 0});Ext.get(Ext.DomQuery.select("p:empty",t)).remove(),Ext.each(Ext.DomQuery.select("p",t),function(e){n.indexOf(e.innerHTML)>-1&&Ext.get(e).remove()});var o=Ext.DomQuery.select("strong",t);return Ext.DomHelper.useDom=!1,Ext.each(o,function(e){var t=Ext.get(e),i=t.dom.innerHTML;Ext.DomHelper.insertBefore(e,{tag:"b",html:i}),t.remove()}),o=Ext.DomQuery.select("em",t),Ext.DomHelper.useDom=!1,Ext.each(o,function(e){var t=Ext.get(e),i=t.dom.innerHTML;Ext.DomHelper.insertBefore(e,{tag:"i",html:i}),t.remove()}),this.resumeEvents(),!0},blur:function(e,t){if(this.initialized&&(this.hideMediaToolbar(),this.hasFocus)){var i=this.getToolbar();i.items.each(function(e){e.toggle&&e.toggle(!1)}),(!t||!Ext.WindowMgr.getActive()&&this.getEl().parent(".garp-formpanel")&&!this.getEl().parent().contains(Ext.get(t).dom.id))&&(this.updateStatusbar(""),this.hasFocus=!1,this.fireEvent("blur",this),this.wrap.removeClass("x-focus"),this.cleanupHtml(),e&&e.stopEvent&&e.stopEvent())}},initComponent:function(){this.addEvents("toolbarupdated"),Ext.ux.form.RichTextEditor.superclass.initComponent.call(this),this.on("initialize",function(){this.execCmd("styleWithCSS",!1),this.execCmd("insertBrOnReturn",!1,!1),this.execCmd("enableObjectResizing",!1),this.updateStatusbar(""),this.setupImageHandling(),this.getDoc().body.style.backgroundColor="transparent"},this),this.on("editmodechange",function(e,t){t?this.addClass("garp-richtexteditor-source-edit"):this.removeClass("garp-richtexteditor-source-edit")},this),Ext.getBody().on("click",this.blur,this),this.on("push",function(){this.updateStatusbar("")},this)},destroy:function(){Ext.getBody().un("click",this.blur,this)},pushValue:function(){if(this.initialized){var e=this.el.dom.value;if(!this.activated&&e.length<1&&(e=this.defaultValue),this.sourceEditMode)return;this.getEditorBody().innerHTML=e,this.fireEvent("push",this,e),Ext.EventManager.on(this.getDoc(),"keydown",function(e){return e.getKey()==e.TAB?(this.blur(e,!1),!1):void 0},this);var t=new Ext.KeyMap(this.getDoc().body,{ctrl:!0,key:Ext.EventObject.ENTER,fn:function(e){var t=this.findParentByType("garpformpanel");t||(t=this.findParentByType("formpanel")),t&&(this.blur(e,!1),this.syncValue(),this.cleanupHtml(),t.fireEvent("save-all"))},scope:this});t.enable()}},fixKeys:function(){return function(e){if(e.ctrlKey){var t,i=e.getCharCode();if(i>0){switch(i=String.fromCharCode(i),i.toLowerCase()){case"b":t="bold";break;case"i":t="italic";break;case"u":t="underline"}t&&(this.win.focus(),this.execCmd(t),this.deferFocus(),e.preventDefault())}}}}()}),Garp.CodeEditor=function(){this.updateBtns=function(){var e=this.getToolbar().items.map;e.pre.toggle("pre"==this.getDoc().queryCommandValue("formatblock"));var t=this.getCurrentTagName();e.code.toggle("code"===t),e["var"].toggle("var"===t)},this.afterrender=function(){this.addVar=function(){if("var"==this.getCurrentTagName())this.relayCmd("removeformat");else{var e=this.getSelection().toString();e||(e="{var}"),this.insertAtCursor("<var>"+e+"</var>")}},this.addCode=function(){if("code"==this.getCurrentTagName())this.relayCmd("removeformat");else{var e=this.getSelection().toString();e||(e="{code}"),this.insertAtCursor("<code>"+e+"</code>")}},this.addPre=function(){"pre"==this.getDoc().queryCommandValue("formatblock")?this.relayCmd("formatblock","p"):this.relayCmd("formatblock","pre")};var e=this.getToolbar();e.add("-"),e.insert(5,{iconCls:"icon-richtext-add-heading-menu",tabIndex:-1,menu:new Ext.menu.Menu({defaults:{handler:function(e){this.addHeading(e.text)},scope:this},items:[{text:"H1"},{text:"H2"},{text:"H3"},{text:"H4"},{text:"H5"},{text:"H6"}]})}),e.add({tooltip:__("Add &lt;var&gt;"),tabIndex:-1,handler:this.addVar,scope:this,itemId:"var",enableToggle:!0,iconCls:"icon-richtext-add-var"}),e.add({tooltip:__("Add &lt;code&gt;"),tabIndex:-1,handler:this.addCode,scope:this,itemId:"code",enableToggle:!0,iconCls:"icon-richtext-add-code"}),e.add({tooltip:__("Add &lt;pre&gt;"),tabIndex:-1,handler:this.addPre,scope:this,itemId:"pre",iconCls:"icon-richtext-add-pre",enableToggle:!0});var t=e.get("addheading");t.hide()},this.init=function(e){e.on("afterrender",this.afterrender),e.on("toolbarupdated",this.updateBtns)}}),Ext.reg("richtexteditor",Ext.ux.form.RichTextEditor),Ext.form.CKEditor=function(e){this.config=e,e.CKEditor={allowedContent:!0,customConfig:"",format_tags:"p;h2;h3",toolbar:[["Bold","Italic","-","RemoveFormat"],["Link","Unlink"],["NumberedList","BulletedList","Format"],["Cut","Copy","Paste","PasteText","PasteFromWord","-","Undo","Redo","-","Source","-","CharCount"]],removePlugins:"image"},window.WYSIWYG_CSS_URL&&(e.CKEditor.contentsCss=window.WYSIWYG_CSS_URL),e.CKEditor.height="400px",e.CKEditor.maxLength=e.maxLength||0;var t="charcount";if(e.rich){t+=",garpimages";var i=["Garpimage"];"undefined"!=typeof VIDEO_WIDTH&&(t+=",garpvideos",i.push("Garpvideo")),e.CKEditor.toolbar.push(i)}e.CKEditor.extraPlugins=t,Ext.form.CKEditor.superclass.constructor.call(this,e)},Ext.extend(Ext.form.CKEditor,Ext.form.TextArea,{onRender:function(e,t){Ext.form.CKEditor.superclass.onRender.call(this,e,t);var i=function(){this.editor=CKEDITOR.replace(this.id,this.config.CKEditor);var e=this;this.editor.on("dataReady",function(){this.resetDirty(),e.waitingForSetData=!1}),this.setValue(this.orgValue)};return"undefined"==typeof CKEDITOR?void Ext.Loader.load([ASSET_URL+"js/garp/ckeditor/ckeditor.js"],i,this):void i.call(this)},isValid:function(){return this.maxLength&&this.getCharCount()>=this.maxLength?!1:!0},getCharCount:function(){try{return this.editor.document.getBody().getText().length}catch(e){return this.getValue().replace(/(<([^>]+)>)/gi,"").length}},setValue:function(e){function t(e){i.setValue(i.orgValue),i.waitingForSetData=!1,e.removeListener()}if(this.orgValue=e,this.editor){e=e||"";var i=this;this.waitingForSetData&&this.editor.on("dataReady",t),this.waitingForSetData=!0,this.editor.setData(e)}},getValue:function(){var e=this.orgValue;return this.editor&&this.editor.checkDirty()&&(e=this.editor.getData()),e||""},getRawValue:function(){return this.getValue()}}),Ext.form.RichCKEditor=function(e){e.rich=!0,Ext.form.RichCKEditor.superclass.constructor.call(this,e)},Ext.extend(Ext.form.RichCKEditor,Ext.form.CKEditor),Ext.reg("wysiwygeditor",Ext.form.CKEditor),Ext.reg("richwysiwygeditor",Ext.form.RichCKEditor),Garp.i18nSource=Ext.extend(Ext.form.Field,{ref:"../",style:"display:none; height: 0; margin: 0; padding: 0;",hideLabel:!0,originalValue:null,initComponent:function(e){Garp.i18nSource.superclass.initComponent.call(this,e),Garp.i18nSource.superclass.hide.call(this)},getRefField:function(e){return this.refOwner.find("name","_"+this.name+"_"+e)[0]},setValue:function(e){Ext.each(LANGUAGES,function(t){this.getRefField(t)&&null!==e&&this.getRefField(t).setValue(e[t])},this),Garp.i18nSource.superclass.setValue.call(this,e)},setRawValue:function(e){return this.setValue(e)},getValue:function(){var e={};return Ext.each(LANGUAGES,function(t){field=this.getRefField(t),field&&field.isDirty()&&(e[t]=""===field.getValue()?null:field.getValue())},this),e},getRawValue:function(e){return this.getValue(e)},isDirty:function(){var e=!1;return Ext.each(LANGUAGES,function(t){return this.getRefField(t)&&this.getRefField(t).isDirty()?(e=!0,!1):void 0},this),e},_setAll:function(e,t,i){return Ext.each(LANGUAGES,function(i){var s=this.getRefField(i);s&&s[e]&&s[e](t)},this),!i==!0?Garp.i18nSource.superclass[e].call(this,t):void 0},setVisible:function(e){return this._setAll("setVisible",e,!0)},setDisabled:function(e){return this._setAll("setDisabled",e)},show:function(e){return this._setAll("show",e,!0)},hide:function(e){return this._setAll("hide",e,!0)},enable:function(e){return this._setAll("enable",e)},disable:function(e){return this._setAll("disable",e)}}),Ext.reg("i18nsource",Garp.i18nSource),Garp.i18nFieldSet=Ext.extend(Ext.form.FieldSet,{cls:"i18n-fieldset",collapsed:!0,initComponent:function(e){Garp.i18nFieldSet.superclass.initComponent.call(this,e)}}),Ext.reg("i18nfieldset",Garp.i18nFieldSet),Garp.WysiwygField=Ext.extend(Ext.form.TextField,{region:"center",hideLabel:!0,bodyStyle:"overflow-y: auto",reset:function(){this.chapterct.removeAll(!0),delete this.originalValue,this.chapterct.items.length||this.chapterct.addWysiwygCt()},hideMode:"display",extraTypes:[],setValue:function(e){this.reset();var t=this.maxCols;e&&e.length&&(this.chapterct.removeAll(!0),Ext.each(e,function(e){e||(e={type:"",classes:[]});var i=this.chapterct.addWysiwygCt({type:e.type,_classes:e.classes},this.chapterct.items?this.chapterct.items.last():null);e.content&&Ext.each(e.content,function(e){if(!e.model)return console&&console.dir&&(console.dir(e),console.warn("Model type not found. DB corrupted or silly developer at work...")),void(e.remove&&e.remove());var s=new Garp.dataTypes[e.model].Wysiwyg({ct:i,_data:e.data,_classes:e.classes,model:e.model,type:e.type,col:"grid-"+e.columns+"-"+t,maxCols:t});i.add(s),i.afterAdd()})},this))},getValue:function(){var e=[];return this.chapterct.items.each(function(t){var i=[];t.body.dom&&(Ext.each(t.body.dom.childNodes,function(e){var t=Ext.getCmp(e.getAttribute("id"));if(t.getValue()){var s=t.getValue();t.type&&(s.type=t.getType()),t.getClasses&&t.getClasses()&&(s.classes=t.getClasses()),i.push(s)}}),i.length&&e.push({content:i,type:t.getExtraType()}))},this),e},isValid:function(){return!0},isDirty:function(){if(this.getValue()&&this.originalValue){var e=Ext.util.JSON.encode;return e(this.getValue())!=e(this.originalValue)}},afterRender:function(){this.wrap=this.el.wrap(),this.extraTypes=Garp.dataTypes.Chapter.getField("type").store,this.chapterct=new Garp.Chapterct({renderTo:this.wrap,ownerField:this,maxCols:this.maxCols,extraTypes:this.extraTypes}),this.on("resize",function(){this.chapterct.setWidth(this.getWidth())},this),this.el.hide(),Garp.WysiwygField.superclass.afterRender.call(this)},initComponent:function(){Garp.WysiwygField.superclass.initComponent.call(this,arguments)}}),Ext.reg("wysiwygfield",Garp.WysiwygField),Garp.Wysiwygct=Ext.extend(Ext.Panel,{cls:"wysiwyg-ct",bodyCssClass:"wysiwyg-body",bodyBorder:!1,autoScroll:!0,autoHeight:!0,padding:"30",maxCols:null,extraTypes:null,moveChapter:function(e){var t=this.ct.getWysiwygIdx(this);if(!(1===e&&t===this.ct.items.length-1||-1===e&&0===t)){var i=this.ct.ownerField.getValue(),s=i.slice(0),a=i[t],n=i[t+e];i[t+e]=a,i[t]=n;var r=Garp.formPanel.formcontent.get(0).body,o=r.getScroll().top;this.ct.ownerField.setValue(i),r&&o&&r.scrollTo("top",o,!1),this.ct.ownerField.originalValue=s}},getWysiwygDataTypes:function(){var e=[];for(var t in Garp.dataTypes)Garp.dataTypes[t].Wysiwyg&&e.push(Garp.dataTypes[t]);return e},setExtraType:function(){if(this.el){var e=this.getTopToolbar().extraTypesMenu.getValue(),t=this.el.select(".wysiwyg-body");Ext.each(this.extraTypes,function(e){t.removeClass(e[0])},this),t.addClass(e),this.ownerCt.extraType=e}},getExtraType:function(){return this.getTopToolbar().extraTypesMenu.getValue()},getRange:function(){var e,t;return t=window.getSelection(),t.getRangeAt?t.rangeCount>0&&(e=t.getRangeAt(0)):(e=document.createRange(),e.setStart(t.anchorNode,t.anchorOffset),e.setEnd(t.focusNode,t.focusOffset),e.collapsed!==t.isCollapsed&&(e.setStart(t.focusNode,t.focusOffset),e.setEnd(t.anchorNode,t.anchorOffset))),e},setupTbar:function(){function e(){var e=[{text:__("Add chapter"),iconCls:"icon-wysiwyg-add-chapter",handler:function(){this.ownerCt.addWysiwygCt({type:""},this)},scope:this},"-"];return Ext.each(this.getWysiwygDataTypes(),function(t){e.push({text:__(t.text),iconCls:t.iconCls,handler:function(){new t.Wysiwyg({ct:this,maxCols:this.maxCols,_data:{}})},scope:this})},this),e}this.tbar=new Ext.Toolbar({cls:"garp-formpanel-toolbar",padding:"0 10 0 10",width:"100%",defaults:{xtype:"button",scope:this},items:[{iconCls:"icon-new",text:__("Add"),ref:"addBtn",menu:e.call(this)}," ",{xtype:"combo",editable:!1,forceSelection:!0,triggerAction:"all",ref:"extraTypesMenu",store:this.extraTypes,value:"",listeners:{select:function(){return this.ownerCt.ownerCt.setExtraType(),this.blur(),!0}}}," "," ",{iconCls:"icon-wysiwyg-bold",ref:"boldBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(e,t){t.preventDefault(),document.execCommand("Bold",!1,null)}},{iconCls:"icon-wysiwyg-italic",ref:"italicBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(e,t){t.preventDefault(),document.execCommand("Italic",!1,null)}},{iconCls:"icon-wysiwyg-orderedlist",ref:"insertorderedlistBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(e,t){t.preventDefault(),document.execCommand("Insertorderedlist",!1,null)}},{iconCls:"icon-wysiwyg-unorderedlist",ref:"insertunorderedlistBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(e,t){t.preventDefault(),document.execCommand("Insertunorderedlist",!1,null)}},{iconCls:"icon-wysiwyg-createlink",ref:"createlinkBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(e,t){function i(){var e=!1;return"A"==s.getCurrentTagName()?(s.getRange().selectNodeContents(s.getRange().endContainer),!0):(Ext.each(s.getRange().endContainer.childNodes,function(t){return t.nodeName&&"A"==t.nodeName?(e=!0,!1):void 0}),e)}t.preventDefault();var s=this;if(i())document.execCommand("Unlink",!1,null);else{var a=this.getSelection(),n=a.toString();if(n){var r=s.getRange(),o=new Ext.Window({title:__("Add link"),iconCls:"icon-richtext-add-link",width:445,modal:!0,height:240,border:!0,layout:"fit",defaultButton:"_url",items:[{xtype:"fieldset",bodyCssClass:"garp-dialog-fieldset",labelWidth:160,items:[{xtype:"textfield",fieldLabel:__("Url"),name:"url",id:"_url",vtype:"mailtoOrUrl",allowBlank:!1,plugins:[Garp.mailtoOrUrlPlugin],value:""},{xtype:"textfield",fieldLabel:__("Title"),name:"title",value:""},{xtype:"checkbox",allowBlank:!0,fieldLabel:__("Open in new window"),name:"target",checked:""}]}],buttonAlign:"right",buttons:[{text:__("Cancel"),handler:function(){o.close()}},{text:__("Ok"),ref:"../ok",handler:function(){var e=o.find("name","url")[0].getValue(),t=o.find("name","title")[0].getValue(),i="1"==o.find("name","target")[0].getValue(),s=document.createElement("a");s.setAttribute("href",e),i&&s.setAttribute("target","_blank"),s.setAttribute("title",t),s.appendChild(document.createTextNode(n)),r.deleteContents(),r.insertNode(s),r.selectNodeContents(s),a.removeAllRanges(),a.addRange(r),o.close()},scope:this}]});o.show(),o.items.get(0).items.get(0).clearInvalid();{new Ext.KeyMap([o.find("name","url")[0].getEl(),o.find("name","title")[0].getEl()],{key:[10,13],fn:function(){o.ok.handler.call(this)},scope:this})}}}}},"->",{iconCls:"icon-wysiwyg-move-up",tooltip:__("Move chapter up"),handler:this.moveChapter.createDelegate(this,[-1])},{iconCls:"icon-wysiwyg-move-down",tooltip:__("Move chapter down"),handler:this.moveChapter.createDelegate(this,[1])},{text:__("Delete"),iconCls:"icon-wysiwyg-remove-chapter",handler:function(){this.ownerCt.items.length>1?this.ownerCt.remove(this):(this.ownerCt.addWysiwygCt(),this.ownerCt.remove(this))}}]})},getSelection:function(){var e="undefined"!=typeof document.selection?document.selection.createRange().text:"function"==typeof document.getSelection?document.getSelection():!1;return e},getCurrentTagName:function(){var e=this.getSelection().focusNode;if(e)return e.tagName?e.tagName:e.parentNode.tagName?e.parentNode.tagName:""},setupTbarWatcher:function(){var e=["bold","italic","insertorderedlist","insertunorderedlist"],t=this;this.tbWatcherInterval=setInterval(function(){var i=t.getTopToolbar();if(i&&0!==Ext.select(".wysiwyg-box").elements.length){i.createlinkBtn.toggle("A"==t.getCurrentTagName(),!1);for(var s=0,a=e.length;a>s;s++){var n=e[s];try{i[n+"Btn"].toggle(document.queryCommandState(n),!1)}catch(r){}}}},100)},setupKeyboardHandling:function(){Ext.EventManager.on(document,"keypress",function(e){if(e.ctrlKey){var t,i=e.getCharCode();if(i>0){switch(i=String.fromCharCode(i)){case"b":t="Bold";break;case"i":t="Italic"}t&&this.body.dom&&this.body.dom.execCommand&&(this.body.dom.execCommand(t,!1,null),e.preventDefault())}}},this)},afterAdd:function(){this.doLayout(),this.setupDD()},removeWysiwygBox:function(e){this.remove(e.id),this.doLayout()},removeColClasses:function(e){if(e)for(var t=1;t<=this.maxCols;t++)Ext.get(e).removeClass("grid-"+t+"-"+this.maxCols)},getCurrentColCount:function(e){for(var t=this.maxCols;t>0;t--)if(e.hasClass("grid-"+t+"-"+this.maxCols))return t;return this.maxCols},setupDD:function(){var e=this,t=Ext.query(".wysiwyg-box");this.getEl().addClass("disabled-targets"),Ext.dd.ScrollManager.register(this.body),Ext.apply(Ext.dd.ScrollManager,{vthresh:50,hthresh:-1,animate:!1,increment:200}),Ext.each(t,function(t){t.resizer&&t.resizer.destroy();var i=null;t.resizer=new Ext.Resizable(t.id,{handles:"e",dynamic:!0,transparent:!0,listeners:{beforeresize:function(){i=this.getEl().getWidth()},resize:function(){var t=this.getEl(),s=t.getWidth(),a=e.getCurrentColCount(t),n=Math.ceil(e.maxCols/(e.getWidth()/s));1>n&&(n=1),s>i?(a>=e.maxCols&&(n=e.maxCols),e.removeColClasses(t),t.addClass("grid-"+n+"-"+e.maxCols)):(1>=a&&(n=1),e.removeColClasses(t),t.addClass("grid-"+n+"-"+e.maxCols)),t.setWidth(""),t.setHeight(""),Ext.getCmp(t.id).fireEvent("user-resize",i,s,"grid-"+n+"-"+e.maxCols)}}});var s=new Ext.dd.DD(t,"wysiwyg-dragables-group",{isTarget:!1,ignoreSelf:!0,scroll:!0});Ext.apply(s,{wysiwygct:e,possibleSuspect:null,b4Drag:function(){!this.el},b4StartDrag:function(){this.el||(this.el=Ext.get(this.getEl())),this.el.addClass("in-drag"),this.originalXY=this.el.getXY()},startDrag:function(){this.wysiwygct.getEl().removeClass("disabled-targets")},onInvalidDrop:function(){this.invalidDrop=!0},removeDropHiglight:function(){Ext.select(".wysiwyg-box .active").each(function(e){e.removeClass("active")}),delete this.possibleSuspect},onDragOver:function(e,t){var i=Ext.get(t);i.parent("#"+this.el.id)||(this.removeDropHiglight(),i.addClass("active"),this.possibleSuspect=i)},onDragOut:function(){this.removeDropHiglight()},endDrag:function(){if(this.el.removeClass("in-drag"),this.wysiwygct.getEl().addClass("disabled-targets"),this.possibleSuspect){{var t=Ext.get(this.possibleSuspect),i=t.hasClass("top"),s=(t.hasClass("bottom"),t.hasClass("left"));t.hasClass("right")}t=t.findParent(".wysiwyg-box"),i||s?this.el.insertBefore(t):this.el.insertAfter(t),this.el.frame(null,1)}else this.el.moveTo(this.originalXY[0],this.originalXY[1]),delete this.invalidDrop;this.removeDropHiglight(),e.setupDD(),this.el.clearPositioning(),this.el.setStyle("position","relative")}});var a=Ext.get(t),n=a.child(".dd-handle").id;s.setHandleElId(n);new Ext.dd.DDTarget(a.child(".top").id,"wysiwyg-dragables-group",{}),new Ext.dd.DDTarget(a.child(".right").id,"wysiwyg-dragables-group",{}),new Ext.dd.DDTarget(a.child(".bottom").id,"wysiwyg-dragables-group",{}),new Ext.dd.DDTarget(a.child(".left").id,"wysiwyg-dragables-group",{})}),this.getEl().addClass("disabled-targets"),this.extraType&&this.getTopToolbar().extraTypesMenu.setValue(this.extraType).fireEvent("select")},verticalCenter:function(){this.el.select(".vertical-center").each(function(e){e.setHeight(e.parent().getHeight())})},initComponent:function(){this.setupTbar(),this.setupTbarWatcher(),this.setupKeyboardHandling(),Garp.Wysiwygct.superclass.initComponent.call(this,arguments),this.on("afterlayout",this.setupDD,this,{single:!0}),this.on("afterrender",function(){this.body.wrap({tag:"div",cls:"wysiwyg-wrap"}),this.verticalCenter()},this),this.on("add",function(e,t){e.verticalCenter(),t.on("showsettings",function(t,i){if(Garp.dataTypes.ContentNode.getField("type").store){var s,a=[];s=t.getMenuOptions?t.getMenuOptions():!1,s&&(a=s,a.push("-")),s=Garp.dataTypes.ContentNode.getField("type").store,s&&Ext.each(s,function(e){var i={text:e[1],val:e[0]};t.el.hasClass(e[0])&&(i.checked=!0),a.push(i)});var n=new Ext.menu.Menu({defaults:{group:"type",handler:function(t){Ext.each(s,function(e){this.el.removeClass(e[0])},this),this.el.addClass(t.val),this.type=t.val,e.verticalCenter(),this.onSettingsMenu&&this.onSettingsMenu(t)},scope:this},items:a});n.showAt(i.getXY())}})})},onDestroy:function(){this.tbWatcherInterval&&clearInterval(this.tbWatcherInterval)}}),Ext.reg("wysiwygct",Garp.Wysiwygct),Garp.Chapterct=Ext.extend(Ext.Panel,{autoScroll:!0,autoHeight:!0,border:!1,bodyBorder:!1,cls:"chapter-ct",maxCols:null,extraTypes:null,getWysiwygIdx:function(e){var t=0;return e&&this.items.each(function(i,s){return i==e?(t=s,!1):void 0}),t},addWysiwygCt:function(e,t){var i;return this.insert(this.getWysiwygIdx(t)+1,i=new Garp.Wysiwygct({ct:this,extraTypes:this.extraTypes,extraType:e&&e.type?e.type:"",maxCols:this.maxCols})),this.doLayout(),i},initComponent:function(){Garp.Chapterct.superclass.initComponent.call(this,arguments)},afterRender:function(){this.on("resize",function(){this.items.each(function(e){e.setWidth(this.getWidth())},this)},this),this.addWysiwygCt(),Garp.Chapterct.superclass.afterRender.call(this,arguments)}}),Ext.reg("chapterct",Garp.Chapterct),Garp.WysiwygAbstract=Ext.extend(Ext.BoxComponent,{ct:null,settingsMenu:!0,model:"Text",data:{},_data:{},_classes:null,getValue:function(){return this.getData()?{columns:this.col?this.col.split("-")[1]:null,data:this.getData(),model:this.model,type:"",classes:this.getClasses()}:null},html:'<div class="dd-handle icon-move"></div><div class="dd-handle icon-delete"></div><div class="dd-handle icon-settings"></div><div class="target top"></div><div class="target right"></div><div class="target bottom"></div><div class="target left"></div>',contentEditableEl:null,col:null,getData:function(){return{description:this.contentEditable?this.contentEditableEl.dom.innerHTML:""}},getType:function(){return this.type||""},showSettingsMenu:function(e,t){this.fireEvent("showsettings",e,t)},showAnimClassesDialog:function(){Ext.Msg.prompt(__("Garp"),__("Enter animation classes"),function(e,t){"ok"===e&&this.setClasses(t)},this,!0,this.getClasses()||"ani-")},getClasses:function(){return this._classes},setClasses:function(e){this._classes=e},afterRender:function(){Garp.WysiwygAbstract.superclass.afterRender.call(this,arguments),this.el.select(".dd-handle.icon-delete").on("click",function(){this.ownerCt&&this.ownerCt.removeWysiwygBox(this)},this),this.settingsMenu?this.el.select(".dd-handle.icon-settings").on("click",function(e){this.showSettingsMenu(this,e)},this):this.el.select(".dd-handle.icon-settings").hide()},beforeInit:!1,afterInit:function(){this.col||(this.col="grid-"+this.maxCols+"-"+this.maxCols,this.addClass(this.col)),this.ct.add(this),this.ct.afterAdd()},initComponent:function(){Garp.WysiwygAbstract.superclass.initComponent.call(this,arguments),this.beforeInit?this.beforeInit(this.afterInit):this.afterInit(),this.on("user-resize",function(e,t,i){this.col=i},this)}}),Garp.FilterMenu=function(){this.init=function(e){function t(t){var i=e.ownerCt,s=i.getStore().baseParams;switch(s.query||(s.query={}),delete s.query.online_status,delete s.query.author_id,"function"==typeof Garp.dataTypes[Garp.currentModel].clearFilters?Garp.dataTypes[Garp.currentModel].clearFilters():"all"==t.ref&&(s.query={}),t.ref){case"published":Ext.apply(s.query,{online_status:"1"});break;case"drafts":Ext.apply(s.query,{online_status:"0"});break;case"my":Ext.apply(s.query,{author_id:Garp.localUser.id})}return i.getStore().reload(),!0}this.tb=e,this.defaultFilter={text:__("All"),ref:"all"},this.resetUI=function(){this.tb.filterBtn.setIconClass("icon-filter-off"),this.tb.filterBtn.menu.all.setChecked(!0),this.tb.filterStatus.hide(),this.tb.filterStatus.update("")},this.buildMenu=function(){var e=[];Garp.dataTypes[Garp.currentModel].filterMenu&&Ext.each(Garp.dataTypes[Garp.currentModel].filterMenu,function(t){e.push(t)});var t=Garp.dataTypes[Garp.currentModel];return e.push(this.defaultFilter),t.getColumn("published")&&e.push({text:__("Drafts"),ref:"drafts"},{text:__("Published"),ref:"published"}),t.getColumn("author_id")&&e.push({text:__("My items"),ref:"my"}),Ext.each(e,function(e){return"undefined"!=typeof e.isDefault&&e.isDefault?(this.defaultFilter=e,!1):void 0},this),e},this.filterMenu=this.buildMenu(),this.filterStatus=e.add({ref:"filterStatus",text:"all"!==this.defaultFilter.ref?this.defaultFilter.text:"",xtype:"tbtext",hidden:"all"===this.defaultFilter.ref}),this.filterBtn=e.add({ref:"filterBtn",tooltip:"Filter",iconCls:"all"==this.defaultFilter.ref?"icon-filter-off":"icon-filter-on",hidden:this.filterMenu.length<=1,menu:{defaultType:"menucheckitem",defaults:{group:"filter",handler:t,scope:this},items:this.filterMenu}}),this.filterBtn.menu.find("text",this.defaultFilter.text)[0].setChecked(!0),this.filterBtn.menu.on("itemclick",function(e){return"all"===e.ref?(this.filterStatus.update(""),this.filterStatus.hide(),void this.filterBtn.setIconClass("icon-filter-off")):(e.text&&this.filterStatus.update(e.text),this.filterStatus.show(),void this.filterBtn.setIconClass("icon-filter-on"))},this),this.tb.on("change",function(e){0===e.store.getCount()?this.filterStatus.hide():this.filterStatus.show()})}},Ext.ns("Garp"),Garp.TweetWindow=Ext.extend(Ext.util.Observable,{urlPart:"",width:550,height:460,x:320,y:120,bodyBorder:!1,url:"https://twitter.com/intent/tweet?",constructor:function(e){Ext.apply(this,e),this.winId="tweet-"+Ext.id();var t=new Ext.Template("chrome=no,menubar=no,toolbar=no,scrollbars=no,width={width},height={height},left={left},top={top}");t=t.apply({width:this.width,height:this.height,left:this.x,top:this.y}),this.win=window.open(this.url+this.urlPart,"tweet-"+this.winId,t),this.win.focus(),Garp.TweetWindow.superclass.constructor.call(this,e)}}),Garp.TweetField=Ext.extend(Ext.Panel,{border:!1,layout:"hbox",fieldLabel:__("Twitter description"),showTW:!0,showFB:!0,showIN:!0,loadScript:function(e,t){var i=document.createElement("script");t?i.src=e:i.innerHtml=e,Ext.select("head").first().dom.appendChild(i)},initComponent:function(e){this.loadScript("http://platform.linkedin.com/in.js",!0),this.loadScript("http://connect.facebook.net/en_US/all.js",!0),this.loadScript("if(typeof FB != 'undefined' && FB.init){FB.init({ appId: FB_APP_ID,cookie:true, status:true, xfbml:true});}"),this.twitterExcerpt=new Ext.form.TextArea({name:"twitter_description",messageTarget:"side",maxLength:119,countBox:"twitterCount",flex:1,margins:"0 5 0 0",ref:"../../../../twitterExcerpt",allowBlank:!0}),this.items=[this.twitterExcerpt,{xtype:"button",name:"tweetBtn",margins:"0 5 0 0",hidden:!this.showTW,ref:"../../../../tweetBtn",width:32,handler:function(e,t){var i=this.refOwner;if(i)if(i.bitly_url.getValue()){var s=i.twitterExcerpt.getValue();s+=" ",s+=i.bitly_url.getValue();{new Garp.TweetWindow({urlPart:Ext.urlEncode({text:s}),x:t.getPageX(),y:t.getPageY()})}}else Ext.Msg.alert("Garp",__("In order to tweet, you need to save your data first."))},iconCls:"icon-twitter"},{xtype:"button",margins:"0 5 0 0",hidden:!this.showFB,name:"fbBtn",ref:"../../../../fbBtn",width:32,handler:function(){var e=this.refOwner;if(e)if(e.bitly_url.getValue()){var t=e.twitterExcerpt.getValue();t+=" ",t+=e.bitly_url.getValue();var i=new Ext.LoadMask(Ext.getBody(),{text:__("Please wait")});i.show(),FB.ui({method:"feed",description:e.twitterExcerpt.getValue(),link:e.bitly_url.getValue(),show_error:!0},function(){i.hide()})}else Ext.Msg.alert("Garp",__("In order to FB, you need to save your data first."))},iconCls:"icon-fb"},{xtype:"button",hidden:!this.showIN,name:"inBtn",ref:"../../../../inBtn",width:32,handler:function(){function e(){if(t.bitly_url.getValue()){var e=t.twitterExcerpt.getValue(),i=t.bitly_url.getValue();e.replace('"','"'),e+=" ",e+='<a href="'+i+'">'+i+"</a>"}Ext.MessageBox.confirm(__("Garp"),__("Do you want to update your linkedIn status? <br>")+e,function(t){if("yes"==t){var i=new Ext.LoadMask(Ext.getBody(),{text:__("Please wait")});i.show(),updateURL="/people/~/person-activities",IN.API.Raw(updateURL).method("POST").body('{"contentType":"linkedin-html","body":"'+e+'"}').result(function(){i.hide()}).error(function(){i.hide(),Ext.MessageBox.alert(__("Garp"),__("Something went wrong while updating your status"))})}})}var t=this.refOwner;t&&(IN.User.isAuthorized()?e():IN.User.authorize(e,this))},iconCls:"icon-linkedin"},{xtype:"box",ref:"../../../../twitterCount",width:60,cls:"garp-countbox"}],Garp.TweetField.superclass.initComponent.call(this,e)}}),Ext.reg("tweetfield",Garp.TweetField),Ext.ns("Garp"),Garp.ImageEditor=Ext.extend(Ext.Panel,{layout:"fit",border:!1,bodyStyle:"backgroundColor: #888",updateOutline:function(){var e=Ext.get(this.crop),t=Ext.get(this.img),i=t.getX()-e.getX(),s=t.getY()-e.getY(),a=i+"px "+s+"px";
return e.setStyle({"background-position":a}),this.dd.constrainTo(this.img),!0},setupEditor:function(){var e=this,t=new Image;Ext.get(t).on({load:function(){this.img=Ext.DomHelper.append(e.body,{tag:"img",src:t.src,cls:"imageeditor-subject",width:t.width,height:t.height}),Ext.get(this.img).center(this.body),this.crop=Ext.DomHelper.insertAfter(this.img,{tag:"div",cls:"imageeditor-cropoutline",children:[{tag:"div",cls:"imageeditor-cropoutline-mq",children:[{tag:"div",cls:"left"},{tag:"div",cls:"right"},{tag:"div",cls:"top"},{tag:"div",cls:"bottom"}]}],style:{width:t.width+"px",height:t.height+"px",background:"url("+t.src+")","background-repeat":"no-repeat"}}),this.resizer=new Ext.Resizable(this.crop,{handles:"all",transparent:!0,constrainTo:this.img,dynamic:!1,width:200,height:112.5,preserveRatio:!0,listeners:{resize:this.updateOutline.createDelegate(this)}}),Ext.get(this.crop).center(this.body),this.dd=Ext.get(this.crop).initDD(null,null,{onDrag:this.updateOutline.createDelegate(this)}),this.dd.constrainTo(this.img);var i=Ext.get(this.crop),s=Ext.get(this.img);i.setTop(s.getTop(!0)+10),i.setLeft(s.getLeft(!0)+30),this.updateOutline()},error:function(){},scope:this},this),t.src=this.image},initComponent:function(){this.addEvents("done"),this.buttonAlign="left",this.buttons=[{xtype:"box",html:__("Drag the selection, or drag the corners to resize the selection.")},"->",{text:__("Ok"),scope:this,handler:function(){this.fireEvent("done",[this.image])}}],Garp.ImageEditor.superclass.initComponent.call(this),this.on("afterrender",this.setupEditor.createDelegate(this))}}),Ext.ns("Garp"),Garp.ImagePickerWindow=Ext.extend(Ext.Window,{imgGridQuery:null,captionValue:null,alignValue:"",cropTemplateName:null,hideWizardText:!1,model:"Image",title:__("Image"),iconCls:"icon-image",layout:"card",activeItem:0,width:640,height:500,border:!1,modal:!0,buttonAlign:"left",resizable:!1,defaults:{border:!1},navHandler:function(e){var t=this.getLayout().activeItem.id;switch(t=parseInt(t.substr(5,t.length),10),t+=e,0>=t&&(t=0),t){case 1:this.tplGrid.getStore().on({load:{single:!0,scope:this,fn:function(){if(this.cropTemplateName){var e=this.tplGrid.getStore().getAt(this.tplGrid.getStore().find("name",this.cropTemplateName));this.tplGrid.getSelectionModel().selectRecords([e])}else this.tplGrid.getSelectionModel().selectFirstRow();if(!this.captionValue){var t=this.imgGrid.getSelectionModel().getSelected().get("caption");t&&CURRENT_LANGUAGE&&t.hasOwnProperty(CURRENT_LANGUAGE)&&(t=t[CURRENT_LANGUAGE]),this.caption.getForm().findField("caption").setValue(t)}}}}),this.tplGrid.getStore().load(),this.prevBtn.enable(),this.nextBtn.setText(__("Ok"));break;case 2:var i=this.imgGrid.getSelectionModel().getSelected(),s=this.tplGrid.getSelectionModel().getSelected();this.fireEvent("select",{image:i,template:s,src:IMAGES_CDN+"scaled/"+s.get("name")+"/"+i.get("id"),align:this.alignment.getForm().getValues().align,caption:this.caption.getForm().getValues().caption}),this.close();break;default:this.prevBtn.disable(),this.nextBtn.setDisabled(this.imgGrid.getSelectionModel().getCount()<1),this.nextBtn.setText(__("Next"))}this.getLayout().setActiveItem("page-"+t)},getStoreCfg:function(){return{autoLoad:!1,autoSave:!1,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",fields:Garp.dataTypes[this.model].getStoreFieldsFromColumnModel(),totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize,query:this.query||null},api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}}},getGridCfg:function(e){return{border:!0,region:"center",hideHeaders:e,enableDragDrop:!1,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:function(){for(var e=[],t=Garp.dataTypes[this.model].columnModel,i=0,s=t.length;s>i;i++){var a=Ext.apply({},t[i]);e.push(a)}return e}.call(this)}),pageSize:Garp.pageSize,viewConfig:{scrollOffset:-1,forceFit:!0,autoFill:!0}}},updatePreview:function(){var e=this.tplGrid.getSelectionModel().getSelected().get("name"),t=170,i=170,s=this.imgGrid.getSelectionModel().getSelected().get("id");this.previewpanel.update({IMAGES_CDN:IMAGES_CDN,BASE:BASE,tpl:e,id:s,width:t,height:i,"float":this.alignment.getForm().getValues().align})},clearSelection:function(){this.fireEvent("select",{selected:null}),this.close()},initComponent:function(){this.addEvents("select"),this.imgStore=new Ext.data.DirectStore(Ext.apply({},{writer:new Ext.data.JsonWriter({paramsAsHash:!1,writeAllFields:!0,encode:!1}),api:{create:Ext.emptyFn,read:Garp[this.model].fetch,update:Ext.emptyFn,destroy:Ext.emptyFn}},this.getStoreCfg())),this.imgGrid=new Ext.grid.GridPanel(Ext.apply({},{region:"center",title:__("Available"),itemId:"imgPanel",margins:"15 15 15 15",store:this.imgStore,bbar:new Ext.PagingToolbar({pageSize:Garp.pageSize,store:this.imgStore,beforePageText:"",displayInfo:!1}),tbar:new Ext.ux.Searchbar({xtype:"searchbar",store:this.imgStore}),listeners:{rowdblclick:this.navHandler.createDelegate(this,[1])}},this.getGridCfg(!0))),this.tplGrid=new Ext.grid.GridPanel({itemId:"tplPanel",margins:"15 15 0 15",title:__("Crop"),region:"center",hideHeaders:!0,store:new Ext.data.DirectStore({autoLoad:!0,autoSave:!1,autoDestroy:!0,remoteSort:!0,restful:!0,root:"rows",idProperty:"id",fields:[{name:"name"},{name:"w"},{name:"h"}],api:{create:Ext.emptyFn,read:Garp.CropTemplate.fetch,update:Ext.emptyFn,destroy:Ext.emptyFn}}),sm:new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{rowselect:this.updatePreview,scope:this}}),cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:[{id:"name",dataIndex:"name",header:__("Name"),width:200},{id:"w",dataIndex:"w",header:__("Width")},{id:"h",dataIndex:"h",header:__("Height")},{id:"preview",dataIndex:"name",header:__("Preview"),renderer:Garp.renderers.cropPreviewRenderer}]}),viewConfig:{scrollOffset:-1,forceFit:!0,autoFill:!0},listeners:{rowdblclick:this.navHandler.createDelegate(this,[1])}}),this.imgGrid.getSelectionModel().on("selectionchange",this.navHandler.createDelegate(this,[0])),this.tplGrid.getSelectionModel().on("selectionchange",function(){this.nextBtn.setDisabled(0===this.tplGrid.getSelectionModel().getCount())},this);var e=new Ext.Template("<h2>",__("Step")," {step} ",__("of")," 2</h2><p>{description}</p>");if(this.items=[{id:"page-0",layout:"border",bodyBorder:!0,border:!0,split:!1,items:[{region:"north",ref:"../northpanel",border:!1,html:this.hideWizardText?"":e.apply({description:__("Specify an image or add new one"),step:1}),margins:"10 15 0 15",bodyBorder:!1,bbar:new Ext.Toolbar({style:"border:0; margin-top: 10px;",border:!1,items:[{iconCls:"icon-new",ref:"newBtn",hidden:!Garp.dataTypes[this.model].quickCreatable,text:__("New "+Garp.dataTypes[this.model].text),handler:function(){var e=new Garp.RelateCreateWindow({model:this.model,iconCls:this.iconCls,title:this.title,listeners:{scope:this,aftersave:function(e,t){this.imgStore.insert(0,t),this.imgGrid.getSelectionModel().selectRecords([t],!0),this.imgStore.reload()}}});e.show()},scope:this}]})},this.imgGrid]},{id:"page-1",layout:"border",bodyBorder:!0,border:!0,split:!1,items:[{region:"north",border:!1,margins:"10 15 0 15",html:e.apply({description:__("Specify a crop template, set aligning and/or add a caption"),step:2})},this.tplGrid,{region:"east",margins:"15 15 0 0",ref:"../previewpanel",width:260,bodyStyle:"background:#e0e0e0;",title:__("Preview"),tpl:'<p style="font-size:9px;"><img src="{IMAGES_CDN}scaled/{tpl}/{id}" style="float: {float};max-width: {width}px; max-height: {height}px; border: 1px #ddd solid; margin: 3px;" />Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>'},{region:"south",border:!1,bodyBorder:!1,height:145,margins:"15 15 15 15",bodyStyle:"background-color: #eee",layout:"border",defaults:{xtype:"form",layout:"form",labelWidth:180,labelSeparator:"",border:!0,bodyStyle:"padding: 5px 0 0 5px"},items:[{title:__("Caption"),region:"center",ref:"../../caption",bodyStyle:"margin:0; padding:0;",items:[{border:!1,fieldLabel:__("Caption"),hideLabel:!0,xtype:"textarea",style:"border: 0;",height:118,anchor:"100%",name:"caption",value:this.captionValue}]},{title:__("Alignment"),region:"east",width:260,margins:"0 0 0 15",bodyStyle:"padding: 10px",ref:"../../alignment",defaults:{handler:this.updatePreview,scope:this},items:[{fieldLabel:__("No alignment"),xtype:"radio",name:"align",checked:""===this.alignValue,inputValue:""},{fieldLabel:__("Align left"),xtype:"radio",name:"align",checked:"left"==this.alignValue,inputValue:"left"},{fieldLabel:__("Align right"),xtype:"radio",name:"align",checked:"right"==this.alignValue,inputValue:"right"}]}]}]}],this.buttons=[{text:__("Previous"),ref:"../prevBtn",handler:this.navHandler.createDelegate(this,[-1])},"->",{text:__("Cancel"),handler:function(){this.close()},scope:this},{text:__("Clear selection"),ref:"../clearBtn",hidden:!0,handler:this.clearSelection.createDelegate(this)},{text:__("Next"),ref:"../nextBtn",handler:this.navHandler.createDelegate(this,[1])}],this.imgGridQuery){this.imgGrid.getStore().setBaseParam("query",this.imgGridQuery),this.imgGrid.getStore().on({load:{single:!0,scope:this,fn:function(){this.imgGrid.getSelectionModel().selectFirstRow(),this.navHandler(1)}}});var t=this.imgGrid.getTopToolbar().searchField;t.setValue(this.imgGridQuery.id),t.hasSearch=!0,t.fireEvent("change")}Garp.ImagePickerWindow.superclass.initComponent.call(this),this.on("show",function(){if(this.navHandler(-1),!this.imgGridQuery){new Ext.KeyNav(this.imgGrid.getEl(),{enter:this.navHandler.createDelegate(this,[1])})}this.imgStore.load(),this.allowBlank&&this.clearBtn.show()},this)}}),Ext.ns("Garp"),Garp.ModelPickerWindow=Ext.extend(Garp.ImagePickerWindow,{model:null,hideWizardText:!0,allowBlank:!1,activeItem:0,navHandler:function(e){var t=this.getLayout().activeItem.id;switch(t=parseInt(t.substr(5,t.length),10),t+=e,0>=t&&(t=0),t){case 1:var i=this.imgGrid.getSelectionModel().getSelected();this.fireEvent("select",{selected:i||null}),this.close();break;default:if(!this.allowBlank){var s=this.imgGrid.getSelectionModel();s.on("selectionchange",function(){this.nextBtn.setDisabled(1!=s.getCount())},this)}this.prevBtn.disable(),this.nextBtn.setText(__("Ok")),this.nextBtn.setDisabled(!this.allowBlank)}this.getLayout().setActiveItem("page-"+t)},initComponent:function(){var e=Garp.dataTypes[this.model];this.setTitle(__(e.text)),this.setIconClass(e.iconCls),Garp.ModelPickerWindow.superclass.initComponent.call(this)}}),Ext.ns("Garp"),Garp.RelateCreateWindow=Ext.extend(Ext.Window,{model:"",iconCls:"",title:"",cls:"relate-create-window",modal:!0,width:640,border:!0,preventBodyReset:!1,autoScroll:!0,rec:null,quickCreatableInit:Ext.emptyFn,initComponent:function(){this.iconCls||this.setIconClass(Garp.dataTypes[this.model].iconCls),this.title||this.setTitle(Garp.dataTypes[this.model].text),this.addEvents("aftersave","afterinit"),this.writer=new Ext.data.JsonWriter({paramsAsHash:!1,encode:!1});var e=[],t=Garp.dataTypes[this.model].columnModel;Ext.each(t,function(t){e.push(t.dataIndex)}),this.store=new Ext.data.DirectStore({fields:e,autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize},api:{create:Garp[this.model].create||Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Garp[this.model].update||Ext.emptyFn,destroy:Garp[this.model].destroy||Ext.emptyFn},writer:this.writer});var i=Ext.apply({},Garp.dataTypes[this.model].formConfig[0].items[0]),s=Ext.apply({},Garp.dataTypes[this.model].formConfig[0].listeners);i={ref:"../formcontent",items:[i],listeners:s,bodyCssClass:"garp-formpanel",border:!1};for(var a=0;a<i.items[0].items.length;++a)"collapsed"in i.items[0].items[a]&&(i.items[0].items[a].collapsed=!0);this.items=[{border:!1,xtype:"form",layout:"form",ref:"form",defaults:{autoWidth:!0,border:!1,bodyCssClass:"garp-formpanel"},items:i}],this.buttons||(this.buttons=[]),this.buttons.push([{text:__("Cancel"),ref:"../cancelBtn",handler:function(){this.close()},scope:this},{text:__("Ok"),ref:"../okBtn",handler:function(){this.saveAll(!0)},scope:this}]),Garp.RelateCreateWindow.superclass.initComponent.call(this)},saveAll:function(e){return this.form.getForm().isValid()?(this.form.getForm().updateRecord(this.rec),this.store.on({save:{fn:function(){this.rec=this.store.getAt(0),this.formcontent&&this.formcontent.fireEvent("loaddata",this.rec,this),this.fireEvent("aftersave",this,this.rec),this.loadMask.hide(),e&&this.close()},single:!0,scope:this}}),void(-1!==this.store.save()&&(this.loadMask=new Ext.LoadMask(this.getEl()),this.loadMask.show()))):void this.form.getForm().items.each(function(){this.isValid()})},afterRender:function(){Garp.RelateCreateWindow.superclass.afterRender.call(this),this.form.getForm().setValues(Garp.dataTypes[this.model].defaultData),this.onShow&&this.onShow.call(this);var e=new this.store.recordType(Ext.apply({},Garp.dataTypes[this.model].defaultData));this.rec=e,this.store.insert(0,e),this.getForm=function(){return this.form.getForm()},this.on("save-all",this.saveAll,this),this.on("show",function(){if(this.formcontent.fireEvent("loaddata",e,this),this.quickCreatableInit(),this.getForm().clearInvalid(),this.quickCreateReference){var t=this.parentId||Garp.gridPanel.getSelectionModel().getSelected().get("id");this.getForm().findField(this.quickCreateReference).store.on("load",function(){this.getForm().findField(this.quickCreateReference).setValue(t)},this,{single:!0}),this.getForm().findField(this.quickCreateReference).store.load(),this.getForm().findField(this.quickCreateReference).hide(),this.setHeight(this.getHeight()),this.center()}window.weenerdog=this,this.keymap=new Ext.KeyMap(this.formcontent.getEl(),[{key:Ext.EventObject.ENTER,ctrl:!0,scope:this,handler:function(){return this.form.getForm().items.each(function(){this.fireEvent("blur",this)}),this.okBtn.handler.call(this),!1}}]),this.keymap.stopEvent=!0,this.fireEvent("afterinit",this)},this)}}),Garp.InlineRelator=Ext.extend(Ext.Panel,{model:"",rule:null,rule2:null,unrelateExisting:!0,localId:null,border:!1,bodyBorder:!1,autoHeight:!0,autoScroll:!0,getEmptyRecord:function(){return new this.relationStore.recordType},setupStore:function(){var e=Garp.dataTypes[this.model].getStoreFieldsFromColumnModel(),t=function(){for(var t=[],i=0;i<e.length;++i)t.push(e[i].name);return t}();this.writer=new Ext.data.JsonWriter({paramsAsHash:!1,encode:!1}),this.relationStore=new Ext.data.DirectStore({fields:e,autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize,fields:t,query:""},api:{create:Garp[this.model].create||Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Garp[this.model].update||Ext.emptyFn,destroy:Garp[this.model].destroy||Ext.emptyFn},writer:this.writer,listeners:{beforeload:{fn:function(){return this.localId?!0:!1},scope:this},load:{fn:function(){this.addInlineForms(),0!==this.relationStore.getCount()||this.addBtn||this.addAddBtn()},scope:this}}})},addAddBtn:function(){this.add({xtype:"button",ref:"addBtn",iconCls:"icon-new",text:__(Garp.dataTypes[this.model].text),handler:function(e){this.remove(e),this.addForm()},scope:this}),this.doLayout()},addInlineForms:function(){this.relationStore.each(function(e){this.add({xtype:"inlineform",rec:e,model:this.model,inlineRelator:this})},this),this.doLayout()},addForm:function(e){var t=0;t=e?this.relationStore.findBy(function(t){return t==e.rec?!0:void 0})+1:this.relationStore.getCount();var i=this.getEmptyRecord();this.relationStore.insert(t,i),this.insert(t,{xtype:"inlineform",rec:i,model:this.model,inlineRelator:this}),this.doLayout(),this.items.last().items.each(function(){return this.hidden||this.disabled||!this.focus?void 0:(this.focus(),!1)})},relate:function(){var e={model:this.model,unrelateExisting:this.unrelateExisting,primaryKey:this.localId,foreignKeys:function(){var e=[];return this.relationStore.each(function(t){e.push({key:t.data.id,relationMetadata:t.data.relationMetadata?t.data.relationMetadata[Garp.currentModel]:[]})}),e.reverse(),e}.call(this)};this.rule&&(e.rule=this.rule),this.rule2&&(e.rule2=this.rule2);var t=this;Garp[Garp.currentModel].relate(e,function(e){e&&(t.relationStore.removeAll(!0),t.items.each(function(e){t.remove(e)}),t.relationStore.reload())})},saveAll:function(){this.relationStore.on({save:{fn:this.relate,scope:this}}),this.relationStore.save()},removeForm:function(e){this.relationStore.remove(e.rec),this.remove(e),this.doLayout(),this.relate()},initComponent:function(e){Garp.InlineRelator.superclass.initComponent.call(this,e),this.ownerForm=this.ownerCt.ownerCt,this.setupStore(),this.ownerForm.on("loaddata",function(e){this.localId=e.get("id"),this.items.each(function(e){this.remove(e)},this),this.relationStore.removeAll(!0);var t={};t[Garp.currentModel+".id"]=this.localId,this.relationStore.setBaseParam("query",t),this.relationStore.reload()},this),Garp.eventManager.on("save-all",function(){this.items.each(function(){this.updateRecord&&this.updateRecord(this.rec)}),this.saveAll()},this)}}),Ext.reg("inlinerelator",Garp.InlineRelator),Garp.InlineForm=Ext.extend(Ext.Panel,{rec:null,inlineRelator:"",border:!1,bodyBorder:!1,hideBorders:!0,style:"padding-bottom: 2px;",border:!1,bodyBorder:!1,layout:"hbox",hideLabel:!0,xtype:"inlineform",morphFields:function(e){var t=e.items.slice(0);return t.push({iconCls:"icon-new",xtype:"button",width:31,margins:"0 0 0 1",flex:0,handler:function(){this.inlineRelator.addForm(this)},scope:this},{iconCls:"icon-delete",xtype:"button",width:31,margins:"0 0 0 1",flex:0,handler:function(){this.inlineRelator.removeForm(this)},scope:this}),Ext.each(t,function(e){e.hasOwnProperty("flex")||(e.flex=1),e.margins="0 0 0 1"}),t},loadRecord:function(e){this.items.each(function(t){t.name&&e.get(t.name)&&t.setValue&&t.setValue(e.get(t.name))})},updateRecord:function(){this.items.each(function(e){e.name&&e.getValue()&&this.rec.set(e.name,e.getValue())},this)},initComponent:function(){this.items=this.morphFields(Ext.apply({},Garp.dataTypes[this.model].formConfig[0].items[0])),Garp.InlineForm.superclass.initComponent.call(this),this.rec&&this.loadRecord(this.rec)}}),Ext.reg("inlineform",Garp.InlineForm),Garp.InlineRelatorLabels=Ext.extend(Ext.Panel,{model:null,layout:"hbox",border:!1,hideLabel:!0,style:"margin-bottom: 5px;font-weight: bold;",defaults:{flex:1,xtype:"label"},initComponent:function(e){var t=Garp.dataTypes[this.model].formConfig[0].items[0].items.slice(0),i=[];Ext.each(t,function(e){e.disabled||e.hidden||!e.fieldLabel||i.push({text:__(e.fieldLabel)})}),i.push({width:65,text:" ",flex:0}),this.items=i,Garp.InlineRelatorLabels.superclass.initComponent.call(this,e)}}),Ext.reg("inlinerelatorlabels",Garp.InlineRelatorLabels),window.onYouTubeIframeAPIReady=null,Garp.YouTubeUploadWindow=Ext.extend(Ext.Window,{modal:!0,title:__("YouTube Upload"),width:610,height:435,resizable:!1,html:'<div id="widget"></div>',scriptTagId:"youtubeuploadwindow",_lm:new Ext.LoadMask(Ext.getBody(),{msg:__("Waiting for YouTube. This might take a while&hellip;")}),initComponent:function(e){this.addEvents(["uploadcomplete"]),Garp.YouTubeUploadWindow.superclass.initComponent.call(this,e)},afterRender:function(e){function t(){new YT.UploadWidget("widget",{webcamOnly:!1,width:600,events:{onApiReady:function(){n._lm.hide()},onUploadSuccess:function(){n._lm.show()},onProcessingComplete:function(e){n._lm.hide(),n.fireEvent("uploadcomplete",e)}}});n.el.select("iframe").first().show()}Garp.YouTubeUploadWindow.superclass.afterRender.call(this,e),this.on("beforeclose",function(){this._lm.hide()},this),this._lm.show();var i=document.getElementById(this.scriptTagId)||!1,s=document.createElement("script");s.src="//www.youtube.com/iframe_api",s.id=this.scriptTagId;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(s,a);var n=this;i?t():window.onYouTubeIframeAPIReady=t}}),Ext.ns("Ext.ux"),Ext.ux.RelationField=Ext.extend(Ext.form.ComboBox,{model:null,allowBlank:!1,autoLoad:!0,editable:!1,triggerAction:"all",typeAhead:!1,mode:"remote",valueField:"id",displayField:"name",disableCreate:!1,emptyText:__("(empty)"),trigger1Class:"relation-open-button",cls:"relation-field",allQuery:"",lastQuery:"",baseParams:{start:0,limit:Garp.pageSize},selectCallback:function(e){var t=this.getValue();return e&&e.hasOwnProperty("selected")?(null===e.selected?this.setValue(null):(this.setValue(e.selected.get(this.displayField)||e.selected.get("id")),this.disable(),this.store.on({load:function(){this.setValue(e.selected.get("id")),this.enable(),this.assertValue&&this.assertValue(),this.el.focus(!0),this.collapse.defer(200,this)},single:!0,scope:this}),this.store.load()),this.originalValue=t,this.win.destroy(),void this.fireEvent("select",e)):void this.win.destroy()},triggerFn:function(){this.win=new Garp.ModelPickerWindow({model:this.model,query:this.allQuery||null,allowBlank:this.allowBlank}),this.win.on("select",this.selectCallback,this),this.win.on("close",this.selectCallback,this),this.win.show()},createRelationUrl:function(){return this.getValue()?BASE+"admin?"+Ext.urlEncode({model:this.model,id:this.getValue()}):!1},onRelationOpenTriggerClick:function(){if(this.tip)this.tip.isVisible()?this.tip.hide():this.tip.show();else{var e=this.createRelationUrl();if(e){window.open(e)}}},getValue:function(){var e=Ext.ux.RelationField.superclass.getValue.call(this);return(""===e||e==this.emptyText)&&(e=null),e},setValue:function(e){this.el.removeClass("x-form-invalid"),e&&this.store.find("id",e)<0&&(this.disable(),this.el.addClass("loading"),this.store.load({add:!0,single:!0,params:{query:{id:e}},callback:function(e){this.enable(),this.el.removeClass("loading"),e&&e.length?(this.assertValue(),this.collapse()):(this.store.clearFilter(),this.el.addClass("x-form-invalid"))},scope:this})),e?this.getTrigger(0).removeClass("no-relation"):this.getTrigger(0).addClass("no-relation"),Ext.ux.RelationField.superclass.setValue.call(this,e)},initComponent:function(){this.store=new Ext.data.DirectStore({autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",fields:Garp.dataTypes[this.model]?Garp.dataTypes[this.model].getStoreFieldsFromColumnModel():[],totalProperty:"total",sortInfo:Garp.dataTypes[this.model]&&Garp.dataTypes[this.model].sortInfo?Garp.dataTypes[this.model].sortInfo:null,baseParams:this.baseParams,api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}}),this.store.on({load:{single:!0,scope:this,fn:function(){var e={id:0};e[this.displayField]=this.emptyText;var t=new this.store.recordType(e,0);this.store.add(t),this.assertValue()}}}),this.triggerFn?this.onTriggerClick=this.triggerFn:this.store.load(),Ext.ux.RelationField.superclass.initComponent.call(this),this.triggerConfig={tag:"span",cls:"x-form-twin-triggers",cn:[{tag:"img",src:Ext.BLANK_IMAGE_URL,alt:"",title:__("Open in new window"),cls:"x-form-trigger "+this.trigger1Class},{tag:"img",src:Ext.BLANK_IMAGE_URL,alt:"",cls:"x-form-trigger "+this.trigger2Class}]},Garp.dataTypes[this.model]||this.disable()},getTrigger:function(e){return this.triggers[e]},afterRender:function(){Ext.form.TwinTriggerField.superclass.afterRender.call(this);for(var e=this.triggers,t=0,i=e.length;i>t;++t)this["hideTrigger"+(t+1)]&&e[t].hide();Garp.dataTypes[this.model].previewItems&&Garp.dataTypes[this.model].previewItems.length&&(this.tip=new Ext.ToolTip({target:this.el,html:"",anchor:"top",anchorOffset:5,closable:!0,showDelay:1e3,hideDelay:3500,listeners:{show:function(e){var t=this.store.find("id",this.getValue()),i=Garp.dataTypes[this.model].previewItems;if(t>-1){var s=this.store.getAt(t).data,a="<ul>";Ext.each(i,function(e){var t=s[e]||"";a+="<li>"+__(e)+": <b>"+t+"</b></li>"}),a+="</ul>",a+='<a target="_blank" href="'+BASE+"admin/?model="+this.model+"&id="+s.id+'">'+__("Open in new window")+"</a>",e.update(a)}else e.hide()},scope:this},scope:this}))},initTrigger:function(){var e=this.trigger.select(".x-form-trigger",!0),t=this;e.each(function(e,i,s){var a="Trigger"+(s+1);e.hide=function(){var e=t.wrap.getWidth();this.dom.style.display="none",t.el.setWidth(e-t.trigger.getWidth()),t["hidden"+a]=!0},e.show=function(){var e=t.wrap.getWidth();this.dom.style.display="",t.el.setWidth(e-t.trigger.getWidth()),t["hidden"+a]=!1},0===s?this.mon(e,"click",this.onRelationOpenTriggerClick,this,{preventDefault:!0}):this.mon(e,"click",this.onTriggerClick,this,{preventDefault:!0}),e.addClassOnOver("x-form-trigger-over"),e.addClassOnClick("x-form-trigger-click")},this),this.triggers=e.elements},getTriggerWidth:function(){var e=0;return Ext.each(this.triggers,function(t,i){var s="Trigger"+(i+1),a=t.getWidth();e+=0!==a||this["hidden"+s]?a:this.defaultTriggerWidth},this),e},onDestroy:function(){Ext.destroy(this.triggers),Ext.form.TwinTriggerField.superclass.onDestroy.call(this)},onTrigger1Click:Ext.emptyFn,onTrigger2Click:Ext.emptyFn}),Ext.ux.JoinedRelationField=Ext.extend(Ext.ux.RelationField,{bindedField:null,selectCallback:function(e){var t,i;e&&"undefined"!=typeof e.selected&&(e.selected?(t=e.selected.get("id"),i=Garp.dataTypes[this.model].displayFieldRenderer(e.selected)):(t=null,i=null),this.form.findField(this.bindedField).setValue(t),this.setValue(i),this.fireEvent("select",e))},isDirty:function(){return!1},getValue:function(){return null},createRelationUrl:function(){var e=this.form.findField(this.bindedField).getValue();return e?BASE+"admin?"+Ext.urlEncode({model:this.model,id:e}):!1},setValue:function(e){return Ext.ux.RelationField.superclass.setValue.call(this,e),this}}),Ext.ux.BindedField=Ext.extend(Ext.form.TextField,{bindedField:null,initComponent:function(e){this.hidden=!0,this.hideFieldLabel=!0,Ext.ux.BindedField.superclass.initComponent.call(this,e)},getValue:function(){var e=Ext.ux.BindedField.superclass.getValue.call(this);return""===e?null:e}}),Ext.reg("relationfield",Ext.ux.RelationField),Ext.reg("joinedrelationfield",Ext.ux.JoinedRelationField),Ext.reg("bindedfield",Ext.ux.BindedField),Ext.ns("Ext.ux"),Ext.ux.RelationPanel=Ext.extend(Ext.Panel,{layout:"border",bodyBorder:!1,border:!0,forceLayout:!0,monitorValid:!1,minimalUI:!1,paginated:!1,quickCreatable:!1,quickCreateReference:null,localId:null,unrelateExisting:!0,model:null,weighable:!1,rule:null,rule2:null,bindingModel:null,bidirectional:!0,foreignKey:"id",columns:null,title:"",quickCreateBtnLabel:"",maxItems:null,metaDataEditors:null,metaDataRenderers:null,metaDataValidator:function(){return!0},metaDataConfig:{},dirty:function(){if(this.fireEvent("dirty"),this.metaDataPanel)var e=this.metaDataValidator(this.metaDataPanel.getSource(),this.relateePanel.store.data);e&&this.getTopToolbar().saveBtn.enable(),this.getTopToolbar().cancelBtn.enable(),this.ownerCt.items.each(function(e){e!=this&&e.disable()},this)},undirty:function(){this.fireEvent("undirty"),this.getTopToolbar().saveBtn.disable(),this.getTopToolbar().cancelBtn.disable(),this.ownerCt.items.each(function(e){e!=this&&e.enable()},this)},getRowIndex:function(e,t){return e.getView().findRowIndex(Ext.lib.Event.getTarget(t))},highlight:function(e){this.highlightEl&&this.highlightEl.removeClass("garp-dnd-over"),e&&(this.highlightEl=Ext.get(e),this.highlightEl.addClass("garp-dnd-over"))},setupDD:function(){var e=this;new Ext.dd.DropTarget(this.relatePanel.getView().el,{ddGroup:"dd",copy:!0,notifyOut:function(){e.highlight(!1)},notifyOver:function(t,i){return"relatePanel"==t.dragData.grid.itemId?Ext.dd.DropZone.prototype.dropNotAllowed:(e.highlight(e.relatePanel.getView().getRow(e.getRowIndex(e.relatePanel,i)),this.highlight),Ext.dd.DropZone.prototype.dropAllowed)},notifyDrop:function(t,i){if(e.highlight(!1),"relatePanel"==t.dragData.grid.itemId)return!1;var s=t.dragData.selections,a=e.getRowIndex(e.relateePanel,i);return e.moveRecords(t.grid,e.relatePanel,s,a),!0}}),new Ext.dd.DropTarget(this.relateePanel.getView().el,{ddGroup:"dd",copy:!0,notifyOut:function(){e.highlight(!1)},notifyOver:function(t,i){return e.highlight(e.relateePanel.getView().getRow(e.getRowIndex(e.relateePanel,i)),this.highlight),e.weighable||"relateePanel"!=t.dragData.grid.itemId?"relateePanel"==t.dragData.grid.itemId?Ext.dd.DropZone.prototype.dropAllowed:e.maxItems&&e.relateeStore.getCount()>=e.maxItems?Ext.dd.DropZone.prototype.dropNotAllowed:Ext.dd.DropZone.prototype.dropAllowed:Ext.dd.DropZone.prototype.dropNotAllowed},notifyDrop:function(t,i){if(!e.weighable&&"relateePanel"==t.dragData.grid.itemId)return!1;e.highlight(!1);var s=t.dragData.selections,a=e.getRowIndex(e.relateePanel,i);return e.moveRecords(t.grid,e.relateePanel,s,a),!(e.maxItems&&e.relateeStore.getCount()>=e.maxItems)}})},moveRecords:function(e,t,i,s){if(!(this.maxItems&&this.relateeStore.getCount()>=this.maxItems&&t==this.relateePanel&&e!==t||(i||(i=e.getSelectionModel().getSelections()),this.maxItems&&this.relateeStore.getCount()+i.length>this.maxItems&&e==this.relatePanel))){Ext.each(i,function(i){var a=new e.store.recordType(i.data);Ext.isNumber(s)?t.store.insert(s,a):(s=t.store.getCount(),t.store.add(a)),e.store.remove(i)}),Ext.each([e,t],function(e){e.getSelectionModel().clearSelections(),e.getView().refresh()}),this.dirty(),this.weighable||(t.store.remoteSort=!1,t.store.sort(Garp.dataTypes[this.model].sortInfo.field,Garp.dataTypes[this.model].sortInfo.direction),t.store.remoteSort=!0);var a=i[0],n=t.store.find("id",a.data.id);t.getSelectionModel().selectRow(n||0)}},getStoreCfg:function(){return{autoLoad:!1,autoSave:!1,remoteSort:!0,restful:!0,autoDestroy:!0,pruneModifiedRecords:!0,root:"rows",idProperty:"id",fields:function(){var e=Garp.dataTypes[this.model].getStoreFieldsFromColumnModel();return e.push({dataIndex:"relationMetadata",header:!1,searchable:!1,hidden:!0}),e}.call(this),totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:function(){var e={start:0,limit:Garp.pageSize};return this.rule&&(e.rule=this.rule),this.rule2&&(e.rule2=this.rule2),this.bindingModel&&(e.bindingModel=this.bindingModel),e.bidirectional=this.bidirectional,e}.call(this),api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}}},getGridCfg:function(e){return{border:!0,region:"center",hideHeaders:e,enableDragDrop:!0,ddGroup:"dd",cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:function(){var e,t,i,s=[];if(this.columns){e=Garp.dataTypes[this.model].columnModel;for(t=0,i=e.length;i>t;t++)"boolean"==typeof e[t].hidden&&e[t].hidden||(col=Ext.apply({},e[t]),col.hidden=-1==this.columns.indexOf(col.dataIndex),s.push(col));return s}for(e=Garp.dataTypes[this.model].columnModel,t=0,i=e.length;i>t;t++)"boolean"==typeof e[t].hidden&&e[t].hidden||(col=Ext.apply({},e[t]),s.push(col));return s}.call(this)}),pageSize:Garp.pageSize,title:__("Available"),iconCls:this.iconCls,viewConfig:{scrollOffset:-1,forceFit:!0,autoFill:!0}}},getButtonPanel:function(){return{border:!1,xtype:"container",bodyBorder:!1,region:"east",width:50,margins:"0 0 0 20",bodyCssClass:"garp-relatepanel-buttons",layout:"vbox",layoutConfig:{align:"stretch",pack:"center",defaultMargins:{top:5,left:5,right:5,bottom:5}},items:[{xtype:"button",iconCls:"icon-relatepanel-relate",ref:"../../relateBtn",tooltip:__("Relate selected item(s)"),handler:this.moveRecords.createDelegate(this,[this.relatePanel,this.relateePanel,!1,!1])},{xtype:"button",iconCls:"icon-relatepanel-unrelate",ref:"../../unrelateBtn",tooltip:__("Unrelate selected item(s)"),handler:this.moveRecords.createDelegate(this,[this.relateePanel,this.relatePanel,!1,!1])}]}},saveRelations:function(e){if(Garp[Garp.currentModel].relate&&("undefined"==typeof e&&(e={}),this.relateeStore&&(e.force||0!==this.relateeStore.getModifiedRecords().length||0!==this.relateStore.getModifiedRecords().length))){this.loadMask=new Ext.LoadMask(this.getEl(),{msg:__("Relating&hellip;")}),this.loadMask.show();
var t={model:this.model,unrelateExisting:this.unrelateExisting,primaryKey:this.localId,foreignKeys:function(){var e=[];return this.relateeStore.each(function(t){e.push({key:t.data.id,relationMetadata:t.data.relationMetadata?t.data.relationMetadata[Garp.currentModel]:[]})}),e.reverse(),e}.call(this)};this.rule&&(t.rule=this.rule),this.rule2&&(t.rule2=this.rule2),this.bindingModel&&(t.bindingModel=this.bindingModel),t.bidirectional=this.bidirectional,Garp[Garp.currentModel].relate(t,function(e){if(this.loadMask.hide(),e)if(this.model==Garp.currentModel){var t=Garp.gridPanel.getStore();this.relateStore.rejectChanges(),this.relateeStore.rejectChanges(),t.on({load:{fn:function(){var e=Garp.gridPanel.getSelectionModel();this._selectionChange(e),this.relateStore.reload(),this.relateeStore.reload()},scope:this,buffer:100,single:!0}}),t.reload()}else this.relateStore.reload(),this.relateeStore.reload()},this)}},checkDirty:function(e){return"function"!=typeof e&&(e=Ext.emptyFn),0==this.relateStore.getModifiedRecords().length&&0==this.relateeStore.getModifiedRecords().length?!0:(Ext.Msg.show({animEl:Garp.viewport.getEl(),icon:Ext.MessageBox.QUESTION,title:__("Garp"),msg:__("Would you like to save your changes?"),buttons:Ext.Msg.YESNOCANCEL,scope:this,fn:function(t){function i(){s--,0===s&&(this.relateStore.rejectChanges(),this.relateeStore.rejectChanges(),e())}switch(t){case"yes":this.saveRelations();var s=2;this.relateeStore.on({load:{fn:i,scope:this,single:!0}}),this.relateStore.on({load:{fn:i,scope:this,single:!0}});break;case"no":this.relateStore.rejectChanges(),this.relateeStore.rejectChanges(),e()}}}),!1)},_selectionChange:function(e){if(this.setDisabled(1!==e.getCount()),1!==e.getCount())return void(this.ownerCt&&this.ownerCt.setActiveTab&&this.ownerCt.setActiveTab(0));var t=e.getSelected().get(this.foreignKey);t?this.localId=t:(this.localId=e.getSelected().get("id"),null===this.localId&&(this.setDisabled(!0),this.ownerCt.setActiveTab(0)));var i;i={},"undefined"==typeof this.filterColumn?i[Garp.currentModel+".id <>"]=t:i[this.filterColumn+" <>"]=t;var s=Ext.apply(this.relateStore.baseParams,{query:i,rule:this.rule});this.rule2&&(s.rule2=this.rule2),this.bindingModel&&(s.bindingModel=this.bindingModel),s.bidirectional=this.bidirectional,this.relateStore.setBaseParam(s),i={},"undefined"==typeof this.filterColumn?i[Garp.currentModel+".id"]=t:i[this.filterColumn]=t,s=Ext.apply(this.relateeStore.baseParams,{query:i,rule:this.rule}),this.rule2&&(s.rule2=this.rule2),this.bindingModel&&(s.bindingModel=this.bindingModel),s.bidirectional=this.bidirectional,this.relateeStore.setBaseParam(s),this.searchbar.setBaseParams(),!this.hidden&&this.rendered&&(this.relateePanel.getSelectionModel().clearSelections(!0),this.metaDataPanel&&(this.metaDataPanel.hide(),this.metaDataPanel.ownerCt.doLayout()),this.relateStore.reload(),this.relateeStore.reload())},_onActivate:function(){this._onActivate.isLoaded||(this.minimalUI||this.relateStore.on({load:{scope:this,single:!0,fn:this.setupDD}}),this.relateStore.load(),this.relateeStore.load(),this._onActivate.isLoaded=!0,this.relatePanel.doLayout())},updateOpenNewWindow:function(){function e(e,t){return!e!=!t}e(1==this.relatePanel.getSelectionModel().getCount(),1==this.relateePanel.getSelectionModel().getCount())?this.getTopToolbar().buttonopennewwindow.show():this.getTopToolbar().buttonopennewwindow.hide()},initComponent:function(){function e(e){null!==this.maxItems&&(e.getCount()==this.maxItems?this.relateBtn.disable():this.relateBtn.enable()),this.relateStore.filter([{scope:this,fn:function(e){return!this.relateeStore.getById(e.get("id"))}}])}function t(){a.rendered&&a.isVisible()&&(a.metaDataValidator(a.metaDataPanel.getSource(),a.relateePanel.store.data)?a.getTopToolbar().saveBtn.enable():a.getTopToolbar().saveBtn.disable())}if(Garp.dataTypes[this.model]){var i=null;this.iconCls||this.setIconClass(Garp.dataTypes[this.model].iconCls),this.title||this.setTitle(__(Garp.dataTypes[this.model].text)),this.quickCreateBtnLabel||(this.quickCreateBtnLabel=this.title),this.bodyCssClass="garp-relatepanel-buttons",this.relateStore=new Ext.data.DirectStore(Ext.apply({},{listeners:{load:{scope:this,single:!0,fn:function(){this.relateeStore.load()}}},api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}},this.getStoreCfg())),this.relateeStore=new Ext.data.DirectStore(Ext.apply({},{baseParams:{limit:this.paginated?Garp.pageSize:i},writer:new Ext.data.JsonWriter({paramsAsHash:!1,writeAllFields:!0,encode:!1}),listeners:{load:e.createSequence(this.undirty),add:e,remove:e,save:e,update:e,scope:this}},this.getStoreCfg())),this.relatePanel=new Ext.grid.GridPanel(Ext.apply({},{itemId:"relatePanel",store:this.relateStore,bbar:new Ext.PagingToolbar({pageSize:Garp.pageSize,store:this.relateStore,beforePageText:"",displayInfo:!1}),tbar:this.searchbar=new Ext.ux.Searchbar({xtype:"searchbar",store:this.relateStore}),listeners:{rowdblclick:function(){this.moveRecords(this.relatePanel,this.relateePanel,!1,!1)},scope:this}},this.getGridCfg(!1)));var s=Ext.apply({},{itemId:"relateePanel",title:__("Related"),iconCls:"icon-relatepanel-related",store:this.relateeStore,tbar:null!==this.maxItems?new Ext.Toolbar({items:[{xtype:"tbtext",text:this.maxItems+__(" item(s) maximum")}]}):null,monitorResize:!0,layout:"fit",pageSize:i,listeners:this.minimalUI?{}:{rowdblclick:function(){this.moveRecords(this.relateePanel,this.relatePanel,!1,!1)},scope:this}},this.getGridCfg(null!==this.maxItems));if(this.paginated&&(s.pageSize=Garp.pageSize,s.bbar=new Ext.PagingToolbar({pageSize:Garp.pageSize,store:this.relateeStore,beforePageText:"",displayInfo:!1})),this.relateePanel=new Ext.grid.GridPanel(s),this.minimalUI)this.items=[{xtype:"container",layout:"border",border:!1,margins:"20 20 20 20",region:"center",items:this.relateePanel}];else{var a=this,n={split:!0,__relationPanel:this,layout:"fit",region:"south",minHeight:250,height:200,collapsed:!1,customEditors:this.metaDataEditors,customRenderers:this.metaDataRenderers,forceValidation:!0,hidden:!0,collapsible:!1,source:this.source||{},listeners:{propertychange:t}};Ext.apply(n,this.metaDataConfig),this.metaDataPanel=new Ext.grid.PropertyGrid(n),this.metaDataPanel.store.on("load",t,this),this.items=[{xtype:"container",layout:"border",border:!1,width:"50%",margins:"15 15 20 15",region:"center",items:[this.relatePanel,this.getButtonPanel()]},{xtype:"container",layout:"border",width:"50%",region:"east",margins:"15 15 20 5",border:!1,bodyCssClass:"garp-relatepanel-buttons",items:[this.relateePanel,this.metaDataPanel]}]}this.tbar=new Ext.Toolbar({style:"border:0; padding: 15px 15px 0 15px;",border:!1,items:[{iconCls:"icon-save",text:__("Save"),ref:"saveBtn",disabled:!0,hidden:this.minimalUI,handler:function(){this.saveRelations()},scope:this},{iconCls:"icon-cancel",text:__("Cancel"),ref:"cancelBtn",hidden:this.minimalUI,disabled:!0,handler:function(){this.relateeStore.reload(),this.metaDataPanel.hide(),this.metaDataPanel.setSource(this.source||{}),this.relateePanel.getSelectionModel().selectRange(-1,-1)},scope:this},Garp.dataTypes[this.model].quickCreatable?{iconCls:"icon-new",text:__("New "+this.quickCreateBtnLabel),handler:function(){var e={model:this.model,iconCls:this.iconCls,title:this.title,quickCreateReference:this.quickCreateReference};this.quickCreateConfig&&(e=Ext.apply(e,this.quickCreateConfig));var t=new Garp.RelateCreateWindow(e);t.show(),t.on("aftersave",function(e,t){this.relateeStore.add(t),this.saveRelations({force:!0})},this)},scope:this}:{hidden:!0}," ",{iconCls:"icon-open-new-window",hidden:!0,ref:"buttonopennewwindow",text:__("Open in new window"),handler:function(){var e;if(this.relatePanel.getSelectionModel().getCount()>0?(e=this.relatePanel.getSelectionModel().getSelected(),Garp.eventManager.on("external-relation-save",function(){this.relatePanel.getStore().reload()},this)):(e=this.relateePanel.getSelectionModel().getSelected(),Garp.eventManager.on("external-relation-save",function(){this.relateePanel.getStore().reload()},this)),e){var t=e.get("id"),i=BASE+"admin?model="+this.model+"&id="+t;window.open(i)}},scope:this},"->",{text:__("Export"),iconCls:"icon-export",hidden:!1,handler:function(){var e=new Garp.ExportWindow;e.show()}}," ",{iconCls:"icon-help",text:__("How does this work?"),hidden:this.minimalUI,handler:function(){var e=new Ext.ToolTip({target:this.getEl(),anchor:"top",preventBodyReset:!0,bodyCssClass:"garp-tooltip",html:__("Relate or reorder items by dragging them around, or use the arrow buttons in the middle."),autoHide:!0});e.show()}}]}),this.on("activate",this._onActivate,this),this.on("hide",function(){this._onActivate.isLoaded=!1},this),this.on("deactivate",this.checkDirty,this),this.relatePanel.getSelectionModel().on({selectionchange:{scope:this,buffer:25,fn:this.updateOpenNewWindow}}),this.relateePanel.getSelectionModel().on({selectionchange:{scope:this,buffer:25,fn:function(e){if(this.updateOpenNewWindow(),this.metaDataPanel){var t=!1;for(var i in this.metaDataPanel.getSource()){t=!0;break}e&&1==e.getCount()&&t?e&&1==e.getCount()&&this.relateeStore&&this.relateeStore.fields.containsKey("relationMetadata")&&(this.metaDataPanel.show(),this.metaDataPanel.ownerCt.doLayout(),this.metaDataPanel.startEditing(0,1)):(this.metaDataPanel.hide(),this.metaDataPanel.ownerCt.doLayout())}}},rowselect:{scope:this,buffer:20,fn:function(e,t,i){if(this.metaDataPanel)if(1==e.getCount()){if(i.data.relationMetadata&&i.data.relationMetadata[Garp.currentModel]){this.metaDataPanel._recordRef=i.id;var s=i.data.relationMetadata[Garp.currentModel];for(var a in s)null===s[a]&&(s[a]="");this.metaDataPanel.setSource(s)}}else this.metaDataPanel.hide(),this.metaDataPanel.ownerCt.doLayout()}}}),this.metaDataPanel&&this.metaDataPanel.on("propertychange",function(e,t,i,s){if(i!=s){var a=this.relateeStore.getById(this.metaDataPanel._recordRef);if(!a)return;a.beginEdit();{a.data.relationMetadata[Garp.currentModel]}a.set({k:e}),a.markDirty(),a.endEdit(),this.relateePanel.getView().refresh()}},this),Garp.eventManager&&Garp.eventManager.on({"after-save":{scope:this,fn:this._selectionChange},selectionchange:{scope:this,fn:this._selectionChange,buffer:400},"save-all":{scope:this,fn:function(){this.saveRelations()}},beforerowselect:{scope:this,fn:function(e,t){return this.checkDirty(function(){e.selectRow(t)})}}})}else this.ownerCt.on("afterrender",function(){this.destroy()},this);Ext.ux.RelationPanel.superclass.initComponent.call(this)},onDestroy:function(){this.un("activate",this._onActivate,this),Garp.eventManager&&(Garp.eventManager.un("save-all",this.saveRelations,this),Garp.eventManager.un("selectionchange",this._selectionChange,this),Garp.eventManager.un("after-save",this._selectionChange,this)),Ext.ux.RelationPanel.superclass.onDestroy.call(this),this._onActivate.isLoaded=!1}}),Ext.reg("relationpanel",Ext.ux.RelationPanel),Ext.namespace("Ext.ux.form"),Ext.ux.form.SuperBoxSelect=function(e){Ext.ux.form.SuperBoxSelect.superclass.constructor.call(this,e),this.addEvents("beforeadditem","additem","newitem","beforeremoveitem","removeitem","clear")},Ext.ux.form.SuperBoxSelect=Ext.extend(Ext.ux.form.SuperBoxSelect,Ext.form.ComboBox,{allowAddNewData:!1,backspaceDeletesLastItem:!0,classField:null,clearBtnCls:"",displayFieldTpl:null,extraItemCls:"",extraItemStyle:"",expandBtnCls:"",fixFocusOnTabSelect:!0,forceFormValue:!0,itemDelimiterKey:Ext.EventObject.ENTER,navigateItemsWithTab:!0,pinList:!0,preventDuplicates:!0,queryValuesDelimiter:"|",queryValuesIndicator:"valuesqry",removeValuesFromStore:!0,renderFieldBtns:!0,stackItems:!1,styleField:null,supressClearValueRemoveEvents:!1,validationEvent:"blur",valueDelimiter:",",initComponent:function(){Ext.apply(this,{items:new Ext.util.MixedCollection(!1),usedRecords:new Ext.util.MixedCollection(!1),addedRecords:[],remoteLookup:[],hideTrigger:!0,grow:!1,resizable:!1,multiSelectMode:!1,preRenderValue:null,renderFieldBtns:!1,typeAhead:!1,pinList:!1,emptyText:__("(empty)"),forceSelection:!1,remote:!0}),this.transform&&this.doTransform(),this.forceFormValue&&this.items.on({add:this.manageNameAttribute,remove:this.manageNameAttribute,clear:this.manageNameAttribute,scope:this}),Ext.ux.form.SuperBoxSelect.superclass.initComponent.call(this),"remote"===this.mode&&this.store&&this.store.on("load",this.onStoreLoad,this),this.on({beforequery:function(e){if(""==e.query)return!1;var t={},i=this.displayField;t[i+" like"]="%"+e.query+"%",Ext.apply(e,{forceAll:!0,query:{or:t}})},scope:this}),Garp.eventManager.on({selectionchange:{scope:this,fn:this.onSelectionChange,buffer:400},"save-all":{fn:this.relate,scope:this}}),this.store=new Ext.data.DirectStore({autoLoad:!1,autoSave:!1,batch:!0,pruneModifiedRecords:!0,remoteSort:!1,restful:!1,autoDestroy:!0,root:"rows",idProperty:"id",fields:Garp.dataTypes[this.model].getStoreFieldsFromColumnModel(),totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo,baseParams:{start:0,limit:Garp.pageSize},api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}})},getParentForm:function(){return this.findParentBy(function(e){return e.getForm})},onSelectionChange:function(){this.clearValue(),this.clearInvalid(),this.disable(),this.suspendEvents();var e=this.getParentForm().getForm().findField("id").getValue(),t={};t[this.rule+".id"]=e,Garp[this.model].fetch({rule:this.rule,query:t},function(e){e.rows.length?Ext.each(e.rows,function(e){this.addRecord(this.createRecord(e))},this):this.applyEmptyText(),this.originalValue=this.getValue(),this.resumeEvents(),this.enable()},this)},relate:function(){this.getParentForm().getForm().findField("id").getValue()&&(this.items.length||this.isDirty())&&Garp[Garp.currentModel].relate({model:this.model,rule:this.rule,unrelateExisting:!0,primaryKey:this.getParentForm().getForm().findField("id").getValue(),foreignKeys:function(){var e=[];return this.items.each(function(t){e.push({key:t.value})}),e}.call(this)},this.onSelectionChange,this)},onRender:function(e,t){var i=this.hiddenName;this.hiddenName=null,Ext.ux.form.SuperBoxSelect.superclass.onRender.call(this,e,t),this.hiddenName=i,this.manageNameAttribute();var s=this.stackItems===!0?"x-superboxselect-stacked":"";this.renderFieldBtns&&(s+=" x-superboxselect-display-btns"),this.el.removeClass("x-form-text").addClass("x-superboxselect-input-field"),this.wrapEl=this.el.wrap({tag:"ul"}),this.outerWrapEl=this.wrapEl.wrap({tag:"div",cls:"x-form-text x-superboxselect "+s}),this.inputEl=this.el.wrap({tag:"li",cls:"x-superboxselect-input"}),this.renderFieldBtns&&this.setupFieldButtons().manageClearBtn(),this.setupFormInterception()},onStoreLoad:function(e,t,i){var s=i.params[this.queryParam]||e.baseParams[this.queryParam]||"",a=i.params[this.queryValuesIndicator]||e.baseParams[this.queryValuesIndicator];if(s&&s.or&&(s=s.or["name like"]),this.removeValuesFromStore&&this.store.each(function(e){this.usedRecords.containsKey(e.get(this.valueField))&&this.store.remove(e)},this),a){var n=s.split(this.queryValuesDelimiter);Ext.each(n,function(e){this.remoteLookup.remove(e);var t=this.findRecord(this.valueField,e);t&&this.addRecord(t)},this),this.setOriginal&&(this.setOriginal=!1,this.originalValue=this.getValue())}""!==s&&this.allowAddNewData&&Ext.each(this.remoteLookup,function(e){if("object"==typeof e&&e[this.displayField]==s){if(this.remoteLookup.remove(e),t.length&&t[0].get(this.displayField)===s)return void this.addRecord(t[0]);var i=this.createRecord(e);return this.store.add(i),this.addRecord(i),this.addedRecords.push(i),void function(){this.isExpanded()&&this.collapse()}.defer(10,this)}},this);var r=[];if(""===s)Ext.each(this.addedRecords,function(e){this.preventDuplicates&&this.usedRecords.containsKey(e.get(this.valueField))||r.push(e)},this);else{var o=new RegExp(Ext.escapeRe(s)+".*","i");Ext.each(this.addedRecords,function(e){this.preventDuplicates&&this.usedRecords.containsKey(e.get(this.valueField))||o.test(e.get(this.displayField))&&r.push(e)},this)}this.store.add(r),this.store.sort(this.displayField,"ASC"),0===this.store.getCount()&&this.isExpanded()&&this.collapse()},doTransform:function(){var e=Ext.getDom(this.transform),t=[];if(!this.store){this.mode="local";for(var i=[],s=e.options,a=0,n=s.length;n>a;a++){var r=s[a],o=Ext.get(r),l=o.getAttributeNS(null,"value")||"",d=o.getAttributeNS(null,"className")||"",h=o.getAttributeNS(null,"style")||"";r.selected&&t.push(l),i.push([l,r.text,d,"string"==typeof h?h:h.cssText])}this.store=new Ext.data.SimpleStore({id:0,fields:["value","text","cls","style"],data:i}),Ext.apply(this,{valueField:"value",displayField:"text",classField:"cls",styleField:"style"})}t.length&&(this.value=t.join(","))},setupFieldButtons:function(){return this.buttonWrap=this.outerWrapEl.createChild({cls:"x-superboxselect-btns"}),this.buttonClear=this.buttonWrap.createChild({tag:"div",cls:"x-superboxselect-btn-clear "+this.clearBtnCls}),this.buttonExpand=this.buttonWrap.createChild({tag:"div",cls:"x-superboxselect-btn-expand "+this.expandBtnCls}),this.initButtonEvents(),this},initButtonEvents:function(){this.buttonClear.addClassOnOver("x-superboxselect-btn-over").on("click",function(e){e.stopEvent(),this.disabled||(this.clearValue(),this.el.focus())},this),this.buttonExpand.addClassOnOver("x-superboxselect-btn-over").on("click",function(e){e.stopEvent(),this.disabled||(this.isExpanded()?this.multiSelectMode=!1:this.pinList&&(this.multiSelectMode=!0),this.onTriggerClick())},this)},removeButtonEvents:function(){return this.buttonClear.removeAllListeners(),this.buttonExpand.removeAllListeners(),this},clearCurrentFocus:function(){return this.currentFocus&&(this.currentFocus.onLnkBlur(),this.currentFocus=null),this},initEvents:function(){var e=this.el;e.on({click:this.onClick,focus:this.clearCurrentFocus,blur:this.onBlur,keydown:this.onKeyDownHandler,keyup:this.onKeyUpBuffered,scope:this}),this.on({collapse:this.onCollapse,expand:this.clearCurrentFocus,scope:this}),this.wrapEl.on("click",this.onWrapClick,this),this.outerWrapEl.on("click",this.onWrapClick,this),this.inputEl.focus=function(){e.focus()},Ext.ux.form.SuperBoxSelect.superclass.initEvents.call(this),Ext.apply(this.keyNav,{tab:function(t){return this.fixFocusOnTabSelect&&this.isExpanded()?(t.stopEvent(),e.blur(),this.onViewClick(!1),this.focus(!1,10),!0):(this.onViewClick(!1),""!==e.dom.value&&this.setRawValue(""),!0)},down:function(){this.isExpanded()||this.currentFocus?(this.inKeyMode=!0,this.selectNext()):this.onTriggerClick()},enter:function(){}})},onClick:function(){this.clearCurrentFocus(),this.collapse(),this.autoSize()},beforeBlur:Ext.form.ComboBox.superclass.beforeBlur,onFocus:function(){this.outerWrapEl.addClass(this.focusClass),Ext.ux.form.SuperBoxSelect.superclass.onFocus.call(this)},onBlur:function(){this.outerWrapEl.removeClass(this.focusClass),this.clearCurrentFocus(),""!==this.el.dom.value&&(this.applyEmptyText(),this.autoSize()),Ext.ux.form.SuperBoxSelect.superclass.onBlur.call(this)},onCollapse:function(){this.view.clearSelections(),this.multiSelectMode=!1},onWrapClick:function(e){e.stopEvent(),this.collapse(),this.el.focus(),this.clearCurrentFocus()},markInvalid:function(e){var t,i;if(this.rendered&&!this.preventMark){switch(this.outerWrapEl.addClass(this.invalidClass),e=e||this.invalidText,this.msgTarget){case"qtip":Ext.apply(this.el.dom,{qtip:e,qclass:"x-form-invalid-tip"}),Ext.apply(this.wrapEl.dom,{qtip:e,qclass:"x-form-invalid-tip"}),Ext.QuickTips&&Ext.QuickTips.enable();break;case"title":this.el.dom.title=e,this.wrapEl.dom.title=e,this.outerWrapEl.dom.title=e;break;case"under":if(!this.errorEl){if(t=this.getErrorCt(),!t){this.el.dom.title=e;break}this.errorEl=t.createChild({cls:"x-form-invalid-msg"}),this.errorEl.setWidth(t.getWidth(!0)-20)}this.errorEl.update(e),Ext.form.Field.msgFx[this.msgFx].show(this.errorEl,this);break;case"side":if(!this.errorIcon){if(t=this.getErrorCt(),!t){this.el.dom.title=e;break}this.errorIcon=t.createChild({cls:"x-form-invalid-icon"})}this.alignErrorIcon(),Ext.apply(this.errorIcon.dom,{qtip:e,qclass:"x-form-invalid-tip"}),this.errorIcon.show(),this.on("resize",this.alignErrorIcon,this);break;default:i=Ext.getDom(this.msgTarget),i.innerHTML=e,i.style.display=this.msgDisplay}this.fireEvent("invalid",this,e)}},clearInvalid:function(){if(this.rendered&&!this.preventMark){switch(this.outerWrapEl.removeClass(this.invalidClass),this.msgTarget){case"qtip":this.el.dom.qtip="",this.wrapEl.dom.qtip="";break;case"title":this.el.dom.title="",this.wrapEl.dom.title="",this.outerWrapEl.dom.title="";break;case"under":this.errorEl&&Ext.form.Field.msgFx[this.msgFx].hide(this.errorEl,this);break;case"side":this.errorIcon&&(this.errorIcon.dom.qtip="",this.errorIcon.hide(),this.un("resize",this.alignErrorIcon,this));break;default:var e=Ext.getDom(this.msgTarget);e.innerHTML="",e.style.display="none"}this.fireEvent("valid",this)}},alignErrorIcon:function(){this.wrap&&this.errorIcon.alignTo(this.wrap,"tl-tr",[Ext.isIE?5:2,3])},expand:function(){!this.isExpanded()&&this.hasFocus&&(this.list.alignTo(this.outerWrapEl,this.listAlign).show(),this.innerList.setOverflow("auto"),Ext.getDoc().on({mousewheel:this.collapseIf,mousedown:this.collapseIf,scope:this}),this.fireEvent("expand",this))},restrictHeight:function(){var e=this.innerList.dom,t=e.scrollTop,i=this.list;e.style.height="";var s=i.getFrameWidth("tb")+(this.resizable?this.handleHeight:0)+this.assetHeight,a=Math.max(e.clientHeight,e.offsetHeight,e.scrollHeight),n=this.getPosition()[1]-Ext.getBody().getScroll().top,r=Ext.lib.Dom.getViewHeight()-n-this.getSize().height,o=Math.max(n,r,this.minHeight||0)-i.shadowOffset-s-5;a=Math.min(a,o,this.maxHeight),this.innerList.setHeight(a),i.beginUpdate(),i.setHeight(a+s),i.alignTo(this.outerWrapEl,this.listAlign),i.endUpdate(),this.multiSelectMode&&(e.scrollTop=t)},validateValue:function(){return 0===this.items.getCount()?this.allowBlank?(this.clearInvalid(),!0):(this.markInvalid(this.blankText),!1):(this.clearInvalid(),!0)},manageNameAttribute:function(){0===this.items.getCount()&&this.forceFormValue?this.el.dom.setAttribute("name",this.hiddenName||this.name):this.el.dom.removeAttribute("name")},setupFormInterception:function(){var e=this.getParentForm().form;if(e){var t=e.getValues;e.getValues=function(i){this.el.dom.disabled=!0;var s=this.el.dom.value;this.setRawValue("");var a=t.call(e);return this.el.dom.disabled=!1,this.setRawValue(s),this.forceFormValue&&0===this.items.getCount()&&(a[this.name]=""),i?Ext.urlEncode(a):a}.createDelegate(this)}},onResize:function(e,t,i,s){var a=Ext.isIE6?4:Ext.isIE7?1:Ext.isIE8?1:0;this.wrapEl&&(this._width=e,this.outerWrapEl.setWidth(e-a),this.renderFieldBtns&&(a+=this.buttonWrap.getWidth()+20,this.wrapEl.setWidth(e-a))),Ext.ux.form.SuperBoxSelect.superclass.onResize.call(this,e,t,i,s),this.autoSize()},onEnable:function(){Ext.ux.form.SuperBoxSelect.superclass.onEnable.call(this),this.items.each(function(e){e.enable()}),this.renderFieldBtns&&this.initButtonEvents()},onDisable:function(){Ext.ux.form.SuperBoxSelect.superclass.onDisable.call(this),this.items.each(function(e){e.disable()}),this.renderFieldBtns&&this.removeButtonEvents()},clearValue:function(e){return Ext.ux.form.SuperBoxSelect.superclass.clearValue.call(this),this.preventMultipleRemoveEvents=e||this.supressClearValueRemoveEvents||!1,this.removeAllItems(),this.preventMultipleRemoveEvents=!1,this.fireEvent("clear",this),this},onKeyUp:function(e){this.editable===!1||e.isSpecialKey()&&e.getKey()!==e.BACKSPACE||e.getKey()===this.itemDelimiterKey||e.hasModifier()&&!e.shiftKey||(this.lastKey=e.getKey(),this.dqTask.delay(this.queryDelay))},onKeyDownHandler:function(e){var t,i,s;if((e.getKey()===e.DELETE||e.getKey()===e.SPACE)&&this.currentFocus)return e.stopEvent(),t=this.currentFocus,this.on("expand",function(){this.collapse()},this,{single:!0}),s=this.items.indexOfKey(this.currentFocus.key),this.clearCurrentFocus(),s<this.items.getCount()-1&&(i=this.items.itemAt(s+1)),t.preDestroy(!0),i&&function(){i.onLnkFocus(),this.currentFocus=i}.defer(200,this),!0;var a,n=this.el.dom.value,r=e.ctrlKey;if(e.getKey()===this.itemDelimiterKey){if(e.stopEvent(),""!==n)r||!this.isExpanded()?(this.view.clearSelections(),this.collapse(),this.setRawValue(""),this.fireEvent("newitem",this,n)):(this.onViewClick(),this.unsetDelayCheck&&(this.delayedCheck=!0,this.unsetDelayCheck.defer(10,this)));else{if(!this.isExpanded())return;this.onViewClick(),this.unsetDelayCheck&&(this.delayedCheck=!0,this.unsetDelayCheck.defer(10,this))}return!0}return""!==n?void this.autoSize():e.getKey()===e.HOME?(e.stopEvent(),this.items.getCount()>0&&(this.collapse(),a=this.items.get(0),a.el.focus()),!0):e.getKey()===e.BACKSPACE?(e.stopEvent(),this.currentFocus?(t=this.currentFocus,this.on("expand",function(){this.collapse()},this,{single:!0}),s=this.items.indexOfKey(t.key),this.clearCurrentFocus(),s<this.items.getCount()-1&&(i=this.items.itemAt(s+1)),t.preDestroy(!0),void(i&&function(){i.onLnkFocus(),this.currentFocus=i}.defer(200,this))):(a=this.items.get(this.items.getCount()-1),a&&(this.backspaceDeletesLastItem?(this.on("expand",function(){this.collapse()},this,{single:!0}),a.preDestroy(!0)):this.navigateItemsWithTab?a.onElClick():this.on("expand",function(){this.collapse(),this.currentFocus=a,this.currentFocus.onLnkFocus.defer(20,this.currentFocus)},this,{single:!0})),!0)):e.isNavKeyPress()?e.getKey()===e.LEFT||e.getKey()===e.UP&&!this.isExpanded()?(e.stopEvent(),this.collapse(),a=this.items.get(this.items.getCount()-1),this.navigateItemsWithTab?a&&a.focus():this.currentFocus?(s=this.items.indexOfKey(this.currentFocus.key),this.clearCurrentFocus(),0!==s&&(this.currentFocus=this.items.itemAt(s-1),this.currentFocus.onLnkFocus())):(this.currentFocus=a,a&&a.onLnkFocus()),!0):e.getKey()===e.DOWN&&this.currentFocus?(this.collapse(),e.stopEvent(),s=this.items.indexOfKey(this.currentFocus.key),s==this.items.getCount()-1?this.clearCurrentFocus.defer(10,this):(this.clearCurrentFocus(),this.currentFocus=this.items.itemAt(s+1),this.currentFocus&&this.currentFocus.onLnkFocus()),!0):void(e.getKey()===e.RIGHT&&(this.collapse(),a=this.items.itemAt(0),this.navigateItemsWithTab?a&&a.focus():this.currentFocus?(s=this.items.indexOfKey(this.currentFocus.key),this.clearCurrentFocus(),s<this.items.getCount()-1&&(this.currentFocus=this.items.itemAt(s+1),this.currentFocus&&this.currentFocus.onLnkFocus())):(this.currentFocus=a,a&&a.onLnkFocus()))):(this.multiSelectMode=!1,void this.clearCurrentFocus())},onKeyUpBuffered:function(e){e.isNavKeyPress()||this.autoSize()},reset:function(){this.killItems(),Ext.ux.form.SuperBoxSelect.superclass.reset.call(this),this.addedRecords=[],this.autoSize().setRawValue("")},applyEmptyText:function(){return this.setRawValue(""),this.items.getCount()>0?(this.el.removeClass(this.emptyClass),this.setRawValue(""),this):(this.rendered&&this.emptyText&&this.getRawValue().length<1&&(this.setRawValue(this.emptyText),this.el.addClass(this.emptyClass)),this)},removeAllItems:function(){return this.items.each(function(e){e.preDestroy(!0)},this),this.manageClearBtn(),this},killItems:function(){return this.items.each(function(e){e.kill()},this),this.resetStore(),this.items.clear(),this.manageClearBtn(),this},resetStore:function(){return this.store.clearFilter(),this.removeValuesFromStore?(this.usedRecords.each(function(e){this.store.add(e)},this),this.usedRecords.clear(),this.sortStore(),this):this},sortStore:function(){var e=this.store.getSortState();return e&&e.field&&this.store.sort(e.field,e.direction),this},getCaption:function(e){"string"==typeof this.displayFieldTpl&&(this.displayFieldTpl=new Ext.XTemplate(this.displayFieldTpl));var t,i=e instanceof Ext.data.Record?e.data:e;return this.displayFieldTpl?t=this.displayFieldTpl.apply(i):this.displayField&&(t=i[this.displayField]),t},addRecord:function(e){var t=e.data[this.displayField],i=this.getCaption(e),s=e.data[this.valueField],a=this.classField?e.data[this.classField]:"",n=this.styleField?e.data[this.styleField]:"";this.removeValuesFromStore&&(this.usedRecords.add(s,e),this.store.remove(e)),this.addItemBox(s,t,i,a,n),this.fireEvent("additem",this,s,e)},createRecord:function(e){if(!this.recordConstructor){var t=[{name:this.valueField},{name:this.displayField}];this.classField&&t.push({name:this.classField}),this.styleField&&t.push({name:this.styleField}),this.recordConstructor=Ext.data.Record.create(t)}return new this.recordConstructor(e)},addItems:function(e){Ext.isArray(e)?Ext.each(e,function(e){this.addItem(e)},this):this.addItem(e)},addNewItem:function(e){this.addItem(e,!0)},addItem:function(e,t){var i=e[this.valueField];if(this.disabled)return!1;if(!this.preventDuplicates||!this.hasValue(i)){var s=this.findRecord(this.valueField,i);if(s)return void this.addRecord(s);if(this.allowAddNewData){if("remote"===this.mode)return this.remoteLookup.push(e),void this.doQuery(i,!1,!1,t);var a=this.createRecord(e);return this.store.add(a),this.addRecord(a),!0}}},addItemBox:function(e,t,i,s,a){var n,r=function(e){var t="";if("function"==typeof e)t=e.call();else if("object"==typeof e)for(var i in e)t+=i+":"+e[i]+";";else"string"==typeof e&&(t=e+";");return t},o=Ext.id(null,"sbx-item"),l=new Ext.ux.form.SuperBoxSelectItem({owner:this,disabled:this.disabled,renderTo:this.wrapEl,cls:this.extraItemCls+" "+s,style:r(this.extraItemStyle)+" "+a,caption:i,display:t,value:e,key:o,listeners:{remove:function(e){this.fireEvent("beforeremoveitem",this,e.value)!==!1&&(this.items.removeKey(e.key),this.removeValuesFromStore&&this.usedRecords.containsKey(e.value)&&(this.store.add(this.usedRecords.get(e.value)),this.usedRecords.removeKey(e.value),this.sortStore(),this.view&&this.view.render()),this.preventMultipleRemoveEvents||this.fireEvent.defer(250,this,["removeitem",this,e.value,this.findInStore(e.value)]))},destroy:function(){this.collapse(),this.autoSize().manageClearBtn().validateValue()},scope:this}});l.render(),n={tag:"input",type:"hidden",value:e,name:this.hiddenName||this.name},this.disabled&&Ext.apply(n,{disabled:"disabled"}),l.hidden=this.el.insertSibling(n,"before"),this.items.add(o,l),this.applyEmptyText().autoSize().manageClearBtn().validateValue()},manageClearBtn:function(){if(!this.renderFieldBtns||!this.rendered)return this;var e="x-superboxselect-btn-hide";return 0===this.items.getCount()?this.buttonClear.addClass(e):this.buttonClear.removeClass(e),this},findInStore:function(e){var t=this.store.find(this.valueField,e);return t>-1?this.store.getAt(t):!1},getValue:function(){var e=[];return this.items.each(function(t){e.push(t.value)}),e.join(this.valueDelimiter)},getValueEx:function(){var e=[];return this.items.each(function(t){var i={};i[this.valueField]=t.value,i[this.displayField]=t.display,this.classField&&(i[this.classField]=t.cls||""),this.styleField&&(i[this.styleField]=t.style||""),e.push(i)},this),e},initValue:function(){Ext.ux.form.SuperBoxSelect.superclass.initValue.call(this),"remote"===this.mode&&(this.setOriginal=!0)},setValue:function(e){if(!this.rendered)return void(this.value=e);if(this.removeAllItems().resetStore(),this.remoteLookup=[],!Ext.isEmpty(e)){var t=e;if(Ext.isArray(e)||(e=""+e,t=e.split(this.valueDelimiter)),Ext.each(t,function(e){var t=this.findRecord(this.valueField,e);t?this.addRecord(t):"remote"===this.mode&&this.remoteLookup.push(e)},this),"remote"===this.mode){var i=this.remoteLookup.join(this.queryValuesDelimiter);this.doQuery(i,!1,!0)}}},setValueEx:function(e){return this.removeAllItems().resetStore(),Ext.isArray(e)||(e=[e]),this.remoteLookup=[],this.allowAddNewData&&"remote"===this.mode?void Ext.each(e,function(e){var t=this.findRecord(this.valueField,e[this.valueField])||this.createRecord(e);this.addRecord(t)},this):void Ext.each(e,function(e){this.addItem(e)},this)},hasValue:function(e){var t=!1;return this.items.each(function(i){return i.value==e?(t=!0,!1):void 0},this),t},onSelect:function(e,t){if(this.fireEvent("beforeselect",this,e,t)!==!1){var i=e.data[this.valueField];if(this.preventDuplicates&&this.hasValue(i))return;
this.setRawValue(""),this.lastSelectionText="",this.fireEvent("beforeadditem",this,i)!==!1&&this.addRecord(e),0!==this.store.getCount()&&this.multiSelectMode?this.restrictHeight():this.collapse()}},onDestroy:function(){this.items.purgeListeners(),this.killItems(),this.renderFieldBtns&&Ext.destroy(this.buttonClear,this.buttonExpand,this.buttonWrap),Ext.destroy(this.inputEl,this.wrapEl,this.outerWrapEl),Ext.ux.form.SuperBoxSelect.superclass.onDestroy.call(this)},autoSize:function(){if(!this.rendered)return this;this.metrics||(this.metrics=Ext.util.TextMetrics.createInstance(this.el));var e=this.el,t=e.dom.value,i=document.createElement("div");""===t&&this.emptyText&&this.items.getCount()<1&&(t=this.emptyText),i.appendChild(document.createTextNode(t)),t=i.innerHTML,i=null,t+="&#160;";var s=Math.max(this.metrics.getWidth(t)+24,24);return"undefined"!=typeof this._width&&(s=Math.min(this._width,s)),this.el.setWidth(s),Ext.isIE&&(this.el.dom.style.top="0"),this},doQuery:function(e,t,i,s){e=Ext.isEmpty(e)?"":e;var a={query:e,forceAll:t,combo:this,cancel:!1};return this.fireEvent("beforequery",a)===!1||a.cancel?!1:(e=a.query,t=a.forceAll,void((t===!0||e.length>=this.minChars||i&&!Ext.isEmpty(e))&&(this.lastQuery!==e||s?(this.lastQuery=e,"local"==this.mode?(this.selectedIndex=-1,t?this.store.clearFilter():this.store.filter(this.displayField,e),this.onLoad()):(this.store.baseParams[this.queryParam]=e,this.store.baseParams[this.queryValuesIndicator]=i,this.store.load({params:this.getParams(e)}),s||this.expand())):(this.selectedIndex=-1,this.onLoad()))))}}),Ext.reg("superboxselect",Ext.ux.form.SuperBoxSelect),Ext.ux.form.SuperBoxSelectItem=function(e){Ext.apply(this,e),Ext.ux.form.SuperBoxSelectItem.superclass.constructor.call(this)},Ext.ux.form.SuperBoxSelectItem=Ext.extend(Ext.ux.form.SuperBoxSelectItem,Ext.Component,{initComponent:function(){Ext.ux.form.SuperBoxSelectItem.superclass.initComponent.call(this)},onElClick:function(){var e=this.owner;if(e.clearCurrentFocus().collapse(),e.navigateItemsWithTab)this.focus();else{e.el.dom.focus();(function(){this.onLnkFocus(),e.currentFocus=this}).defer(10,this)}},onLnkClick:function(e){e&&e.stopEvent(),this.preDestroy(),this.owner.navigateItemsWithTab||this.owner.el.focus()},onLnkFocus:function(){this.el.addClass("x-superboxselect-item-focus"),this.owner.outerWrapEl.addClass("x-form-focus")},onLnkBlur:function(){this.el.removeClass("x-superboxselect-item-focus"),this.owner.outerWrapEl.removeClass("x-form-focus")},enableElListeners:function(){this.el.on("click",this.onElClick,this,{stopEvent:!0}),this.el.addClassOnOver("x-superboxselect-item x-superboxselect-item-hover"),this.el.on("mouseout",function(){this.el.removeClass("x-superboxselect-item-hover")},this)},enableLnkListeners:function(){this.lnk.on({click:this.onLnkClick,focus:this.onLnkFocus,blur:this.onLnkBlur,scope:this})},enableAllListeners:function(){this.enableElListeners(),this.enableLnkListeners()},disableAllListeners:function(){this.el.removeAllListeners(),this.lnk.un("click",this.onLnkClick,this),this.lnk.un("focus",this.onLnkFocus,this),this.lnk.un("blur",this.onLnkBlur,this)},onRender:function(e,t){Ext.ux.form.SuperBoxSelectItem.superclass.onRender.call(this,e,t);var i=this.el;i&&i.remove(),this.el=i=e.createChild({tag:"li"},e.last()),i.addClass("x-superboxselect-item");{var s=this.owner.navigateItemsWithTab?Ext.isSafari?"button":"a":"span";this.key}Ext.apply(i,{focus:function(){var e=this.down(s+".x-superboxselect-item-close");e&&e.focus()},preDestroy:function(){this.preDestroy()}.createDelegate(this)}),this.enableElListeners(),i.update(this.caption);var a={tag:s,"class":"x-superboxselect-item-close",tabIndex:this.owner.navigateItemsWithTab?"0":"-1"};"a"===s&&(a.href="#"),this.lnk=i.createChild(a),this.disabled?this.disableAllListeners():this.enableLnkListeners(),this.on({disable:this.disableAllListeners,enable:this.enableAllListeners,scope:this}),this.setupKeyMap()},setupKeyMap:function(){this.keyMap=new Ext.KeyMap(this.lnk,[{key:[Ext.EventObject.BACKSPACE,Ext.EventObject.DELETE,Ext.EventObject.SPACE],fn:this.preDestroy,scope:this},{key:[Ext.EventObject.RIGHT,Ext.EventObject.DOWN],fn:function(){this.moveFocus("right")},scope:this},{key:[Ext.EventObject.LEFT,Ext.EventObject.UP],fn:function(){this.moveFocus("left")},scope:this},{key:[Ext.EventObject.HOME],fn:function(){var e=this.owner.items.get(0).el.focus();e&&e.el.focus()},scope:this},{key:[Ext.EventObject.END],fn:function(){this.owner.el.focus()},scope:this},{key:Ext.EventObject.ENTER,fn:function(){}}]),this.keyMap.stopEvent=!0},moveFocus:function(e){var t=this.el["left"==e?"prev":"next"]()||this.owner.el;t.focus.defer(100,t)},preDestroy:function(e){if(this.fireEvent("remove",this)!==!1){var t=function(){this.owner.navigateItemsWithTab&&this.moveFocus("right"),this.hidden.remove(),this.hidden=null,this.destroy()};return e?t.call(this):this.el.hide({duration:.2,callback:t,scope:this}),this}},kill:function(){this.hidden.remove(),this.hidden=null,this.purgeListeners(),this.destroy()},onDisable:function(){this.hidden&&this.hidden.dom.setAttribute("disabled","disabled"),this.keyMap.disable(),Ext.ux.form.SuperBoxSelectItem.superclass.onDisable.call(this)},onEnable:function(){this.hidden&&this.hidden.dom.removeAttribute("disabled"),this.keyMap.enable(),Ext.ux.form.SuperBoxSelectItem.superclass.onEnable.call(this)},onDestroy:function(){Ext.destroy(this.lnk,this.el),Ext.ux.form.SuperBoxSelectItem.superclass.onDestroy.call(this)}}),Ext.ns("Garp"),Garp.MetaPanel=Ext.extend(Ext.Container,{disablePublishedEdit:!1,disableCreatedEdit:!1,disableAuthorIdEdit:!1,region:"east",width:190,maxWidth:190,header:!1,border:!1,cls:"garp-metapanel",ref:"metaPanel",monitorValid:!1,processData:function(e){this.rec=e,this.update(e.data),this.bindEditors(),Ext.get("author-name").update(e.get("author")),Ext.get("modifier-name").update(e.get("modifier"))},buildTplItem:function(e){if(Ext.isObject(e))return e.tpl||"";var t="";return t+="<h3>"+__(e)+"</h3>",t+="<p>{"+e+"}</p>"},buildTpl:function(){var e=Garp.dataTypes[Garp.currentModel].metaPanelItems,t=[];Ext.each(e,function(e){switch(e){case"created":t.push("<h3>",__("Created"),"</h3>",'<span id="author-image"></span>','<a id="author-name"></a>','<a id="created-date">{[Garp.renderers.metaPanelDateRenderer(values.created)]}</a>');break;case"modified":t.push("<h3>",__("Modified"),"</h3>",'<span id="modifier-image"></span>','<p id="modifier-name"></p>','<p id="modified-date">{[Garp.renderers.metaPanelDateRenderer(values.modified)]}</p>');break;case"published":t.push("<h3>",__("Published"),"</h3>",'<tpl if="typeof online_status !== &quot;undefined&quot;  && online_status === &quot;1&quot;">',this.disablePublishedEdit?'<span class="published-date">{[Garp.renderers.metaPanelDateRenderer(values.published)]}</span>':['<a class="published-date">{[Garp.renderers.metaPanelDateRenderer(values.published)]}</a>','<tpl if="values.published">',' <a class="remove-published-date" title="',__("Delete"),'"> </a>',"</tpl>"].join(""),"</tpl>",'<div id="online-status">',__("Draft"),": ",'<tpl if="typeof online_status !== &quot;undefined&quot; && online_status == &quot;1&quot;">','<input type="checkbox">',"</tpl>",'<tpl if="typeof online_status !== &quot;undefined&quot;  && (!online_status || online_status === &quot;0&quot;) ">','<input type="checkbox" checked>',"</tpl></div>");break;default:t.push(this.buildTplItem(e))}},this),t.push('<div class="copyright">',"Garp &copy {[Garp.renderers.yearRenderer(new Date())]} by ",'<a href="http://grrr.nl/" target="_blank">',"Grrr","</a><br>version 3.5","</div>"),this.tpl=new Ext.XTemplate(t,{compiled:!0})},setVal:function(e,t){var i=Garp.gridPanel.getSelectionModel().getSelected();i.get("name")!=t&&(this.fireEvent("dirty"),i.beginEdit(),i.set(e,t),i.endEdit(),i.phantom||(this.disable(),this.fireEvent("save-all")))},bindEditors:function(){this.el.select("#author-name").un("click").on("click",function(e,t){this.disableAuthorIdEdit||(this.authorIdEditor.startEdit(t,this.rec.get("author_id")),this.authorIdEditor.field.triggerFn(),this.authorIdEditor.el.hide())},this),this.el.select("#online-status input").un("click").on("click",function(e,t){this.setVal("online_status",Ext.get(t).getAttribute("checked")?"0":"1",!0)},this),this.el.select("#created-date").un("click").on("click",function(e,t){this.disableCreatedEdit||(this.createdDateEditor.startEdit(t,this.rec.get("created")),this.createdDateEditor.field.df.onTriggerClick())},this),this.el.select(".published-date").un("click").on("click",function(e,t){this.disablePublishedEdit||(this.publishedDateEditor.startEdit(t,this.rec.get("published")),this.publishedDateEditor.field.df.onTriggerClick())},this),this.el.select(".remove-published-date").un("click").on("click",function(){this.setVal("published",null)},this)},buildEditors:function(){var e={field:{xtype:"xdatetime",width:180,emptyText:__("No date specified"),timeConfig:{increment:30},dateConfig:{emptyText:__("No date specified")},timeWidth:60,dateFormat:"j M Y"},offsets:[0,-6],alignment:"tl?",completeOnEnter:!0,cancelOnEsc:!0,updateEl:!1,ignoreNoChange:!0};this.authorIdEditor=new Ext.Editor(Ext.apply({},{disabled:this.disableAuthorIdEdit,field:{xtype:"relationfield",model:"User",displayField:"fullname",listeners:{select:function(e){e&&e.selected&&this.setVal("author_id",e.selected.id),this.authorIdEditor.completeEdit()},scope:this}}},e)),this.createdDateEditor=new Ext.Editor(Ext.apply({},{disabled:this.disableCreatedEdit,listeners:{beforecomplete:function(e,t){t&&this.setVal("created",t)},scope:this}},e)),this.publishedDateEditor=new Ext.Editor(Ext.apply({},{disabled:this.disablePublishedEdit,listeners:{beforecomplete:function(e,t){t&&this.setVal("published",t)},scope:this}},e))},initComponent:function(e){this.buildTpl(),this.buildEditors(),Garp.MetaPanel.superclass.initComponent.call(this,e),this.on({loaddata:{fn:this.processData,scope:this}})}}),Garp.ModelMenu=function(e){Ext.apply(this,e);var t=[];for(var i in Garp.dataTypes)-1==this.menuItems.indexOf(i)&&this.menuItems.push(i);t.push(function(){var e=[];return Ext.each(this.menuItems,function(t){if("-"==t)e.length>0&&"-"!=e[e.length-1]&&e.push("-");else{if(!Garp.dataTypes[t])throw'Oops! JS model "'+t+'" not found! Is it spawned and bugfree?';var i=Garp.dataTypes[t];if(!Garp[t])throw'Oops! dataType "'+t+'" not found! Does it exist in the smd?';i.setupACL(Garp[t])?(i.fireEvent("init"),e.push({hidden:i.hidden,text:__(i.text),name:i.text,iconCls:i.iconCls,handler:function(){Garp.viewport.formPanelCt.show(),Garp.viewport.gridPanelCt.expand(),Garp.eventManager.fireEvent("modelchange",!0,t,null,null)}})):delete Garp.dataTypes[i.text]}}),e}.call(this)),Garp.ModelMenu.superclass.constructor.call(this,Ext.applyIf(e,{cls:"garp-model-menu",text:__("Content"),iconCls:"icon-no-model",menu:new Ext.menu.Menu({items:t})})),this.on("afterrender",function(){this.getEl().on("click",function(){Garp.viewport.gridPanelCt.expand()})},this)},Ext.extend(Garp.ModelMenu,Ext.Button,{}),Garp.WelcomePanel=function(e){this.html=Ext.getDom("welcome-panel-content").innerHTML,Garp.WelcomePanel.superclass.constructor.call(this,e)},Ext.extend(Garp.WelcomePanel,Ext.Container,{border:!0,hideButtonArr:["newButton","deleteButton","separator"],listeners:{render:function(){Ext.each(this.hideButtonArr,function(e){Garp.toolbar[e].hide()})},destroy:function(){Ext.each(this.hideButtonArr,function(e){Garp.toolbar[e].show()})}}}),Garp.GridPanel=Ext.extend(Ext.grid.GridPanel,{loadMask:!0,model:null,newItem:function(){if(!this.disabled&&!Garp.dataTypes[Garp.currentModel].disableCreate){var e=new this.store.recordType(Ext.apply({},Garp.dataTypes[this.model].defaultData));this.store.insert(0,e),this.getSelectionModel().selectFirstRow()}},deleteItems:function(){var e=this.getSelectionModel().getCount();if(!(0>=e)){var t=this.getSelectionModel().getSelected();return t.phantom?(this.store.remove(t),this.getSelectionModel().clearSelections(),void this.fireEvent("afterdelete")):void(this.disabled||Garp.dataTypes[Garp.currentModel].disableDelete||Ext.Msg.confirm(__("Garp"),__(1==e?"Are you sure you want to delete the selected item?":"Are you sure you want to delete the selected items?"),function(e){var t=this.getSelectionModel();"yes"==e&&(Ext.each(t.getSelections(),function(e){this.store.remove(e)}),this.getStore().save(),t.clearSelections(),this.fireEvent("afterdelete")),t.selectRow(t.last)},this))}},saveAll:function(){this.fireEvent("beforesave");var e=this.getView().scroller.getScroll().top;this.getStore().getModifiedRecords().length>0&&this.loadMask.show();var t=this.getStore().getModifiedRecords();t.length&&(t=t[0]),this.getStore().on({save:{fn:function(i){0===this.getStore().getModifiedRecords().length&&(i.on({load:{scope:this,single:!0,fn:function(){if(t&&t.get&&!i.getById(t.get("id")))this.getStore().on({load:{scope:this,single:!0,fn:function(){this.loadMask.hide(),this.getSelectionModel().selectFirstRow(),this.getTopToolbar().searchById(t.get("id")),this.fireEvent("after-save",this.getSelectionModel()),this.enable()}}}),this.getStore().load({params:{query:{id:t.get("id")}}});else{this.loadMask.hide(),this.fireEvent("after-save",this.getSelectionModel()),this.enable();var s=this;setTimeout(function(){s.getView().scroller.dom.scrollTop=e},10)}}}}),i.reload())},scope:this,single:!0}}),this.getStore().save()},loadStoreWithDefaults:function(){this.filterMenu&&this.filterMenu.defaultFilter?this.filterMenu.defaultFilter.handler(this.filterMenu.defaultFilter):this.getStore().load()},selectAll:function(){if(this.disabled)return!1;var e=this.getSelectionModel(),t=this.getStore();e.getCount()===t.getCount()?e.clearSelections():e.selectAll()},focus:function(){var e=this.getSelectionModel();e.hasSelection()||e.selectFirstRow();var t=0,i=e.getSelections();i.length&&(t=this.getStore().indexOf(i[0])),this.getView().focusRow(t)},setupEvents:function(){function e(e){return!e.getTarget("input")&&!e.getTarget("textarea")&&!e.getTarget("iframe")}{var t=this.getBottomToolbar();new Ext.KeyMap(this.getEl(),[{key:"a",ctrl:!0,fn:function(t,i){e(i)&&(this.selectAll(),i.stopEvent())},scope:this},{key:Ext.EventObject.DELETE,ctrl:!0,handler:function(t,i){if(e(i)){if(Garp.dataTypes[Garp.currentModel].disableDelete||Garp.toolbar.deleteButton.disabled)return;this.fireEvent("delete"),i.stopEvent()}},scope:this},{key:Ext.EventObject.BACKSPACE,ctrl:!1,handler:function(t,i){if(e(i)){if(Garp.dataTypes[Garp.currentModel].disableDelete||Garp.toolbar.deleteButton.disabled)return;this.fireEvent("delete"),i.stopEvent()}},scope:this}]),new Ext.KeyNav(this.getEl(),{enter:this.fireEvent.createDelegate(this,["defocus"]),pageUp:function(e){e.ctrlKey||e.shiftKey?t.moveFirst():t.cursor>0&&t.movePrevious()},pageDown:function(e){e.ctrlKey||e.shiftKey?t.moveLast():t.cursor+this.getStore().getCount()<this.getStore().getTotalCount()&&t.moveNext()},scope:this})}this.on({scope:this,"new":{fn:this.newItem},"save-all":{fn:this.saveAll,buffer:200},"delete":{fn:this.deleteItems}})},initComponent:function(){function e(e,t){return e.getModifiedRecords().length?(Ext.Msg.show({animEl:Garp.viewport.getEl(),icon:Ext.MessageBox.QUESTION,title:__("Garp"),msg:__("Would you like to save your changes?"),buttons:Ext.Msg.YESNOCANCEL,fn:function(s){switch(s){case"yes":e.on({save:{single:!0,fn:function(){e.load(t)}}}),e.save();break;case"no":e.rejectChanges(),e.on({load:{single:!0,fn:function(){i.getSelectionModel().clearSelections(!1)}}}),e.load(t)}}}),!1):void 0}this.addEvents("beforesave","rowselect","beforerowselect","storeloaded","rowdblclick","selectionchange");var t=Garp.dataTypes[this.model].getStoreFieldsFromColumnModel();this.writer=new Ext.data.JsonWriter({paramsAsHash:!1,encode:!1});var i=this;this.filterMenu=new Garp.FilterMenu,this.store=new Ext.data.DirectStore({autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",fields:t,listeners:{beforeload:e,load:this.fireEvent.createDelegate(this,["storeloaded"]),exception:{scope:this,fn:function(){this.loadMask.hide()}}},totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize},api:{create:Garp[this.model].create||function(){return!0},read:Garp[this.model].fetch||function(){return!0},update:Garp[this.model].update||function(){return!0},destroy:Garp[this.model].destroy||function(){return!0}},writer:this.writer}),i=this,Ext.applyIf(this,{cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:Garp.dataTypes[this.model].columnModel,listeners:{hiddenchange:function(){setTimeout(function(){i.getView().refresh()},100)}}}),pageSize:Garp.pageSize,viewConfig:{scrollOffset:20,emptyText:Ext.PagingToolbar.prototype.emptyMsg,deferEmptyText:!1,deferRowRender:!1,enableRowBody:!0,forceFit:!0,contextRowCls:"garp-contextrow"},store:this.store,border:!1,sm:new Ext.grid.RowSelectionModel({singleSelect:!1}),bbar:new Ext.PagingToolbar({pageSize:Garp.pageSize,displayInfo:!0,store:this.store,plugins:[this.filterMenu]}),tbar:new Ext.ux.Searchbar({layout:"hbox",store:this.store,listeners:{search:{scope:this,fn:function(){this.getBottomToolbar().plugins[0].resetUI()}}}})}),this.relayEvents(this.sm,["beforerowselect","rowselect","selectionchange","rowdblclick"]),Garp.GridPanel.superclass.initComponent.call(this),this.on("render",function(){this.setupEvents()},this),this.on("headerclick",function(e,t){if(e.getColumnModel().columns[t].virtual){var i;return i=e.getColumnModel().columns[t].sortable?e.getColumnModel().columns[t].dataIndex:e.getColumnModel().columns[t].virtualSortField,i&&(e.getStore().on({load:{single:!0,scope:this,fn:function(){for(var i=0,s=e.getColumnModel().columns.length;s>i;i++){var a=Ext.get(e.getView().getHeaderCell(i));a.removeClass("sort-asc"),a.removeClass("sort-desc")}var n=e.getStore().sortInfo.direction.toLowerCase();Ext.get(e.getView().getHeaderCell(t)).addClass("sort-"+n)}}}),e.getStore().sort(i)),!1}})},setupContextMenus:function(){function e(){null!==this._previousContextedRow&&Ext.get(this.getView().getRow(this._previousContextedRow)).removeClass(this.getView().contextRowCls)}var t=this,i={iconCls:"icon-refresh",text:__("Refresh"),handler:function(){t.getStore().reload()}},s={iconCls:"icon-new",text:__("New"),handler:function(){t.newItem()}},a=new Ext.menu.Menu({items:[{iconCls:"icon-open",text:__("Open"),handler:function(){e.call(t),t.getSelectionModel().selectRow(t._previousContextedRow)}},{iconCls:"icon-open-new-window",text:__("Open in new window"),handler:function(){t.fireEvent("open-new-window")}},s,{iconCls:"icon-delete",text:__("Delete"),handler:function(){t.deleteItems()}},"-",i]}),n=new Ext.menu.Menu({items:[s,"-",i]});this.on("contextmenu",function(e){e.stopEvent(),a.hide(),n.showAt(e.getXY())}),this._previousContextedRow=null,this.getView().el.on("click",e.createDelegate(this)),this.getView().el.on("contextmenu",e.createDelegate(this)),this.on("cellcontextmenu",function(t,i,s,r){r.stopEvent();var o=t.getView();e.call(this),Ext.get(o.getRow(i)).addClass(o.contextRowCls),t._previousContextedRow=i,n.hide(),a.showAt(r.getXY())})},afterRender:function(){this.getBottomToolbar().on("defocus",this.focus.createDelegate(this)),Garp.GridPanel.superclass.afterRender.call(this),this.setupContextMenus()}}),Garp.FormPanel=Ext.extend(Ext.FormPanel,{layout:"fit",hideMode:"offsets",monitorValid:!0,trackResetOnLoad:!1,clientValidation:!0,state:null,updateUI:function(){if(this.rec&&this.formcontent.rendered&&!this.hidden){var e=1,t=2,i=4,s=8,a=16,n=32,r=this.getForm().isValid(),o=this.getForm().isDirty(),l=this.state;if(this.state=this.rec.phantom?r?e:t:o?r?a:n:r?i:s,this.state!=l){var d=this.formcontent.getTopToolbar();switch(this.state){case e:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.enable(),d.saveButton.enable(),d.saveAsDraftButton.enable(),d.cancelButton.enable(),d.previewButton.disable();break;case t:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.disable(),d.saveButton.disable(),d.saveAsDraftButton.disable(),d.cancelButton.enable(),d.previewButton.disable();break;case i:this.fireEvent("undirty"),this.enableTabs(),this.metaPanel.enable(),d.saveButton.disable(),d.saveAsDraftButton.disable(),d.cancelButton.disable(),d.previewButton.enable();break;case s:this.fireEvent("undirty"),this.enableTabs(),this.metaPanel.enable(),d.saveButton.disable(),d.saveAsDraftButton.disable(),d.cancelButton.disable(),d.previewButton.disable();break;case a:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.enable(),d.saveButton.enable(),d.saveAsDraftButton.enable(),d.cancelButton.enable(),d.previewButton.disable();break;default:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.disable(),d.saveButton.disable(),d.saveAsDraftButton.disable(),d.cancelButton.enable(),d.previewButton.disable()}}}},disableTabs:function(){this.get(0).items.each(function(e){e!=this.formcontent&&e.disable()},this)},enableTabs:function(){this.get(0).items.each(function(e){e!=this.formcontent&&e.enable()},this)},getTab:function(e){return this.get(0).items.find(function(t){return t.model==e})},newItem:function(){this.form.reset(),function(){this.stopMonitoring(),this.focusFirstField(),this.getForm().items.each(function(e){"function"==typeof e.blur&&(e.on("blur",this.startMonitoring.createDelegate(this),this,{single:!0}),e.on("keyup",this.startMonitoring.createDelegate(this),this,{single:!0}))},this),this.getForm().clearInvalid(),this.updateUI(),this.rec=Garp.gridPanel.getSelectionModel().getSelected(),this.formcontent.fireEvent("loaddata",this.rec,this)}.defer(100,this),this.getForm().clearInvalid()},getErrors:function(){var e="";return this.getForm().items.each(function(t){t.getActiveError()&&(e+=t.getActiveError()+": "+t.fieldLabel+"<br>")}),e},updateTitle:function(){if(Garp.dataTypes[Garp.currentModel].displayFieldRenderer){var e=this.items.itemAt(0).items.itemAt(0);"relationpanel"!==e.xtype&&e.setTitle(Garp.dataTypes[Garp.currentModel].displayFieldRenderer(this.rec))}},loadData:function(e){function t(){this.formcontent.rendered&&this.formcontent.fireEvent("loaddata",this.rec,this),this.metaPanel.rendered&&this.metaPanel.fireEvent("loaddata",this.rec,this),this.state=null,this.startMonitoring(),this.getForm().clearInvalid()}var i=this.getForm();if(this.stopMonitoring(),!i.isDirty()&&1==e.getCount()&&(this.rec=e.getSelected(),this.rec&&(this.state=null,i.loadRecord(this.rec),this.ownerCt))){this.updateTitle(),this.fireEvent("defocus"),t.call(this),this.formcontent.on("activate",t,this,{single:!0}),this.metaPanel.on("activate",t,this,{single:!0});var s=Garp.dataTypes[Garp.currentModel].getColumn("online_status")&&Garp.dataTypes[Garp.currentModel].getColumn("published")?!0:!1;this.formcontent.getTopToolbar().saveAsDraftButton.setVisible(s),i.unDirty()}},focusFirstField:function(){this.getForm().items.each(function(e){return!e.hidden&&!e.disabled&&e.focus&&Ext.isFunction(e.focus)?(e.focus(100),!1):!0})},afterRender:function(){var e=new Ext.KeyMap(this.getEl(),[{key:Ext.EventObject.ESC,scope:this,handler:function(){this.fireEvent("defocus")}}]);e.stopEvent=!0,this.get(0).items.each(function(e){e!=this.formcontent&&this.relayEvents(e,["dirty","undirty"])},this),Garp.FormPanel.superclass.afterRender.call(this)},initComponent:function(){function e(){t[0].tbar.items.unshift({text:__("Use Image"),iconCls:"icon-camera",ref:"chooseButton",disabled:!1,handler:function(){window.opener.CKEDITOR.tools.callFunction(1,"test.jpg"),window.close()},scope:this})}this.id=Ext.id(),this.addEvents("save-all","cancel","preview","open-new-window","lock","unlock","dirty","undirty","delete"),this.on({scope:this,"new":{buffer:30,fn:this.newItem},"save-all":{fn:function(){var e=this.formcontent.getTopToolbar();e.saveButton.disable(),e.saveAsDraftButton.disable(),e.cancelButton.disable()}},"after-save":{fn:function(e){this.state=null,this.form.unDirty(),this.form.reset(),this.loadData(e),this.updateUI()}},rowselect:{buffer:100,fn:this.loadData},clientvalidation:{fn:function(e,t){this.updateUI(t)}}});var t=[];Ext.each(Garp.dataTypes[Garp.currentModel].formConfig,function(e){t.push(Ext.apply({},e))}),Ext.apply(t[0],{ref:"../formcontent",title:"&nbsp;",layout:"border"}),Ext.apply(t[0].items[0],{region:"center",autoScroll:!0,margins:"0 0 0 10"}),t[0].tbar={cls:"garp-formpanel-toolbar",items:[{text:__("Save"),iconCls:"icon-save",ref:"saveButton",disabled:!0,handler:function(){this.dirtyState=null,this.fireEvent("save-all")},scope:this},{text:__("Save as draft"),hidden:!this.draftable,iconCls:"icon-save-draft",ref:"saveAsDraftButton",disabled:!0,handler:function(){this.dirtyState=null,this.rec.set("online_status",0),this.fireEvent("save-all")},scope:this},{text:__("Cancel"),iconCls:"icon-cancel",ref:"cancelButton",disabled:!0,handler:function(){function e(){this.getForm().reset(),this.updateUI(),this.rec=null,this.fireEvent("delete")}return this.getForm().isDirty()?void Ext.Msg.confirm(__("Garp"),__("Are you sure you want to revert your changes?"),function(t){"yes"==t&&(this.rec.phantom?e.call(this):(this.getForm().reset(),this.updateUI(),this.fireEvent("cancel",this)))},this):!this.rec||this.rec.phantom?void e.call(this):void 0},scope:this}," ",{text:__("Open in new window"),iconCls:"icon-open-new-window",handler:function(){this.fireEvent("open-new-window")},scope:this}," ",{text:__("Preview"),iconCls:"icon-preview",ref:"previewButton",disabled:!0,hidden:Garp.currentModel&&!Garp.dataTypes[Garp.currentModel].previewLink,scope:this,handler:function(){this.fireEvent("preview")},listeners:{disable:function(){this.setTooltip(__("To preview, save this item first"))},enable:function(){this.setTooltip(__("Preview this item"))}}}]};var i=Garp.dataTypes[Garp.currentModel],s=Ext.apply({hidden:window.innerWidth<=Garp.SMALLSCREENWIDTH},i.metaPanelConfig?i.metaPanelConfig:{});t[0].items.push(this.metaPanel=new Garp.MetaPanel(s)),"Image"===Garp.currentModel&&"undefined"!=typeof IS_CKEDITOR_IMAGE_BROWSER&&IS_CKEDITOR_IMAGE_BROWSER&&e(),this.items={xtype:"tabpanel",deferredRender:!1,activeTab:0,resizeTabs:!0,minTabWidth:100,tabWidth:150,tabMargin:15,enableTabScroll:!0,border:!1,defaults:{border:!1,deferredRender:!1,bodyCssClass:"garp-formpanel"},items:t},this.relayEvents(this.metaPanel,["save-all","dirty","undirty"]),Garp.FormPanel.superclass.initComponent.call(this,arguments),this.stopMonitoring()}}),Ext.reg("garpformpanel",Garp.FormPanel),Garp.Toolbar=Ext.extend(Ext.Toolbar,{addColumnMenu:function(){},removeColumnMenu:function(){},initComponent:function(){Ext.apply(this,{style:"padding:0px 10px 0px 10px;border:0;",cls:"garp-main-toolbar cms-branding-small",items:[Garp.modelMenu,"-",{xtype:"tbspacer"},{text:__("New"),iconCls:"icon-new",ref:"newButton",handler:function(){this.fireEvent("new")},scope:this},{text:__("Delete"),iconCls:"icon-delete",ref:"deleteButton",handler:function(){this.fireEvent("delete")},scope:this}," ",{xtype:"tbseparator",ref:"separator"},{text:__("more"),iconCls:"icon-extra",ref:"extraMenu",menu:new Ext.menu.Menu({items:[{text:__("Import")+"&hellip;",iconCls:"icon-import",ref:"importButton",hidden:!0,handler:function(){if(Garp.currentModel){var e=new Garp.ImportWindow;e.show()}}},{text:__("Export")+"&hellip;",iconCls:"icon-export",ref:"exportButton",hidden:!0,handler:function(){if(Garp.currentModel){var e=new Garp.ExportWindow;e.show()}}},{text:__("Print"),iconCls:"icon-print",ref:"printButton",hidden:!0,handler:function(){if(Garp.currentModel)if(1==Garp.gridPanel.getSelectionModel().getCount())Ext.select("body").addClass("print-form"),Garp.gridPanel.ownerCt.collapse(),Garp.viewport.doLayout(),setTimeout(function(){window.print(),Garp.gridPanel.ownerCt.expand(),Ext.select("body").removeClass("print-form")},500);else{Ext.select("body").addClass("print-grid");var e=Garp.gridPanel.ownerCt.getWidth();Garp.gridPanel.getSelectionModel().clearSelections(),Garp.formPanel.ownerCt.collapse&&Garp.formPanel.ownerCt.collapse(),Garp.gridPanel.ownerCt.collapse(),Garp.gridPanel.ownerCt.setWidth(640),Garp.gridPanel.ownerCt.expand();var t=Ext.select(".x-grid3-scroller").first(),i=t.getStyle("width"),s=t.getStyle("height");t.setStyle({overflow:"visible",position:"fixed",height:"auto"}),setTimeout(function(){window.print(),t.first().setStyle({overflow:"auto","overflow-x":"hidden",position:"relative",width:i,height:s}),Garp.gridPanel.ownerCt.setWidth(e),Garp.formPanel.ownerCt.expand&&Garp.formPanel.ownerCt.expand(),Garp.gridPanel.ownerCt.expand(),Garp.viewport.doLayout(),Ext.select("body").removeClass("print-grid")},500)}}},"-",{hidden:!(document.fullScreenElement&&null!==document.fullScreenElement||!document.mozFullScreen&&!document.webkitIsFullScreen),text:__("Full Screen"),iconCls:"icon-fullscreen",handler:function(){var e=document,t=e.documentElement;e.mozFullScreen||e.webkitIsFullScreen?e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}},"-",{text:__("Log out"),iconCls:"icon-logout",ref:"logoutButton",handler:function(){this.fireEvent("logout")},scope:this}]})}]}),Garp.Toolbar.superclass.initComponent.call(this)}}),Garp.InfoPanel=Ext.extend(Ext.Panel,{setInfo:function(e){this.remove(this.innerpanel),this.add([{xtype:"container",ref:"innerpanel",cls:"infopanel cms-branding",border:!1,defaults:{border:!1},items:[{html:'<div class="x-panel-header x-panel-header-noborder x-unselectable" style="-moz-user-select: none;"><img class="x-panel-inline-icon '+e.iconCls+'" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" alt=""><span class="x-panel-header-text">'+__(e.text)+"</span></div>"+(e.description?'<div class="description">'+__(e.description)+"</div>":"")},{xtype:"box",ref:"../count",cls:"total",tpl:e.countTpl}]}])},updateCount:function(e){this.count.update({count:e})},clearInfo:function(){this.update("")},html:"",bodyStyle:"padding: 30px; padding-bottom: 15px;",layout:"fit",listeners:{show:function(){Garp.history&&Garp.currentModel&&Garp.history.pushState({model:Garp.currentModel})}}}),Garp.Viewport=function(e){Garp.Viewport.superclass.constructor.call(this,Ext.applyIf(e||{},{layout:"border",stateful:!1,defaults:{split:!0,animCollapse:!1,border:!1,frame:!1},items:[{region:"north",border:!1,height:40,bodyCssClass:"garp-bg",cls:"toolbarCt",items:Garp.toolbar=new Garp.Toolbar},{ref:"gridPanelCt",region:"west",cls:"gridPanelCt",layout:"fit",xtype:"panel",width:360,minWidth:360,height:200,minHeight:200,collapseMode:"mini",collapsible:!0,header:!1,stateful:!0,stateId:"gridPanelCt",margins:"0 0 4 4",items:[Garp.gridPanel]},{ref:"formPanelCt",region:"center",cls:"formPanelCt",layout:"card",xtype:"container",layoutConfig:{layoutOnCardChange:!0},activeItem:0,border:!1,defaults:{border:!1},margins:"0 4 4 0",items:[Garp.infoPanel=new Garp.InfoPanel({itemId:0,ref:"../infoPanel"})]}]}))},Ext.extend(Garp.Viewport,Ext.Viewport,{}),Ext.ns("Garp"),Garp.ExportWindow=Ext.extend(Ext.Window,{width:580,height:360,modal:!0,layout:"card",activeItem:0,preventBodyReset:!0,title:__("Export"),iconCls:"icon-export",border:!1,defaults:{border:!0,cls:"garp-formpanel"},proceedExport:function(){var e=this.get("page-0").getForm().getValues(),t=[];"undefined"!=typeof Garp.gridPanel.getSelectionModel().getSelected()&&Ext.each(Garp.gridPanel.getSelectionModel().getSelections(),function(e){t.push(e.id)});var i=this.get("page-2").getForm().getFieldValues().exporttype,s=Ext.util.JSON.encode(Garp.gridPanel.store.baseParams.query),a=Garp.gridPanel.getStore().sortInfo,n=Garp.gridPanel.getBottomToolbar().pageSize,r=Garp.gridPanel.getBottomToolbar().cursor,o=this.get("page-1").getForm(),l=this.get("page-0").getForm(),d=o.getValues(),h=[];if(d.__all){var c=this.getCheckboxesFromModel();for(var u in c)"function"!=typeof c[u]&&h.push(c[u].name)}else for(var p in d)h.push(p);var f={};switch(e.selection){case"currentItem":f={selection:"id",exportType:i,sortDir:a.direction,sortField:a.field};
break;case"currentPage":f={selection:"page",page:Math.ceil((r+n)/n),exportType:i,pageSize:n,sortDir:a.direction,sortField:a.field,filter:s};break;case"specific":f={selection:"page",from:e.from,to:e.to,exportType:i,pageSize:n,sortDir:a.direction,sortField:a.field,filter:s};break;case"relation":f={selection:"all",filter:'{"'+Garp.currentModel+'.id":'+t[0]+"}",rule:Garp.formPanel.items.get(0).getLayout().activeItem.rule,rule2:Garp.formPanel.items.get(0).getLayout().activeItem.rule2,exportType:i};break;default:f={selection:"all",exportType:i,pageSize:n,sortDir:a.direction,sortField:a.field,filter:s}}var g;g="relation"==e.selection?Ext.urlEncode(f,BASE+"g/content/export/model/"+l.findField("model").getValue()+"?exporttype="+i):Ext.urlEncode(f,BASE+"g/content/export/model/"+Garp.currentModel+"?exporttype="+i),"currentItem"==e.selection&&(g+="&id=["+t.join(",")+"]"),("currentItem"==e.selection||"currentPage"==e.selection||"specific"==e.selection||"all"==e.selection)&&(g+="&filter="+encodeURIComponent(s),g+="&fields="+encodeURIComponent(h)),this.close(),window.location=g},navHandler:function(e){var t=this.getLayout().activeItem.id;t=parseInt(t.substr(5,t.length),10),this._prevPage=t,t+=e;var i=this.get("page-0").getForm();0>=t?(t=0,this.prevBtn.disable(),this.nextBtn.setText(__("Next")),i.findField("selection").handler.call(this)):2==t?(this.prevBtn.enable(),this.nextBtn.setText(__("Ok"))):3==t?this.proceedExport():(this.prevBtn.enable(),this.nextBtn.setText(__("Next"))),this.getLayout().setActiveItem("page-"+t)},getCheckboxesFromModel:function(){var e=[],t=Garp.gridPanel.getColumnModel().columns;return Ext.each(t,function(t){t.virtual||e.push({boxLabel:Ext.util.Format.stripTags(__(t.header)),name:t.dataIndex,checked:!t.hidden})}),e},initComponent:function(){var e={scope:this,allowBlank:!0,handler:function(){var e=this.get("page-0").getForm(),t=!0,i=!0;"specific"==e.getValues().selection&&(t=!1),"relation"==e.getValues().selection&&(i=!1),e.findField("model").setDisabled(i),e.findField("from").setDisabled(t),e.findField("to").setDisabled(t)}};this.items=[{id:"page-0",xtype:"form",items:[{xtype:"fieldset",labelWidth:200,title:__("Specify selection to export (1/3)"),defaults:e,items:[{fieldLabel:__("Currently selected item(s)"),xtype:"radio",name:"selection",checked:Garp.gridPanel.getSelectionModel().getCount()>1,disabled:!Garp.gridPanel.getSelectionModel().getSelected(),inputValue:"currentItem"},{fieldLabel:__("Current page"),xtype:"radio",name:"selection",checked:0===Garp.gridPanel.getSelectionModel().getCount(),inputValue:"currentPage"},{xtype:"compositefield",fieldLabel:__("Specific pages"),defaults:e,items:[{xtype:"radio",name:"selection",checked:1===Garp.gridPanel.getSelectionModel().getCount()&&!Garp.formPanel.items.get(0).getLayout().activeItem.model,inputValue:"specific",width:30},{xtype:"displayfield",value:__("Page")},{xtype:"numberfield",name:"from",value:1,flex:1},{xtype:"displayfield",value:__("to")},{xtype:"numberfield",name:"to",value:Math.ceil(Garp.gridPanel.getStore().getTotalCount()/Garp.gridPanel.getBottomToolbar().pageSize),flex:1}]},{xtype:"compositefield",fieldLabel:__("Related to current item"),disabled:1!==Garp.gridPanel.getSelectionModel().getCount(),hidden:!Garp.dataTypes[Garp.currentModel].getRelations().length,defaults:e,items:[{xtype:"radio",name:"selection",inputValue:"relation",checked:Garp.formPanel.items.get(0).getLayout().activeItem.model?!0:!1,width:30},{xtype:"displayfield",value:__("Kind")},{flex:1,xtype:"combo",editable:!1,name:"model",value:Garp.formPanel.items.get(0).getLayout().activeItem.model||Garp.dataTypes[Garp.currentModel].getRelations()[0]||null,store:function(){var e=[];return Ext.each(Garp.dataTypes[Garp.currentModel].getRelations(),function(t){Garp.dataTypes[t]&&e.push([t,Garp.dataTypes[t].text])}),e}()}]}]}]},{id:"page-1",xtype:"form",autoScroll:!0,listeners:{show:function(){var e=this.ownerCt;0===e._prevPage&&"relation"==e.get("page-0").getForm().getValues().selection&&e.nextBtn.handler.call(e)}},items:[{xtype:"fieldset",labelWidth:80,title:__("Select fields (2/3)"),items:[{ref:"../all",xtype:"checkbox",name:"__all",fieldLabel:__("All fields"),checked:!0,handler:function(e,t){t?this.refOwner.specific.disable():this.refOwner.specific.enable()}},{xtype:"box",cls:"separator"},{disabled:!0,xtype:"checkboxgroup",ref:"../specific",columns:3,hideLabel:!0,defaults:{xtype:"checkbox"},items:this.getCheckboxesFromModel()}]}]},{id:"page-2",xtype:"form",items:[{xtype:"fieldset",title:__("Export type (3/3)"),items:[{xtype:"combo",name:"exporttype",fieldLabel:__("Format"),allowBlank:!1,editable:!1,triggerAction:"all",typeAhead:!1,mode:"local",value:"txt",store:[["txt","Text"],["csv","CSV"],["excel","Excel"]]}]}]}],this.buttonAlign="left",this.buttons=[{text:__("Previous"),ref:"../prevBtn",handler:this.navHandler.createDelegate(this,[-1])},"->",{text:__("Cancel"),handler:this.close.createDelegate(this)},{text:__("Next"),ref:"../nextBtn",handler:this.navHandler.createDelegate(this,[1])}],Garp.ExportWindow.superclass.initComponent.call(this),this.on("show",this.navHandler.createDelegate(this,[-1]))}}),Ext.ns("Garp"),Garp.ImportWindow=Ext.extend(Ext.Window,{width:810,height:360,modal:!0,layout:"card",activeItem:0,preventBodyReset:!1,title:__("Import"),iconCls:"icon-import",maximizable:!0,border:!1,defaults:{border:!0,frame:!1,style:"background-color: #fff;",bodyStyle:"background-color: #fff;padding-top: 10px; "},navHandler:function(e){var t=this.getLayout().activeItem.id;t=parseInt(t.substr(5,t.length),10),t+=e;var i=this.get("page-1").getForm();0>=t?(t=0,this.prevBtn.disable(),this.nextBtn.setText(__("Next")),this.nextBtn.setDisabled(!i.findField("datafile").getValue())):1==t?(this.progress.reset(),this.progress.wait({text:__("Processing")}),Ext.select(".x-progress-bar").setHeight(18),this.prevBtn.disable(),this.nextBtn.disable(),i.submit()):2==t?(this.nextBtn.setText(__("Ok")),this.prevBtn.enable(),this.nextBtn.enable()):3==t?this.proceedImport():(this.prevBtn.enable(),this.nextBtn.setText(__("Next"))),this.getLayout().setActiveItem("page-"+t)},showMappingUI:function(e){var t=[],i=[];Ext.each(Garp.dataTypes[Garp.currentModel].columnModel,function(e){i.push([e.dataIndex,e.header])}),i.push(["",__("  (Ignore)")]);for(var s=e[0].length,a=function(e,t){var i=Ext.select("."+e.name,null,this.el.body);t?i.removeClass("garp-import-hidden-col"):i.addClass("garp-import-hidden-col")},n=0;s>n;n++){var r=[];r.push({name:"col-"+n,xtype:"combo",allowBlank:!1,editable:!1,triggerAction:"all",typeAhead:!1,mode:"local",store:i,submitValue:!1,value:s>n?i[n][0]:s,width:140,listeners:{select:a,scope:this}});for(var o=0;o<e.length;o++)r.push({xtype:"box",html:(e[o][n]||"")+"",cls:"row-"+o+" col-"+n,style:"background-color: #fff; margin: 5px 10px 5px 2px;"});t.push({items:r})}var l=150*s;this.mappingColumns=new Ext.Panel({layout:"column",columns:i.length,width:l+10,items:t,defaults:{width:150}}),this.get("page-2").add({xtype:"panel",style:"margin: 10px;",frame:!0,bodyStyle:"padding:10px;",autoScroll:!0,items:this.mappingColumns}),this.get("page-2").add({xtype:"fieldset",items:[{xtype:"checkbox",fieldLabel:__("Ignore first row"),name:"ignore-first-row",checked:!1,submitValue:!1,handler:function(e,t){var i=Ext.select(".row-0",null,this.el.body);t?i.addClass("garp-import-hidden-row"):i.removeClass("garp-import-hidden-row")},scope:this},{xtype:"checkbox",fieldLabel:__("Continue on error(s)"),name:"ignoreErrors"}]}),this.getLayout().setActiveItem("page-2"),this.get("page-2").doLayout(),this.navHandler(0),this.get("page-2").getForm().findField("ignore-first-row").setValue(!0)},proceedImport:function(){var e=[],t=this.get("page-2").findByType("combo");Ext.each(t,function(t){e.push(t.getValue())});var i=this.get("page-2").getForm();Ext.apply(i.baseParams,{datafile:this.get("page-1").getForm().findField("datafile").getValue(),mapping:Ext.encode(e),firstRow:this.get("page-2").getForm().findField("ignore-first-row").checked?"1":"0"}),this.lm=new Ext.LoadMask(this.getEl()),this.lm.show(),i.submit()},initComponent:function(){this.progress=new Ext.ProgressBar({animate:!0}),this.items=[{id:"page-0",xtype:"form",timeout:0,items:[{xtype:"fieldset",labelWidth:150,title:__("Specify file to import"),style:"padding-top: 50px; ",items:[{xtype:"uploadfield",uploadURL:BASE+"g/content/upload/type/document",supportedExtensions:["xls","xlsx","xml"],allowBlank:!1,name:"filename",fieldLabel:__("Filename"),listeners:{change:function(e,t){this.get("page-1").getForm().findField("datafile").setValue(t),this.navHandler(1)},scope:this}},{xtype:"displayfield",value:__("Excel filetypes are supported")}]}]},{id:"page-1",timeout:0,xtype:"form",url:BASE+"g/content/import/",baseParams:{model:Garp.currentModel},listeners:{actioncomplete:function(e,t){t.result&&t.result.success&&this.showMappingUI(t.result.data)},actionfailed:function(e,t){var i=__("Something went wrong. Please try again.");t.result&&t.result.message&&(i+="<br>"+t.result.message),Ext.Msg.alert(__("Error"),i),this.close()},scope:this},items:[{xtype:"fieldset",labelWidth:150,title:__("Please wait"),style:"padding-top: 50px; ",items:[this.progress,{xtype:"textfield",hidden:!0,fieldLabel:__("Filename"),ref:"datafile",name:"datafile"}]}]},{id:"page-2",xtype:"form",timeout:1200,url:BASE+"g/content/import/",baseParams:{model:Garp.currentModel},listeners:{actioncomplete:function(e,t){this.lm.hide(),t.result&&t.result.success&&(this.close(),Garp.gridPanel.getStore().reload())},actionfailed:function(e,t){this.lm.hide();var i=__("Something went wrong. Please try again.");t.result.message&&(i+="<br>"+t.result.message),Ext.Msg.alert(__("Error"),i)},scope:this},items:[{xtype:"fieldset",labelWidth:0,title:__("Fields"),items:[]}]}],this.buttonAlign="left",this.buttons=[{text:__("Previous"),disabled:!0,ref:"../prevBtn",handler:this.navHandler.createDelegate(this,[-2])},"->",{text:__("Cancel"),handler:this.close.createDelegate(this)},{text:__("Next"),ref:"../nextBtn",disabled:!0,handler:this.navHandler.createDelegate(this,[1])}],Garp.ImportWindow.superclass.initComponent.call(this)}}),Ext.ns("Garp"),Garp.PasswordFieldset=Ext.extend(Ext.form.FieldSet,{callback:Ext.emptyFn,style:"margin:0;padding:0;",defaultType:"textfield",defaults:{allowBlank:!0},collapseAndHide:function(){this.showpassword.hide(),this.password.hide(),this.plaintext.hide(),this.password.setValue(""),this.password.originalValue="",this.plaintext.setValue(""),this.plaintext.originalValue=""},initComponent:function(e){this.items=[{ref:"setPasswordBtn",fieldLabel:" &nbsp; ",xtype:"button",text:__("Set password"),boxMaxWidth:64,handler:function(){var e=this.refOwner;e.showpassword.isVisible()?e.collapseAndHide():(e.showpassword.show(),e.password.show(),e.plaintext.hide(),e.password.focus(20))}},{ref:"password",fieldLabel:__("Password"),inputType:"password",hidden:!0,listeners:{change:this.callback}},{ref:"plaintext",fieldLabel:__("Password"),inputType:"text",hidden:!0,listeners:{change:this.callback}},{ref:"showpassword",fieldLabel:__("Show Password"),xtype:"checkbox",allowBlank:!0,hidden:!0,handler:function(){var e=this.refOwner,t=this.checked;e.password.setVisible(!t),e.plaintext.setVisible(t),e[t?"plaintext":"password"].setValue(e[t?"password":"plaintext"].getValue())}}];var t=this;this._interval=setInterval(function(){t.password?(t.password.isVisible()||t.plaintext.isVisible())&&(t.password.isVisible()&&t.password.isDirty()?(t.callback(t.password,t.password.getValue()),t.password.originalValue=t.password.getValue()):t.plaintext.isDirty()&&(t.callback(t.plaintext,t.plaintext.getValue()),t.plaintext.originalValue=t.plaintext.getValue())):clearInterval(this._interval)},100),Garp.PasswordFieldset.superclass.initComponent.call(this,e)}}),Ext.reg("passwordfieldset",Garp.PasswordFieldset),Ext.ux.DateTimePicker=Ext.extend(Ext.DatePicker,{showToday:!0,timeValue:"12:00",initComponent:function(){Ext.ux.DateTimePicker.superclass.initComponent.call(this)},onRender:function(e,t){Ext.ux.DateTimePicker.superclass.onRender.call(this,e,t),this.addTimeField.call(this)},addTimeField:function(){this.timeField||(this.timeField=new Ext.form.TimeField({lazyInit:!1,renderTo:this.el.child(".x-date-bottom"),value:this.timeValue,getListParent:function(){var e=this.el.up(".x-menu");return e},listeners:{select:{fn:function(){return!1}},focus:{fn:function(){return this.doDisabled(!0),!1},scope:this},blur:{fn:function(){return this.doDisabled(!1),!1},scope:this},render:function(){this.list.on("click",function(e){return e.stopPropagation(),!1})}},width:60}),Ext.select(".x-date-bottom div, .x-date-bottom table",this.el).each(function(){this.setStyle({"margin-left":"18px","float":"left"})}))}}),Ext.ns("Ext.ux.menu"),Ext.ux.menu.DateTimeMenu=Ext.extend(Ext.menu.DateMenu,{initComponent:function(){this.on("beforeshow",this.onBeforeShow,this),(this.strict=Ext.isIE7&&Ext.isStrict)&&this.on("show",this.onShow,this,{single:!0,delay:20}),Ext.apply(this,{plain:!0,showSeparator:!1,items:this.picker=new Ext.ux.DateTimePicker(Ext.applyIf({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item",id:this.pickerId},this.initialConfig))}),this.picker.purgeListeners(),Ext.menu.DateMenu.superclass.initComponent.call(this),this.relayEvents(this.picker,["select"]),this.on("show",this.picker.focus,this.picker),this.on("select",this.menuHide,this),this.handler&&this.on("select",this.handler,this.scope||this)}}),Ext.ns("Garp"),Garp.DataType=Ext.extend(Ext.util.Observable,{getStoreFieldsFromColumnModel:function(){var e=[];return Ext.each(this.columnModel,function(t){var i={};t.dataIndex&&(i.name=t.dataIndex),t.convert&&(i.convert=t.convert),t.mapping&&(i.mapping=t.mapping),e.push(i)}),e},getViewTpl:function(){var e='<div class="view">';return Ext.each(this.formConfig[0].items[0].items,function(t){!t.hidden&&!t.disabled&&t.fieldLabel&&t.name&&(e+="<h2>"+__(t.fieldLabel)+"</h2>",e+="<div>{"+t.name+"}</div>")}),e+="</div>",this.viewTpl=new Ext.XTemplate(e,{compiled:!0}),this.viewTpl},setupACL:function(e){return Ext.isDefined(e.create)||Ext.apply(this,{disableCreate:!0,quickCreatable:!1}),Ext.isDefined(e.destroy)||Ext.apply(this,{disableDelete:!0}),Ext.isDefined(e.fetch)?!0:(Ext.apply(this,{hidden:!0,disabled:!0,disableCreate:!0,quickCreatable:!1}),!1)},removeColumn:function(e){this.columnModel.remove(this.getColumn(e))},getColumn:function(e){var t;return Ext.each(this.columnModel,function(i){return i.dataIndex==e?void(t=i):void 0}),t},addColumn:function(e){this.columnModel.push(e)},insertColumn:function(e,t){this.columnModel.splice(e,0,t)},removeField:function(e){this.formConfig[0].items[0].items.remove(this.getField(e))},getField:function(e){var t;return Ext.each(this.formConfig[0].items[0].items,function(i){Ext.each(i,function(i){return i.name==e?void(t=i):void 0})}),t},addField:function(e){this.formConfig[0].items[0].items.push(e)},addFields:function(e){Ext.each(e,function(e){this.addField(e)},this)},insertField:function(e,t){this.formConfig[0].items[0].items.splice(e,0,t)},getRelationPanel:function(e){var t;return Ext.each(this.formConfig,function(i){Ext.each(i,function(i){return i.model==e?void(t=i):void 0})}),t},removeRelationPanel:function(e){for(var t=0;t<this.formConfig.length;++t)if(this.formConfig[t].model==e){this.formConfig.splice(t,1);break}},getRelations:function(){var e=[];return Ext.each(this.formConfig,function(t){t.xtype&&"relationpanel"===t.xtype&&e.push(t.model)}),e},addRelationPanel:function(e){Ext.apply(e,{xtype:"relationpanel"}),this.formConfig.push(e)},addListener:function(e,t,i){this.setupListeners(e);var s=this.formConfig[0].listeners[e];this.formConfig[0].listeners[e]=i?function(e,i){t(e,i),s(e,i)}:function(e,i){s(e,i),t(e,i)}},setupListeners:function(){Ext.applyIf(this.formConfig[0],{listeners:{}}),Ext.applyIf(this.formConfig[0].eventName,{loaddata:function(){}})},constructor:function(e){this.addEvents("init"),this.listeners=e.listeners,this.initialCfg=Ext.apply({},e),Ext.apply(this,e),Ext.applyIf(this,{description:"",countTpl:new Ext.XTemplate([__("Total"),": {count} ",'<tpl if="count == 1">',__("item"),"</tpl>",'<tpl if="count != 1">',__("items"),"</tpl>"]),disabled:!1,disableDelete:!1,disableCreate:!1,quickCreatable:!0,displayFieldRenderer:function(e){return e.get("name")?e.get("name"):__(e.phantom?"New "+this.text:"Unnamed "+this.text)},previewItems:[],metaPanelItems:[],previewLink:null,iconCls:"icon-"+this.text.toLowerCase(),isRelationalDataType:!1}),Ext.applyIf(this.defaultData,{created:null,modified:null}),Ext.applyIf(this,{columnModel:[]}),this.isRelationalDataType&&(Ext.apply(this,{disableCreate:!0,disableDelete:!0}),this.addListener("loaddata",function(e,t){t.items.get(0).activate(1),t.items.get(0).hideTabStripItem(0)}));for(var t in this.defaultData){var i=!1;if(Ext.each(this.columnModel,function(e){e.dataIndex&&e.dataIndex==t&&(i=!0)}),!i){var s=Ext.util.Format.capitalize(t.replace("_"," "));this.columnModel.push({hidden:!0,renderer:"created"==t||"modified"==t?Garp.renderers.dateTimeRenderer:null,dataIndex:t,header:__(s)})}}Ext.each(this.columnModel,function(e){e.defaultData&&null===e.defaultData&&(e.useNull=!0),e.virtual&&(e.sortable=!1)}),Garp.DataType.superclass.constructor.call(this,e)}}),Ext.ns("Garp"),Ext.enableListenerCollection=!0,Ext.QuickTips.init(),Ext.Direct.addProvider(Garp.API),Garp.errorHandler={msg:null,win:null,handler:function(e){e||(e=__("No readable error message specified"));var t=!1;this.msg?(t=!0,this.msg=e+"<hr>"+this.msg):this.msg=e,this.win?this.win.clearBtn.show():this.win=new Ext.Window({title:"",data:{msg:__("No error")},tpl:new Ext.Template(['<div class="garp-error-dialog" style="min-height: 80px; max-height: 250px; overflow: auto; ">',"{msg}","</div>"]),width:500,buttonAlign:"center",defaultButton:"defaultButton",buttons:[{text:__("Ok"),id:"defaultButton",handler:function(){this.win.hide()},scope:this},{hidden:!0,text:__("Login again"),handler:function(){this.win.close(),window.location=BASE+"g/auth/login"},scope:this},{hidden:!t,ref:"../clearBtn",text:__("Clear messages"),handler:function(){this.msg="",this.win.update({msg:this.msg}),this.win.hide()},scope:this}]}),this.win.show(),this.win.update({msg:this.msg})}},window.onerror=Garp.errorHandler.handler.createDelegate(Garp.errorHandler),Ext.Direct.on({exception:{fn:function(e){var t="",i="",s="",a="",n="";Ext.isObject(e)&&(a=e.error?e.error.message:__(e.xhr&&403===e.xhr.status?"You've been logged out":"No connection"),n=e.tid,t=n?e.getTransaction():null,Ext.isObject(t)&&(i=t.action,s=t.method),Garp.undirty(),Garp.gridPanel&&Garp.gridPanel.loadMask&&(Garp.gridPanel.loadMask.hide(),Garp.formPanel&&(Garp.formPanel.state=0,Garp.formPanel.updateUI(),Garp.formPanel.fireEvent("dirty")))),Garp.errorHandler.handler("<b>"+(s?__("Error trying to ")+__(s):"")+" "+(Garp.dataTypes[i]?"<i>"+__(Garp.dataTypes[i].text)+"</i>":i)+"</b><br><br>"+a||__("Nothing. Nada.")+"<br>"+(n?__("Transaction id: ")+n:""))}}}),Ext.override(Ext.ux.form.DateTime,{getValue:function(){return this.dateValue?this.dateValue.format(this.hiddenFormat):""}}),Ext.override(Ext.form.Checkbox,{getValue:function(){return this.rendered?this.el.dom.checked?"1":"0":this.checked?"1":"0"}}),Ext.override(Ext.form.DateField,{format:"d F Y",altFormats:"Y-m-d|d F Y|j F Y|d m Y|d n Y|d-m-Y|d-n-Y",invalidText:__('"{0}" is not a valid date. Valid formats are a.o. "19 2 2013" and "19-02-2013"')}),Ext.apply(Ext.form.TimeField.prototype,{altFormats:"g:ia|g:iA|g:i a|g:i A|h:i|g:i|H:i|ga|ha|gA|h a|g a|g A|gi|hi|gia|hia|g|H|H:i:s"}),Ext.apply(Ext.PagingToolbar.prototype,{beforePageText:"",displayMsg:""}),Ext.apply(Ext.ux.form.DateTime.prototype,{timeFormat:"G:i",otherToNow:!1,initDateValue:function(){this.dateValue=this.otherToNow?new Date:new Date((new Date).getFullYear(),0,1,12,0,0)},timeConfig:{increment:30},timeWidth:70}),Ext.form.VTypes.mailtoOrUrlText=__("Not a valid Url"),Ext.override(Ext.grid.RowSelectionModel,{onKeyPress:function(e,t){if(!this.grid.disabled){var i,s="up"==t,a=s?"selectPrevious":"selectNext",n=s?-1:1;!e.shiftKey||this.singleSelect?this[a](!1):this.last!==!1&&this.lastActive!==!1?(i=this.last,this.selectRange(this.last,this.lastActive+n),this.grid.getView().focusRow(this.lastActive),i!==!1&&(this.last=i)):this.selectFirstRow()}}}),Ext.override(Ext.form.BasicForm,{isValid:function(){var e=!0;return this.items.each(function(t){return t.isValid(!0)?void 0:(e=!1,!1)}),e}}),Ext.override(Ext.form.NumberField,{decimalPrecision:16}),Ext.override(Ext.form.NumberField,{setValue:function(e){return e="number"==typeof e?e:parseFloat(String(e).replace(this.decimalSeparator,".")),e=isNaN(e)?null:String(e).replace(".",this.decimalSeparator),Ext.form.NumberField.superclass.setValue.call(this,e)},parseValue:function(e){return e=parseFloat(String(e).replace(this.decimalSeparator,".")),isNaN(e)?null:e},fixPrecision:function(e){var t=isNaN(e);return this.allowDecimals&&-1!=this.decimalPrecision&&!t&&e?parseFloat(parseFloat(e).toFixed(this.decimalPrecision)):t?null:e}}),Ext.apply(Ext.form.ComboBox.prototype,{enableKeyEvents:!0,emptyText:__("(empty)"),afterRender:function(){if(Ext.form.ComboBox.superclass.afterRender.call(this),"local"==this.mode&&"timefield"!=this.xtype&&"datefield"!=this.xtype){var e=this.store.fields.items[this.store.fields.items.length-1].name,t=this.store.fields.items[this.store.fields.items.length-2>-1?this.store.fields.items.length-2:0].name;this.el.on("keypress",function(i){var s=String.fromCharCode(i.getCharCode()),a=this.view.getSelectedIndexes(),n=a.length>0?a[0]:null,r=null===n?0:++n,o=this.store.find(e,s,r,!1);if(o>-1?this.select(o):-1==o&&r>0&&(o=this.store.find(e,s,0,!1),o>-1&&this.select(o)),o>-1){var l=this.store.getAt(o);this.setValue(l.get(t))}},this)}}}),Ext.override(Ext.grid.GridView,{doRender:function(e,t,i,s,a,n){var r,o,l,d,h,c,u=this.templates,p=u.cell,f=u.row,g=a-1,m="width:"+this.getTotalWidth()+";",x=[],v=[],E={tstyle:m},y={},b=t.length;for(h=0;b>h;h++)if(l=t[h]){for(v=[],c=h+s,d=0;a>d;d++)o=e[d],y.id=o.id,y.css=0===d?"x-grid3-cell-first ":d==g?"x-grid3-cell-last ":"",y.attr=y.cellAttr="",y.style=o.style,y.value=o.renderer.call(o.scope,l.data[o.name],y,l,c,d,i,this),Ext.isEmpty(y.value)&&(y.value="&#160;"),this.markDirty&&l.dirty&&"undefined"!=typeof l.modified[o.name]&&(y.css+=" x-grid3-dirty-cell"),v[v.length]=p.apply(y);r=[],n&&(c+1)%2===0&&(r[0]="x-grid3-row-alt"),l.dirty&&(r[1]=" x-grid3-dirty-row"),E.cols=a,this.getRowClass&&(r[2]=this.getRowClass(l,c,E,i)),E.alt=r.join(" "),E.cells=v.join(""),x[x.length]=f.apply(E)}return x.join("")}}),Ext.apply(Ext.form.TextField.prototype,{minLengthText:__("You have {2} character(s) too few. The minimal length is {0}."),maxLengthText:__("You have {2} character(s) too many. The maximum length is {0}."),getErrors:function(e){var t=Ext.form.TextField.superclass.getErrors.apply(this,arguments);if(e=Ext.isDefined(e)?e:this.processValue(this.getRawValue()),Ext.isFunction(this.validator)){var i=this.validator(e);i!==!0&&t.push(i)}if(e.length<1||e===this.emptyText){if(this.allowBlank)return t;t.push(this.blankText)}if(!this.allowBlank&&(e.length<1||e===this.emptyText)&&t.push(this.blankText),e.length<this.minLength&&t.push(String.format(this.minLengthText,this.minLength,e.length,this.minLength-e.length)),e.length>this.maxLength&&t.push(String.format(this.maxLengthText,this.maxLength,e.length,e.length-this.maxLength)),this.vtype){var s=Ext.form.VTypes;s[this.vtype](e,this)||t.push(this.vtypeText||s[this.vtype+"Text"])}return this.regex&&!this.regex.test(e)&&t.push(this.regexText),t}}),Ext.apply(Ext.menu.Menu.prototype,{scrollIncrement:35,onScrollWheel:function(e){e.getWheelDelta()>0?this.onScroll(null,this.scroller.top):e.getWheelDelta()<0&&this.onScroll(null,this.scroller.bottom)}}),Ext.menu.Menu.prototype.createScrollers=Ext.menu.Menu.prototype.createScrollers.createSequence(function(){function e(e){s&&t(),s=setInterval(function(){i.onScroll(null,e)},100)}function t(){clearInterval(s),s=null}var i=this,s=null;Ext.EventManager.addListener(this.el,"mousewheel",this.onScrollWheel,this),this.on("destroy",function(){Ext.EventManager.removeListener(this.el,"mousewheel",this.onScrollWheel,this)}),this.scroller.top.on("mouseenter",e.createDelegate(this,[this.scroller.top])),this.scroller.top.on("mouseleave",t),this.scroller.bottom.on("mouseenter",e.createDelegate(this,[this.scroller.bottom])),this.scroller.bottom.on("mouseleave",t)}),Ext.lib.Dom.getXY=Ext.lib.Dom.getXY.createInterceptor(function(e){return e||!1}),Ext.lib.Region.getRegion=Ext.lib.Region.getRegion.createInterceptor(function(e){return e||!1}),window.onbeforeunload=function(){return Garp.checkForModified()?__("Are you sure you want to navigate away from Garp?"):void 0},Garp.checkForModified=function(){if(Garp.gridPanel&&Garp.gridPanel.getStore&&Garp.gridPanel.getStore()){var e=Garp.gridPanel.getStore().getModifiedRecords().length;return e}return!1},Garp.lazyLoad=function(e,t){var i=Ext.id(null,"garp");window["cb"+i]=t.createDelegate(this).createSequence(function(){delete window["cb"+i]},this);var s=document.createElement("script");s.type="text/javascript",s.src=e+"&callback=cb"+i,document.body.appendChild(s)},Garp.dirty=function(){Garp.gridPanel.disable(),Garp.toolbar.disable()},Garp.undirty=function(){Garp.gridPanel.enable(),Garp.toolbar.enable()},Garp.updateUI=function(e){if(!e||!e.getCount){if(!Garp.gridPanel)return;if(e=Garp.gridPanel.getSelectionModel?Garp.gridPanel.getSelectionModel():!1,!e)return}var t=e.getCount();if(t>1&&(t=2),window.innerWidth<=Garp.SMALLSCREENWIDTH&&1==t&&Garp.viewport.gridPanelCt.collapse(),!Garp.updateUI.prevCount||Garp.updateUI.prevCount!=t){switch(t){case 1:Garp.viewport.formPanelCt.getLayout().setActiveItem(1),Garp.formPanel.show();break;case 0:Garp.viewport.formPanelCt.getLayout().setActiveItem(0),Garp.viewport.infoPanel.setInfo(Garp.dataTypes[Garp.currentModel]),Garp.viewport.formPanelCt.doLayout(),Garp.viewport.infoPanel.updateCount(Garp.gridPanel.getStore().getTotalCount())}return Garp.updateUI.prevCount=t,!0}},Garp.history=Ext.apply(Garp.history||{},{pastModel:null,pushState:function(e){e||(e=this.getCurrentState()),e&&history.pushState&&(e.model!==Garp.history.pastModel?history.pushState(e,""+__(Garp.dataTypes[e.model].text||""),BASE+"admin/?"+Ext.urlEncode(e)):history.replaceState(e,""+__(Garp.dataTypes[e.model].text||""),BASE+"admin/?"+Ext.urlEncode(e)),Garp.history.pastModel=e.model)},getCurrentState:function(){if(Garp.gridPanel&&Garp.gridPanel.store){var e={},t=Garp.gridPanel.getBottomToolbar(),i=Garp.gridPanel.getTopToolbar(),s=Garp.gridPanel.getSelectionModel();return i&&""===i.searchField.getValue()&&(e.page=Math.ceil((t.cursor+t.pageSize)/t.pageSize)||null),e.id=s.getSelected()?parseInt(s.getSelected().get("id"),10)||null:null,e.model=Garp.currentModel,e}return null},parseState:function(e){e||(e=Ext.urlDecode(document.location.search.replace(/\?/,""))),e.model&&Garp.eventManager.fireEvent("modelchange",!1,e.model||null,e.page||null,e.id||null)},setupListeners:function(){var e=this;window.addEventListener("popstate",function(t){t&&t.state&&e.parseState(t.state?t.state:t.originalEvent.state?t.originalEvent.state:null)})}}),Garp.changeModel=function(e,t,i,s){if("undefined"==typeof Garp.dataTypes[t])return!1;if(Garp.checkForModified()>1||1==Garp.checkForModified()&&!Garp.gridPanel.getSelectionModel().getSelected().phantom){{var a=Garp.gridPanel.getStore();Garp.history.getCurrentState()}return void Ext.Msg.show({animEl:Garp.viewport.getEl(),icon:Ext.MessageBox.QUESTION,title:__("Garp"),msg:__("Would you like to save your changes?"),buttons:Ext.Msg.YESNOCANCEL,fn:function(n){switch(n){case"yes":a.on({save:{single:!0,fn:function(){Garp.changeModel(e,t,i,s)}}}),a.save();break;case"no":a.rejectChanges(),Garp.changeModel(e,t,i,s)}}})}Garp.infoPanel.clearInfo(),Garp.eventManager.purgeListeners(),Garp.setupEventManager(),Garp.currentModel=t,e&&Garp.history.pushState({model:t}),Garp.modelMenu.setIconClass(Garp.dataTypes[t].iconCls),Garp.modelMenu.setText(__(Garp.dataTypes[t].text)),Garp.gridPanel&&Garp.gridPanel.ownerCt.remove(Garp.gridPanel),Garp.formPanel&&Garp.formPanel.ownerCt&&(Garp.viewport.formPanelCt.getLayout().setActiveItem(0),Garp.viewport.formPanelCt.remove(Garp.formPanel)),Garp.formPanel=new Garp.FormPanel({previousValidFlag:!0,listeners:{cancel:function(){var e=Garp.gridPanel.getSelectionModel().getSelected();Garp.gridPanel.getSelectionModel().clearSelections(),Garp.gridPanel.getSelectionModel().selectRecords([e])},defocus:function(){Garp.gridPanel.focus.call(Garp.gridPanel)},dirty:Garp.dirty,undirty:Garp.undirty}}),Garp.viewport.formPanelCt.add(Garp.formPanel),Garp.viewport.formPanelCt.doLayout(),Garp.gridPanel=new Garp.GridPanel({model:t,listeners:{beforesave:function(){Garp.syncValues()},rowdblclick:function(){Garp.formPanel.focusFirstField()},afterdelete:function(){Garp.formPanel.hide(),Garp.gridPanel.enable(),Garp.undirty()},defocus:function(){Garp.formPanel.focusFirstField()},storeloaded:{fn:function(){this.enable(),"#selectfirst"==document.location.hash&&Garp.gridPanel.getSelectionModel().selectFirstRow(),Garp.gridPanel.on("rowselect",function(){Garp.history.pushState()},this,{buffer:500})},buffer:300,delay:300,single:!0},"after-save":function(){try{window.opener&&"undefined"!=typeof window.opener.Garp&&window.opener.Garp.eventManager.fireEvent("external-relation-save")}catch(e){}}}}),Garp.viewport.gridPanelCt.add(Garp.gridPanel),Garp.viewport.gridPanelCt.doLayout(),Garp.gridPanel.on({storeloaded:function(){if(Garp.updateUI.prevCount=-1,Garp.updateUI(),Garp.gridPanel.grid){var e=Garp.gridPanel.getSelectionModel(),t=e.getSelections();e.clearSelections(),e.selectRecords(t)}},selectionchange:{fn:Garp.updateUI,buffer:110}}),Garp.gridPanel.relayEvents(Garp.eventManager,["new","save-all","delete","clientvalidation"]),Garp.formPanel.relayEvents(Garp.eventManager,["new","rowselect","after-save"]),Garp.eventManager.relayEvents(Garp.gridPanel,["beforerowselect","rowselect","storeloaded","after-save","selectionchange","open-new-window"]),Garp.eventManager.relayEvents(Garp.formPanel,["clientvalidation","save-all","open-new-window","preview","delete"]),Garp.infoPanel.clearInfo(),s&&!i?Garp.gridPanel.getStore().load({params:{query:{id:s}},callback:function(){Garp.gridPanel.getSelectionModel().selectFirstRow(),Garp.gridPanel.getTopToolbar().searchById(s),Garp.formPanel.on({show:function(){var e=new Ext.ToolTip({target:Garp.gridPanel.getTopToolbar().items.get(1).triggers[0],anchor:"top",anchorOffset:-13,html:__("Click here to view all items again"),closable:!0,autoHide:!0});e.show()},single:!0,delay:100})}}):i?(Garp.gridPanel.getStore().on({load:function(){s&&Garp.gridPanel.getStore().on({load:function(){var e=Garp.gridPanel.getStore().find("id",s);if(e>-1){var t=Garp.gridPanel.getStore().getAt(e);Garp.gridPanel.getSelectionModel().selectRecords([t])}},scope:this,single:!0}),Garp.gridPanel.getBottomToolbar().changePage(i)},single:!0}),Garp.gridPanel.loadStoreWithDefaults()):Garp.gridPanel.loadStoreWithDefaults();var n=Garp.toolbar;n.newButton.setVisible(!Garp.dataTypes[t].disableCreate),n.deleteButton.setVisible(!Garp.dataTypes[t].disableDelete),n.separator.setVisible(!Garp.dataTypes[t].disableDelete||!Garp.dataTypes[t].disableCreate),n.extraMenu.menu.importButton.show(),n.extraMenu.menu.exportButton.show(),n.extraMenu.menu.printButton.show(),document.title=__(Garp.dataTypes[t].text)+" | "+("undefined"!=typeof APP_TITLE?APP_TITLE:"");try{Garp.setFavicon(Garp.dataTypes[t].iconCls)}catch(r){if("SecurityError"!==r.name)throw r}},Garp.setFavicon=function(e){var t=document,i=t.querySelector("."+e);if(i){var s=window.getComputedStyle(i,null).getPropertyValue("background-image");s=s.replace(/\burl\s*\(\s*["']?([^"'\r\n,]+)["']?\s*\)/gi,"$1");var a=t.getElementById("favicon");a.setAttribute("href",s)}},Garp.syncValues=function(){var e=Garp.formPanel;e.getForm().updateRecord(e.rec)},Garp.rebuildViewportItems=function(){Garp.infoPanel&&Garp.infoPanel.clearInfo(),Garp.gridPanel&&Garp.viewport.gridPanelCt.remove(Garp.gridPanel),Garp.formPanel&&Garp.viewport.formPanelCt.remove(Garp.formPanel),Garp.viewport.formPanelCt.add(Garp.formPanel),Garp.formPanel.hide(),Garp.viewport.gridPanelCt.add(Garp.gridPanel),Garp.viewport.gridPanelCt.doLayout()
},Garp.setupEventManager=function(){Garp.eventManager=new Ext.util.Observable,Garp.eventManager.addEvents("modelchange","beforerowselect","rowselect","storeloaded","new","save-all","after-save","delete","logout","open-new-window","external-relation-save","after-init"),Garp.eventManager.on({"new":function(){Garp.updateUI.defer(20)},modelchange:Garp.changeModel,"open-new-window":function(){if(Garp.formPanel){var e=Garp.formPanel.getForm().findField("id").getValue();if(e){var t=BASE+"admin?"+Ext.urlEncode({model:Garp.currentModel,id:e});window.open(t)}}},logout:function(){window.location=BASE+"g/auth/logout"},preview:function(){var e=Garp.dataTypes[Garp.currentModel].previewLink,t=Garp.gridPanel.getSelectionModel().getSelected();if(e&&t){var i=new Ext.Template(e.urlTpl),s=i.apply([t.get(e.param)]);window.open(BASE+s)}},"after-init":function(){Garp.history.setupListeners(),Garp.history.parseState();var e=610;Garp.flashMessage()&&(e=2e3),setTimeout(function(){Ext.get("app-loader").fadeOut()},e),Garp.afterInit()}}),Garp.eventManager.relayEvents(Garp.toolbar,["logout","delete","new","open-new-window"])},Garp.setupGlobalKeys=function(){Garp.keyMap=new Ext.KeyMap(Ext.getBody(),[{key:Ext.EventObject.ENTER,ctrl:!0,handler:function(){Garp.formPanel.formcontent.getTopToolbar().saveButton.disabled||Garp.eventManager.fireEvent("save-all")}},{key:"N",ctrl:!0,handler:function(){Garp.dataTypes[Garp.currentModel].disableCreate||Garp.toolbar.newButton.disabled||Garp.eventManager.fireEvent("new")}}]),Garp.keyMap.stopEvent=!0},Garp.flashMessage=function(){var e=Ext.decode(Ext.util.Cookies.get("FlashMessenger")),t="";if(e.messages){for(var i in e.messages)i=e.messages[i],i&&(i=i.replace(/\+/g," "),t+=i+"<br>");if(t){var s=Ext.get("app-loader");s.update(t),s.setWidth(300),s.setHeight(20*(e.messages.length-1)+30);var a="; path=/",n=new Date;return n.setHours(n.getHours(-1)),a+=null===n?"":"; expires="+n.toGMTString(),document.cookie="FlashMessenger="+a,!0}}return!1},Garp.setupAjaxSpinner=function(){var e=Ext.select("#icon-loading-spinner");e.hide(),Ext.Ajax.on("requestcomplete",function(){Ext.Ajax.isLoading()||e.hide.defer(200,e)}),Ext.Ajax.on("beforerequest",function(){e.show()}),Ext.Ajax.on("requestexception",function(){e.hide()})},Garp.afterInitListeners=[],Garp.afterInit=function(e){return arguments.length?void Garp.afterInitListeners.push(e):void Ext.each(Garp.afterInitListeners,function(e){"function"==typeof e&&e()})},Garp.init=function(){Garp.gridPanel=new Garp.WelcomePanel,Garp.viewport=new Garp.Viewport,Garp.setupEventManager(),Garp.setupGlobalKeys(),Garp.setupAjaxSpinner(),Garp.eventManager.fireEvent("after-init")};