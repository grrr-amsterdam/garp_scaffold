function __(a){if(arguments.length>1){var b=[].slice.call(arguments);return b.unshift("undefined"!=typeof Garp.locale[a]?Garp.locale[a]:a),String.format.apply(String,b)}return"undefined"!=typeof Garp.locale[a]?Garp.locale[a]:a}Ext.ns("Garp"),function(){var a=/(^mailto:(\w+)([\-+.][\w]+)*@(\w[\-\w]*))|((((^https?)|(^ftp)):\/\/)?([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i;Ext.apply(Ext.form.VTypes,{mailtoOrUrl:function(b){return a.test(b)},mailtoOrUrlText:"Not a valid Url"})}(),Garp.mailtoOrUrlPlugin={init:function(a){var b=/(^mailto:(\w+)([\-+.][\w]+)*@(\w[\-\w]*))|(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i;a.on({change:function(a,c){!b.test(c)&&c&&a.setValue("http://"+c)}})}},Ext.apply(Ext.form.BasicForm.prototype,{updateRecord:function(a){a.beginEdit();var b,c,d=a.fields;return d.each(function(d){if(b=this.findField(d.name)){if("undefined"!=typeof b.isDirty&&!b.isDirty())return;c=b.getValue(),Ext.type(c)!==!1&&c.getGroupValue?c=c.getGroupValue():b.eachItem&&(c=[],b.eachItem(function(a){c.push(a.getValue())})),a.set(d.name,c)}},this),a.endEdit(),this}}),Ext.apply(Ext.form.FieldSet.prototype,{border:!1,buttonAlign:"left",collapsible:!0,defaults:{anchor:"-30",msgTarget:"under"},hideCollapseTool:!0,labelWidth:120,labelSeparator:" ",titleCollapse:!0}),Ext.apply(Ext.form.ComboBox.prototype,{triggerAction:"all",typeAhead:!1}),Ext.apply(Ext.grid.GridPanel.prototype,{loadMask:!0}),Ext.apply(Ext.form.BasicForm.prototype,{add:function(){var a=this;return a.items.addAll(Array.prototype.slice.call(arguments,0)),Ext.each(arguments,function(b){b.form=a,b.on("change",a.onFieldChange,a)}),a},onFieldChange:function(){this.fireEvent("change",this)},unDirty:function(){Ext.each(this.items.items,function(){("richtexteditor"===this.xtype||"htmleditor"===this.xtype)&&this.on({beforepush:{fn:function(){return!1},single:!0}}),this.originalValue=this.getValue()})}}),Ext.override(Ext.data.Store,{load:function(a){if(a=Ext.apply({},a),this.storeOptions(a),this.sortInfo&&this.remoteSort){var b=this.paramNames;a.params=Ext.apply({},a.params),a.params[b.sort]=this.sortInfo.field+" "+this.sortInfo.direction,delete a.params[b.dir]}try{return this.execute("read",null,a)}catch(c){return this.handleException(c),!1}}}),Ext.isIE||Ext.apply(Ext.menu.Menu.prototype,{listeners:{show:function(){if(!this.parentMenu){var a=this.getEl(),b={duration:.2};a.fadeIn(b),a.shadow&&a.shadow.el&&a.shadow.el.fadeIn(b)}return!0}}}),Ext.apply(Ext.grid.GridPanel.prototype,{listeners:{containerclick:function(){this.getSelectionModel().clearSelections()},viewready:function(){if(this.getView()&&this.getView().hmenu){var a=this.getView().hmenu.get("columns");a.menu.on("beforeshow",function(){var b=this.items;b.each(function(b){b.text||a.menu.remove(b.itemId)})})}}}}),Garp.videoTpl=new Ext.XTemplate('<iframe width="{width}" height="{height}" src="{player}" frameborder="0"></iframe>'),Ext.override(Ext.Panel,{setTitle:function(a,b){return this.tabEl&&(a=Ext.util.Format.ellipsis(a,25,!0)),this.title=a,this.header&&this.headerAsText&&this.header.child("span").update(a),b&&this.setIconClass(b),this.fireEvent("titlechange",this,a),this}}),Ext.apply(Ext.BasicForm.prototype,{getFieldValues:function(a){var b,c,d,e={};return this.items.each(function(f){function g(f){if(!f.disabled&&(a!==!0||f.isDirty())){if(b=f.getName(),!b)return;c=e[b],d=f.getValue(),Ext.isDefined(c)?Ext.isArray(c)?e[b].push(d):e[b]=[c,d]:e[b]=d}}"tweetfield"==f.xtype&&f.items?f.items.each(function(a){g(a)}):g(f)}),e}}),Ext.override(Ext.grid.Column,{virtual:!1}),Ext.override(Ext.form.Field,{enableKeyEvents:!0,getCountBox:function(){var a;return this.refOwner?a=this.refOwner[this.countBox]:this.ownerCt.ownerCt&&(a=this.ownerCt.ownerCt.ownerCt.ownerCt[this.countBox]),a},updateCountBox:function(){var a=this.maxLength-(this.getValue()?this.getValue().length:0);0>a?this.getCountBox().getEl().addClass("negative"):this.getCountBox().getEl().removeClass("negative"),this.getCountBox().update(a+" "+__("left"))},hideCountBox:function(){return this.getCountBox().update(""),!0},initComponent:function(){return Ext.form.Field.superclass.initComponent.call(this),this.xtype&&"superboxselect"==this.xtype?!0:(this.on("blur",function(){return this.getValue()&&this.getValue()===String(this.getValue())&&this.setValue(String(this.getValue()).trim()),!0},this),this.on("afterrender",function(){this.countBox&&this.maxLength&&(this.getEl().on({keypress:{fn:this.updateCountBox,buffer:50,scope:this}}),this.on("focus",this.updateCountBox,this),this.on("blur",this.hideCountBox,this),this.on("change",this.updateCountBox,this)),!this.allowBlank&&this.label&&this.label.addClass("required-field"),"numberfield"==this.xtype&&this.label&&(this.label.addClass("number-field"),this.width||(this.setWidth(50),delete this.anchor))},this),void this.addEvents("focus","blur","specialkey","change","invalid","valid"))}}),Ext.override(Ext.Button,{initComponent:function(){this.menu&&(this.menu=Ext.menu.MenuMgr.get(this.menu),this.menu.ownerCt=this),Ext.Button.superclass.initComponent.call(this),this.allowBlank!==!0&&this.on("afterrender",function(){this.label&&this.label.addClass("required-field")},this),this.addEvents("click","toggle","mouseover","mouseout","menushow","menuhide","menutriggerover","menutriggerout"),this.menu&&(this.menu.ownerCt=void 0),Ext.isString(this.toggleGroup)&&(this.enableToggle=!0)}}),Ext.override(Ext.form.DisplayField,{setValue:function(a){return this.renderer&&(a=this.renderer(a)),this.setRawValue(a),this}}),Ext.override(Ext.form.TimeField,{format:"H:i",getValue:function(){var a=Ext.form.TimeField.superclass.getValue.call(this);return this.formatDate(this.parseDate(a))||null}}),Ext.override(Ext.form.DateField,{getValue:function(){return this.parseDate(Ext.form.DateField.superclass.getValue.call(this))||null},setValue:function(a){return a&&(a.getFullYear&&a.getFullYear()>-1||this.parseDate(a))?Ext.form.DateField.superclass.setValue.call(this,this.formatDate(this.parseDate(a))):Ext.form.DateField.superclass.setValue.call(this,null)}}),Ext.override(Ext.PagingToolbar,{initComponent:function(){var a=Ext.Toolbar;this.first=new a.Button({}),this.last=new a.Button({}),this.refresh=new a.Button({});var b=[this.prev=new a.Button({tooltip:this.prevText,overflowText:this.prevText,iconCls:"x-tbar-page-prev",disabled:!0,handler:this.movePrevious,scope:this}),this.beforePageText,this.inputItem=new Ext.form.NumberField({cls:"x-tbar-page-number",allowDecimals:!1,allowNegative:!1,enableKeyEvents:!0,selectOnFocus:!0,submitValue:!1,listeners:{scope:this,keydown:this.onPagingKeyDown,blur:this.onPagingBlur}}),this.afterTextItem=new a.TextItem({text:String.format(this.afterPageText,1)}),this.next=new a.Button({tooltip:this.nextText,overflowText:this.nextText,iconCls:"x-tbar-page-next",disabled:!0,handler:this.moveNext,scope:this})],c=this.items||this.buttons||[];this.items=this.prependButtons?c.concat(b):b.concat(c),delete this.buttons,this.displayInfo&&(this.items.push("->"),this.items.push(this.displayItem=new a.TextItem({}))),Ext.PagingToolbar.superclass.initComponent.call(this),this.addEvents("change","beforechange"),this.on("afterlayout",this.onFirstLayout,this,{single:!0}),this.cursor=0,this.bindStore(this.store,!0)}}),Ext.ns("Garp"),Garp.SMALLSCREENWIDTH=640,"undefined"==typeof Garp.locale&&(Garp.locale={});var maxItems=Math.floor((window.innerHeight-100-34)/20)-1;Ext.applyIf(Garp,{pageSize:2*maxItems,localUser:{},confirmMsg:__("Changes will get lost. Continue?")}),Ext.apply(Ext.Ajax,{timeout:0}),Ext.ns("Garp.renderers"),Ext.apply(Garp.renderers,{fullNameConverter:function(a,b){var c=[];return Ext.each(["first_name","last_name_prefix","last_name"],function(a){b[a]&&c.push(b[a])}),c||(c=b.name),c.join(" ")},geocodeAddressRenderer:function(a){a=a.address_components;var b,c,d,e,f,g="";return Ext.each(a,function(a){a.types.indexOf("country")>-1&&(b=a.long_name,c=a.short_name),a.types.indexOf("locality")>-1&&(d=a.short_name),a.types.indexOf("route")>-1&&(e=a.short_name),a.types.indexOf("street_number")>-1&&(f=a.short_name)}),f?g=e+" "+f:e&&(g=e),d&&(g+=", "+d),"NL"!=c&&(g+=", "+b),g},htmlRenderer:function(){return""},shortDateTimeRenderer:function(a){var b="d M Y H:i";return Ext.isDate(a)?a.format(b):a&&"undefined"!=typeof Date.parseDate(a,"Y-m-d H:i:s")?Date.parseDate(a,"Y-m-d H:i:s").format(b):"-"},dateTimeRenderer:function(a){var b="d F Y H:i";return Ext.isDate(a)?a.format(b):a&&"undefined"!=typeof Date.parseDate(a,"Y-m-d H:i:s")?Date.parseDate(a,"Y-m-d H:i:s").format(b):"-"},metaPanelDateRenderer:function(a){return a&&"0000"==a.substr(0,4)?"<i>"+__("Invalid date")+"</i>":a?Garp.renderers.intelliDateTimeRenderer(a):"<i>"+__("No date specified")+"</i>"},dateRenderer:function(a){var b="d F Y";if(Ext.isDate(a)){var c=a.format(b);return c}return a&&"undefined"!=typeof Date.parseDate(a,"Y-m-d")?Date.parseDate(a,"Y-m-d").format(b):a&&"undefined"!=typeof Date.parseDate(a,"d F Y")?Date.parseDate(a,"d F Y").format(b):"-"},timeRenderer:function(a){var b="H:i";if(Ext.isDate(a)){var c=a.format(b);return c}return a&&"undefined"!=typeof Date.parseDate(a,"H:i:s")?Date.parseDate(a,"H:i:s").format(b):a&&"undefined"!=typeof Date.parseDate(a,"H:i")?Date.parseDate(a,"H:i").format(b):"-"},yearRenderer:function(a){var b="Y";return Ext.isDate(a)?a.format(b):a&&"undefined"!=typeof Date.parseDate(a,"Y")?Date.parseDate(a,"Y").format(b):"-"},intelliDateTimeRenderer:function(a){var b=new Date,c=(new Date).add(Date.DAY,-1);return(a=Date.parseDate(a,"Y-m-d H:i:s"))?a.getYear()==b.getYear()&&a.getMonth()==b.getMonth()?a.getDate()==c.getDate()?__("Yesterday at")+" "+a.format("H:i"):a.getDate()==b.getDate()?__("Today at")+" "+a.format("H:i"):a.format("j M"):a.format("j M Y"):void 0},imageRenderer:function(a,b,c,d){c||(c={id:0}),Ext.isObject(d)||(d={size:64});var e=new Ext.Template('<div class="garp-image-renderct"><img src="'+IMAGES_CDN+"scaled/cms_list/"+c.id+'" width="'+d.size+'" alt="{0}" /></div>',{compile:!1,disableFormats:!0}),f=new Ext.Template('<div class="garp-image-renderct"><img src="{0}" width="'+d.size+'" alt="{0}" /></div>',{compile:!1,disableFormats:!0});if("undefined"==typeof c)return __("New Image");var g=a?/^https?:\/\//.test(a)?f.apply([a]):e.apply([a]):__("No Image uploaded");return g},imageRelationRenderer:function(a,b){var c='<img src="'+IMAGES_CDN+"scaled/cms_list/"+a+'" width="64" alt="" />';return b?(a||(c='<div class="no-img"></div>'),'<div class="garp-image-renderct">'+c+"</div>"):a?c:null},imagePreviewRenderer:function(a,b,c){var d=new Ext.Template('<div class="garp-image-renderct"><img src="'+IMAGES_CDN+"scaled/cms_preview/"+c.id+'" alt="{0}" /></div>',{compile:!0,disableFormats:!0});"undefined"==typeof c&&(c={phantom:!0});var e=a?d.apply([a]):__(c.phantom===!0?"New Image":"No Image uploaded");return e},uploadedImagePreviewRenderer:function(a){var b=new Ext.Template('<div class="garp-image-renderct"><img src="'+IMAGES_CDN+a+'" /></div>',{compile:!0,disableFormats:!0});return b.apply(a)},cropPreviewRenderer:function(a,b,c){if(c.get("w")&&c.get("h")){var d=32,e=c.get("w")/c.get("h")*d,f=c.get("h")/c.get("w")*d;e>d&&(f*=d/e,e=d),f>d&&(e*=d/f,f=d),f==e&&(e=f=.75*d);var g=(d-f)/2,h=(d-e)/2;return f=Math.ceil(f),e=Math.ceil(e),g=Math.floor(g),h=Math.floor(h),'<div style="background: #aaa; width: '+d+"px; height: "+d+'px; border: 1px #888 solid;"><div style="width: '+e+"px; height: "+f+"px; background-color: #eee;margin: "+g+"px "+h+'px;"></div></div>'}return""},checkVisible:function(a,b,c){return c.getRow(a)?Ext.get(c.getCell(a,b)).isVisible(!0):!1},remoteDisplayFieldRenderer:function(a,b,c,d,e,f,g,h){return h&&a?(g.on("refresh",function(){Garp.renderers.checkVisible(d,e,g)&&Garp[h].fetch({query:{id:a}},function(a){if(a.rows&&a.rows[0]){a.rows[0].get=function(a){return this[a]||""};var b=Garp.dataTypes[h].displayFieldRenderer(a.rows[0]);Ext.get(g.getCell(d,e))&&Ext.get(g.getCell(d,e)).update('<div unselectable="on" class="x-grid3-cell-inner x-grid3-col-0">'+b+"</div>")}})},{buffer:200,scope:this}),'<div class="remoteDisplayFieldSpinner"></div>'):void 0},checkboxRenderer:function(a){return __("1"==a?"yes":"no")},i18nRenderer:function(a){return a&&"object"==typeof a&&a[DEFAULT_LANGUAGE]?a[DEFAULT_LANGUAGE]:"object"!=typeof a?a:"-"}}),Ext.ns("Ext.ux"),Ext.ux.Searchbar=Ext.extend(Ext.Toolbar,{height:27,grid:null,makeQuery:function(a){if(a){var b=this.grid.getStore().baseParams?this.grid.getStore().baseParams.query:"",c=new Ext.util.MixedCollection;c.addAll(Garp.dataTypes);var d={};Ext.isObject(b)&&c.eachKey(function(a){var c=a+".id";b[c]&&(d[c]=b[c]);var e=a+".id <>";b[e]&&(d[e]=b[e])});var e=this.getSelectedSearchFields();!e.length&&this.getAllSearchFields().length&&(e=this.searchableFields);var f=Ext.apply(this.convertQueryString(a,e),d);this.grid.getStore().setBaseParam("query",f),this.grid.getStore().setBaseParam("pageSize",Garp.pageSize)}else this.grid.getStore().baseParams=Ext.apply({},this.originalBaseParams);this.fireEvent("search",this),this.grid.getStore().load()},convertQueryString:function(a,b){if(""===a)return{};var c="%"+a+"%";if(b&&b.length){var d={};return Ext.each(b,function(a){d[a+" like"]=c}),{or:d}}},getSelectedSearchFields:function(){var a=[];return this.searchOptionsMenu&&Ext.each(this.searchOptionsMenu.items.items,function(b){"menucheckitem"===b.xtype&&b.checked&&b._dataIndex&&a.push(b._dataIndex)}),a},getAllSearchFields:function(){var a=[];if(this.grid)return Ext.each(this.grid.getColumnModel().config,function(b){b.searchable!==!1&&(b.searchable||"relationMetadata"!==b.dataIndex)&&a.push(b)}),a},searchOptionsMenu:new Ext.menu.Menu({items:{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:Ext.PagingToolbar.prototype.emptyMsg}}),buildSearchOptionsMenu:function(){var a=this.getAllSearchFields(),b=[{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:__("Search in:")},{xtype:"menucheckitem",ref:"selectAll",hideOnClick:!1,checked:!1,text:__("Select All"),checkHandler:function(a,b){a.parentMenu&&a.parentMenu.items.each(function(){this._dataIndex&&this.setChecked(b,!0)})}},"-"];this.searchableFields=[],Ext.each(a,function(a){b.push({text:a.header,checked:a.searchable||!a.hidden,_dataIndex:a.dataIndex}),(a.searchable||!a.hidden)&&this.searchableFields.push(a.dataIndex)},this),this.searchOptionsMenu=new Ext.menu.Menu({defaults:{xtype:"menucheckitem",hideOnClick:!1},items:b})},setBaseParams:function(){this.originalBaseParams=Ext.apply({},this.store.baseParams)},initComponent:function(){this.addEvents("search"),this.store.on({load:{scope:this,single:!0,fn:function(){this.grid||(this.grid=this.ownerCt),this.grid&&(this.grid.getColumnModel().on("hiddenchange",function(){this.buildSearchOptionsMenu()},this),this.buildSearchOptionsMenu())}}});var a=this;this.layout="hbox",this.items=[{xtype:"tbbutton",ref:"searchoptionsbtn",iconCls:"icon-searchoptions",tooltip:__("Zoekopties"),width:22,flex:0,scope:this,handler:function(a){this.searchOptionsMenu.show(a.el)}},this.searchField=new Ext.ux.form.SearchField({xtype:"twintrigger",flex:1,store:this.store,value:Ext.isObject(this.store.baseParams.query)?"":this.store.baseParams.query,listeners:{change:function(){var a=this.getValue();a.length<1?this.removeClass("has-search"):this.addClass("has-search")}},onTrigger1Click:function(){this.hasSearch&&(this.triggers[0].hide(),this.el.dom.value="",a.makeQuery(""),this.removeClass("has-search"))},onTrigger2Click:function(){var b=this.getRawValue();return b.length<1?void this.onTrigger1Click():(this.triggers[0].show(),this.hasSearch=!0,void a.makeQuery(b))}})],Ext.ux.Searchbar.superclass.initComponent.call(this)},blur:function(){this.searchField.blur(),Ext.ux.Searchbar.superclass.blur.call(this)},searchById:function(a){var b=this,c=this.searchField,d=this.searchOptionsMenu;c.setValue(a),c.triggers[0].show(),c.hasSearch=!0,c.fireEvent("change"),d.items.each(function(a){a.setChecked&&a.setChecked("id"==a.text?!0:!1)}),b.fireEvent("change")},afterRender:function(){new Ext.KeyNav(this.getEl(),{esc:function(){this.blur(),this.fireEvent("defocus")},scope:this});this.setBaseParams(),Ext.ux.Searchbar.superclass.afterRender.call(this)}}),Ext.reg("searchbar",Ext.ux.Searchbar),Ext.ns("Ext.ux.form"),Ext.ux.form.DateTime=Ext.extend(Ext.form.Field,{dateValidator:null,defaultAutoCreate:{tag:"input",type:"hidden"},dtSeparator:" ",hiddenFormat:"Y-m-d H:i:s",otherToNow:!0,timePosition:"right",timeValidator:null,timeWidth:100,dateFormat:"m/d/y",timeFormat:"g:i A",initComponent:function(){Ext.ux.form.DateTime.superclass.initComponent.call(this);var a=Ext.apply({},{id:this.id+"-date",format:this.dateFormat||Ext.form.DateField.prototype.format,width:this.timeWidth,hidden:this.hidden,selectOnFocus:this.selectOnFocus,validator:this.dateValidator,enableKeyEvents:!0,listeners:{blur:{scope:this,fn:this.onBlur},keypress:{scope:this,fn:this.onBlur},focus:{scope:this,fn:this.onFocus}}},this.dateConfig);this.df=new Ext.form.DateField(a),this.df.ownerCt=this,delete this.dateFormat;var b=Ext.apply({},{id:this.id+"-time",format:this.timeFormat||Ext.form.TimeField.prototype.format,width:this.timeWidth,hidden:this.hidden,selectOnFocus:this.selectOnFocus,validator:this.timeValidator,enableKeyEvents:!0,listeners:{blur:{scope:this,fn:this.onBlur},keypress:{scope:this,fn:this.onBlur},focus:{scope:this,fn:this.onFocus}}},this.timeConfig);this.tf=new Ext.form.TimeField(b),this.tf.ownerCt=this,delete this.timeFormat,this.relayEvents(this.df,["focus","specialkey","invalid","valid"]),this.relayEvents(this.tf,["focus","specialkey","invalid","valid"]),this.on("specialkey",this.onSpecialKey,this)},onRender:function(a,b){if(!this.isRendered){Ext.ux.form.DateTime.superclass.onRender.call(this,a,b);var c;if(c="below"===this.timePosition||"bellow"===this.timePosition?Ext.DomHelper.append(a,{tag:"table",style:"border-collapse:collapse",children:[{tag:"tr",children:[{tag:"td",style:"padding-bottom:1px",cls:"ux-datetime-date"}]},{tag:"tr",children:[{tag:"td",cls:"ux-datetime-time"}]}]},!0):Ext.DomHelper.append(a,{tag:"table",style:"border-collapse:collapse",children:[{tag:"tr",children:[{tag:"td",style:"padding-right:4px",cls:"ux-datetime-date"},{tag:"td",cls:"ux-datetime-time"}]}]},!0),this.tableEl=c,this.wrap=c.wrap({cls:"x-form-field-wrap"}),this.wrap.on("mousedown",this.onMouseDown,this,{delay:10}),this.df.render(c.child("td.ux-datetime-date")),this.tf.render(c.child("td.ux-datetime-time")),this.df.el.swallowEvent(["keydown","keypress"]),this.tf.el.swallowEvent(["keydown","keypress"]),"side"===this.msgTarget){var d=this.el.findParent(".x-form-element",10,!0);d&&(this.errorIcon=d.createChild({cls:"x-form-invalid-icon"}));var e={errorIcon:this.errorIcon,msgTarget:"side",alignErrorIcon:this.alignErrorIcon.createDelegate(this)};Ext.apply(this.df,e),Ext.apply(this.tf,e)}this.el.dom.name=this.hiddenName||this.name||this.id,this.df.el.dom.removeAttribute("name"),this.tf.el.dom.removeAttribute("name"),this.isRendered=!0,this.updateHidden()}},adjustSize:Ext.BoxComponent.prototype.adjustSize,alignErrorIcon:function(){this.errorIcon.alignTo(this.tableEl,"tl-tr",[2,0])},initDateValue:function(){this.dateValue=this.otherToNow?new Date:new Date(1970,0,1,0,0,0)},clearInvalid:function(){this.df.clearInvalid(),this.tf.clearInvalid()},markInvalid:function(a){this.df.markInvalid(a),this.tf.markInvalid(a)},beforeDestroy:function(){this.isRendered&&(this.wrap.removeAllListeners(),this.wrap.remove(),this.tableEl.remove(),this.df.destroy(),this.tf.destroy())},disable:function(){return this.isRendered&&(this.df.disabled=this.disabled,this.df.onDisable(),this.tf.onDisable()),this.disabled=!0,this.df.disabled=!0,this.tf.disabled=!0,this.fireEvent("disable",this),this},enable:function(){return this.rendered&&(this.df.onEnable(),this.tf.onEnable()),this.disabled=!1,this.df.disabled=!1,this.tf.disabled=!1,this.fireEvent("enable",this),this},focus:function(){this.df.focus()},getPositionEl:function(){return this.wrap},getResizeEl:function(){return this.wrap},getValue:function(){return this.dateValue?new Date(this.dateValue):""},isValid:function(){return this.df.isValid()&&this.tf.isValid()},isVisible:function(){return this.df.rendered&&this.df.getActionEl().isVisible()},onBlur:function(a){this.wrapClick&&(a.focus(),this.wrapClick=!1),a===this.df?this.updateDate():this.updateTime(),this.updateHidden(),this.validate(),function(){if(!this.df.hasFocus&&!this.tf.hasFocus){var a=this.getValue();String(a)!==String(this.startValue)&&this.fireEvent("change",this,a,this.startValue),this.hasFocus=!1,this.fireEvent("blur",this)}}.defer(100,this)},onFocus:function(){this.hasFocus||(this.hasFocus=!0,this.startValue=this.getValue(),this.fireEvent("focus",this))},onMouseDown:function(a){this.disabled||(this.wrapClick="td"===a.target.nodeName.toLowerCase())},onSpecialKey:function(a,b){var c=b.getKey();c===b.TAB&&(a!==this.df||b.shiftKey||(b.stopEvent(),this.tf.focus()),a===this.tf&&b.shiftKey&&(b.stopEvent(),this.df.focus()),this.updateValue()),c===b.ENTER&&(this.tf.setValue(this.tf.getRawValue()),this.updateValue())},reset:function(){},setDate:function(a){this.df.setValue(a)},setTime:function(a){this.tf.setValue(a)},setSize:function(a,b){a&&("below"===this.timePosition?(this.df.setSize(a,b),this.tf.setSize(a,b),Ext.isIE&&(this.df.el.up("td").setWidth(a),this.tf.el.up("td").setWidth(a))):(this.df.setSize(a-this.timeWidth-4,b),this.tf.setSize(this.timeWidth,b),Ext.isIE&&(this.df.el.up("td").setWidth(a-this.timeWidth-4),this.tf.el.up("td").setWidth(this.timeWidth))))},setValue:function(a){if(!a&&!0===this.emptyToNow)return void this.setValue(new Date);if(!a)return this.setDate(""),this.setTime(""),void this.updateValue();"number"==typeof a?a=new Date(a):"string"==typeof a&&this.hiddenFormat&&(a=Date.parseDate(a,this.hiddenFormat)),a=a?a:new Date(1970,0,1,0,0,0);var b;a instanceof Date?(this.setDate(a),this.setTime(a),this.dateValue=new Date(Ext.isIE?a.getTime():a)):(b=a.split(this.dtSeparator),this.setDate(b[0]),b[1]&&(b[2]&&(b[1]+=b[2]),this.setTime(b[1]))),this.updateValue()},setVisible:function(a){return a?(this.df.show(),this.tf.show()):(this.df.hide(),this.tf.hide()),this},show:function(){return this.setVisible(!0)},hide:function(){return this.setVisible(!1)},updateDate:function(){var a=this.df.getValue();a?(this.dateValue instanceof Date||(this.initDateValue(),this.tf.getValue()||this.setTime(this.dateValue)),this.dateValue.setMonth(0),this.dateValue.setFullYear(a.getFullYear()),this.dateValue.setMonth(a.getMonth(),a.getDate())):(this.dateValue="",this.setTime(""))},updateTime:function(){var a=this.tf.getValue();!a||a instanceof Date||(a=Date.parseDate(a,this.tf.format)),a&&!this.df.getValue()&&(this.initDateValue(),this.setDate(this.dateValue)),this.dateValue instanceof Date&&(a?(this.dateValue.setHours(a.getHours()),this.dateValue.setMinutes(a.getMinutes()),this.dateValue.setSeconds(a.getSeconds())):(this.dateValue.setHours(0),this.dateValue.setMinutes(0),this.dateValue.setSeconds(0)))},updateHidden:function(){if(this.isRendered){var a=this.dateValue instanceof Date?this.dateValue.format(this.hiddenFormat):"";this.el.dom.value=a}},updateValue:function(){this.updateDate(),this.updateTime(),this.updateHidden()},validate:function(){return this.df.validate()&&this.tf.validate()},renderer:function(a){var b=a.editor.dateFormat||Ext.ux.form.DateTime.prototype.dateFormat;b+=" "+(a.editor.timeFormat||Ext.ux.form.DateTime.prototype.timeFormat);var c=function(a){var c=Ext.util.Format.date(a,b);return c};return c}}),Ext.reg("xdatetime",Ext.ux.form.DateTime),Ext.apply(Ext.ux.form.DateTime.prototype,{dateFormat:"d F Y",timeFormat:"H:i:s"}),Garp.MapWindow=Ext.extend(Ext.Window,{width:800,height:440,modal:!0,iconCls:"icon-map",maximizable:!0,frame:!0,title:__("Map"),buttonAlign:"left",lat:null,"long":null,address:null,fieldRef:null,map:null,pointer:null,latlng:null,buildPointer:function(){this.pointer=new google.maps.Marker({position:this.latlng,animation:google.maps.Animation.DROP,draggable:!0});var a=this;google.maps.event.addListener(this.pointer,"dragend",function(b){a.latlng=b.latLng,a.map.setCenter(b.latLng)}),this.pointer.setMap(this.map)},addLocation:function(){this.latlng=this.map.getCenter(),this.buildPointer(),this.pointer.setMap(this.map),this.addLocationBtn.hide(),this.removeLocationBtn.show()},removeLocation:function(){this.pointer&&this.pointer.setMap(null),this.addLocationBtn.show(),this.removeLocationBtn.hide()},drawMap:function(){if(this.map=new google.maps.Map(this.body.dom,{mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:11}),this.pointer)this.map.setCenter(this.latlng),this.pointer.setMap(this.map),this.removeLocationBtn.show(),this.addLocationBtn.hide();else{this.addLocationBtn.show(),this.removeLocationBtn.hide();var a=this.fieldRef.find("name",this.lat)[0].getValue(),b=this.fieldRef.find("name",this["long"])[0].getValue();a&&b?(this.latlng=new google.maps.LatLng(a,b),this.map.setCenter(this.latlng),this.buildPointer()):this.map.setCenter(new google.maps.LatLng(52.3650012,5.0692639))}},initComponent:function(){this.on({afterrender:{scope:this,fn:function(){"undefined"==typeof google?Garp.lazyLoad("//maps.googleapis.com/maps/api/js?sensor=false",this.drawMap.createDelegate(this)):this.drawMap()}}},{resize:{fn:function(){this.map&&google.maps.event.trigger(this.map,"resize")}}}),Ext.apply(this,{buttons:[{text:__("Add Location"),ref:"../addLocationBtn",hidden:!0,handler:this.addLocation.createDelegate(this)},{text:__("Remove Location"),ref:"../removeLocationBtn",hidden:!0,handler:this.removeLocation.createDelegate(this)},{text:__("Address Lookup"),iconCls:"icon-search",scope:this,handler:function(){var a=this;Ext.Msg.prompt(__("Address Lookup"),__("Please enter the address to lookup:"),function(b,c){if("ok"==b&&c){var d=new google.maps.Geocoder;d.geocode({address:c},function(b,c){"OK"==c&&b.length?(a.latlng=b[0].geometry.location,a.buildPointer(),a.drawMap(),a.addLocationBtn.hide(),a.removeLocationBtn.show()):Ext.Msg.alert(a.title,__("Address not found"))})}})}},"->",{text:__("Ok"),scope:this,handler:function(){this.fieldRef.find("name",this.lat)[0].setValue(""+this.latlng.lat()),this.fieldRef.find("name",this["long"])[0].setValue(""+this.latlng.lng()),this.fieldRef.find("name",this.lat)[0].fireEvent("change"),this.fieldRef.find("name",this["long"])[0].fireEvent("change"),this.close()}},{text:__("Cancel"),scope:this,handler:this.close}]}),Garp.MapWindow.superclass.initComponent.call(this)}}),Ext.ns("Garp"),Garp.MapField=Ext.extend(Ext.form.FieldSet,{latFieldname:"location_lat",longFieldname:"location_long",addressRef:"location_address",fieldLabel:__("Location"),anchor:-30,layout:"hbox",msgTarget:"under",style:"padding: 0;",updateAddress:function(){function a(){var a=new google.maps.Geocoder;c.getValue()&&d.getValue()?a.geocode({latLng:new google.maps.LatLng(c.getValue(),d.getValue())},function(a,b){e.update(b==google.maps.GeocoderStatus.OK?a[0]?Garp.renderers.geocodeAddressRenderer(a[0]):__("Location set, but unknown"):b==google.maps.GeocoderStatus.ZERO_RESULTS?__("Location set, but unknown"):__("Unknown error occurred."))}):e.update(__("No location specified"))}var b=this.refOwner.refOwner,c=b.getForm().findField(this.latFieldname),d=b.getForm().findField(this.longFieldname),e=b.formcontent[this.addressRef];"undefined"==typeof google?Garp.lazyLoad("http://maps.googleapis.com/maps/api/js?sensor=false",a):a(),c.on("change",a)},initComponent:function(a){this.items=[{xtype:"button",iconCls:"icon-map",text:__("Map"),flex:0,margins:"0 20 0 0",handler:function(){new Garp.MapWindow({fieldRef:this.ownerCt,lat:this.latFieldname,"long":this.longFieldname}).show()},scope:this},{name:this.latFieldname,fieldLabel:__("Location lat"),disabled:!1,hidden:!0,allowBlank:!0,xtype:"textfield"},{name:this.longFieldname,fieldLabel:__("Location long"),disabled:!1,hidden:!0,allowBlank:!0,xtype:"textfield"},{xtype:"box",ref:"../../"+this.addressRef,flex:0,margins:"4 20 0 0"}],Garp.MapField.superclass.initComponent.call(this,a),this.on("show",this.updateAddress,this)}}),Ext.reg("mapfield",Garp.MapField),Ext.ux.form.RederedDisplayField=Ext.extend(Ext.form.DisplayField,{renderer:function(a){return a},setRawValue:function(a){return a=this.renderer(a),this.htmlEncode&&(a=Ext.util.Format.htmlEncode(a)),this.rendered?this.el.dom.innerHTML=Ext.isEmpty(a)?"":a:this.value=a}}),Ext.reg("rendereddisplayfield",Ext.ux.form.RederedDisplayField),Ext.ns("Ext.ux.form"),Ext.ux.form.FileUploadField=Ext.extend(Ext.form.TextField,{buttonText:__("Browse&hellip;"),buttonOnly:!1,buttonOffset:3,readOnly:!0,autoSize:Ext.emptyFn,initComponent:function(){Ext.ux.form.FileUploadField.superclass.initComponent.call(this),this.addEvents("fileselected")},onRender:function(a,b){Ext.ux.form.FileUploadField.superclass.onRender.call(this,a,b),this.wrap=this.el.wrap({cls:"x-form-field-wrap x-form-file-wrap"}),this.el.addClass("x-form-file-text"),this.el.dom.removeAttribute("name"),this.createFileInput();var c=Ext.applyIf(this.buttonCfg||{},{text:this.buttonText});this.button=new Ext.Button(Ext.apply(c,{renderTo:this.wrap,cls:"x-form-file-btn"+(c.iconCls?" x-btn-icon":"")})),this.buttonOnly&&(this.el.hide(),this.wrap.setWidth(this.button.getEl().getWidth())),this.bindListeners(),this.resizeEl=this.positionEl=this.wrap},bindListeners:function(){this.fileInput.on({scope:this,mouseenter:function(){this.button.addClass(["x-btn-over","x-btn-focus"])},mouseleave:function(){this.button.removeClass(["x-btn-over","x-btn-focus","x-btn-click"])},mousedown:function(){this.button.addClass("x-btn-click")},mouseup:function(){this.button.removeClass(["x-btn-over","x-btn-focus","x-btn-click"])},change:function(){var a=this.fileInput.dom.value;this.setValue(a),this.fireEvent("fileselected",this,a)}})},createFileInput:function(){this.fileInput=this.wrap.createChild({id:this.getFileInputId(),name:this.name||this.getId(),cls:"x-form-file",tag:"input",type:"file",size:1})},reset:function(){this.fileInput&&(this.fileInput.remove(),this.createFileInput(),this.bindListeners()),Ext.ux.form.FileUploadField.superclass.reset.call(this)},getFileInputId:function(){return this.id+"-file"},onResize:function(a,b){Ext.ux.form.FileUploadField.superclass.onResize.call(this,a,b),this.wrap.setWidth(a),this.buttonOnly||(a=this.wrap.getWidth()-this.button.getEl().getWidth()-this.buttonOffset,this.el.setWidth(a))},onDestroy:function(){Ext.ux.form.FileUploadField.superclass.onDestroy.call(this),Ext.destroy(this.fileInput,this.button,this.wrap)},onDisable:function(){Ext.ux.form.FileUploadField.superclass.onDisable.call(this),this.doDisable(!0)},onEnable:function(){Ext.ux.form.FileUploadField.superclass.onEnable.call(this),this.doDisable(!1)},doDisable:function(a){this.fileInput.dom.disabled=a,this.button.setDisabled(a)},preFocus:Ext.emptyFn,alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,"tl-tr",[2,0])}}),Ext.reg("fileuploadfield",Ext.ux.form.FileUploadField),Ext.form.FileUploadField=Ext.ux.form.FileUploadField,Ext.ns("Ext.ux.form"),Ext.ux.form.UploadCombo=Ext.extend(Ext.form.TriggerField,{title:__("Upload"),fieldLabel:__("File"),iconCls:"icon-image",emptyText:__("Select file"),previewTpl:new Ext.Template('<img src="{0}uploads/images/{1}" title="{1}" style="max-width:400px;max-height:260px;" /><br><a href="{0}uploads/images/{1}" target="_blank">'+__("Download")+"&hellip;</a>"),uploadURL:BASE+"g/content/upload",showUploadDialog:function(){var a={ref:"previewBox",hideMode:"visibility",frame:!0,hidden:!0};this.getValue()&&Ext.apply(a,{html:this.previewTpl.apply([BASE,this.getValue()]),style:"overflow: auto;margin-bottom: 10px;text-align:center;",height:290,hidden:!1}),this.win=new Ext.Window({modal:!0,title:this.title,iconCls:this.iconCls,width:450,height:this.getValue()?420:130,border:!1,items:[{xtype:"form",ref:"formpanel",fileUpload:!0,border:!1,frame:!0,bodyStyle:"padding: 10px 10px 0 10px",items:[a,{anchor:"95%",value:this.value,height:40,name:"file",fieldLabel:this.fieldLabel,allowBlank:!1,buttonText:__("Browse&hellip;"),hideFieldLabel:!0,emptyText:this.emptyText,listeners:{fileselected:this.performUpload.createDelegate(this)},xtype:"fileuploadfield"}]}],buttons:[{text:__("Cancel"),scope:this,handler:function(){this.win.close()
}}]}),this.win.show(),this.setupFileDrop()},performUpload:function(){var a=this.win.formpanel.getForm();if(a.isDirty()){var b=new Ext.LoadMask(Ext.getBody(),{msg:__("Uploading...")});b.show();a.submit({clientValidation:!1,url:this.uploadURL,success:this.uploadCallback.createSequence(function(){b.hide()}).createDelegate(this),failure:function(a,c){b.hide();var d="";c&&c.result&&c.result.messages&&c.result.messages.length&&(d=c.result.messages.join("<br />")),Ext.Msg.alert(__("Error"),"<b>"+__("Error uploading file")+"</b>:<br />"+d)}})}else this.win.close()},uploadCallback:function(a,b){this.win.close(),b.result.file&&this.setValue(b.result.file),this.fireEvent("change",this,b.result.file,"")},setupFileDrop:function(){function a(a){return a.stopPropagation(),a.preventDefault(),!1}function b(b){function c(a){for(var b="",c=0;a>c;c++)b+=""+Math.floor(10*Math.random());return b}a(b),b=b.browserEvent;var e=new Ext.LoadMask(d.win.getEl(),__("Uploading..."));if(b.dataTransfer&&b.dataTransfer.files){var f=b.dataTransfer.files[0],g=new FileReader;g.onload=function(a){var b=a.target.result,g=new XMLHttpRequest,h="",i="",j="\r\n";g.addEventListener("load",function(a){e.hide();var b=Ext.decode(a.target.responseText),c={result:b};d.uploadCallback.call(d,null,c)},!1);var k="---------------------------"+c(13);g.open("POST",d.uploadURL,!0),g.setRequestHeader("Content-Type","multipart/form-data; boundary="+k),g.setRequestHeader("Content-Length",f.fileSize),h+="--"+k+j,h+='Content-Disposition: form-data; name="file"; filename="'+f.fileName+'"'+j+j,i=j+"--"+k+"--"+j,g.sendAsBinary(h+""+b+i),e.show()},g.readAsBinaryString(f)}return!1}var c=this.win.getEl(),d=this;Ext.EventManager.on(c,"dragenter",function(b){c.highlight(),a(b)}),Ext.EventManager.on(c,"dragexit",a),Ext.EventManager.on(c,"dragover",a),Ext.EventManager.on(c,"drop",b)},onTriggerClick:function(){this.showUploadDialog()},getValue:function(){var a=Ext.ux.form.UploadCombo.superclass.getValue.call(this);return a||(a=null),a},initComponent:function(){Ext.ux.form.UploadCombo.superclass.initComponent.call(this,arguments)}}),Ext.reg("uploadcombo",Ext.ux.form.UploadCombo),Ext.ns("Ext.ux.form"),Ext.ux.form.UploadField=Ext.extend(Ext.ux.form.FileUploadField,{maxSurface:6e6,uploadURL:BASE+"g/content/upload",supportedExtensions:["gif","jpg","jpeg","png"],getValue:function(){var a=Ext.ux.form.UploadCombo.superclass.getValue.call(this);return a||(a=null),a},validateExtension:function(a){var b=a.split(".");if(!b)return!1;b=b[b.length-1];var c=b[0];return c.length?this.supportedExtensions.indexOf(b.toLowerCase())>-1:!1},validateResolution:function(a,b){if("function"!=typeof FileReader)return void b(!0);var c=new FileReader,d=this;c.onload=function(){var a=new Image;a.onload=function(){var c=a.width*a.height,e=c<=d.maxSurface;b(e)},a.src=c.result},c.readAsDataURL(a)},handleFileDrop:function(a){return this.wrap.removeClass("x-focus"),a.dataTransfer&&a.dataTransfer.files&&1==a.dataTransfer.files.length&&this.performUpload(a.dataTransfer.files[0]),!1},handleFileSelect:function(){this.performUpload(this.fileInput)},isImage:function(a){var b=a.name.split(".").pop();if(!b)return!1;for(var c=["jpg","jpeg","png","gif"],d=0,e=c.length;e>d;++d)if(c[d]===b)return!0;return!1},performUpload:function(a){var b=this;if(Ext.isIE){var c=new Ext.LoadMask(Ext.getBody(),{msg:__("Loading")});c.show();var d=Ext.DomHelper,e=Ext.get(d.insertHtml("beforeEnd",Ext.getBody().dom,'<iframe src="javscript:false;" name="uploadFrame" style="display:none;"></iframe>')),f=Ext.get(d.insertHtml("beforeEnd",Ext.getBody().dom,'<form method="post" target="uploadFrame" action="'+this.uploadURL+'" enctype="multipart/form-data"></form>'));Ext.get(a).appendTo(f),e.on("load",function(){var a=Ext.decode(e.dom.contentDocument.body.innerHTML);a&&a.success?(b.setValue(a.filename),b.fireEvent("change",b,a.filename)):Ext.Msg.alert(__("Garp"),__("Error uploading file.")),f.remove(),e.remove(),c.hide()}),f.dom.submit()}else{var g;if(g=a.dom&&a.dom.files?a.dom.files[0]:a,!g||!g.name)return;var h=function(a,c){b.setValue(b.originalValue),Ext.Msg.alert(a||__("Garp"),c||__("Error uploading file."))},i=function(a){if(a)if(b.validateExtension(g.name)){var c=new FormData,d=new XMLHttpRequest;b.uploadDialog=Ext.Msg.progress(__("Upload"),__("Initializing upload")),c.append("filename",g),d.addEventListener("load",function(){var a=Ext.decode(d.responseText);b.uploadDialog.hide(),a.success?(b.setValue(a.filename),b.fireEvent("change",b,a.filename)):h()},!1),d.addEventListener("error",function(){b.uploadDialog.hide(),h()},!1),d.upload.addEventListener("progress",function(a){a.lengthComputable&&(b.uploadDialog.updateProgress(a.loaded/a.total),b.uploadDialog.updateText(__("Uploading")+" "+Math.ceil(a.loaded/a.total*100)+"%"))},!1),d.open("POST",b.uploadURL),b.uploadDialog.updateText(__("Uploading&hellip;")),setTimeout(function(){d.send(c)},350)}else h(__("Error"),"<b>"+__("Extension not supported")+"</b><br /><br />"+__("Supported extensions are:")+"<br /> "+b.supportedExtensions.join(" "));else{var e=Ext.util.Format.number(b.maxSurface,"1000.000/i"),f=Math.floor(Math.sqrt(b.maxSurface));f=1e3*Math.round((f+500)/1e3);var i=Math.floor(b.maxSurface/f);h(__("Error"),"<b>"+__("Resolution too high. Please make sure the image's surface area does not exceed "+e)+" pixels. <br>For instance: "+f+" x "+i+" pixels.</b>")}};this.isImage(g)?this.validateResolution(g,i):i(!0)}},setupDnD:function(){var a={normalized:!1,preventDefault:!0,stopPropagation:!0};this.wrap.on("dragenter",function(){this.wrap.addClass("x-focus")},this,a),this.wrap.on("dragexit",function(){this.wrap.removeClass("x-focus")},this,a),this.wrap.on("dragover",function(){},this,a),this.wrap.on("drop",function(a){this.handleFileDrop(a)},this,a)},onDestroy:function(){this.uploadDialog&&this.uploadDialog.hide(),Ext.ux.form.UploadField.superclass.onDestroy.call(this)},initComponent:function(){this.on("fileselected",this.handleFileSelect,this),Ext.ux.form.UploadField.superclass.initComponent.call(this,arguments),this.on("afterrender",this.setupDnD,this)}}),Ext.reg("uploadfield",Ext.ux.form.UploadField),Ext.ns("Ext.ux"),Ext.ux.PagingSearchBar=Ext.extend(Ext.PagingToolbar,{height:27,displayInfo:!0,enableOverflow:!0,grid:null,_resizeSearchFieldWidth:function(){var a=this.getWidth();if(this.searchField){var b=this.displayInfo?460:230;this.searchField.setWidth(a-b),320>a?this.searchoptionsbtn.hide():this.searchoptionsbtn.show()}},makeQuery:function(a){var b=this.grid.store.baseParams.query,c=new Ext.util.MixedCollection;c.addAll(Garp.dataTypes);var d={};Ext.isObject(b)&&c.eachKey(function(a){a+=".id",b[a]&&(d[a]=b[a])}),this.grid.store.baseParams.query=Ext.apply(this.convertQueryString(a,this.getSelectedSearchFields()),d),this.moveFirst()},convertQueryString:function(a,b){if(""===a)return{};var c="%"+a+"%",d={};return Ext.each(b,function(a){d[a+" like"]=c}),{or:d}},getSelectedSearchFields:function(){var a=[];return this.searchOptionsMenu&&Ext.each(this.searchOptionsMenu.items.items,function(b){"menucheckitem"===b.xtype&&b.checked&&b._dataIndex&&a.push(b._dataIndex)}),a},getAllSearchFields:function(){var a=[];if(this.grid)return Ext.each(this.grid.getColumnModel().config,function(b){"relationMetadata"!==b.dataIndex&&a.push(b)}),a},searchOptionsMenu:new Ext.menu.Menu({items:{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:Ext.PagingToolbar.prototype.emptyMsg}}),buildSearchOptionsMenu:function(){var a=this.getAllSearchFields(),b=[{xtype:"menutextitem",cls:"garp-searchoptions-menu",text:__("Zoeken in:")},"-"];Ext.each(a,function(a){b.push({text:a.header,_dataIndex:a.dataIndex})}),this.searchOptionsMenu=new Ext.menu.Menu({defaults:{xtype:"menucheckitem",hideOnClick:!1,checked:!0},items:b})},initComponent:function(){this.store.on({load:{scope:this,single:!0,fn:function(){this.grid||(this.grid=this.ownerCt),this.buildSearchOptionsMenu()}}});var a=this;this.items=["->"," ",{xtype:"tbbutton",ref:"searchoptionsbtn",iconCls:"icon-searchoptions",cls:"garp-searchoptions",tooltip:__("Zoekopties"),scope:this,handler:function(a){this.searchOptionsMenu.show(a.el)}},this.searchField=new Ext.ux.form.SearchField({xtype:"twintrigger",style:"paddingLeft: 22px;",store:this.store,value:this.store.baseParams.query,listeners:{change:function(){var a=this.getValue();a.length<1?this.removeClass("has-search"):this.addClass("has-search")}},onTrigger1Click:function(){this.hasSearch&&(this.triggers[0].hide(),this.el.dom.value="",a.makeQuery(""))},onTrigger2Click:function(){var b=this.getRawValue();return b.length<1?void this.onTrigger1Click():(this.triggers[0].show(),this.hasSearch=!0,void a.makeQuery(b))},width:80})],this.on({resize:this._resizeSearchFieldWidth,afterlayout:this._resizeSearchFieldWidth},this),Ext.ux.PagingSearchBar.superclass.initComponent.call(this)},blur:function(){this.searchField.blur(),Ext.ux.PagingSearchBar.superclass.blur.call(this)},afterRender:function(){new Ext.KeyNav(this.getEl(),{esc:function(){this.blur(),this.fireEvent("defocus")},scope:this});Ext.ux.PagingSearchBar.superclass.afterRender.call(this)}}),Ext.reg("pagingsearchbar",Ext.ux.PagingSearchBar),Ext.ns("Ext.ux.form"),Ext.ux.form.SearchField=Ext.extend(Ext.form.TwinTriggerField,{initComponent:function(){Ext.ux.form.SearchField.superclass.initComponent.call(this),this.on("specialkey",function(a,b){b.getKey()==b.ENTER&&(this.onTrigger2Click(),b.stopEvent())},this)},xtype:"twintrigger",validationEvent:!1,validateOnBlur:!1,trigger1Class:"x-form-clear-trigger",trigger2Class:"x-form-search-trigger",hideTrigger1:!0,hasSearch:!1,paramName:"query",blur:function(){this.getEl().removeClass("x-form-focus"),Ext.ux.form.SearchField.superclass.blur.call(this)},onTrigger1Click:function(){if(this.hasSearch){this.el.dom.value="";var a={start:0};this.store.baseParams=this.store.baseParams||{},this.store.baseParams[this.paramName]="",this.store.reload({params:a}),this.triggers[0].hide(),this.hasSearch=!1}},onTrigger2Click:function(){var a=this.getRawValue();if(a.length<1)return void this.onTrigger1Click();var b={start:0};this.store.baseParams=this.store.baseParams||{},this.store.baseParams[this.paramName]=a,this.store.reload({params:b}),this.hasSearch=!0,this.triggers[0].show()}}),Ext.reg("twintrigger",Ext.ux.form.SearchField),Ext.ns("Ext.ux.form"),Ext.isIE?Ext.ux.form.RichTextEditor=Ext.extend(Ext.form.HtmlEditor,{enableAlignments:!1,enableBlockQuote:!0,enableColors:!1,enableEmbed:!0,enableFont:!1,enableFontSize:!1,enableFormat:!0,enableHeading:!0,enableLists:!0,enableDefinitionList:!0,enableMedia:!0,enableLinks:!0,enableUnderline:!1,enableSourceEdit:!0,defaultHeadingTag:"h2",defaultValue:"<p>&#8203;</p>",setValue:function(a){a||(a=this.defaultValue),Ext.ux.form.RichTextEditor.superclass.setValue.call(this,a)},isDirty:function(){return!this.disabled&&this.rendered&&this.isVisible()?String(this.getValue())!==String(this.originalValue):!1},getDocMarkup:function(){return'<html><head><link rel="stylesheet" href="'+BASE+"v"+ASSET_VERSION+'/css/garp/garp-richtexteditor.css" type="text/css"></head><body style="padding:0 !important;"></body></html>'},onRender:function(a,b){Ext.ux.form.RichTextEditor.superclass.onRender.call(this,a,b),this.statusbar=new Ext.Component({renderTo:this.wrap.dom,cls:"x-toolbar garp-richtexteditor-statusbar",html:__("Internet Explorer mode: Not all options are available")})},blur:function(a,b){if(this.initialized&&this.hasFocus){var c=this.getToolbar();c.items.each(function(a){a.toggle&&a.toggle(!1)}),(!b||!Ext.WindowMgr.getActive()&&this.getEl().parent(".garp-formpanel")&&!this.getEl().parent().contains(Ext.get(b).dom.id))&&(this.hasFocus=!1,this.fireEvent("blur",this),this.wrap.removeClass("x-focus"),this.cleanupHtml(),this.hideMediaToolbar(),this.updateStatusbar(""))}},initComponent:function(){this.addEvents("toolbarupdated"),Ext.ux.form.RichTextEditor.superclass.initComponent.call(this),this.on("initialize",function(){this.execCmd("styleWithCSS",!1),this.execCmd("insertBrOnReturn",!1,!1),this.execCmd("enableObjectResizing",!1),this.updateStatusbar(""),this.setupImageHandling(),this.getDoc().body.style.backgroundColor="transparent"},this),this.on("editmodechange",function(a,b){b?this.addClass("garp-richtexteditor-source-edit"):this.removeClass("garp-richtexteditor-source-edit")},this)},destroy:function(){Ext.getBody().un("click",this.blur,this)},pushValue:function(){if(this.initialized){var a=this.el.dom.value;if(!this.activated&&a.length<1&&(a=this.defaultValue),this.sourceEditMode)return;this.getEditorBody().innerHTML=a,this.fireEvent("push",this,a),Ext.EventManager.on(this.getDoc(),"keydown",function(a){return a.getKey()==a.TAB?(this.blur(a,!1),!1):void 0},this)}}}):(Ext.ux.form.RichTextEditor=Ext.extend(Ext.form.HtmlEditor,{enableAlignments:!1,enableBlockQuote:!0,enableColors:!1,enableEmbed:!0,enableFont:!1,enableFontSize:!1,enableFormat:!0,enableHeading:!0,enableLists:!0,enableDefinitionList:!0,enableMedia:!0,enableLinks:!1,enableLink:!0,enableUnderline:!1,enableSourceEdit:!0,defaultHeadingTag:"h2",maxLength:null,iframePad:5,height:500,showStatusbar:!0,showCharCount:!0,hasFocus:!1,defaultValue:"<p>&#8203;</p>",getValue:function(){var a=Ext.ux.form.RichTextEditor.superclass.getValue.call(this);return"<p>​</p>"==a?null:a},setValue:function(a){a||(a=this.defaultValue),Ext.ux.form.RichTextEditor.superclass.setValue.call(this,a)},getRange:function(){var a,b,c=this.getWin(),d=this.getDoc();return b=c.getSelection(),b.getRangeAt?b.rangeCount>0&&(a=b.getRangeAt(0)):(a=d.createRange(),a.setStart(b.anchorNode,b.anchorOffset),a.setEnd(b.focusNode,b.focusOffset),a.collapsed!==b.isCollapsed&&(a.setStart(b.focusNode,b.focusOffset),a.setEnd(b.anchorNode,b.anchorOffset))),a},getSelection:function(){var a=this.getWin(),b="undefined"!=typeof a.selection?a.selection.createRange().text:"function"==typeof a.getSelection?a.getSelection():!1;return b},findNode:function(a){a=a.toUpperCase();var b=this.getRange();if(b){var c=null;return Ext.each(["commonAncestorContainer","startContainer","endContainer"],function(d){var e=b[d];return e.tagName&&e.tagName===a?void(c=e):e.parentNode&&e.parentNode.tagName===a?void(c=e.parentNode):e.previousSibling&&e.previousSibling.tagName===a?void(c=e.previousSibling):e.children&&(Ext.each(e.children,function(b){return b.tagName&&b.tagName===a?void(c=b):void 0}),c)?c:void 0}),c}},createOrRemoveTag:function(a){var b=this.getRange(),c=this.getSelection();if(b&&c){var d,e=this.findNode(a);if(e){b.selectNode(e);var f=b.toString();d=this.getDoc().createTextNode(f),b.deleteContents(),b.insertNode(d),b.selectNodeContents(d)}else d=this.getDoc().createElement(a),d.appendChild(b.extractContents()),b.insertNode(d),b.selectNode(d);c.removeAllRanges(),c.addRange(b),this.focus.defer(20,this)}},addHeading:function(a){a||(a=this.defaultHeadingTag),a=a.toUpperCase(),this.createOrRemoveTag(a)},addBlockQuote:function(){var a=this.getSelection(),b=this.filterTagsOnly(this.walk(a.focusNode,!0)),c=!1;Ext.each(b,function(a){"BLOCKQUOTE"==a.tagName.toUpperCase()&&(c=!0)}),c?this.relayCmd("outdent"):this.relayCmd("formatblock","blockquote")},addLink:function(){var a=null,b=null,c=null,d=!1,e=this.getSelection().toString(),f=this.walk(this.getRange().endContainer,!0);Ext.each(f,function(f){return"A"==f.tagName?(a=decodeURIComponent(f.href),b=""!==f.target?!0:null,c=f.title,e||(e=f.textContent),d=f,!1):void 0});var g=new Ext.Window({title:__("Add link"),iconCls:"icon-richtext-add-link",width:445,modal:!0,height:240,border:!0,layout:"fit",defaultButton:"_url",items:[{xtype:"fieldset",bodyCssClass:"garp-dialog-fieldset",labelWidth:160,items:[{xtype:"textfield",fieldLabel:__("Url"),name:"url",id:"_url",vtype:"mailtoOrUrl",allowBlank:!1,plugins:[Garp.mailtoOrUrlPlugin],value:a||""},{xtype:"textfield",fieldLabel:__("Title"),name:"title",value:c},{xtype:"checkbox",allowBlank:!0,fieldLabel:__("Open in new window"),name:"target",checked:b!==!0?!0:!1}]}],buttonAlign:"right",buttons:[{text:__("Cancel"),handler:function(){g.close()}},{text:__("Ok"),ref:"../ok",handler:function(){var a=g.find("name","url")[0].getValue(),b=g.find("name","title")[0].getValue(),c="1"==g.find("name","target")[0].getValue();if(a)if(e||(e=a),d)d.setAttribute("href",a),c?d.setAttribute("target","_blank"):d.removeAttribute("target"),d.setAttribute("title",b);else{var f=this.getSelection(),h=this.getRange(),i=this.getDoc().createElement("a");i.setAttribute("href",a),c&&i.setAttribute("target","_blank"),i.setAttribute("title",b),i.appendChild(this.getDoc().createTextNode(e)),h.deleteContents(),h.insertNode(i),h.selectNodeContents(i),f.removeAllRanges(),f.addRange(h)}g.close()},scope:this}]});g.show(),g.items.get(0).items.get(0).clearInvalid();new Ext.KeyMap([g.find("name","url")[0].getEl(),g.find("name","title")[0].getEl()],{key:[10,13],fn:function(){g.ok.handler.call(this)},scope:this});this.tb.items.map.createlink.toggle(!1)},removeSelection:function(a){this.getWin().focus();var b=this.getSelection(),c=this.getRange();c||(c=this.getDoc().createRange()),c.selectNode(a.dom),b.removeAllRanges(),b.addRange(c),this.execCmd("delete")},showMediaToolbar:function(a){function b(a){var b=c.getStyle("float")==a?"":a;c.setStyle("float",b),this.mediaToolbar.left.toggle("left"==b),this.mediaToolbar.right.toggle("right"==b)}var c=Ext.get(a),d=Ext.get(this.iframe),e=Garp.viewport?this.ownerCt.ownerCt.el.getTop():0;this.hideMediaToolbar(),this.mediaToolbarLayer=new Ext.Layer({shadow:"frame",shadowOffset:4});var f=5;this.mediaToolbarLayer.setWidth("IFRAME"==a.nodeName||"OBJECT"==a.nodeName?100:132),this.mediaToolbarLayer.setHeight(28),this.mediaToolbarLayer.setX(Math.max(0,c.getX())+Math.max(0,d.getBox(!1,!1).x)+f),this.mediaToolbarLayer.setY(Math.max(e,Math.max(0,c.getY())+Math.max(0,d.getBox(!1,!1).y)+f)),this.mediaToolbarLayer.show();var g=[];g.push({iconCls:"icon-richtext-edit-image",tooltip:__("Edit image"),scope:this,hidden:"IFRAME"==a.nodeName||"OBJECT"==a.nodeName,handler:this.hideMediaToolbar.createSequence(this.editImage.createDelegate(this,[c]))},{iconCls:"icon-richtext-remove-image",tooltip:__("Remove image"),scope:this,handler:this.hideMediaToolbar.createSequence(this.removeSelection.createDelegate(this,[c]))},"-",{iconCls:"icon-richtext-align-left",tooltip:"Align left",pressed:"left"==c.getStyle("float"),enableToggle:!0,ref:"left",handler:b.createDelegate(this,["left"])},{iconCls:"icon-richtext-align-right",tooltip:"Align right",pressed:"right"==c.getStyle("float"),enableToggle:!0,ref:"right",handler:b.createDelegate(this,["right"])}),this.mediaToolbar=new Ext.Toolbar({renderTo:this.mediaToolbarLayer,items:[g]}),this.mediaToolbar.show()},hideMediaToolbar:function(){this.mediaToolbarLayer&&this.mediaToolbarLayer.remove(),this.mediaToolbar&&this.mediaToolbar.destroy()},setupImageHandling:function(){var a=this,b=Ext.DomQuery.select("dl.figure img, dl.figure dd",this.getDoc().body);Ext.each(b,function(a){a.draggable=!1}),this.getWin().addEventListener("mousedown",function(b){if("IMG"==b.target.nodeName){var c=b.target.parentNode.parentNode;if(Ext.get(c).hasClass("figure")){var d=a.getSelection();d.removeAllRanges();var e=document.createRange();e.selectNodeContents(c),e.setStartBefore(c),e.setEndAfter(c),d.addRange(e)}}return!0},!1),this.getWin().addEventListener("mouseover",function(b){if(b&&b.target){var c=b.target;return"figure"==c.className||"IFRAME"==c.nodeName||"OBJECT"==c.nodeName?a.getSelection().focusNode!==a.getDoc().getElementsByTagName("body")[0]&&a.showMediaToolbar(c):c.parentNode&&c.parentNode.parentNode&&"figure"==c.parentNode.parentNode.className?a.getSelection().focusNode!==a.getDoc().getElementsByTagName("body")[0]&&a.showMediaToolbar(c.parentNode.parentNode):a.hideMediaToolbar(),!0}},!1)},putImage:function(a){{var b=new Ext.XTemplate(['<tpl if="caption">','<tpl if="align">','<dl class="figure" style="float: {align};">',"</tpl>",'<tpl if="!align">','<dl class="figure" style="float: none;">',"</tpl>","<dt>",'<img src="{path}" draggable="false"> ',"</dt>",'<dd draggable="false">{caption}</dd>',"</dl>","</tpl>",'<tpl if="!caption">','<tpl if="align">','<img class="figure" src="{path}" style="float: {align};">',"</tpl>",'<tpl if="!align">','<img class="figure" src="{path}" style="float: none;">',"</tpl>","</tpl>"]),c=this.getSelection();c.anchorNode,c.anchorOffset,c.focusNode,c.focusOffset}this.insertAtCursor(b.apply({path:a.src,width:a.template.get("w"),height:a.template.get("h"),align:a.align,caption:a.caption||!1}));var d=this;setTimeout(function(){var a=Ext.select(".figure",null,d.getDoc()).last().dom,b=d.getDoc().getElementsByTagName("body")[0].children;if(b[b.length-1].isSameNode(a)){var c=document.createElement("p"),e=document.createTextNode(" ​ ");c.appendChild(e),d.getDoc().getElementsByTagName("body")[0].appendChild(c)}setTimeout(function(){var a=d.getSelection(),b=d.getDoc().body.children;b=b[b.length-1],a.removeAllRanges();var c=d.getDoc().createRange();c.setStart(b,0),c.setStartBefore(b),c.setEnd(b,0),c.setEndAfter(b),c.collapse(!1),a.addRange(c),a.selectAllChildren(b),a.collapse(b,1)},100)},100)},addImage:function(){var a=new Garp.ImagePickerWindow({});a.on("select",this.putImage,this),a.show()},editImage:function(a){var b=a.child("img")?a.child("img").getAttribute("src"):a.getAttribute("src");b=b.split("/"),""===b[b.length-1]&&b.splice(b.length-1,1);var c=b[b.length-1],d=b[b.length-2],e=a.getStyle("float"),f=a.child("dd")?a.child("dd").dom.innerHTML:null,g=new Garp.ImagePickerWindow({imgGridQuery:{id:c},cropTemplateName:d,captionValue:f,alignValue:"none"==e?"":e});g.on("select",function(b){g.close(),this.removeSelection(a),this.putImage(b)},this),g.show()},addVideo:function(){var a=new Garp.ModelPickerWindow({model:"Video",listeners:{select:function(a){var b=a.selected;this.insertAtCursor("<p></p>"+Garp.videoTpl.apply({player:b.get("player"),width:VIDEO_WIDTH,height:VIDEO_HEIGHT})+"<p></p>")},scope:this}});a.show()},pastePlainText:function(){var a=new Ext.form.TextArea,b=new Ext.Window({width:480,height:320,modal:!0,layout:"fit",title:__("Paste as plain text"),iconCls:"icon-richtext-paste-plain-text",defaultButton:a,items:[a],buttons:[{text:__("Cancel"),ref:"../cancel",scope:this,handler:function(){b.close()}},{text:__("Ok"),ref:"../ok",scope:this,handler:function(){var c=a.getValue();this.insertAtCursor(c),b.close()}}]});b.show(),b.keymap=new Ext.KeyMap(b.getEl(),[{key:Ext.EventObject.ENTER,ctrl:!0,scope:this,fn:function(){b.ok.handler.call(this)}},{key:Ext.EventObject.ESC,scope:this,fn:function(a){b.cancel.handler.call(this),a.stopEvent()}}]),b.keymap.stopEvent=!0},addEmbed:function(){var a=new Ext.form.TextArea,b=new Ext.Window({width:480,height:320,modal:!0,layout:"fit",title:__("Embed HTML"),iconCls:"icon-richtext-add-embed",defaultButton:a,items:[a],buttons:[{text:__("Ok"),ref:"../ok",scope:this,handler:function(){var c=a.getValue();this.insertAtCursor("<p></p>"),this.execCmd("InsertHTML",c),this.insertAtCursor("<p></p>"),b.close()}},{text:__("Cancel"),ref:"../cancel",scope:this,handler:function(){b.close()}}]});b.show(),b.keymap=new Ext.KeyMap(b.getEl(),[{key:Ext.EventObject.ENTER,ctrl:!0,scope:this,fn:function(){b.ok.handler.call(this)}},{key:Ext.EventObject.ESC,scope:this,fn:function(a){b.cancel.handler.call(this),a.stopEvent()}}]),b.keymap.stopEvent=!0},walk:function(a,b,c){return c||(c=[]),!b==!1&&(b=!0),b?(c.push(a),a&&a.parentNode&&"HTML"!==a.nodeName&&(a=a.parentNode,this.walk(a,b,c))):(c.push(a),a&&a.childNodes&&a.childNodes[0]&&(a=a.childNodes[0],this.walk(a,b,c))),c},filterTagsOnly:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d.tagName&&b.push(d)}return b},getCurrentTagName:function(){var a=this.getSelection().focusNode;if(a)return a=a.tagName?a.tagName:a.parentNode.tagName?a.parentNode.tagName:"",a.toLowerCase()},getCurrentClassList:function(){var a=this.getSelection().focusNode;if(a){var b=a.className?a.className:a.parentNode.className?a.parentNode.className:"";return b.toLowerCase()}},buildStatusbar:function(){this.statusbar=new Ext.Component({renderTo:this.wrap.dom,cls:"x-toolbar garp-richtexteditor-statusbar",html:"&nbsp;"});var a=null;this.statusbar.el.on("mouseover",function(b,c){var d=Number(c.className.substr(1,c.className.length));if(!isNaN(d)){var e=this.getSelection(),f=this.filterTagsOnly(this.walk(e.focusNode,!0).reverse());a=f[d],a&&Ext.get(a).addClass("garp-richtexteditor-highlight")}},this),this.statusbar.el.on("mouseout",function(){a&&Ext.get(a).removeClass("garp-richtexteditor-highlight")},this)},updateStatusbar:function(a){if(this.statusbar){if(""!==a){var b=this.getSelection();if(!b)return;var c=this.walk(b.focusNode,!0).reverse();a="";for(var d=1,e=c.length;e>d;d++){var f=c[d];a+=f.tagName?'<span class="_'+d+'">'+f.tagName+"</span> &gt; ":'<span class="_'+d+'">"'+Ext.util.Format.ellipsis(f.nodeValue,20,!0)+'"</span>'}}else a="&nbsp;";this.maxLength?a+='<span class="count">'+(this.maxLength-this.getCharCount()||"")+"</span>":this.showCharCount&&(a+='<span class="count">'+(this.getCharCount()||"")+"</span>"),this.statusbar.update(a)}},getCharCount:function(){if(this.initialized&&this.getDoc()&&this.getDoc().body){var a=this.getDoc().body.textContent;return 8203==a.charCodeAt(0)?a.length-1:a.length}return 0},isValid:function(){return this.maxLength&&this.getCharCount()>=this.maxLength?(this.wrap.addClass(this.invalidClass),!1):(this.wrap&&this.wrap.removeClass(this.invalidClass),!0)},isDirty:function(){return!this.disabled&&this.rendered&&this.isVisible()?"<p>&#8203;</p>"===String(this.originalValue)&&null===this.getValue()?!1:String(this.getValue())!==String(this.originalValue):!1},getDocMarkup:function(){return'<html><head><link rel="stylesheet" href="'+BASE+"v"+ASSET_VERSION+'/css/garp/garp-richtexteditor.css" type="text/css"></head><body></body></html>'},onEditorEvent:function(){this.execCmd("styleWithCSS",!1),this.hasFocus=!0,this.wrap.addClass("x-focus");var a=this.getSelection();a&&this.updateToolbar()},_insertTag:function(a){var b=this.getRange(),c=document.createElement(a?a.toUpperCase():"DIV");return b.insertNode(c)},addDefinitionList:function(){var a=this.getCurrentTagName().toLowerCase();switch(a){case"dl":this.insertAtCursor("</dl><p>");break;case"dt":this.insertAtCursor("</dt></dl><p>");break;case"dd":this.insertAtCursor(Ext.isChrome||Ext.isWebkit?"</dd><dt>&hellip;</dt><dd>&hellip;</dd>":"</dd><dt>");break;default:var b=this.getSelection(),c=Ext.id(),d=b.toString()||"&hellip;",e=this.getRange();e.deleteContents(),this.insertAtCursor(Ext.isChrome||Ext.isWebkit?'<dl><dt id="'+c+'">'+d+"</dt><dd>"+d+"</dd></dl><p>&nbsp;</p>":'<dl><dt id="'+c+'">'+d+"</dt>");var f=this.getDoc().getElementById(c);e.selectNodeContents(f),b.removeAllRanges(),b.addRange(e)}this.deferFocus(),this.updateToolbar.defer(100,this)},updateToolbar:function(){if(!this.readOnly&&this.hasFocus){if(!this.activated&&this.onFirstFocus)return void this.onFirstFocus();var a=this.tb.items.map,b=this.getDoc();if(this.enableFont&&!Ext.isSafari2){var c=(b.queryCommandValue("FontName")||this.defaultFont).toLowerCase();c!=this.fontSelect.dom.value&&(this.fontSelect.dom.value=c)}this.enableFormat&&(a.bold.toggle(b.queryCommandState("bold")),a.italic.toggle(b.queryCommandState("italic")),this.enableUnderline&&a.underline.toggle(b.queryCommandState("underline"))),this.enableAlignments&&(a.justifyleft.toggle(b.queryCommandState("justifyleft")),a.justifycenter.toggle(b.queryCommandState("justifycenter")),a.justifyright.toggle(b.queryCommandState("justifyright"))),!Ext.isSafari2&&this.enableLists&&(a.insertorderedlist.toggle(b.queryCommandState("insertorderedlist")),a.insertunorderedlist.toggle(b.queryCommandState("insertunorderedlist")));var d=b.queryCommandValue("formatblock"),e=["h1","h2","h3","h4","h5","h6"];a.addheading.toggle(d&&e.indexOf(d.toLowerCase())>-1?!0:!1);var f=this.getCurrentTagName(),g=this.getCurrentClassList();a.createlink.toggle("a"==f),g&&g.indexOf&&-1==g.indexOf("figure")&&a.definitionlist.toggle("dl"==f||"dt"==f||"dd"==f),Ext.menu.MenuMgr.hideAll(),this.statusbar&&this.updateStatusbar(),this.syncValue(),this.fireEvent("toolbarupdated",this)}},onRender:function(a,b){Ext.ux.form.RichTextEditor.superclass.onRender.call(this,a,b),this.showStatusbar&&this.buildStatusbar(),Ext.each(["bold","italic","underline","insertorderedlist","insertunorderedlist","addheading","justifyleft","justifycenter","justifyright"],function(a){this.tb.items.map[a]&&this.tb.items.map[a].on("click",function(){this.pressed&&this.toggle.defer(100,this,[!0])})},this)},afterRender:function(){Ext.ux.form.RichTextEditor.superclass.afterRender.call(this);var a=this.getToolbar();if(!this.enableUnderline){var b=a.find("itemId","underline")[0];a.remove(b)}this.enableLists&&this.enableUnderline&&a.insert(3,"-"),a.insert(3,{tooltip:__("<b>Add Blockquote</b><br>Convert selected text into a blockquote."),iconCls:"icon-richtext-add-blockquote",hidden:!this.enableBlockQuote,itemId:"addblockquote",handler:this.addBlockQuote.createDelegate(this),tabIndex:-1,scope:this}),a.insert(4,{tooltip:__("<b>Add Heading</b><br>Convert selected text into a heading."),iconCls:"icon-richtext-add-heading",enableToggle:!0,hidden:!this.enableHeading,itemId:"addheading",handler:this.addHeading.createDelegate(this,[this.defaultHeadingTag]),tabIndex:-1,scope:this}),a.insert(8,{tooltip:__("<b>Add Glossary</b><br>Creates a list of terms."),iconCls:"icon-richtext-add-dl",enableToggle:!0,itemId:"definitionlist",hidden:!this.enableDefinitionList,handler:this.addDefinitionList,tabIndex:-1,scope:this}),a.insert(9,{tooltip:__("<b>Add Link</b><br>Convert selected text into a hyperlink."),iconCls:"icon-richtext-add-link",enableToggle:!0,itemId:"createlink",hidden:!this.enableLink,handler:this.addLink,tabIndex:-1,scope:this}),a.insert(10,{tooltip:__("<b>Image</b><br>Insert image."),iconCls:"icon-richtext-add-image",itemId:"addImage",hidden:!this.enableMedia,handler:this.addImage,tabIndex:-1,scope:this}),a.insert(11,{tooltip:__("<b>Video</b><br>Insert a video."),iconCls:"icon-richtext-add-video",itemId:"addVideo",hidden:!this.enableMedia,handler:this.addVideo,tabIndex:-1,scope:this}),a.insert(12,"-"),a.insert(13,{tooltip:__("<b>Paste as plain text</b><br>Removes styling."),iconCls:"icon-richtext-paste-plain-text",enableToggle:!1,itemId:"pastePlainText",handler:this.pastePlainText,tabIndex:-1,scope:this}),a.insert(14,{tooltip:__("<b>Add Embed</b>"),iconCls:"icon-richtext-add-embed",enableToggle:!1,itemId:"addEmbed",hidden:!this.enableEmbed,handler:this.addEmbed,tabIndex:-1,scope:this})},onResize:function(a,b){if(Ext.form.HtmlEditor.superclass.onResize.apply(this,arguments),this.el&&this.iframe){if(Ext.isNumber(a)){var c=a-this.wrap.getFrameWidth("lr");this.el.setWidth(c),this.tb.setWidth(c),this.iframe.style.width=Math.max(c,0)+"px"}if(Ext.isNumber(b)){var d=b-this.wrap.getFrameWidth("tb")-this.tb.el.getHeight()-(this.statusbar?this.statusbar.el.getHeight():0);this.el.setHeight(d),this.iframe.style.height=Math.max(d,0)+"px";var e=this.getEditorBody();e&&(e.style.height=Math.max(d-2*this.iframePad,0)+"px")}}},unwrap:function(a,b){for(;Ext.DomQuery.select(a,b).length>0;){var c=Ext.DomQuery.selectNode(a,b);for(c.normalize();c.childNodes.length>0;){var d=c.childNodes[c.childNodes.length-1],e=d.cloneNode(!0);c.parentNode.insertBefore(e,c),c.removeChild(d)}c.parentNode.removeChild(c)}},replaceTag:function(a,b,c){var d=Ext.DomQuery.select(a,c);Ext.DomHelper.useDom=!1,Ext.each(d,function(a){var c=Ext.get(a);if(b){var d=c.dom.innerHTML;Ext.DomHelper.insertBefore(a,{tag:b,html:d})}c.remove()})},wrapFragment:function(a,b){var c=b.ownerDocument.createElement(a),d=b.cloneNode(!0);c.appendChild(d),b.parentNode.insertBefore(c,b),b.parentNode.removeChild(b)},fixInlineElements:function(a){var b=["#text","B","BIG","I","SMALL","TT","ABBR","ACRONYM","CITE","CODE","DFN","KBD","STRONG","SAMP","VAR","A","BDO","IMG","MAP","OBJECT","Q","SCRIPT","SPAN","SUB","SUP","BUTTON","INPUT","LABEL","SELECT","TEXTAREA"],c=!1;if(Ext.each(a.childNodes,function(a){b.indexOf(a.nodeName)>-1&&(c||(c=a),lastChild=a)},this),c){var d=a.ownerDocument.createElement("p");
if(c!=lastChild){var e=a.ownerDocument.createRange();e.setStart(c,0),e.setEnd(lastChild,lastChild.length),d.appendChild(e.extractContents())}else d.appendChild(c.cloneNode(!0));c.parentNode.replaceChild(d,c)}a.normalize()},fixBrs:function(a){Ext.each(Ext.DomQuery.select("br",a),function(a){var b=Ext.get(a);return b.parent("p")&&b.parent("p").dom.childNodes[0]==a?void b.remove():b.dom.nextSibling&&"BR"==b.dom.nextSibling.nodeName?void b.remove():void 0})},cleanupHtml:function(){this.suspendEvents();var a=this.getDoc(),b=a.body,c=["&nbsp;","&#8203;"],d=this.getValue();if(!d)return!0;Ext.each(c,function(a){d=d.replace(a," ")}),this.setValue(d),this.unwrap("span",b),this.unwrap("div",b),this.replaceTag("strong","b",b),this.replaceTag("em","i",b),b.normalize();var e=Ext.DomQuery.jsSelect("[id]",b);return Ext.each(e,function(a){a.removeAttribute("id")},this),this.resumeEvents(),!0},cleanupHtmlOld:function(){this.suspendEvents();for(var a=this.getDoc(),b=a.body;Ext.DomQuery.select("span",b).length>0;){var c=Ext.DomQuery.selectNode("span",b);for(c.normalize();c.childNodes.length>0;){var d=c.childNodes[0],e=d.cloneNode(!0);c.parentNode.insertBefore(e,c),c.removeChild(d)}c.parentNode.removeChild(c)}b.normalize(),1==b.children.length&&"BR"==b.children[0].tagName&&b.removeChild(b.children[0]);var f=["&nbsp;","&#8203;"],g=this.getValue();if(!g)return!0;Ext.each(f,function(a){g=g.replace(a," ")}),this.setValue(g),Ext.each(b.childNodes,function(c){if("#text"==c.nodeName&&c.nodeValue){var d=a.createElement("p"),e=a.createTextNode(c.nodeValue);d.appendChild(e),b.insertBefore(d,c),b.removeChild(c)}});Ext.each(Ext.DomQuery.select("br",b),function(a){var b=Ext.get(a);if(b.parent("p"))return 1==b.parent("p").dom.childNodes.length?void b.remove():b.parent("p").dom.childNodes[0]==a?void b.remove():b.dom.nextSibling&&"BR"==b.dom.nextSibling.nodeName?void b.remove():void 0});Ext.get(Ext.DomQuery.select("p:empty",b)).remove(),Ext.each(Ext.DomQuery.select("p",b),function(a){f.indexOf(a.innerHTML)>-1&&Ext.get(a).remove()});var h=Ext.DomQuery.select("strong",b);return Ext.DomHelper.useDom=!1,Ext.each(h,function(a){var b=Ext.get(a),c=b.dom.innerHTML;Ext.DomHelper.insertBefore(a,{tag:"b",html:c}),b.remove()}),h=Ext.DomQuery.select("em",b),Ext.DomHelper.useDom=!1,Ext.each(h,function(a){var b=Ext.get(a),c=b.dom.innerHTML;Ext.DomHelper.insertBefore(a,{tag:"i",html:c}),b.remove()}),this.resumeEvents(),!0},blur:function(a,b){if(this.initialized&&(this.hideMediaToolbar(),this.hasFocus)){var c=this.getToolbar();c.items.each(function(a){a.toggle&&a.toggle(!1)}),(!b||!Ext.WindowMgr.getActive()&&this.getEl().parent(".garp-formpanel")&&!this.getEl().parent().contains(Ext.get(b).dom.id))&&(this.updateStatusbar(""),this.hasFocus=!1,this.fireEvent("blur",this),this.wrap.removeClass("x-focus"),this.cleanupHtml(),a&&a.stopEvent&&a.stopEvent())}},initComponent:function(){this.addEvents("toolbarupdated"),Ext.ux.form.RichTextEditor.superclass.initComponent.call(this),this.on("initialize",function(){this.execCmd("styleWithCSS",!1),this.execCmd("insertBrOnReturn",!1,!1),this.execCmd("enableObjectResizing",!1),this.updateStatusbar(""),this.setupImageHandling(),this.getDoc().body.style.backgroundColor="transparent"},this),this.on("editmodechange",function(a,b){b?this.addClass("garp-richtexteditor-source-edit"):this.removeClass("garp-richtexteditor-source-edit")},this),Ext.getBody().on("click",this.blur,this),this.on("push",function(){this.updateStatusbar("")},this)},destroy:function(){Ext.getBody().un("click",this.blur,this)},pushValue:function(){if(this.initialized){var a=this.el.dom.value;if(!this.activated&&a.length<1&&(a=this.defaultValue),this.sourceEditMode)return;this.getEditorBody().innerHTML=a,this.fireEvent("push",this,a),Ext.EventManager.on(this.getDoc(),"keydown",function(a){return a.getKey()==a.TAB?(this.blur(a,!1),!1):void 0},this);var b=new Ext.KeyMap(this.getDoc().body,{ctrl:!0,key:Ext.EventObject.ENTER,fn:function(a){var b=this.findParentByType("garpformpanel");b||(b=this.findParentByType("formpanel")),b&&(this.blur(a,!1),this.syncValue(),this.cleanupHtml(),b.fireEvent("save-all"))},scope:this});b.enable()}},fixKeys:function(){return function(a){if(a.ctrlKey){var b,c=a.getCharCode();if(c>0){switch(c=String.fromCharCode(c),c.toLowerCase()){case"b":b="bold";break;case"i":b="italic";break;case"u":b="underline"}b&&(this.win.focus(),this.execCmd(b),this.deferFocus(),a.preventDefault())}}}}()}),Garp.CodeEditor=function(){this.updateBtns=function(){var a=this.getToolbar().items.map;a.pre.toggle("pre"==this.getDoc().queryCommandValue("formatblock"));var b=this.getCurrentTagName();a.code.toggle("code"===b),a["var"].toggle("var"===b)},this.afterrender=function(){this.addVar=function(){if("var"==this.getCurrentTagName())this.relayCmd("removeformat");else{var a=this.getSelection().toString();a||(a="{var}"),this.insertAtCursor("<var>"+a+"</var>")}},this.addCode=function(){if("code"==this.getCurrentTagName())this.relayCmd("removeformat");else{var a=this.getSelection().toString();a||(a="{code}"),this.insertAtCursor("<code>"+a+"</code>")}},this.addPre=function(){"pre"==this.getDoc().queryCommandValue("formatblock")?this.relayCmd("formatblock","p"):this.relayCmd("formatblock","pre")};var a=this.getToolbar();a.add("-"),a.insert(5,{iconCls:"icon-richtext-add-heading-menu",tabIndex:-1,menu:new Ext.menu.Menu({defaults:{handler:function(a){this.addHeading(a.text)},scope:this},items:[{text:"H1"},{text:"H2"},{text:"H3"},{text:"H4"},{text:"H5"},{text:"H6"}]})}),a.add({tooltip:__("Add &lt;var&gt;"),tabIndex:-1,handler:this.addVar,scope:this,itemId:"var",enableToggle:!0,iconCls:"icon-richtext-add-var"}),a.add({tooltip:__("Add &lt;code&gt;"),tabIndex:-1,handler:this.addCode,scope:this,itemId:"code",enableToggle:!0,iconCls:"icon-richtext-add-code"}),a.add({tooltip:__("Add &lt;pre&gt;"),tabIndex:-1,handler:this.addPre,scope:this,itemId:"pre",iconCls:"icon-richtext-add-pre",enableToggle:!0});var b=a.get("addheading");b.hide()},this.init=function(a){a.on("afterrender",this.afterrender),a.on("toolbarupdated",this.updateBtns)}}),Ext.reg("richtexteditor",Ext.ux.form.RichTextEditor),Garp.i18nSource=Ext.extend(Ext.form.Field,{ref:"../",style:"display:none; height: 0; margin: 0; padding: 0;",hideLabel:!0,originalValue:null,initComponent:function(a){Garp.i18nSource.superclass.initComponent.call(this,a),Garp.i18nSource.superclass.hide.call(this)},getRefField:function(a){return this.refOwner.find("name","_"+this.name+"_"+a)[0]},setValue:function(a){Ext.each(LANGUAGES,function(b){this.getRefField(b)&&null!==a&&this.getRefField(b).setValue(a[b])},this),Garp.i18nSource.superclass.setValue.call(this,a)},setRawValue:function(a){return this.setValue(a)},getValue:function(){var a={};return Ext.each(LANGUAGES,function(b){field=this.getRefField(b),field&&field.isDirty()&&(a[b]=""===field.getValue()?null:field.getValue())},this),a},getRawValue:function(a){return this.getValue(a)},isDirty:function(){var a=!1;return Ext.each(LANGUAGES,function(b){return this.getRefField(b)&&this.getRefField(b).isDirty()?(a=!0,!1):void 0},this),a},_setAll:function(a,b,c){return Ext.each(LANGUAGES,function(c){var d=this.getRefField(c);d&&d[a]&&d[a](b)},this),!c==!0?Garp.i18nSource.superclass[a].call(this,b):void 0},setVisible:function(a){return this._setAll("setVisible",a,!0)},setDisabled:function(a){return this._setAll("setDisabled",a)},show:function(a){return this._setAll("show",a,!0)},hide:function(a){return this._setAll("hide",a,!0)},enable:function(a){return this._setAll("enable",a)},disable:function(a){return this._setAll("disable",a)}}),Ext.reg("i18nsource",Garp.i18nSource),Garp.i18nFieldSet=Ext.extend(Ext.form.FieldSet,{cls:"i18n-fieldset",collapsed:!0,initComponent:function(a){Garp.i18nFieldSet.superclass.initComponent.call(this,a)}}),Ext.reg("i18nfieldset",Garp.i18nFieldSet),Garp.WysiwygField=Ext.extend(Ext.form.TextField,{region:"center",hideLabel:!0,bodyStyle:"overflow-y: auto",reset:function(){this.chapterct.removeAll(!0),delete this.originalValue,this.chapterct.items.length||this.chapterct.addWysiwygCt()},hideMode:"display",extraTypes:[],setValue:function(a){this.reset();var b=this.maxCols;a&&a.length&&(this.chapterct.removeAll(!0),Ext.each(a,function(a){a||(a={type:"",classes:[]});var c=this.chapterct.addWysiwygCt({type:a.type,_classes:a.classes},this.chapterct.items?this.chapterct.items.last():null);a.content&&Ext.each(a.content,function(a){if(!a.model)return console&&console.dir,void(a.remove&&a.remove());var d=new Garp.dataTypes[a.model].Wysiwyg({ct:c,_data:a.data,_classes:a.classes,model:a.model,type:a.type,col:"grid-"+a.columns+"-"+b,maxCols:b});c.add(d),c.afterAdd()})},this))},getValue:function(){var a=[];return this.chapterct.items.each(function(b){var c=[];b.body.dom&&(Ext.each(b.body.dom.childNodes,function(a){var b=Ext.getCmp(a.getAttribute("id"));if(b.getValue()){var d=b.getValue();b.type&&(d.type=b.getType()),b.getClasses&&b.getClasses()&&(d.classes=b.getClasses()),c.push(d)}}),c.length&&a.push({content:c,type:b.getExtraType()}))},this),a},isValid:function(){return!0},isDirty:function(){if(this.getValue()&&this.originalValue){var a=Ext.util.JSON.encode;return a(this.getValue())!=a(this.originalValue)}},afterRender:function(){this.wrap=this.el.wrap(),this.extraTypes=Garp.dataTypes.Chapter.getField("type").store,this.chapterct=new Garp.Chapterct({renderTo:this.wrap,ownerField:this,maxCols:this.maxCols,extraTypes:this.extraTypes}),this.on("resize",function(){this.chapterct.setWidth(this.getWidth())},this),this.el.hide(),Garp.WysiwygField.superclass.afterRender.call(this)},initComponent:function(){Garp.WysiwygField.superclass.initComponent.call(this,arguments)}}),Ext.reg("wysiwygfield",Garp.WysiwygField),Garp.Wysiwygct=Ext.extend(Ext.Panel,{cls:"wysiwyg-ct",bodyCssClass:"wysiwyg-body",bodyBorder:!1,autoScroll:!0,autoHeight:!0,padding:"30",maxCols:null,extraTypes:null,moveChapter:function(a){var b=this.ct.getWysiwygIdx(this);if(!(1===a&&b===this.ct.items.length-1||-1===a&&0===b)){var c=this.ct.ownerField.getValue(),d=c.slice(0),e=c[b],f=c[b+a];c[b+a]=e,c[b]=f;var g=Garp.formPanel.formcontent.get(0).body,h=g.getScroll().top;this.ct.ownerField.setValue(c),g&&h&&g.scrollTo("top",h,!1),this.ct.ownerField.originalValue=d}},getWysiwygDataTypes:function(){var a=[];for(var b in Garp.dataTypes)Garp.dataTypes[b].Wysiwyg&&a.push(Garp.dataTypes[b]);return a},setExtraType:function(){if(this.el){var a=this.getTopToolbar().extraTypesMenu.getValue(),b=this.el.select(".wysiwyg-body");Ext.each(this.extraTypes,function(a){b.removeClass(a[0])},this),b.addClass(a),this.ownerCt.extraType=a}},getExtraType:function(){return this.getTopToolbar().extraTypesMenu.getValue()},getRange:function(){var a,b;return b=window.getSelection(),b.getRangeAt?b.rangeCount>0&&(a=b.getRangeAt(0)):(a=document.createRange(),a.setStart(b.anchorNode,b.anchorOffset),a.setEnd(b.focusNode,b.focusOffset),a.collapsed!==b.isCollapsed&&(a.setStart(b.focusNode,b.focusOffset),a.setEnd(b.anchorNode,b.anchorOffset))),a},setupTbar:function(){function a(){var a=[{text:__("Add chapter"),iconCls:"icon-wysiwyg-add-chapter",handler:function(){this.ownerCt.addWysiwygCt({type:""},this)},scope:this},"-"];return Ext.each(this.getWysiwygDataTypes(),function(b){a.push({text:__(b.text),iconCls:b.iconCls,handler:function(){new b.Wysiwyg({ct:this,maxCols:this.maxCols,_data:{}})},scope:this})},this),a}this.tbar=new Ext.Toolbar({cls:"garp-formpanel-toolbar",padding:"0 10 0 10",width:"100%",defaults:{xtype:"button",scope:this},items:[{iconCls:"icon-new",text:__("Add"),ref:"addBtn",menu:a.call(this)}," ",{xtype:"combo",editable:!1,forceSelection:!0,triggerAction:"all",ref:"extraTypesMenu",store:this.extraTypes,value:"",listeners:{select:function(){return this.ownerCt.ownerCt.setExtraType(),this.blur(),!0}}}," "," ",{iconCls:"icon-wysiwyg-bold",ref:"boldBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(a,b){b.preventDefault(),document.execCommand("Bold",!1,null)}},{iconCls:"icon-wysiwyg-italic",ref:"italicBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(a,b){b.preventDefault(),document.execCommand("Italic",!1,null)}},{iconCls:"icon-wysiwyg-orderedlist",ref:"insertorderedlistBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(a,b){b.preventDefault(),document.execCommand("Insertorderedlist",!1,null)}},{iconCls:"icon-wysiwyg-unorderedlist",ref:"insertunorderedlistBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(a,b){b.preventDefault(),document.execCommand("Insertunorderedlist",!1,null)}},{iconCls:"icon-wysiwyg-createlink",ref:"createlinkBtn",clickEvent:"mousedown",enableToggle:!0,handler:function(a,b){function c(){var a=!1;return"A"==d.getCurrentTagName()?(d.getRange().selectNodeContents(d.getRange().endContainer),!0):(Ext.each(d.getRange().endContainer.childNodes,function(b){return b.nodeName&&"A"==b.nodeName?(a=!0,!1):void 0}),a)}b.preventDefault();var d=this;if(c())document.execCommand("Unlink",!1,null);else{var e=this.getSelection(),f=e.toString();if(f){var g=d.getRange(),h=new Ext.Window({title:__("Add link"),iconCls:"icon-richtext-add-link",width:445,modal:!0,height:240,border:!0,layout:"fit",defaultButton:"_url",items:[{xtype:"fieldset",bodyCssClass:"garp-dialog-fieldset",labelWidth:160,items:[{xtype:"textfield",fieldLabel:__("Url"),name:"url",id:"_url",vtype:"mailtoOrUrl",allowBlank:!1,plugins:[Garp.mailtoOrUrlPlugin],value:""},{xtype:"textfield",fieldLabel:__("Title"),name:"title",value:""},{xtype:"checkbox",allowBlank:!0,fieldLabel:__("Open in new window"),name:"target",checked:""}]}],buttonAlign:"right",buttons:[{text:__("Cancel"),handler:function(){h.close()}},{text:__("Ok"),ref:"../ok",handler:function(){var a=h.find("name","url")[0].getValue(),b=h.find("name","title")[0].getValue(),c="1"==h.find("name","target")[0].getValue(),d=document.createElement("a");d.setAttribute("href",a),c&&d.setAttribute("target","_blank"),d.setAttribute("title",b),d.appendChild(document.createTextNode(f)),g.deleteContents(),g.insertNode(d),g.selectNodeContents(d),e.removeAllRanges(),e.addRange(g),h.close()},scope:this}]});h.show(),h.items.get(0).items.get(0).clearInvalid();{new Ext.KeyMap([h.find("name","url")[0].getEl(),h.find("name","title")[0].getEl()],{key:[10,13],fn:function(){h.ok.handler.call(this)},scope:this})}}}}},"->",{iconCls:"icon-wysiwyg-move-up",tooltip:__("Move chapter up"),handler:this.moveChapter.createDelegate(this,[-1])},{iconCls:"icon-wysiwyg-move-down",tooltip:__("Move chapter down"),handler:this.moveChapter.createDelegate(this,[1])},{text:__("Delete"),iconCls:"icon-wysiwyg-remove-chapter",handler:function(){this.ownerCt.items.length>1?this.ownerCt.remove(this):(this.ownerCt.addWysiwygCt(),this.ownerCt.remove(this))}}]})},getSelection:function(){var a="undefined"!=typeof document.selection?document.selection.createRange().text:"function"==typeof document.getSelection?document.getSelection():!1;return a},getCurrentTagName:function(){var a=this.getSelection().focusNode;if(a)return a.tagName?a.tagName:a.parentNode.tagName?a.parentNode.tagName:""},setupTbarWatcher:function(){var a=["bold","italic","insertorderedlist","insertunorderedlist"],b=this;this.tbWatcherInterval=setInterval(function(){var c=b.getTopToolbar();if(c&&0!==Ext.select(".wysiwyg-box").elements.length){c.createlinkBtn.toggle("A"==b.getCurrentTagName(),!1);for(var d=0,e=a.length;e>d;d++){var f=a[d];try{c[f+"Btn"].toggle(document.queryCommandState(f),!1)}catch(g){}}}},100)},setupKeyboardHandling:function(){Ext.EventManager.on(document,"keypress",function(a){if(a.ctrlKey){var b,c=a.getCharCode();if(c>0){switch(c=String.fromCharCode(c)){case"b":b="Bold";break;case"i":b="Italic"}b&&this.body.dom&&this.body.dom.execCommand&&(this.body.dom.execCommand(b,!1,null),a.preventDefault())}}},this)},afterAdd:function(){this.doLayout(),this.setupDD()},removeWysiwygBox:function(a){this.remove(a.id),this.doLayout()},removeColClasses:function(a){if(a)for(var b=1;b<=this.maxCols;b++)Ext.get(a).removeClass("grid-"+b+"-"+this.maxCols)},getCurrentColCount:function(a){for(var b=this.maxCols;b>0;b--)if(a.hasClass("grid-"+b+"-"+this.maxCols))return b;return this.maxCols},setupDD:function(){var a=this,b=Ext.query(".wysiwyg-box");this.getEl().addClass("disabled-targets"),Ext.dd.ScrollManager.register(this.body),Ext.apply(Ext.dd.ScrollManager,{vthresh:50,hthresh:-1,animate:!1,increment:200}),Ext.each(b,function(b){b.resizer&&b.resizer.destroy();var c=null;b.resizer=new Ext.Resizable(b.id,{handles:"e",dynamic:!0,transparent:!0,listeners:{beforeresize:function(){c=this.getEl().getWidth()},resize:function(){var b=this.getEl(),d=b.getWidth(),e=a.getCurrentColCount(b),f=Math.ceil(a.maxCols/(a.getWidth()/d));1>f&&(f=1),d>c?(e>=a.maxCols&&(f=a.maxCols),a.removeColClasses(b),b.addClass("grid-"+f+"-"+a.maxCols)):(1>=e&&(f=1),a.removeColClasses(b),b.addClass("grid-"+f+"-"+a.maxCols)),b.setWidth(""),b.setHeight(""),Ext.getCmp(b.id).fireEvent("user-resize",c,d,"grid-"+f+"-"+a.maxCols)}}});var d=new Ext.dd.DD(b,"wysiwyg-dragables-group",{isTarget:!1,ignoreSelf:!0,scroll:!0});Ext.apply(d,{wysiwygct:a,possibleSuspect:null,b4Drag:function(){!this.el},b4StartDrag:function(){this.el||(this.el=Ext.get(this.getEl())),this.el.addClass("in-drag"),this.originalXY=this.el.getXY()},startDrag:function(){this.wysiwygct.getEl().removeClass("disabled-targets")},onInvalidDrop:function(){this.invalidDrop=!0},removeDropHiglight:function(){Ext.select(".wysiwyg-box .active").each(function(a){a.removeClass("active")}),delete this.possibleSuspect},onDragOver:function(a,b){var c=Ext.get(b);c.parent("#"+this.el.id)||(this.removeDropHiglight(),c.addClass("active"),this.possibleSuspect=c)},onDragOut:function(){this.removeDropHiglight()},endDrag:function(){if(this.el.removeClass("in-drag"),this.wysiwygct.getEl().addClass("disabled-targets"),this.possibleSuspect){{var b=Ext.get(this.possibleSuspect),c=b.hasClass("top"),d=(b.hasClass("bottom"),b.hasClass("left"));b.hasClass("right")}b=b.findParent(".wysiwyg-box"),c||d?this.el.insertBefore(b):this.el.insertAfter(b),this.el.frame(null,1)}else this.el.moveTo(this.originalXY[0],this.originalXY[1]),delete this.invalidDrop;this.removeDropHiglight(),a.setupDD(),this.el.clearPositioning(),this.el.setStyle("position","relative")}});var e=Ext.get(b),f=e.child(".dd-handle").id;d.setHandleElId(f);new Ext.dd.DDTarget(e.child(".top").id,"wysiwyg-dragables-group",{}),new Ext.dd.DDTarget(e.child(".right").id,"wysiwyg-dragables-group",{}),new Ext.dd.DDTarget(e.child(".bottom").id,"wysiwyg-dragables-group",{}),new Ext.dd.DDTarget(e.child(".left").id,"wysiwyg-dragables-group",{})}),this.getEl().addClass("disabled-targets"),this.extraType&&this.getTopToolbar().extraTypesMenu.setValue(this.extraType).fireEvent("select")},verticalCenter:function(){this.el.select(".vertical-center").each(function(a){a.setHeight(a.parent().getHeight())})},initComponent:function(){this.setupTbar(),this.setupTbarWatcher(),this.setupKeyboardHandling(),Garp.Wysiwygct.superclass.initComponent.call(this,arguments),this.on("afterlayout",this.setupDD,this,{single:!0}),this.on("afterrender",function(){this.body.wrap({tag:"div",cls:"wysiwyg-wrap"}),this.verticalCenter()},this),this.on("add",function(a,b){a.verticalCenter(),b.on("showsettings",function(b,c){if(Garp.dataTypes.ContentNode.getField("type").store){var d,e=[];d=b.getMenuOptions?b.getMenuOptions():!1,d&&(e=d,e.push("-")),d=Garp.dataTypes.ContentNode.getField("type").store,d&&Ext.each(d,function(a){var c={text:a[1],val:a[0]};b.el.hasClass(a[0])&&(c.checked=!0),e.push(c)});var f=new Ext.menu.Menu({defaults:{group:"type",handler:function(b){Ext.each(d,function(a){this.el.removeClass(a[0])},this),this.el.addClass(b.val),this.type=b.val,a.verticalCenter(),this.onSettingsMenu&&this.onSettingsMenu(b)},scope:this},items:e});f.showAt(c.getXY())}})})},onDestroy:function(){this.tbWatcherInterval&&clearInterval(this.tbWatcherInterval)}}),Ext.reg("wysiwygct",Garp.Wysiwygct),Garp.Chapterct=Ext.extend(Ext.Panel,{autoScroll:!0,autoHeight:!0,border:!1,bodyBorder:!1,cls:"chapter-ct",maxCols:null,extraTypes:null,getWysiwygIdx:function(a){var b=0;return a&&this.items.each(function(c,d){return c==a?(b=d,!1):void 0}),b},addWysiwygCt:function(a,b){var c;return this.insert(this.getWysiwygIdx(b)+1,c=new Garp.Wysiwygct({ct:this,extraTypes:this.extraTypes,extraType:a&&a.type?a.type:"",maxCols:this.maxCols})),this.doLayout(),c},initComponent:function(){Garp.Chapterct.superclass.initComponent.call(this,arguments)},afterRender:function(){this.on("resize",function(){this.items.each(function(a){a.setWidth(this.getWidth())},this)},this),this.addWysiwygCt(),Garp.Chapterct.superclass.afterRender.call(this,arguments)}}),Ext.reg("chapterct",Garp.Chapterct),Garp.WysiwygAbstract=Ext.extend(Ext.BoxComponent,{ct:null,settingsMenu:!0,model:"Text",data:{},_data:{},_classes:null,getValue:function(){return this.getData()?{columns:this.col?this.col.split("-")[1]:null,data:this.getData(),model:this.model,type:"",classes:this.getClasses()}:null},html:'<div class="dd-handle icon-move"></div><div class="dd-handle icon-delete"></div><div class="dd-handle icon-settings"></div><div class="target top"></div><div class="target right"></div><div class="target bottom"></div><div class="target left"></div>',contentEditableEl:null,col:null,getData:function(){return{description:this.contentEditable?this.contentEditableEl.dom.innerHTML:""}},getType:function(){return this.type||""},showSettingsMenu:function(a,b){this.fireEvent("showsettings",a,b)},showAnimClassesDialog:function(){Ext.Msg.prompt(__("Garp"),__("Enter animation classes"),function(a,b){"ok"===a&&this.setClasses(b)},this,!0,this.getClasses()||"ani-")},getClasses:function(){return this._classes},setClasses:function(a){this._classes=a},afterRender:function(){Garp.WysiwygAbstract.superclass.afterRender.call(this,arguments),this.el.select(".dd-handle.icon-delete").on("click",function(){this.ownerCt&&this.ownerCt.removeWysiwygBox(this)},this),this.settingsMenu?this.el.select(".dd-handle.icon-settings").on("click",function(a){this.showSettingsMenu(this,a)},this):this.el.select(".dd-handle.icon-settings").hide()},beforeInit:!1,afterInit:function(){this.col||(this.col="grid-"+this.maxCols+"-"+this.maxCols,this.addClass(this.col)),this.ct.add(this),this.ct.afterAdd()},initComponent:function(){Garp.WysiwygAbstract.superclass.initComponent.call(this,arguments),this.beforeInit?this.beforeInit(this.afterInit):this.afterInit(),this.on("user-resize",function(a,b,c){this.col=c},this)}}),Garp.FilterMenu=function(){this.init=function(a){function b(b){var c=a.ownerCt,d=c.getStore().baseParams;switch(d.query||(d.query={}),delete d.query.online_status,delete d.query.author_id,"function"==typeof Garp.dataTypes[Garp.currentModel].clearFilters?Garp.dataTypes[Garp.currentModel].clearFilters():"all"==b.ref&&(d.query={}),b.ref){case"published":Ext.apply(d.query,{online_status:"1"});break;case"drafts":Ext.apply(d.query,{online_status:"0"});break;case"my":Ext.apply(d.query,{author_id:Garp.localUser.id})}return c.getStore().reload(),!0}this.tb=a,this.defaultFilter={text:__("All"),ref:"all"},this.resetUI=function(){this.tb.filterBtn.setIconClass("icon-filter-off"),this.tb.filterBtn.menu.all.setChecked(!0),this.tb.filterStatus.hide()},this.buildMenu=function(){var a=[];Garp.dataTypes[Garp.currentModel].filterMenu&&Ext.each(Garp.dataTypes[Garp.currentModel].filterMenu,function(b){a.push(b)});var b=Garp.dataTypes[Garp.currentModel];return a.push(this.defaultFilter),b.getColumn("published")&&a.push({text:__("Drafts"),ref:"drafts"},{text:__("Published"),ref:"published"}),b.getColumn("author_id")&&a.push({text:__("My items"),ref:"my"}),Ext.each(a,function(a){return"undefined"!=typeof a.isDefault&&a.isDefault?(this.defaultFilter=a,!1):void 0},this),a},this.filterMenu=this.buildMenu(),this.filterStatus=a.add({ref:"filterStatus",text:"all"!==this.defaultFilter.ref?this.defaultFilter.text:"",xtype:"tbtext",hidden:"all"===this.defaultFilter.ref}),this.filterBtn=a.add({ref:"filterBtn",tooltip:"Filter",iconCls:"all"==this.defaultFilter.ref?"icon-filter-off":"icon-filter-on",hidden:this.filterMenu.length<=1,menu:{defaultType:"menucheckitem",defaults:{group:"filter",handler:b,scope:this},items:this.filterMenu}}),this.filterBtn.menu.find("text",this.defaultFilter.text)[0].setChecked(!0),this.filterBtn.menu.on("itemclick",function(a){return"all"===a.ref?(this.filterStatus.update(""),this.filterStatus.hide(),void this.filterBtn.setIconClass("icon-filter-off")):(a.text&&this.filterStatus.update(a.text),this.filterStatus.show(),void this.filterBtn.setIconClass("icon-filter-on"))},this),this.tb.on("change",function(a){0===a.store.getCount()?this.filterStatus.hide():this.filterStatus.show()})}},Ext.ns("Garp"),Garp.TweetWindow=Ext.extend(Ext.util.Observable,{urlPart:"",width:550,height:460,x:320,y:120,bodyBorder:!1,url:"https://twitter.com/intent/tweet?",constructor:function(a){Ext.apply(this,a),this.winId="tweet-"+Ext.id();var b=new Ext.Template("chrome=no,menubar=no,toolbar=no,scrollbars=no,width={width},height={height},left={left},top={top}");b=b.apply({width:this.width,height:this.height,left:this.x,top:this.y}),this.win=window.open(this.url+this.urlPart,"tweet-"+this.winId,b),this.win.focus(),Garp.TweetWindow.superclass.constructor.call(this,a)}}),Garp.TweetField=Ext.extend(Ext.Panel,{border:!1,layout:"hbox",fieldLabel:__("Twitter description"),showTW:!0,showFB:!0,showIN:!0,loadScript:function(a,b){var c=document.createElement("script");b?c.src=a:c.innerHtml=a,Ext.select("head").first().dom.appendChild(c)},initComponent:function(a){this.loadScript("http://platform.linkedin.com/in.js",!0),this.loadScript("http://connect.facebook.net/en_US/all.js",!0),this.loadScript("if(typeof FB != 'undefined' && FB.init){FB.init({ appId: FB_APP_ID,cookie:true, status:true, xfbml:true});}"),this.twitterExcerpt=new Ext.form.TextArea({name:"twitter_description",messageTarget:"side",maxLength:119,countBox:"twitterCount",flex:1,margins:"0 5 0 0",ref:"../../../../twitterExcerpt",allowBlank:!0}),this.items=[this.twitterExcerpt,{xtype:"button",name:"tweetBtn",margins:"0 5 0 0",hidden:!this.showTW,ref:"../../../../tweetBtn",width:32,handler:function(a,b){var c=this.refOwner;if(c)if(c.bitly_url.getValue()){var d=c.twitterExcerpt.getValue();d+=" ",d+=c.bitly_url.getValue();{new Garp.TweetWindow({urlPart:Ext.urlEncode({text:d}),x:b.getPageX(),y:b.getPageY()})}}else Ext.Msg.alert("Garp",__("In order to tweet, you need to save your data first."))},iconCls:"icon-twitter"},{xtype:"button",margins:"0 5 0 0",hidden:!this.showFB,name:"fbBtn",ref:"../../../../fbBtn",width:32,handler:function(){var a=this.refOwner;if(a)if(a.bitly_url.getValue()){var b=a.twitterExcerpt.getValue();b+=" ",b+=a.bitly_url.getValue();var c=new Ext.LoadMask(Ext.getBody(),{text:__("Please wait")});c.show(),FB.ui({method:"feed",description:a.twitterExcerpt.getValue(),link:a.bitly_url.getValue(),show_error:!0},function(){c.hide()})}else Ext.Msg.alert("Garp",__("In order to FB, you need to save your data first."))},iconCls:"icon-fb"},{xtype:"button",hidden:!this.showIN,name:"inBtn",ref:"../../../../inBtn",width:32,handler:function(){function a(){if(b.bitly_url.getValue()){var a=b.twitterExcerpt.getValue(),c=b.bitly_url.getValue();a.replace('"','"'),a+=" ",a+='<a href="'+c+'">'+c+"</a>"}Ext.MessageBox.confirm(__("Garp"),__("Do you want to update your linkedIn status? <br>")+a,function(b){if("yes"==b){var c=new Ext.LoadMask(Ext.getBody(),{text:__("Please wait")});c.show(),updateURL="/people/~/person-activities",IN.API.Raw(updateURL).method("POST").body('{"contentType":"linkedin-html","body":"'+a+'"}').result(function(){c.hide()}).error(function(){c.hide(),Ext.MessageBox.alert(__("Garp"),__("Something went wrong while updating your status"))})}})}var b=this.refOwner;b&&(IN.User.isAuthorized()?a():IN.User.authorize(a,this))},iconCls:"icon-linkedin"},{xtype:"box",ref:"../../../../twitterCount",width:60,cls:"garp-countbox"}],Garp.TweetField.superclass.initComponent.call(this,a)}}),Ext.reg("tweetfield",Garp.TweetField),Ext.ns("Garp"),Garp.ImageEditor=Ext.extend(Ext.Panel,{layout:"fit",border:!1,bodyStyle:"backgroundColor: #888",updateOutline:function(){var a=Ext.get(this.crop),b=Ext.get(this.img),c=b.getX()-a.getX(),d=b.getY()-a.getY(),e=c+"px "+d+"px";return a.setStyle({"background-position":e}),this.dd.constrainTo(this.img),!0},setupEditor:function(){var a=this,b=new Image;Ext.get(b).on({load:function(){this.img=Ext.DomHelper.append(a.body,{tag:"img",src:b.src,cls:"imageeditor-subject",width:b.width,height:b.height}),Ext.get(this.img).center(this.body),this.crop=Ext.DomHelper.insertAfter(this.img,{tag:"div",cls:"imageeditor-cropoutline",children:[{tag:"div",cls:"imageeditor-cropoutline-mq",children:[{tag:"div",cls:"left"},{tag:"div",cls:"right"},{tag:"div",cls:"top"},{tag:"div",cls:"bottom"}]}],style:{width:b.width+"px",height:b.height+"px",background:"url("+b.src+")","background-repeat":"no-repeat"}}),this.resizer=new Ext.Resizable(this.crop,{handles:"all",transparent:!0,constrainTo:this.img,dynamic:!1,width:200,height:112.5,preserveRatio:!0,listeners:{resize:this.updateOutline.createDelegate(this)}}),Ext.get(this.crop).center(this.body),this.dd=Ext.get(this.crop).initDD(null,null,{onDrag:this.updateOutline.createDelegate(this)}),this.dd.constrainTo(this.img);var c=Ext.get(this.crop),d=Ext.get(this.img);c.setTop(d.getTop(!0)+10),c.setLeft(d.getLeft(!0)+30),this.updateOutline()},error:function(){},scope:this},this),b.src=this.image},initComponent:function(){this.addEvents("done"),this.buttonAlign="left",this.buttons=[{xtype:"box",html:__("Drag the selection, or drag the corners to resize the selection.")},"->",{text:__("Ok"),scope:this,handler:function(){this.fireEvent("done",[this.image])}}],Garp.ImageEditor.superclass.initComponent.call(this),this.on("afterrender",this.setupEditor.createDelegate(this))}}),Ext.ns("Garp"),Garp.ImagePickerWindow=Ext.extend(Ext.Window,{imgGridQuery:null,captionValue:null,alignValue:"",cropTemplateName:null,hideWizardText:!1,model:"Image",title:__("Image"),iconCls:"icon-image",layout:"card",activeItem:0,width:640,height:500,border:!1,modal:!0,buttonAlign:"left",resizable:!1,defaults:{border:!1},navHandler:function(a){var b=this.getLayout().activeItem.id;switch(b=parseInt(b.substr(5,b.length),10),b+=a,0>=b&&(b=0),b){case 1:this.tplGrid.getStore().on({load:{single:!0,scope:this,fn:function(){if(this.cropTemplateName){var a=this.tplGrid.getStore().getAt(this.tplGrid.getStore().find("name",this.cropTemplateName));this.tplGrid.getSelectionModel().selectRecords([a])}else this.tplGrid.getSelectionModel().selectFirstRow();this.captionValue||this.caption.getForm().findField("caption").setValue(this.imgGrid.getSelectionModel().getSelected().get("caption"))}}}),this.tplGrid.getStore().load(),this.prevBtn.enable(),this.nextBtn.setText(__("Ok"));break;case 2:var c=this.imgGrid.getSelectionModel().getSelected(),d=this.tplGrid.getSelectionModel().getSelected();this.fireEvent("select",{image:c,template:d,src:IMAGES_CDN+"scaled/"+d.get("name")+"/"+c.get("id"),align:this.alignment.getForm().getValues().align,caption:this.caption.getForm().getValues().caption}),this.close();break;default:this.prevBtn.disable(),this.nextBtn.setDisabled(this.imgGrid.getSelectionModel().getCount()<1),this.nextBtn.setText(__("Next"))}this.getLayout().setActiveItem("page-"+b)},getStoreCfg:function(){return{autoLoad:!1,autoSave:!1,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",fields:Garp.dataTypes[this.model].getStoreFieldsFromColumnModel(),totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize,query:this.query||null},api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}}},getGridCfg:function(a){return{border:!0,region:"center",hideHeaders:a,enableDragDrop:!1,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:function(){for(var a=[],b=Garp.dataTypes[this.model].columnModel,c=0,d=b.length;d>c;c++){var e=Ext.apply({},b[c]);
a.push(e)}return a}.call(this)}),pageSize:Garp.pageSize,viewConfig:{scrollOffset:-1,forceFit:!0,autoFill:!0}}},updatePreview:function(){var a=this.tplGrid.getSelectionModel().getSelected().get("name"),b=170,c=170,d=this.imgGrid.getSelectionModel().getSelected().get("id");this.previewpanel.update({IMAGES_CDN:IMAGES_CDN,BASE:BASE,tpl:a,id:d,width:b,height:c,"float":this.alignment.getForm().getValues().align})},clearSelection:function(){this.fireEvent("select",{selected:null}),this.close()},initComponent:function(){this.addEvents("select"),this.imgStore=new Ext.data.DirectStore(Ext.apply({},{writer:new Ext.data.JsonWriter({paramsAsHash:!1,writeAllFields:!0,encode:!1}),api:{create:Ext.emptyFn,read:Garp[this.model].fetch,update:Ext.emptyFn,destroy:Ext.emptyFn}},this.getStoreCfg())),this.imgGrid=new Ext.grid.GridPanel(Ext.apply({},{region:"center",title:__("Available"),itemId:"imgPanel",margins:"15 15 15 15",store:this.imgStore,bbar:new Ext.PagingToolbar({pageSize:Garp.pageSize,store:this.imgStore,beforePageText:"",displayInfo:!1}),tbar:new Ext.ux.Searchbar({xtype:"searchbar",store:this.imgStore}),listeners:{rowdblclick:this.navHandler.createDelegate(this,[1])}},this.getGridCfg(!0))),this.tplGrid=new Ext.grid.GridPanel({itemId:"tplPanel",margins:"15 15 0 15",title:__("Crop"),region:"center",hideHeaders:!0,store:new Ext.data.DirectStore({autoLoad:!0,autoSave:!1,autoDestroy:!0,remoteSort:!0,restful:!0,root:"rows",idProperty:"id",fields:[{name:"name"},{name:"w"},{name:"h"}],api:{create:Ext.emptyFn,read:Garp.CropTemplate.fetch,update:Ext.emptyFn,destroy:Ext.emptyFn}}),sm:new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{rowselect:this.updatePreview,scope:this}}),cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:[{id:"name",dataIndex:"name",header:__("Name"),width:200},{id:"w",dataIndex:"w",header:__("Width")},{id:"h",dataIndex:"h",header:__("Height")},{id:"preview",dataIndex:"name",header:__("Preview"),renderer:Garp.renderers.cropPreviewRenderer}]}),viewConfig:{scrollOffset:-1,forceFit:!0,autoFill:!0},listeners:{rowdblclick:this.navHandler.createDelegate(this,[1])}}),this.imgGrid.getSelectionModel().on("selectionchange",this.navHandler.createDelegate(this,[0])),this.tplGrid.getSelectionModel().on("selectionchange",function(){this.nextBtn.setDisabled(0===this.tplGrid.getSelectionModel().getCount())},this);var a=new Ext.Template("<h2>",__("Step")," {step} ",__("of")," 2</h2><p>{description}</p>");if(this.items=[{id:"page-0",layout:"border",bodyBorder:!0,border:!0,split:!1,items:[{region:"north",ref:"../northpanel",border:!1,html:this.hideWizardText?"":a.apply({description:__("Specify an image or add new one"),step:1}),margins:"10 15 0 15",bodyBorder:!1,bbar:new Ext.Toolbar({style:"border:0; margin-top: 10px;",border:!1,items:[{iconCls:"icon-new",ref:"newBtn",hidden:!Garp.dataTypes[this.model].quickCreatable,text:__("New "+Garp.dataTypes[this.model].text),handler:function(){var a=new Garp.RelateCreateWindow({model:this.model,iconCls:this.iconCls,title:this.title,listeners:{scope:this,aftersave:function(a,b){this.imgStore.insert(0,b),this.imgGrid.getSelectionModel().selectRecords([b],!0),this.imgStore.reload()}}});a.show()},scope:this}]})},this.imgGrid]},{id:"page-1",layout:"border",bodyBorder:!0,border:!0,split:!1,items:[{region:"north",border:!1,margins:"10 15 0 15",html:a.apply({description:__("Specify a crop template, set aligning and/or add a caption"),step:2})},this.tplGrid,{region:"east",margins:"15 15 0 0",ref:"../previewpanel",width:260,bodyStyle:"background:#e0e0e0;",title:__("Preview"),tpl:'<p style="font-size:9px;"><img src="{IMAGES_CDN}scaled/{tpl}/{id}" style="float: {float};max-width: {width}px; max-height: {height}px; border: 1px #ddd solid; margin: 3px;" />Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>'},{region:"south",border:!1,bodyBorder:!1,height:145,margins:"15 15 15 15",bodyStyle:"background-color: #eee",layout:"border",defaults:{xtype:"form",layout:"form",labelWidth:180,labelSeparator:"",border:!0,bodyStyle:"padding: 5px 0 0 5px"},items:[{title:__("Caption"),region:"center",ref:"../../caption",bodyStyle:"margin:0; padding:0;",items:[{border:!1,fieldLabel:__("Caption"),hideLabel:!0,xtype:"textarea",style:"border: 0;",height:118,anchor:"100%",name:"caption",value:this.captionValue}]},{title:__("Alignment"),region:"east",width:260,margins:"0 0 0 15",bodyStyle:"padding: 10px",ref:"../../alignment",defaults:{handler:this.updatePreview,scope:this},items:[{fieldLabel:__("No alignment"),xtype:"radio",name:"align",checked:""===this.alignValue,inputValue:""},{fieldLabel:__("Align left"),xtype:"radio",name:"align",checked:"left"==this.alignValue,inputValue:"left"},{fieldLabel:__("Align right"),xtype:"radio",name:"align",checked:"right"==this.alignValue,inputValue:"right"}]}]}]}],this.buttons=[{text:__("Previous"),ref:"../prevBtn",handler:this.navHandler.createDelegate(this,[-1])},"->",{text:__("Cancel"),handler:function(){this.close()},scope:this},{text:__("Clear selection"),ref:"../clearBtn",hidden:!0,handler:this.clearSelection.createDelegate(this)},{text:__("Next"),ref:"../nextBtn",handler:this.navHandler.createDelegate(this,[1])}],this.imgGridQuery){this.imgGrid.getStore().setBaseParam("query",this.imgGridQuery),this.imgGrid.getStore().on({load:{single:!0,scope:this,fn:function(){this.imgGrid.getSelectionModel().selectFirstRow(),this.navHandler(1)}}});var b=this.imgGrid.getTopToolbar().searchField;b.setValue(this.imgGridQuery.id),b.hasSearch=!0,b.fireEvent("change")}Garp.ImagePickerWindow.superclass.initComponent.call(this),this.on("show",function(){if(this.navHandler(-1),!this.imgGridQuery){new Ext.KeyNav(this.imgGrid.getEl(),{enter:this.navHandler.createDelegate(this,[1])})}this.imgStore.load(),this.allowBlank&&this.clearBtn.show()},this)}}),Ext.ns("Garp"),Garp.ModelPickerWindow=Ext.extend(Garp.ImagePickerWindow,{model:null,hideWizardText:!0,allowBlank:!1,activeItem:0,navHandler:function(a){var b=this.getLayout().activeItem.id;switch(b=parseInt(b.substr(5,b.length),10),b+=a,0>=b&&(b=0),b){case 1:var c=this.imgGrid.getSelectionModel().getSelected();this.fireEvent("select",{selected:c||null}),this.close();break;default:if(!this.allowBlank){var d=this.imgGrid.getSelectionModel();d.on("selectionchange",function(){this.nextBtn.setDisabled(1!=d.getCount())},this)}this.prevBtn.disable(),this.nextBtn.setText(__("Ok")),this.nextBtn.setDisabled(!this.allowBlank)}this.getLayout().setActiveItem("page-"+b)},initComponent:function(){var a=Garp.dataTypes[this.model];this.setTitle(__(a.text)),this.setIconClass(a.iconCls),Garp.ModelPickerWindow.superclass.initComponent.call(this)}}),Ext.ns("Garp"),Garp.RelateCreateWindow=Ext.extend(Ext.Window,{model:"",iconCls:"",title:"",cls:"relate-create-window",modal:!0,width:640,border:!0,preventBodyReset:!1,autoScroll:!0,rec:null,quickCreatableInit:Ext.emptyFn,initComponent:function(){this.iconCls||this.setIconClass(Garp.dataTypes[this.model].iconCls),this.title||this.setTitle(Garp.dataTypes[this.model].text),this.addEvents("aftersave","afterinit"),this.writer=new Ext.data.JsonWriter({paramsAsHash:!1,encode:!1});var a=[],b=Garp.dataTypes[this.model].columnModel;Ext.each(b,function(b){a.push(b.dataIndex)}),this.store=new Ext.data.DirectStore({fields:a,autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize},api:{create:Garp[this.model].create||Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Garp[this.model].update||Ext.emptyFn,destroy:Garp[this.model].destroy||Ext.emptyFn},writer:this.writer});var c=Ext.apply({},Garp.dataTypes[this.model].formConfig[0].items[0]),d=Ext.apply({},Garp.dataTypes[this.model].formConfig[0].listeners);c={ref:"../formcontent",items:[c],listeners:d,bodyCssClass:"garp-formpanel",border:!1},this.items=[{border:!1,xtype:"form",layout:"form",ref:"form",defaults:{autoWidth:!0,border:!1,bodyCssClass:"garp-formpanel"},items:c}],this.buttons||(this.buttons=[]),this.buttons.push([{text:__("Cancel"),ref:"../cancelBtn",handler:function(){this.close()},scope:this},{text:__("Ok"),ref:"../okBtn",handler:function(){this.saveAll(!0)},scope:this}]),Garp.RelateCreateWindow.superclass.initComponent.call(this)},saveAll:function(a){return this.form.getForm().isValid()?(this.form.getForm().updateRecord(this.rec),this.store.on({save:{fn:function(){this.rec=this.store.getAt(0),this.formcontent&&this.formcontent.fireEvent("loaddata",this.rec,this),this.fireEvent("aftersave",this,this.rec),this.loadMask.hide(),a&&this.close()},single:!0,scope:this}}),void(-1!==this.store.save()&&(this.loadMask=new Ext.LoadMask(this.getEl()),this.loadMask.show()))):void this.form.getForm().items.each(function(){this.isValid()})},afterRender:function(){Garp.RelateCreateWindow.superclass.afterRender.call(this),this.form.getForm().setValues(Garp.dataTypes[this.model].defaultData),this.onShow&&this.onShow.call(this);var a=new this.store.recordType(Ext.apply({},Garp.dataTypes[this.model].defaultData));this.rec=a,this.store.insert(0,a),this.getForm=function(){return this.form.getForm()},this.on("save-all",this.saveAll,this),this.on("show",function(){if(this.formcontent.fireEvent("loaddata",a,this),this.quickCreatableInit(),this.getForm().clearInvalid(),this.quickCreateReference){var b=this.parentId||Garp.gridPanel.getSelectionModel().getSelected().get("id");this.getForm().findField(this.quickCreateReference).store.on("load",function(){this.getForm().findField(this.quickCreateReference).setValue(b)},this,{single:!0}),this.getForm().findField(this.quickCreateReference).store.load()}this.keymap=new Ext.KeyMap(this.formcontent.getEl(),[{key:Ext.EventObject.ENTER,ctrl:!0,scope:this,handler:function(){return this.form.getForm().items.each(function(){this.fireEvent("blur",this)}),this.okBtn.handler.call(this),!1}}]),this.keymap.stopEvent=!0,this.fireEvent("afterinit",this)},this)}}),Garp.InlineRelator=Ext.extend(Ext.Panel,{model:"",rule:null,rule2:null,unrelateExisting:!0,localId:null,border:!1,bodyBorder:!1,autoHeight:!0,autoScroll:!0,getEmptyRecord:function(){return new this.relationStore.recordType},setupStore:function(){var a=Garp.dataTypes[this.model].getStoreFieldsFromColumnModel();this.writer=new Ext.data.JsonWriter({paramsAsHash:!1,encode:!1}),this.relationStore=new Ext.data.DirectStore({fields:a,autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize,query:""},api:{create:Garp[this.model].create||Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Garp[this.model].update||Ext.emptyFn,destroy:Garp[this.model].destroy||Ext.emptyFn},writer:this.writer,listeners:{beforeload:{fn:function(){return this.localId?!0:!1},scope:this},load:{fn:function(){this.addInlineForms(),0!==this.relationStore.getCount()||this.addBtn||this.addAddBtn()},scope:this}}})},addAddBtn:function(){this.add({xtype:"button",ref:"addBtn",iconCls:"icon-new",text:__(Garp.dataTypes[this.model].text),handler:function(a){this.remove(a),this.addForm()},scope:this}),this.doLayout()},addInlineForms:function(){this.relationStore.each(function(a){this.add({xtype:"inlineform",rec:a,model:this.model,inlineRelator:this})},this),this.doLayout()},addForm:function(a){var b=0;b=a?this.relationStore.findBy(function(b){return b==a.rec?!0:void 0})+1:this.relationStore.getCount();var c=this.getEmptyRecord();this.relationStore.insert(b,c),this.insert(b,{xtype:"inlineform",rec:c,model:this.model,inlineRelator:this}),this.doLayout(),this.items.last().items.each(function(){return this.hidden||this.disabled||!this.focus?void 0:(this.focus(),!1)})},relate:function(){var a={model:this.model,unrelateExisting:this.unrelateExisting,primaryKey:this.localId,foreignKeys:function(){var a=[];return this.relationStore.each(function(b){a.push({key:b.data.id,relationMetadata:b.data.relationMetadata?b.data.relationMetadata[Garp.currentModel]:[]})}),a.reverse(),a}.call(this)};this.rule&&(a.rule=this.rule),this.rule2&&(a.rule2=this.rule2);var b=this;Garp[Garp.currentModel].relate(a,function(a){a&&(b.relationStore.removeAll(!0),b.items.each(function(a){b.remove(a)}),b.relationStore.reload())})},saveAll:function(){this.relationStore.on({save:{fn:this.relate,scope:this}}),this.relationStore.save()},removeForm:function(a){this.relationStore.remove(a.rec),this.remove(a),this.doLayout(),this.relate()},initComponent:function(a){Garp.InlineRelator.superclass.initComponent.call(this,a),this.ownerForm=this.ownerCt.ownerCt,this.setupStore(),this.ownerForm.on("loaddata",function(a){this.localId=a.get("id"),this.items.each(function(a){this.remove(a)},this),this.relationStore.removeAll(!0);var b={};b[Garp.currentModel+".id"]=this.localId,this.relationStore.setBaseParam("query",b),this.relationStore.reload()},this),Garp.eventManager.on("save-all",function(){this.items.each(function(){this.updateRecord&&this.updateRecord(this.rec)}),this.saveAll()},this)}}),Ext.reg("inlinerelator",Garp.InlineRelator),Garp.InlineForm=Ext.extend(Ext.Panel,{rec:null,inlineRelator:"",border:!1,bodyBorder:!1,hideBorders:!0,style:"padding-bottom: 2px;",border:!1,bodyBorder:!1,layout:"hbox",hideLabel:!0,xtype:"inlineform",morphFields:function(a){var b=a.items.slice(0);return b.push({iconCls:"icon-new",xtype:"button",width:31,margins:"0 0 0 1",flex:0,handler:function(){this.inlineRelator.addForm(this)},scope:this},{iconCls:"icon-delete",xtype:"button",width:31,margins:"0 0 0 1",flex:0,handler:function(){this.inlineRelator.removeForm(this)},scope:this}),Ext.each(b,function(a){a.hasOwnProperty("flex")||(a.flex=1),a.margins="0 0 0 1"}),b},loadRecord:function(a){this.items.each(function(b){b.name&&a.get(b.name)&&b.setValue&&b.setValue(a.get(b.name))})},updateRecord:function(){this.items.each(function(a){a.name&&a.getValue()&&this.rec.set(a.name,a.getValue())},this)},initComponent:function(){this.items=this.morphFields(Ext.apply({},Garp.dataTypes[this.model].formConfig[0].items[0])),Garp.InlineForm.superclass.initComponent.call(this),this.rec&&this.loadRecord(this.rec)}}),Ext.reg("inlineform",Garp.InlineForm),Garp.InlineRelatorLabels=Ext.extend(Ext.Panel,{model:null,layout:"hbox",border:!1,hideLabel:!0,style:"margin-bottom: 5px;font-weight: bold;",defaults:{flex:1,xtype:"label"},initComponent:function(a){var b=Garp.dataTypes[this.model].formConfig[0].items[0].items.slice(0),c=[];Ext.each(b,function(a){a.disabled||a.hidden||!a.fieldLabel||c.push({text:__(a.fieldLabel)})}),c.push({width:65,text:" ",flex:0}),this.items=c,Garp.InlineRelatorLabels.superclass.initComponent.call(this,a)}}),Ext.reg("inlinerelatorlabels",Garp.InlineRelatorLabels),Ext.ns("Ext.ux"),Ext.ux.RelationField=Ext.extend(Ext.form.ComboBox,{model:null,allowBlank:!1,autoLoad:!0,editable:!1,triggerAction:"all",typeAhead:!1,mode:"remote",valueField:"id",displayField:"name",disableCreate:!1,emptyText:__("(empty)"),trigger1Class:"relation-open-button",cls:"relation-field",allQuery:"",lastQuery:"",baseParams:{start:0,limit:Garp.pageSize},selectCallback:function(a){var b=this.getValue();return a&&a.hasOwnProperty("selected")?(null===a.selected?this.setValue(null):(this.setValue(a.selected.get(this.displayField)||a.selected.get("id")),this.disable(),this.store.on({load:function(){this.setValue(a.selected.get("id")),this.enable(),this.assertValue&&this.assertValue(),this.el.focus(!0),this.collapse.defer(200,this)},single:!0,scope:this}),this.store.load()),this.originalValue=b,this.win.destroy(),void this.fireEvent("select",a)):void this.win.destroy()},triggerFn:function(){this.win=new Garp.ModelPickerWindow({model:this.model,query:this.allQuery||null,allowBlank:this.allowBlank}),this.win.on("select",this.selectCallback,this),this.win.on("close",this.selectCallback,this),this.win.show()},createRelationUrl:function(){return this.getValue()?BASE+"admin?"+Ext.urlEncode({model:this.model,id:this.getValue()}):!1},onRelationOpenTriggerClick:function(){if(this.tip)this.tip.isVisible()?this.tip.hide():this.tip.show();else{var a=this.createRelationUrl();if(a){window.open(a)}}},getValue:function(){var a=Ext.ux.RelationField.superclass.getValue.call(this);return(""===a||a==this.emptyText)&&(a=null),a},setValue:function(a){this.el.removeClass("x-form-invalid"),a&&this.store.find("id",a)<0&&(this.disable(),this.el.addClass("loading"),this.store.load({add:!0,single:!0,params:{query:{id:a}},callback:function(a){this.enable(),this.el.removeClass("loading"),a&&a.length?(this.assertValue(),this.collapse()):(this.store.clearFilter(),this.el.addClass("x-form-invalid"))},scope:this})),a?this.getTrigger(0).removeClass("no-relation"):this.getTrigger(0).addClass("no-relation"),Ext.ux.RelationField.superclass.setValue.call(this,a)},initComponent:function(){this.store=new Ext.data.DirectStore({autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",fields:Garp.dataTypes[this.model]?Garp.dataTypes[this.model].getStoreFieldsFromColumnModel():[],totalProperty:"total",sortInfo:Garp.dataTypes[this.model]&&Garp.dataTypes[this.model].sortInfo?Garp.dataTypes[this.model].sortInfo:null,baseParams:this.baseParams,api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}}),this.store.on({load:{single:!0,scope:this,fn:function(){var a={id:0};a[this.displayField]=this.emptyText;var b=new this.store.recordType(a,0);this.store.add(b),this.assertValue()}}}),this.triggerFn?this.onTriggerClick=this.triggerFn:this.store.load(),Ext.ux.RelationField.superclass.initComponent.call(this),this.triggerConfig={tag:"span",cls:"x-form-twin-triggers",cn:[{tag:"img",src:Ext.BLANK_IMAGE_URL,alt:"",title:__("Open in new window"),cls:"x-form-trigger "+this.trigger1Class},{tag:"img",src:Ext.BLANK_IMAGE_URL,alt:"",cls:"x-form-trigger "+this.trigger2Class}]},Garp.dataTypes[this.model]||this.disable()},getTrigger:function(a){return this.triggers[a]},afterRender:function(){Ext.form.TwinTriggerField.superclass.afterRender.call(this);for(var a=this.triggers,b=0,c=a.length;c>b;++b)this["hideTrigger"+(b+1)]&&a[b].hide();Garp.dataTypes[this.model].previewItems&&Garp.dataTypes[this.model].previewItems.length&&(this.tip=new Ext.ToolTip({target:this.el,html:"",anchor:"top",anchorOffset:5,closable:!0,showDelay:1e3,hideDelay:3500,listeners:{show:function(a){var b=this.store.find("id",this.getValue()),c=Garp.dataTypes[this.model].previewItems;if(b>-1){var d=this.store.getAt(b).data,e="<ul>";Ext.each(c,function(a){var b=d[a]||"";e+="<li>"+__(a)+": <b>"+b+"</b></li>"}),e+="</ul>",e+='<a target="_blank" href="'+BASE+"admin/?model="+this.model+"&id="+d.id+'">'+__("Open in new window")+"</a>",a.update(e)}else a.hide()},scope:this},scope:this}))},initTrigger:function(){var a=this.trigger.select(".x-form-trigger",!0),b=this;a.each(function(a,c,d){var e="Trigger"+(d+1);a.hide=function(){var a=b.wrap.getWidth();this.dom.style.display="none",b.el.setWidth(a-b.trigger.getWidth()),b["hidden"+e]=!0},a.show=function(){var a=b.wrap.getWidth();this.dom.style.display="",b.el.setWidth(a-b.trigger.getWidth()),b["hidden"+e]=!1},0===d?this.mon(a,"click",this.onRelationOpenTriggerClick,this,{preventDefault:!0}):this.mon(a,"click",this.onTriggerClick,this,{preventDefault:!0}),a.addClassOnOver("x-form-trigger-over"),a.addClassOnClick("x-form-trigger-click")},this),this.triggers=a.elements},getTriggerWidth:function(){var a=0;return Ext.each(this.triggers,function(b,c){var d="Trigger"+(c+1),e=b.getWidth();a+=0!==e||this["hidden"+d]?e:this.defaultTriggerWidth},this),a},onDestroy:function(){Ext.destroy(this.triggers),Ext.form.TwinTriggerField.superclass.onDestroy.call(this)},onTrigger1Click:Ext.emptyFn,onTrigger2Click:Ext.emptyFn}),Ext.ux.JoinedRelationField=Ext.extend(Ext.ux.RelationField,{bindedField:null,selectCallback:function(a){var b,c;a&&"undefined"!=typeof a.selected&&(a.selected?(b=a.selected.get("id"),c=Garp.dataTypes[this.model].displayFieldRenderer(a.selected)):(b=null,c=null),this.form.findField(this.bindedField).setValue(b),this.setValue(c),this.fireEvent("select",a))},isDirty:function(){return!1},getValue:function(){return null},createRelationUrl:function(){var a=this.form.findField(this.bindedField).getValue();return a?BASE+"admin?"+Ext.urlEncode({model:this.model,id:a}):!1},setValue:function(a){return Ext.ux.RelationField.superclass.setValue.call(this,a),this}}),Ext.ux.BindedField=Ext.extend(Ext.form.TextField,{bindedField:null,initComponent:function(a){this.hidden=!0,this.hideFieldLabel=!0,Ext.ux.BindedField.superclass.initComponent.call(this,a)},getValue:function(){var a=Ext.ux.BindedField.superclass.getValue.call(this);return""===a?null:a}}),Ext.reg("relationfield",Ext.ux.RelationField),Ext.reg("joinedrelationfield",Ext.ux.JoinedRelationField),Ext.reg("bindedfield",Ext.ux.BindedField),Ext.ns("Ext.ux"),Ext.ux.RelationPanel=Ext.extend(Ext.Panel,{layout:"border",bodyBorder:!1,border:!0,forceLayout:!0,monitorValid:!1,minimalUI:!1,paginated:!1,quickCreatable:!1,quickCreateReference:null,localId:null,unrelateExisting:!0,model:null,weighable:!1,rule:null,rule2:null,bindingModel:null,bidirectional:!0,foreignKey:"id",columns:null,title:"",quickCreateBtnLabel:"",maxItems:null,metaDataEditors:null,metaDataValidator:function(){return!0},dirty:function(){if(this.fireEvent("dirty"),this.metaDataPanel)var a=this.metaDataValidator(this.metaDataPanel.getSource(),this.relateePanel.store.data);a&&this.getTopToolbar().saveBtn.enable(),this.getTopToolbar().cancelBtn.enable(),this.ownerCt.items.each(function(a){a!=this&&a.disable()},this)},undirty:function(){this.fireEvent("undirty"),this.getTopToolbar().saveBtn.disable(),this.getTopToolbar().cancelBtn.disable(),this.ownerCt.items.each(function(a){a!=this&&a.enable()},this)},getRowIndex:function(a,b){return a.getView().findRowIndex(Ext.lib.Event.getTarget(b))},highlight:function(a){this.highlightEl&&this.highlightEl.removeClass("garp-dnd-over"),a&&(this.highlightEl=Ext.get(a),this.highlightEl.addClass("garp-dnd-over"))},setupDD:function(){var a=this;new Ext.dd.DropTarget(this.relatePanel.getView().el,{ddGroup:"dd",copy:!0,notifyOut:function(){a.highlight(!1)},notifyOver:function(b,c){return"relatePanel"==b.dragData.grid.itemId?Ext.dd.DropZone.prototype.dropNotAllowed:(a.highlight(a.relatePanel.getView().getRow(a.getRowIndex(a.relatePanel,c)),this.highlight),Ext.dd.DropZone.prototype.dropAllowed)},notifyDrop:function(b,c){if(a.highlight(!1),"relatePanel"==b.dragData.grid.itemId)return!1;var d=b.dragData.selections,e=a.getRowIndex(a.relateePanel,c);return a.moveRecords(b.grid,a.relatePanel,d,e),!0}}),new Ext.dd.DropTarget(this.relateePanel.getView().el,{ddGroup:"dd",copy:!0,notifyOut:function(){a.highlight(!1)},notifyOver:function(b,c){return a.highlight(a.relateePanel.getView().getRow(a.getRowIndex(a.relateePanel,c)),this.highlight),a.weighable||"relateePanel"!=b.dragData.grid.itemId?"relateePanel"==b.dragData.grid.itemId?Ext.dd.DropZone.prototype.dropAllowed:a.maxItems&&a.relateeStore.getCount()>=a.maxItems?Ext.dd.DropZone.prototype.dropNotAllowed:Ext.dd.DropZone.prototype.dropAllowed:Ext.dd.DropZone.prototype.dropNotAllowed},notifyDrop:function(b,c){if(!a.weighable&&"relateePanel"==b.dragData.grid.itemId)return!1;a.highlight(!1);var d=b.dragData.selections,e=a.getRowIndex(a.relateePanel,c);return a.moveRecords(b.grid,a.relateePanel,d,e),!(a.maxItems&&a.relateeStore.getCount()>=a.maxItems)}})},moveRecords:function(a,b,c,d){if(!(this.maxItems&&this.relateeStore.getCount()>=this.maxItems&&b==this.relateePanel&&a!==b||(c||(c=a.getSelectionModel().getSelections()),this.maxItems&&this.relateeStore.getCount()+c.length>this.maxItems&&a==this.relatePanel))){Ext.each(c,function(c){var e=new a.store.recordType(c.data);Ext.isNumber(d)?b.store.insert(d,e):(d=b.store.getCount(),b.store.add(e)),a.store.remove(c)}),Ext.each([a,b],function(a){a.getSelectionModel().clearSelections(),a.getView().refresh()}),this.dirty(),this.weighable||(b.store.remoteSort=!1,b.store.sort(Garp.dataTypes[this.model].sortInfo.field,Garp.dataTypes[this.model].sortInfo.direction),b.store.remoteSort=!0);var e=c[0],f=b.store.find("id",e.data.id);b.getSelectionModel().selectRow(f||0)}},getStoreCfg:function(){return{autoLoad:!1,autoSave:!1,remoteSort:!0,restful:!0,autoDestroy:!0,pruneModifiedRecords:!0,root:"rows",idProperty:"id",fields:function(){var a=Garp.dataTypes[this.model].getStoreFieldsFromColumnModel();return a.push({dataIndex:"relationMetadata",header:!1,searchable:!1,hidden:!0}),a}.call(this),totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:function(){var a={start:0,limit:Garp.pageSize};return this.rule&&(a.rule=this.rule),this.rule2&&(a.rule2=this.rule2),this.bindingModel&&(a.bindingModel=this.bindingModel),a.bidirectional=this.bidirectional,a}.call(this),api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}}},getGridCfg:function(a){return{border:!0,region:"center",hideHeaders:a,enableDragDrop:!0,ddGroup:"dd",cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:function(){var a,b,c,d=[];if(this.columns){a=Garp.dataTypes[this.model].columnModel;for(b=0,c=a.length;c>b;b++)col=Ext.apply({},a[b]),col.hidden=-1==this.columns.indexOf(col.dataIndex),d.push(col);return d}for(a=Garp.dataTypes[this.model].columnModel,b=0,c=a.length;c>b;b++)col=Ext.apply({},a[b]),d.push(col);return d}.call(this)}),pageSize:Garp.pageSize,title:__("Available"),iconCls:this.iconCls,viewConfig:{scrollOffset:-1,forceFit:!0,autoFill:!0}}},getButtonPanel:function(){return{border:!1,xtype:"container",bodyBorder:!1,region:"east",width:50,margins:"0 0 0 20",bodyCssClass:"garp-relatepanel-buttons",layout:"vbox",layoutConfig:{align:"stretch",pack:"center",defaultMargins:{top:5,left:5,right:5,bottom:5}},items:[{xtype:"button",iconCls:"icon-relatepanel-relate",ref:"../../relateBtn",tooltip:__("Relate selected item(s)"),handler:this.moveRecords.createDelegate(this,[this.relatePanel,this.relateePanel,!1,!1])},{xtype:"button",iconCls:"icon-relatepanel-unrelate",ref:"../../unrelateBtn",tooltip:__("Unrelate selected item(s)"),handler:this.moveRecords.createDelegate(this,[this.relateePanel,this.relatePanel,!1,!1])}]}},saveRelations:function(a){if(Garp[Garp.currentModel].relate&&("undefined"==typeof a&&(a={}),this.relateeStore&&(a.force||0!==this.relateeStore.getModifiedRecords().length||0!==this.relateStore.getModifiedRecords().length))){this.loadMask=new Ext.LoadMask(this.getEl(),{msg:__("Relating&hellip;")}),this.loadMask.show();var b={model:this.model,unrelateExisting:this.unrelateExisting,primaryKey:this.localId,foreignKeys:function(){var a=[];return this.relateeStore.each(function(b){a.push({key:b.data.id,relationMetadata:b.data.relationMetadata?b.data.relationMetadata[Garp.currentModel]:[]})}),a.reverse(),a}.call(this)};this.rule&&(b.rule=this.rule),this.rule2&&(b.rule2=this.rule2),this.bindingModel&&(b.bindingModel=this.bindingModel),b.bidirectional=this.bidirectional,Garp[Garp.currentModel].relate(b,function(a){if(this.loadMask.hide(),a)if(this.model==Garp.currentModel){var b=Garp.gridPanel.getStore();this.relateStore.rejectChanges(),this.relateeStore.rejectChanges(),b.on({load:{fn:function(){var a=Garp.gridPanel.getSelectionModel();this._selectionChange(a),this.relateStore.reload(),this.relateeStore.reload()},scope:this,buffer:100,single:!0}}),b.reload()}else this.relateStore.reload(),this.relateeStore.reload()},this)}},checkDirty:function(a){return"function"!=typeof a&&(a=Ext.emptyFn),this.relateStore.getModifiedRecords().length>0||this.relateeStore.getModifiedRecords().length>0?(Ext.Msg.show({animEl:Garp.viewport.getEl(),icon:Ext.MessageBox.QUESTION,title:__("Garp"),msg:__("Would you like to save your changes?"),buttons:Ext.Msg.YESNOCANCEL,scope:this,fn:function(b){function c(){d--,0===d&&(this.relateStore.rejectChanges(),this.relateeStore.rejectChanges(),a())}switch(b){case"yes":this.saveRelations();var d=2;this.relateeStore.on({load:{fn:c,scope:this,single:!0}}),this.relateStore.on({load:{fn:c,scope:this,single:!0}});break;case"no":this.relateStore.rejectChanges(),this.relateeStore.rejectChanges(),a()}}}),!1):!0},_selectionChange:function(a){if(this.setDisabled(1!==a.getCount()),1!==a.getCount())return void(this.ownerCt&&this.ownerCt.setActiveTab&&this.ownerCt.setActiveTab(0));var b=a.getSelected().get(this.foreignKey);b?this.localId=b:(this.localId=a.getSelected().get("id"),null===this.localId&&(this.setDisabled(!0),this.ownerCt.setActiveTab(0)));var c;c={},"undefined"==typeof this.filterColumn?c[Garp.currentModel+".id <>"]=b:c[this.filterColumn+" <>"]=b;var d=Ext.apply(this.relateStore.baseParams,{query:c,rule:this.rule});this.rule2&&(d.rule2=this.rule2),this.bindingModel&&(d.bindingModel=this.bindingModel),d.bidirectional=this.bidirectional,this.relateStore.setBaseParam(d),c={},"undefined"==typeof this.filterColumn?c[Garp.currentModel+".id"]=b:c[this.filterColumn]=b,d=Ext.apply(this.relateeStore.baseParams,{query:c,rule:this.rule}),this.rule2&&(d.rule2=this.rule2),this.bindingModel&&(d.bindingModel=this.bindingModel),d.bidirectional=this.bidirectional,this.relateeStore.setBaseParam(d),this.searchbar.setBaseParams(),!this.hidden&&this.rendered&&(this.relateePanel.getSelectionModel().clearSelections(!0),this.metaPanel&&(this.metaDataPanel.hide(),this.metaDataPanel.ownerCt.doLayout()),this.relateStore.reload(),this.relateeStore.reload())},_onActivate:function(){this._onActivate.isLoaded||(this.minimalUI||this.relateStore.on({load:{scope:this,single:!0,fn:this.setupDD}}),this.relateStore.load(),this.relateeStore.load(),this._onActivate.isLoaded=!0,this.relatePanel.doLayout())},updateOpenNewWindow:function(){function a(a,b){return!a!=!b}a(1==this.relatePanel.getSelectionModel().getCount(),1==this.relateePanel.getSelectionModel().getCount())?this.getTopToolbar().buttonopennewwindow.show():this.getTopToolbar().buttonopennewwindow.hide()},initComponent:function(){function a(a){null!==this.maxItems&&(a.getCount()==this.maxItems?this.relateBtn.disable():this.relateBtn.enable()),this.relateStore.filter([{scope:this,fn:function(a){return!this.relateeStore.getById(a.get("id"))}}])}function b(){e.rendered&&e.isVisible()&&(e.metaDataValidator(e.metaDataPanel.getSource(),e.relateePanel.store.data)?e.getTopToolbar().saveBtn.enable():e.getTopToolbar().saveBtn.disable())}if(Garp.dataTypes[this.model]){var c=null;this.iconCls||this.setIconClass(Garp.dataTypes[this.model].iconCls),this.title||this.setTitle(__(Garp.dataTypes[this.model].text)),this.quickCreateBtnLabel||(this.quickCreateBtnLabel=this.title),this.bodyCssClass="garp-relatepanel-buttons",this.relateStore=new Ext.data.DirectStore(Ext.apply({},{listeners:{load:{scope:this,single:!0,fn:function(){this.relateeStore.load()}}},api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}},this.getStoreCfg())),this.relateeStore=new Ext.data.DirectStore(Ext.apply({},{baseParams:{limit:this.paginated?Garp.pageSize:c},writer:new Ext.data.JsonWriter({paramsAsHash:!1,writeAllFields:!0,encode:!1}),listeners:{load:a.createSequence(this.undirty),add:a,remove:a,save:a,update:a,scope:this}},this.getStoreCfg())),this.relatePanel=new Ext.grid.GridPanel(Ext.apply({},{itemId:"relatePanel",store:this.relateStore,bbar:new Ext.PagingToolbar({pageSize:Garp.pageSize,store:this.relateStore,beforePageText:"",displayInfo:!1}),tbar:this.searchbar=new Ext.ux.Searchbar({xtype:"searchbar",store:this.relateStore}),listeners:{rowdblclick:function(){this.moveRecords(this.relatePanel,this.relateePanel,!1,!1)},scope:this}},this.getGridCfg(!1)));var d=Ext.apply({},{itemId:"relateePanel",title:__("Related"),iconCls:"icon-relatepanel-related",store:this.relateeStore,tbar:null!==this.maxItems?new Ext.Toolbar({items:[{xtype:"tbtext",text:this.maxItems+__(" item(s) maximum")}]}):null,monitorResize:!0,layout:"fit",pageSize:c,listeners:this.minimalUI?{}:{rowdblclick:function(){this.moveRecords(this.relateePanel,this.relatePanel,!1,!1)
},scope:this}},this.getGridCfg(null!==this.maxItems));if(this.paginated&&(d.pageSize=Garp.pageSize,d.bbar=new Ext.PagingToolbar({pageSize:Garp.pageSize,store:this.relateeStore,beforePageText:"",displayInfo:!1})),this.relateePanel=new Ext.grid.GridPanel(d),this.minimalUI)this.items=[{xtype:"container",layout:"border",border:!1,margins:"20 20 20 20",region:"center",items:this.relateePanel}];else{var e=this;this.metaDataPanel=new Ext.grid.PropertyGrid({split:!0,__relationPanel:this,layout:"fit",region:"south",minHeight:250,height:200,collapsed:!1,customEditors:this.metaDataEditors,foceValidation:!0,hidden:!0,collapsible:!1,source:this.source||{},listeners:{propertychange:b}}),this.metaDataPanel.store.on("load",b,this),this.items=[{xtype:"container",layout:"border",border:!1,width:"50%",margins:"15 15 20 15",region:"center",items:[this.relatePanel,this.getButtonPanel()]},{xtype:"container",layout:"border",width:"50%",region:"east",margins:"15 15 20 5",border:!1,bodyCssClass:"garp-relatepanel-buttons",items:[this.relateePanel,this.metaDataPanel]}]}this.tbar=new Ext.Toolbar({style:"border:0; padding: 15px 15px 0 15px;",border:!1,items:[{iconCls:"icon-save",text:__("Save"),ref:"saveBtn",disabled:!0,hidden:this.minimalUI,handler:function(){this.saveRelations()},scope:this},{iconCls:"icon-cancel",text:__("Cancel"),ref:"cancelBtn",hidden:this.minimalUI,disabled:!0,handler:function(){this.relateeStore.reload(),this.metaDataPanel.hide(),this.metaDataPanel.setSource(this.source||{}),this.relateePanel.getSelectionModel().selectRange(-1,-1)},scope:this},Garp.dataTypes[this.model].quickCreatable?{iconCls:"icon-new",text:__("New "+this.quickCreateBtnLabel),handler:function(){var a={model:this.model,iconCls:this.iconCls,title:this.title,quickCreateReference:this.quickCreateReference};this.quickCreateConfig&&(a=Ext.apply(a,this.quickCreateConfig));var b=new Garp.RelateCreateWindow(a);b.show(),b.on("aftersave",function(a,b){this.relateeStore.add(b),this.saveRelations({force:!0})},this)},scope:this}:{hidden:!0}," ",{iconCls:"icon-open-new-window",hidden:!0,ref:"buttonopennewwindow",text:__("Open in new window"),handler:function(){var a;if(this.relatePanel.getSelectionModel().getCount()>0?(a=this.relatePanel.getSelectionModel().getSelected(),Garp.eventManager.on("external-relation-save",function(){this.relatePanel.getStore().reload()},this)):(a=this.relateePanel.getSelectionModel().getSelected(),Garp.eventManager.on("external-relation-save",function(){this.relateePanel.getStore().reload()},this)),a){var b=a.get("id"),c=BASE+"admin?model="+this.model+"&id="+b;window.open(c)}},scope:this},"->",{text:__("Export"),iconCls:"icon-export",hidden:!1,handler:function(){var a=new Garp.ExportWindow;a.show()}}," ",{iconCls:"icon-help",text:__("How does this work?"),hidden:this.minimalUI,handler:function(){var a=new Ext.ToolTip({target:this.getEl(),anchor:"top",preventBodyReset:!0,bodyCssClass:"garp-tooltip",html:__("Relate or reorder items by dragging them around, or use the arrow buttons in the middle."),autoHide:!0});a.show()}}]}),this.on("activate",this._onActivate,this),this.on("hide",function(){this._onActivate.isLoaded=!1},this),this.on("deactivate",this.checkDirty,this),this.relatePanel.getSelectionModel().on({selectionchange:{scope:this,buffer:25,fn:this.updateOpenNewWindow}}),this.relateePanel.getSelectionModel().on({selectionchange:{scope:this,buffer:25,fn:function(a){if(this.updateOpenNewWindow(),this.metaDataPanel){var b=!1;for(var c in this.metaDataPanel.getSource()){b=!0;break}a&&1==a.getCount()&&b?a&&1==a.getCount()&&this.relateeStore&&this.relateeStore.fields.containsKey("relationMetadata")&&(this.metaDataPanel.show(),this.metaDataPanel.ownerCt.doLayout(),this.metaDataPanel.startEditing(0,1)):(this.metaDataPanel.hide(),this.metaDataPanel.ownerCt.doLayout())}}},rowselect:{scope:this,buffer:20,fn:function(a,b,c){if(this.metaDataPanel)if(1==a.getCount()){if(c.data.relationMetadata&&c.data.relationMetadata[Garp.currentModel]){this.metaDataPanel._recordRef=c.id;var d=c.data.relationMetadata[Garp.currentModel];for(var e in d)null===d[e]&&(d[e]="");this.metaDataPanel.setSource(d)}}else this.metaDataPanel.hide(),this.metaDataPanel.ownerCt.doLayout()}}}),this.metaDataPanel&&this.metaDataPanel.on("propertychange",function(a,b,c,d){if(c!=d){var e=this.relateeStore.getById(this.metaDataPanel._recordRef);if(!e)return;e.beginEdit();{e.data.relationMetadata[Garp.currentModel]}e.set({k:a}),e.markDirty(),e.endEdit(),this.relateePanel.getView().refresh()}},this),Garp.eventManager&&Garp.eventManager.on({"after-save":{scope:this,fn:this._selectionChange},selectionchange:{scope:this,fn:this._selectionChange,buffer:400},"save-all":{scope:this,fn:function(){this.saveRelations()}},beforerowselect:{scope:this,fn:function(a,b){return this.checkDirty(function(){a.selectRow(b)})}}})}else this.ownerCt.on("afterrender",function(){this.destroy()},this);Ext.ux.RelationPanel.superclass.initComponent.call(this)},onDestroy:function(){this.un("activate",this._onActivate,this),Garp.eventManager&&(Garp.eventManager.un("save-all",this.saveRelations,this),Garp.eventManager.un("selectionchange",this._selectionChange,this),Garp.eventManager.un("after-save",this._selectionChange,this)),Ext.ux.RelationPanel.superclass.onDestroy.call(this),this._onActivate.isLoaded=!1}}),Ext.reg("relationpanel",Ext.ux.RelationPanel),Ext.namespace("Ext.ux.form"),Ext.ux.form.SuperBoxSelect=function(a){Ext.ux.form.SuperBoxSelect.superclass.constructor.call(this,a),this.addEvents("beforeadditem","additem","newitem","beforeremoveitem","removeitem","clear")},Ext.ux.form.SuperBoxSelect=Ext.extend(Ext.ux.form.SuperBoxSelect,Ext.form.ComboBox,{allowAddNewData:!1,backspaceDeletesLastItem:!0,classField:null,clearBtnCls:"",displayFieldTpl:null,extraItemCls:"",extraItemStyle:"",expandBtnCls:"",fixFocusOnTabSelect:!0,forceFormValue:!0,itemDelimiterKey:Ext.EventObject.ENTER,navigateItemsWithTab:!0,pinList:!0,preventDuplicates:!0,queryValuesDelimiter:"|",queryValuesIndicator:"valuesqry",removeValuesFromStore:!0,renderFieldBtns:!0,stackItems:!1,styleField:null,supressClearValueRemoveEvents:!1,validationEvent:"blur",valueDelimiter:",",initComponent:function(){Ext.apply(this,{items:new Ext.util.MixedCollection(!1),usedRecords:new Ext.util.MixedCollection(!1),addedRecords:[],remoteLookup:[],hideTrigger:!0,grow:!1,resizable:!1,multiSelectMode:!1,preRenderValue:null,renderFieldBtns:!1,typeAhead:!1,pinList:!1,emptyText:__("(empty)"),forceSelection:!1,remote:!0}),this.transform&&this.doTransform(),this.forceFormValue&&this.items.on({add:this.manageNameAttribute,remove:this.manageNameAttribute,clear:this.manageNameAttribute,scope:this}),Ext.ux.form.SuperBoxSelect.superclass.initComponent.call(this),"remote"===this.mode&&this.store&&this.store.on("load",this.onStoreLoad,this),this.on({beforequery:function(a){if(""==a.query)return!1;var b={},c=this.displayField;b[c+" like"]="%"+a.query+"%",Ext.apply(a,{forceAll:!0,query:{or:b}})},scope:this}),Garp.eventManager.on({selectionchange:{scope:this,fn:this.onSelectionChange,buffer:400},"save-all":{fn:this.relate,scope:this}}),this.store=new Ext.data.DirectStore({autoLoad:!1,autoSave:!1,batch:!0,pruneModifiedRecords:!0,remoteSort:!1,restful:!1,autoDestroy:!0,root:"rows",idProperty:"id",fields:Garp.dataTypes[this.model].getStoreFieldsFromColumnModel(),totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo,baseParams:{start:0,limit:Garp.pageSize},api:{create:Ext.emptyFn,read:Garp[this.model].fetch||Ext.emptyFn,update:Ext.emptyFn,destroy:Ext.emptyFn}})},getParentForm:function(){return this.findParentBy(function(a){return a.getForm})},onSelectionChange:function(){this.clearValue(),this.clearInvalid(),this.disable(),this.suspendEvents();var a=this.getParentForm().getForm().findField("id").getValue(),b={};b[this.rule+".id"]=a,Garp[this.model].fetch({rule:this.rule,query:b},function(a){a.rows.length?Ext.each(a.rows,function(a){this.addRecord(this.createRecord(a))},this):this.applyEmptyText(),this.originalValue=this.getValue(),this.resumeEvents(),this.enable()},this)},relate:function(){this.getParentForm().getForm().findField("id").getValue()&&(this.items.length||this.isDirty())&&Garp[Garp.currentModel].relate({model:this.model,rule:this.rule,unrelateExisting:!0,primaryKey:this.getParentForm().getForm().findField("id").getValue(),foreignKeys:function(){var a=[];return this.items.each(function(b){a.push({key:b.value})}),a}.call(this)},this.onSelectionChange,this)},onRender:function(a,b){var c=this.hiddenName;this.hiddenName=null,Ext.ux.form.SuperBoxSelect.superclass.onRender.call(this,a,b),this.hiddenName=c,this.manageNameAttribute();var d=this.stackItems===!0?"x-superboxselect-stacked":"";this.renderFieldBtns&&(d+=" x-superboxselect-display-btns"),this.el.removeClass("x-form-text").addClass("x-superboxselect-input-field"),this.wrapEl=this.el.wrap({tag:"ul"}),this.outerWrapEl=this.wrapEl.wrap({tag:"div",cls:"x-form-text x-superboxselect "+d}),this.inputEl=this.el.wrap({tag:"li",cls:"x-superboxselect-input"}),this.renderFieldBtns&&this.setupFieldButtons().manageClearBtn(),this.setupFormInterception()},onStoreLoad:function(a,b,c){var d=c.params[this.queryParam]||a.baseParams[this.queryParam]||"",e=c.params[this.queryValuesIndicator]||a.baseParams[this.queryValuesIndicator];if(d&&d.or&&(d=d.or["name like"]),this.removeValuesFromStore&&this.store.each(function(a){this.usedRecords.containsKey(a.get(this.valueField))&&this.store.remove(a)},this),e){var f=d.split(this.queryValuesDelimiter);Ext.each(f,function(a){this.remoteLookup.remove(a);var b=this.findRecord(this.valueField,a);b&&this.addRecord(b)},this),this.setOriginal&&(this.setOriginal=!1,this.originalValue=this.getValue())}""!==d&&this.allowAddNewData&&Ext.each(this.remoteLookup,function(a){if("object"==typeof a&&a[this.displayField]==d){if(this.remoteLookup.remove(a),b.length&&b[0].get(this.displayField)===d)return void this.addRecord(b[0]);var c=this.createRecord(a);return this.store.add(c),this.addRecord(c),this.addedRecords.push(c),void function(){this.isExpanded()&&this.collapse()}.defer(10,this)}},this);var g=[];if(""===d)Ext.each(this.addedRecords,function(a){this.preventDuplicates&&this.usedRecords.containsKey(a.get(this.valueField))||g.push(a)},this);else{var h=new RegExp(Ext.escapeRe(d)+".*","i");Ext.each(this.addedRecords,function(a){this.preventDuplicates&&this.usedRecords.containsKey(a.get(this.valueField))||h.test(a.get(this.displayField))&&g.push(a)},this)}this.store.add(g),this.store.sort(this.displayField,"ASC"),0===this.store.getCount()&&this.isExpanded()&&this.collapse()},doTransform:function(){var a=Ext.getDom(this.transform),b=[];if(!this.store){this.mode="local";for(var c=[],d=a.options,e=0,f=d.length;f>e;e++){var g=d[e],h=Ext.get(g),i=h.getAttributeNS(null,"value")||"",j=h.getAttributeNS(null,"className")||"",k=h.getAttributeNS(null,"style")||"";g.selected&&b.push(i),c.push([i,g.text,j,"string"==typeof k?k:k.cssText])}this.store=new Ext.data.SimpleStore({id:0,fields:["value","text","cls","style"],data:c}),Ext.apply(this,{valueField:"value",displayField:"text",classField:"cls",styleField:"style"})}b.length&&(this.value=b.join(","))},setupFieldButtons:function(){return this.buttonWrap=this.outerWrapEl.createChild({cls:"x-superboxselect-btns"}),this.buttonClear=this.buttonWrap.createChild({tag:"div",cls:"x-superboxselect-btn-clear "+this.clearBtnCls}),this.buttonExpand=this.buttonWrap.createChild({tag:"div",cls:"x-superboxselect-btn-expand "+this.expandBtnCls}),this.initButtonEvents(),this},initButtonEvents:function(){this.buttonClear.addClassOnOver("x-superboxselect-btn-over").on("click",function(a){a.stopEvent(),this.disabled||(this.clearValue(),this.el.focus())},this),this.buttonExpand.addClassOnOver("x-superboxselect-btn-over").on("click",function(a){a.stopEvent(),this.disabled||(this.isExpanded()?this.multiSelectMode=!1:this.pinList&&(this.multiSelectMode=!0),this.onTriggerClick())},this)},removeButtonEvents:function(){return this.buttonClear.removeAllListeners(),this.buttonExpand.removeAllListeners(),this},clearCurrentFocus:function(){return this.currentFocus&&(this.currentFocus.onLnkBlur(),this.currentFocus=null),this},initEvents:function(){var a=this.el;a.on({click:this.onClick,focus:this.clearCurrentFocus,blur:this.onBlur,keydown:this.onKeyDownHandler,keyup:this.onKeyUpBuffered,scope:this}),this.on({collapse:this.onCollapse,expand:this.clearCurrentFocus,scope:this}),this.wrapEl.on("click",this.onWrapClick,this),this.outerWrapEl.on("click",this.onWrapClick,this),this.inputEl.focus=function(){a.focus()},Ext.ux.form.SuperBoxSelect.superclass.initEvents.call(this),Ext.apply(this.keyNav,{tab:function(b){return this.fixFocusOnTabSelect&&this.isExpanded()?(b.stopEvent(),a.blur(),this.onViewClick(!1),this.focus(!1,10),!0):(this.onViewClick(!1),""!==a.dom.value&&this.setRawValue(""),!0)},down:function(){this.isExpanded()||this.currentFocus?(this.inKeyMode=!0,this.selectNext()):this.onTriggerClick()},enter:function(){}})},onClick:function(){this.clearCurrentFocus(),this.collapse(),this.autoSize()},beforeBlur:Ext.form.ComboBox.superclass.beforeBlur,onFocus:function(){this.outerWrapEl.addClass(this.focusClass),Ext.ux.form.SuperBoxSelect.superclass.onFocus.call(this)},onBlur:function(){this.outerWrapEl.removeClass(this.focusClass),this.clearCurrentFocus(),""!==this.el.dom.value&&(this.applyEmptyText(),this.autoSize()),Ext.ux.form.SuperBoxSelect.superclass.onBlur.call(this)},onCollapse:function(){this.view.clearSelections(),this.multiSelectMode=!1},onWrapClick:function(a){a.stopEvent(),this.collapse(),this.el.focus(),this.clearCurrentFocus()},markInvalid:function(a){var b,c;if(this.rendered&&!this.preventMark){switch(this.outerWrapEl.addClass(this.invalidClass),a=a||this.invalidText,this.msgTarget){case"qtip":Ext.apply(this.el.dom,{qtip:a,qclass:"x-form-invalid-tip"}),Ext.apply(this.wrapEl.dom,{qtip:a,qclass:"x-form-invalid-tip"}),Ext.QuickTips&&Ext.QuickTips.enable();break;case"title":this.el.dom.title=a,this.wrapEl.dom.title=a,this.outerWrapEl.dom.title=a;break;case"under":if(!this.errorEl){if(b=this.getErrorCt(),!b){this.el.dom.title=a;break}this.errorEl=b.createChild({cls:"x-form-invalid-msg"}),this.errorEl.setWidth(b.getWidth(!0)-20)}this.errorEl.update(a),Ext.form.Field.msgFx[this.msgFx].show(this.errorEl,this);break;case"side":if(!this.errorIcon){if(b=this.getErrorCt(),!b){this.el.dom.title=a;break}this.errorIcon=b.createChild({cls:"x-form-invalid-icon"})}this.alignErrorIcon(),Ext.apply(this.errorIcon.dom,{qtip:a,qclass:"x-form-invalid-tip"}),this.errorIcon.show(),this.on("resize",this.alignErrorIcon,this);break;default:c=Ext.getDom(this.msgTarget),c.innerHTML=a,c.style.display=this.msgDisplay}this.fireEvent("invalid",this,a)}},clearInvalid:function(){if(this.rendered&&!this.preventMark){switch(this.outerWrapEl.removeClass(this.invalidClass),this.msgTarget){case"qtip":this.el.dom.qtip="",this.wrapEl.dom.qtip="";break;case"title":this.el.dom.title="",this.wrapEl.dom.title="",this.outerWrapEl.dom.title="";break;case"under":this.errorEl&&Ext.form.Field.msgFx[this.msgFx].hide(this.errorEl,this);break;case"side":this.errorIcon&&(this.errorIcon.dom.qtip="",this.errorIcon.hide(),this.un("resize",this.alignErrorIcon,this));break;default:var a=Ext.getDom(this.msgTarget);a.innerHTML="",a.style.display="none"}this.fireEvent("valid",this)}},alignErrorIcon:function(){this.wrap&&this.errorIcon.alignTo(this.wrap,"tl-tr",[Ext.isIE?5:2,3])},expand:function(){!this.isExpanded()&&this.hasFocus&&(this.list.alignTo(this.outerWrapEl,this.listAlign).show(),this.innerList.setOverflow("auto"),Ext.getDoc().on({mousewheel:this.collapseIf,mousedown:this.collapseIf,scope:this}),this.fireEvent("expand",this))},restrictHeight:function(){var a=this.innerList.dom,b=a.scrollTop,c=this.list;a.style.height="";var d=c.getFrameWidth("tb")+(this.resizable?this.handleHeight:0)+this.assetHeight,e=Math.max(a.clientHeight,a.offsetHeight,a.scrollHeight),f=this.getPosition()[1]-Ext.getBody().getScroll().top,g=Ext.lib.Dom.getViewHeight()-f-this.getSize().height,h=Math.max(f,g,this.minHeight||0)-c.shadowOffset-d-5;e=Math.min(e,h,this.maxHeight),this.innerList.setHeight(e),c.beginUpdate(),c.setHeight(e+d),c.alignTo(this.outerWrapEl,this.listAlign),c.endUpdate(),this.multiSelectMode&&(a.scrollTop=b)},validateValue:function(){return 0===this.items.getCount()?this.allowBlank?(this.clearInvalid(),!0):(this.markInvalid(this.blankText),!1):(this.clearInvalid(),!0)},manageNameAttribute:function(){0===this.items.getCount()&&this.forceFormValue?this.el.dom.setAttribute("name",this.hiddenName||this.name):this.el.dom.removeAttribute("name")},setupFormInterception:function(){var a=this.getParentForm().form;if(a){var b=a.getValues;a.getValues=function(c){this.el.dom.disabled=!0;var d=this.el.dom.value;this.setRawValue("");var e=b.call(a);return this.el.dom.disabled=!1,this.setRawValue(d),this.forceFormValue&&0===this.items.getCount()&&(e[this.name]=""),c?Ext.urlEncode(e):e}.createDelegate(this)}},onResize:function(a,b,c,d){var e=Ext.isIE6?4:Ext.isIE7?1:Ext.isIE8?1:0;this.wrapEl&&(this._width=a,this.outerWrapEl.setWidth(a-e),this.renderFieldBtns&&(e+=this.buttonWrap.getWidth()+20,this.wrapEl.setWidth(a-e))),Ext.ux.form.SuperBoxSelect.superclass.onResize.call(this,a,b,c,d),this.autoSize()},onEnable:function(){Ext.ux.form.SuperBoxSelect.superclass.onEnable.call(this),this.items.each(function(a){a.enable()}),this.renderFieldBtns&&this.initButtonEvents()},onDisable:function(){Ext.ux.form.SuperBoxSelect.superclass.onDisable.call(this),this.items.each(function(a){a.disable()}),this.renderFieldBtns&&this.removeButtonEvents()},clearValue:function(a){return Ext.ux.form.SuperBoxSelect.superclass.clearValue.call(this),this.preventMultipleRemoveEvents=a||this.supressClearValueRemoveEvents||!1,this.removeAllItems(),this.preventMultipleRemoveEvents=!1,this.fireEvent("clear",this),this},onKeyUp:function(a){this.editable===!1||a.isSpecialKey()&&a.getKey()!==a.BACKSPACE||a.getKey()===this.itemDelimiterKey||a.hasModifier()&&!a.shiftKey||(this.lastKey=a.getKey(),this.dqTask.delay(this.queryDelay))},onKeyDownHandler:function(a){var b,c,d;if((a.getKey()===a.DELETE||a.getKey()===a.SPACE)&&this.currentFocus)return a.stopEvent(),b=this.currentFocus,this.on("expand",function(){this.collapse()},this,{single:!0}),d=this.items.indexOfKey(this.currentFocus.key),this.clearCurrentFocus(),d<this.items.getCount()-1&&(c=this.items.itemAt(d+1)),b.preDestroy(!0),c&&function(){c.onLnkFocus(),this.currentFocus=c}.defer(200,this),!0;var e,f=this.el.dom.value,g=a.ctrlKey;if(a.getKey()===this.itemDelimiterKey){if(a.stopEvent(),""!==f)g||!this.isExpanded()?(this.view.clearSelections(),this.collapse(),this.setRawValue(""),this.fireEvent("newitem",this,f)):(this.onViewClick(),this.unsetDelayCheck&&(this.delayedCheck=!0,this.unsetDelayCheck.defer(10,this)));else{if(!this.isExpanded())return;this.onViewClick(),this.unsetDelayCheck&&(this.delayedCheck=!0,this.unsetDelayCheck.defer(10,this))}return!0}return""!==f?void this.autoSize():a.getKey()===a.HOME?(a.stopEvent(),this.items.getCount()>0&&(this.collapse(),e=this.items.get(0),e.el.focus()),!0):a.getKey()===a.BACKSPACE?(a.stopEvent(),this.currentFocus?(b=this.currentFocus,this.on("expand",function(){this.collapse()},this,{single:!0}),d=this.items.indexOfKey(b.key),this.clearCurrentFocus(),d<this.items.getCount()-1&&(c=this.items.itemAt(d+1)),b.preDestroy(!0),void(c&&function(){c.onLnkFocus(),this.currentFocus=c}.defer(200,this))):(e=this.items.get(this.items.getCount()-1),e&&(this.backspaceDeletesLastItem?(this.on("expand",function(){this.collapse()},this,{single:!0}),e.preDestroy(!0)):this.navigateItemsWithTab?e.onElClick():this.on("expand",function(){this.collapse(),this.currentFocus=e,this.currentFocus.onLnkFocus.defer(20,this.currentFocus)},this,{single:!0})),!0)):a.isNavKeyPress()?a.getKey()===a.LEFT||a.getKey()===a.UP&&!this.isExpanded()?(a.stopEvent(),this.collapse(),e=this.items.get(this.items.getCount()-1),this.navigateItemsWithTab?e&&e.focus():this.currentFocus?(d=this.items.indexOfKey(this.currentFocus.key),this.clearCurrentFocus(),0!==d&&(this.currentFocus=this.items.itemAt(d-1),this.currentFocus.onLnkFocus())):(this.currentFocus=e,e&&e.onLnkFocus()),!0):a.getKey()===a.DOWN&&this.currentFocus?(this.collapse(),a.stopEvent(),d=this.items.indexOfKey(this.currentFocus.key),d==this.items.getCount()-1?this.clearCurrentFocus.defer(10,this):(this.clearCurrentFocus(),this.currentFocus=this.items.itemAt(d+1),this.currentFocus&&this.currentFocus.onLnkFocus()),!0):void(a.getKey()===a.RIGHT&&(this.collapse(),e=this.items.itemAt(0),this.navigateItemsWithTab?e&&e.focus():this.currentFocus?(d=this.items.indexOfKey(this.currentFocus.key),this.clearCurrentFocus(),d<this.items.getCount()-1&&(this.currentFocus=this.items.itemAt(d+1),this.currentFocus&&this.currentFocus.onLnkFocus())):(this.currentFocus=e,e&&e.onLnkFocus()))):(this.multiSelectMode=!1,void this.clearCurrentFocus())},onKeyUpBuffered:function(a){a.isNavKeyPress()||this.autoSize()},reset:function(){this.killItems(),Ext.ux.form.SuperBoxSelect.superclass.reset.call(this),this.addedRecords=[],this.autoSize().setRawValue("")},applyEmptyText:function(){return this.setRawValue(""),this.items.getCount()>0?(this.el.removeClass(this.emptyClass),this.setRawValue(""),this):(this.rendered&&this.emptyText&&this.getRawValue().length<1&&(this.setRawValue(this.emptyText),this.el.addClass(this.emptyClass)),this)},removeAllItems:function(){return this.items.each(function(a){a.preDestroy(!0)},this),this.manageClearBtn(),this},killItems:function(){return this.items.each(function(a){a.kill()},this),this.resetStore(),this.items.clear(),this.manageClearBtn(),this},resetStore:function(){return this.store.clearFilter(),this.removeValuesFromStore?(this.usedRecords.each(function(a){this.store.add(a)},this),this.usedRecords.clear(),this.sortStore(),this):this},sortStore:function(){var a=this.store.getSortState();return a&&a.field&&this.store.sort(a.field,a.direction),this},getCaption:function(a){"string"==typeof this.displayFieldTpl&&(this.displayFieldTpl=new Ext.XTemplate(this.displayFieldTpl));var b,c=a instanceof Ext.data.Record?a.data:a;return this.displayFieldTpl?b=this.displayFieldTpl.apply(c):this.displayField&&(b=c[this.displayField]),b},addRecord:function(a){var b=a.data[this.displayField],c=this.getCaption(a),d=a.data[this.valueField],e=this.classField?a.data[this.classField]:"",f=this.styleField?a.data[this.styleField]:"";this.removeValuesFromStore&&(this.usedRecords.add(d,a),this.store.remove(a)),this.addItemBox(d,b,c,e,f),this.fireEvent("additem",this,d,a)},createRecord:function(a){if(!this.recordConstructor){var b=[{name:this.valueField},{name:this.displayField}];this.classField&&b.push({name:this.classField}),this.styleField&&b.push({name:this.styleField}),this.recordConstructor=Ext.data.Record.create(b)}return new this.recordConstructor(a)},addItems:function(a){Ext.isArray(a)?Ext.each(a,function(a){this.addItem(a)},this):this.addItem(a)},addNewItem:function(a){this.addItem(a,!0)},addItem:function(a,b){var c=a[this.valueField];if(this.disabled)return!1;if(!this.preventDuplicates||!this.hasValue(c)){var d=this.findRecord(this.valueField,c);if(d)return void this.addRecord(d);if(this.allowAddNewData){if("remote"===this.mode)return this.remoteLookup.push(a),void this.doQuery(c,!1,!1,b);var e=this.createRecord(a);return this.store.add(e),this.addRecord(e),!0}}},addItemBox:function(a,b,c,d,e){var f,g=function(a){var b="";if("function"==typeof a)b=a.call();else if("object"==typeof a)for(var c in a)b+=c+":"+a[c]+";";else"string"==typeof a&&(b=a+";");return b},h=Ext.id(null,"sbx-item"),i=new Ext.ux.form.SuperBoxSelectItem({owner:this,disabled:this.disabled,renderTo:this.wrapEl,cls:this.extraItemCls+" "+d,style:g(this.extraItemStyle)+" "+e,caption:c,display:b,value:a,key:h,listeners:{remove:function(a){this.fireEvent("beforeremoveitem",this,a.value)!==!1&&(this.items.removeKey(a.key),this.removeValuesFromStore&&this.usedRecords.containsKey(a.value)&&(this.store.add(this.usedRecords.get(a.value)),this.usedRecords.removeKey(a.value),this.sortStore(),this.view&&this.view.render()),this.preventMultipleRemoveEvents||this.fireEvent.defer(250,this,["removeitem",this,a.value,this.findInStore(a.value)]))},destroy:function(){this.collapse(),this.autoSize().manageClearBtn().validateValue()},scope:this}});i.render(),f={tag:"input",type:"hidden",value:a,name:this.hiddenName||this.name},this.disabled&&Ext.apply(f,{disabled:"disabled"}),i.hidden=this.el.insertSibling(f,"before"),this.items.add(h,i),this.applyEmptyText().autoSize().manageClearBtn().validateValue()},manageClearBtn:function(){if(!this.renderFieldBtns||!this.rendered)return this;var a="x-superboxselect-btn-hide";return 0===this.items.getCount()?this.buttonClear.addClass(a):this.buttonClear.removeClass(a),this},findInStore:function(a){var b=this.store.find(this.valueField,a);return b>-1?this.store.getAt(b):!1},getValue:function(){var a=[];return this.items.each(function(b){a.push(b.value)}),a.join(this.valueDelimiter)},getValueEx:function(){var a=[];return this.items.each(function(b){var c={};c[this.valueField]=b.value,c[this.displayField]=b.display,this.classField&&(c[this.classField]=b.cls||""),this.styleField&&(c[this.styleField]=b.style||""),a.push(c)},this),a},initValue:function(){Ext.ux.form.SuperBoxSelect.superclass.initValue.call(this),"remote"===this.mode&&(this.setOriginal=!0)},setValue:function(a){if(!this.rendered)return void(this.value=a);if(this.removeAllItems().resetStore(),this.remoteLookup=[],!Ext.isEmpty(a)){var b=a;if(Ext.isArray(a)||(a=""+a,b=a.split(this.valueDelimiter)),Ext.each(b,function(a){var b=this.findRecord(this.valueField,a);b?this.addRecord(b):"remote"===this.mode&&this.remoteLookup.push(a)},this),"remote"===this.mode){var c=this.remoteLookup.join(this.queryValuesDelimiter);this.doQuery(c,!1,!0)}}},setValueEx:function(a){return this.removeAllItems().resetStore(),Ext.isArray(a)||(a=[a]),this.remoteLookup=[],this.allowAddNewData&&"remote"===this.mode?void Ext.each(a,function(a){var b=this.findRecord(this.valueField,a[this.valueField])||this.createRecord(a);this.addRecord(b)},this):void Ext.each(a,function(a){this.addItem(a)},this)},hasValue:function(a){var b=!1;return this.items.each(function(c){return c.value==a?(b=!0,!1):void 0},this),b},onSelect:function(a,b){if(this.fireEvent("beforeselect",this,a,b)!==!1){var c=a.data[this.valueField];if(this.preventDuplicates&&this.hasValue(c))return;this.setRawValue(""),this.lastSelectionText="",this.fireEvent("beforeadditem",this,c)!==!1&&this.addRecord(a),0!==this.store.getCount()&&this.multiSelectMode?this.restrictHeight():this.collapse()}},onDestroy:function(){this.items.purgeListeners(),this.killItems(),this.renderFieldBtns&&Ext.destroy(this.buttonClear,this.buttonExpand,this.buttonWrap),Ext.destroy(this.inputEl,this.wrapEl,this.outerWrapEl),Ext.ux.form.SuperBoxSelect.superclass.onDestroy.call(this)},autoSize:function(){if(!this.rendered)return this;this.metrics||(this.metrics=Ext.util.TextMetrics.createInstance(this.el));var a=this.el,b=a.dom.value,c=document.createElement("div");""===b&&this.emptyText&&this.items.getCount()<1&&(b=this.emptyText),c.appendChild(document.createTextNode(b)),b=c.innerHTML,c=null,b+="&#160;";var d=Math.max(this.metrics.getWidth(b)+24,24);return"undefined"!=typeof this._width&&(d=Math.min(this._width,d)),this.el.setWidth(d),Ext.isIE&&(this.el.dom.style.top="0"),this},doQuery:function(a,b,c,d){a=Ext.isEmpty(a)?"":a;var e={query:a,forceAll:b,combo:this,cancel:!1};return this.fireEvent("beforequery",e)===!1||e.cancel?!1:(a=e.query,b=e.forceAll,void((b===!0||a.length>=this.minChars||c&&!Ext.isEmpty(a))&&(this.lastQuery!==a||d?(this.lastQuery=a,"local"==this.mode?(this.selectedIndex=-1,b?this.store.clearFilter():this.store.filter(this.displayField,a),this.onLoad()):(this.store.baseParams[this.queryParam]=a,this.store.baseParams[this.queryValuesIndicator]=c,this.store.load({params:this.getParams(a)}),d||this.expand())):(this.selectedIndex=-1,this.onLoad()))))}}),Ext.reg("superboxselect",Ext.ux.form.SuperBoxSelect),Ext.ux.form.SuperBoxSelectItem=function(a){Ext.apply(this,a),Ext.ux.form.SuperBoxSelectItem.superclass.constructor.call(this)},Ext.ux.form.SuperBoxSelectItem=Ext.extend(Ext.ux.form.SuperBoxSelectItem,Ext.Component,{initComponent:function(){Ext.ux.form.SuperBoxSelectItem.superclass.initComponent.call(this)},onElClick:function(){var a=this.owner;if(a.clearCurrentFocus().collapse(),a.navigateItemsWithTab)this.focus();else{a.el.dom.focus();(function(){this.onLnkFocus(),a.currentFocus=this}).defer(10,this)}},onLnkClick:function(a){a&&a.stopEvent(),this.preDestroy(),this.owner.navigateItemsWithTab||this.owner.el.focus()},onLnkFocus:function(){this.el.addClass("x-superboxselect-item-focus"),this.owner.outerWrapEl.addClass("x-form-focus")},onLnkBlur:function(){this.el.removeClass("x-superboxselect-item-focus"),this.owner.outerWrapEl.removeClass("x-form-focus")},enableElListeners:function(){this.el.on("click",this.onElClick,this,{stopEvent:!0}),this.el.addClassOnOver("x-superboxselect-item x-superboxselect-item-hover"),this.el.on("mouseout",function(){this.el.removeClass("x-superboxselect-item-hover")},this)},enableLnkListeners:function(){this.lnk.on({click:this.onLnkClick,focus:this.onLnkFocus,blur:this.onLnkBlur,scope:this})},enableAllListeners:function(){this.enableElListeners(),this.enableLnkListeners()},disableAllListeners:function(){this.el.removeAllListeners(),this.lnk.un("click",this.onLnkClick,this),this.lnk.un("focus",this.onLnkFocus,this),this.lnk.un("blur",this.onLnkBlur,this)},onRender:function(a,b){Ext.ux.form.SuperBoxSelectItem.superclass.onRender.call(this,a,b);var c=this.el;c&&c.remove(),this.el=c=a.createChild({tag:"li"},a.last()),c.addClass("x-superboxselect-item");{var d=this.owner.navigateItemsWithTab?Ext.isSafari?"button":"a":"span";this.key}Ext.apply(c,{focus:function(){var a=this.down(d+".x-superboxselect-item-close");a&&a.focus()},preDestroy:function(){this.preDestroy()}.createDelegate(this)}),this.enableElListeners(),c.update(this.caption);var e={tag:d,"class":"x-superboxselect-item-close",tabIndex:this.owner.navigateItemsWithTab?"0":"-1"};"a"===d&&(e.href="#"),this.lnk=c.createChild(e),this.disabled?this.disableAllListeners():this.enableLnkListeners(),this.on({disable:this.disableAllListeners,enable:this.enableAllListeners,scope:this}),this.setupKeyMap()},setupKeyMap:function(){this.keyMap=new Ext.KeyMap(this.lnk,[{key:[Ext.EventObject.BACKSPACE,Ext.EventObject.DELETE,Ext.EventObject.SPACE],fn:this.preDestroy,scope:this},{key:[Ext.EventObject.RIGHT,Ext.EventObject.DOWN],fn:function(){this.moveFocus("right")},scope:this},{key:[Ext.EventObject.LEFT,Ext.EventObject.UP],fn:function(){this.moveFocus("left")},scope:this},{key:[Ext.EventObject.HOME],fn:function(){var a=this.owner.items.get(0).el.focus();a&&a.el.focus()},scope:this},{key:[Ext.EventObject.END],fn:function(){this.owner.el.focus()},scope:this},{key:Ext.EventObject.ENTER,fn:function(){}}]),this.keyMap.stopEvent=!0},moveFocus:function(a){var b=this.el["left"==a?"prev":"next"]()||this.owner.el;b.focus.defer(100,b)},preDestroy:function(a){if(this.fireEvent("remove",this)!==!1){var b=function(){this.owner.navigateItemsWithTab&&this.moveFocus("right"),this.hidden.remove(),this.hidden=null,this.destroy()};return a?b.call(this):this.el.hide({duration:.2,callback:b,scope:this}),this}},kill:function(){this.hidden.remove(),this.hidden=null,this.purgeListeners(),this.destroy()},onDisable:function(){this.hidden&&this.hidden.dom.setAttribute("disabled","disabled"),this.keyMap.disable(),Ext.ux.form.SuperBoxSelectItem.superclass.onDisable.call(this)},onEnable:function(){this.hidden&&this.hidden.dom.removeAttribute("disabled"),this.keyMap.enable(),Ext.ux.form.SuperBoxSelectItem.superclass.onEnable.call(this)},onDestroy:function(){Ext.destroy(this.lnk,this.el),Ext.ux.form.SuperBoxSelectItem.superclass.onDestroy.call(this)}}),Ext.ns("Garp"),Garp.MetaPanel=Ext.extend(Ext.Container,{disablePublishedEdit:!1,disableCreatedEdit:!1,disableAuthorIdEdit:!1,region:"east",width:190,maxWidth:190,header:!1,border:!1,cls:"garp-metapanel",ref:"metaPanel",monitorValid:!1,processData:function(a){this.rec=a,this.update(a.data),this.bindEditors(),Ext.get("author-name").update(a.get("author")),Ext.get("modifier-name").update(a.get("modifier"))
},buildTplItem:function(a){if(Ext.isObject(a))return a.tpl||"";var b="";return b+="<h3>"+__(a)+"</h3>",b+="<p>{"+a+"}</p>"},buildTpl:function(){var a=Garp.dataTypes[Garp.currentModel].metaPanelItems,b=[];Ext.each(a,function(a){switch(a){case"created":b.push("<h3>",__("Created"),"</h3>",'<span id="author-image"></span>','<a id="author-name"></a>','<a id="created-date">{[Garp.renderers.metaPanelDateRenderer(values.created)]}</a>');break;case"modified":b.push("<h3>",__("Modified"),"</h3>",'<span id="modifier-image"></span>','<p id="modifier-name"></p>','<p id="modified-date">{[Garp.renderers.metaPanelDateRenderer(values.modified)]}</p>');break;case"published":b.push("<h3>",__("Published"),"</h3>",'<tpl if="typeof online_status !== &quot;undefined&quot;  && online_status === &quot;1&quot;">',this.disablePublishedEdit?'<span class="published-date">{[Garp.renderers.metaPanelDateRenderer(values.published)]}</span>':['<a class="published-date">{[Garp.renderers.metaPanelDateRenderer(values.published)]}</a>','<tpl if="values.published">',' <a class="remove-published-date" title="',__("Delete"),'"> </a>',"</tpl>"].join(""),"</tpl>",'<div id="online-status">',__("Draft"),": ",'<tpl if="typeof online_status !== &quot;undefined&quot; && online_status == &quot;1&quot;">','<input type="checkbox">',"</tpl>",'<tpl if="typeof online_status !== &quot;undefined&quot;  && (!online_status || online_status === &quot;0&quot;) ">','<input type="checkbox" checked>',"</tpl></div>");break;default:b.push(this.buildTplItem(a))}},this),b.push('<div class="copyright">',"Garp &copy {[Garp.renderers.yearRenderer(new Date())]} by ",'<a href="http://grrr.nl/" target="_blank">',"Grrr","</a><br>version 3.5.{[GARP_VERSION]}","</div>"),this.tpl=new Ext.XTemplate(b,{compiled:!0})},setVal:function(a,b){var c=Garp.gridPanel.getSelectionModel().getSelected();c.get("name")!=b&&(this.fireEvent("dirty"),c.beginEdit(),c.set(a,b),c.endEdit(),c.phantom||(this.disable(),this.fireEvent("save-all")))},bindEditors:function(){this.el.select("#author-name").un("click").on("click",function(a,b){this.disableAuthorIdEdit||(this.authorIdEditor.startEdit(b,this.rec.get("author_id")),this.authorIdEditor.field.triggerFn(),this.authorIdEditor.el.hide())},this),this.el.select("#online-status input").un("click").on("click",function(a,b){this.setVal("online_status",Ext.get(b).getAttribute("checked")?"0":"1",!0)},this),this.el.select("#created-date").un("click").on("click",function(a,b){this.disableCreatedEdit||(this.createdDateEditor.startEdit(b,this.rec.get("created")),this.createdDateEditor.field.df.onTriggerClick())},this),this.el.select(".published-date").un("click").on("click",function(a,b){this.disablePublishedEdit||(this.publishedDateEditor.startEdit(b,this.rec.get("published")),this.publishedDateEditor.field.df.onTriggerClick())},this),this.el.select(".remove-published-date").un("click").on("click",function(){this.setVal("published",null)},this)},buildEditors:function(){var a={field:{xtype:"xdatetime",width:180,emptyText:__("No date specified"),timeConfig:{increment:30},dateConfig:{emptyText:__("No date specified")},timeWidth:60,dateFormat:"j M Y"},offsets:[0,-6],alignment:"tl?",completeOnEnter:!0,cancelOnEsc:!0,updateEl:!1,ignoreNoChange:!0};this.authorIdEditor=new Ext.Editor(Ext.apply({},{disabled:this.disableAuthorIdEdit,field:{xtype:"relationfield",model:"User",displayField:"fullname",listeners:{select:function(a){a&&a.selected&&this.setVal("author_id",a.selected.id),this.authorIdEditor.completeEdit()},scope:this}}},a)),this.createdDateEditor=new Ext.Editor(Ext.apply({},{disabled:this.disableCreatedEdit,listeners:{beforecomplete:function(a,b){b&&this.setVal("created",b)},scope:this}},a)),this.publishedDateEditor=new Ext.Editor(Ext.apply({},{disabled:this.disablePublishedEdit,listeners:{beforecomplete:function(a,b){b&&this.setVal("published",b)},scope:this}},a))},initComponent:function(a){this.buildTpl(),this.buildEditors(),Garp.MetaPanel.superclass.initComponent.call(this,a),this.on({loaddata:{fn:this.processData,scope:this}})}}),Garp.ModelMenu=function(a){Ext.apply(this,a);var b=[];for(var c in Garp.dataTypes)-1==this.menuItems.indexOf(c)&&this.menuItems.push(c);b.push(function(){var a=[];return Ext.each(this.menuItems,function(b){if("-"==b&&a.length>0&&"-"!=a[a.length-1])a.push("-");else{if(!Garp.dataTypes[b])throw'Oops! JS model "'+b+'" not found! Is it spawned and bugfree?';var c=Garp.dataTypes[b];if(!Garp[b])throw'Oops! dataType "'+b+'" not found! Does it exist in the smd?';c.setupACL(Garp[b])?(c.fireEvent("init"),a.push({hidden:c.hidden,text:__(c.text),name:c.text,iconCls:c.iconCls,handler:function(){Garp.viewport.formPanelCt.show(),Garp.viewport.gridPanelCt.expand(),Garp.eventManager.fireEvent("modelchange",!0,b,null,null)}})):delete Garp.dataTypes[c.text]}}),a}.call(this)),Garp.ModelMenu.superclass.constructor.call(this,Ext.applyIf(a,{cls:"garp-model-menu",text:__("Content"),iconCls:"icon-no-model",menu:new Ext.menu.Menu({items:b})})),this.on("afterrender",function(){this.getEl().on("click",function(){Garp.viewport.gridPanelCt.expand()})},this)},Ext.extend(Garp.ModelMenu,Ext.Button,{}),Garp.WelcomePanel=function(a){this.html=Ext.getDom("welcome-panel-content").innerHTML,Garp.WelcomePanel.superclass.constructor.call(this,a)},Ext.extend(Garp.WelcomePanel,Ext.Container,{border:!0}),Garp.GridPanel=Ext.extend(Ext.grid.GridPanel,{loadMask:!0,model:null,newItem:function(){if(!this.disabled&&!Garp.dataTypes[Garp.currentModel].disableCreate){var a=new this.store.recordType(Ext.apply({},Garp.dataTypes[this.model].defaultData));this.store.insert(0,a),this.getSelectionModel().selectFirstRow()}},deleteItems:function(){var a=this.getSelectionModel().getCount();if(!(0>=a)){var b=this.getSelectionModel().getSelected();return b.phantom?(this.store.remove(b),this.getSelectionModel().clearSelections(),void this.fireEvent("afterdelete")):void(this.disabled||Garp.dataTypes[Garp.currentModel].disableDelete||Ext.Msg.confirm(__("Garp"),__(1==a?"Are you sure you want to delete the selected item?":"Are you sure you want to delete the selected items?"),function(a){var b=this.getSelectionModel();"yes"==a&&(Ext.each(b.getSelections(),function(a){this.store.remove(a)}),this.getStore().save(),b.clearSelections(),this.fireEvent("afterdelete")),b.selectRow(b.last)},this))}},saveAll:function(){this.fireEvent("beforesave");var a=this.getView().scroller.getScroll().top;this.getStore().getModifiedRecords().length>0&&this.loadMask.show();var b=this.getStore().getModifiedRecords();b.length&&(b=b[0]),this.getStore().on({save:{fn:function(c){0===this.getStore().getModifiedRecords().length&&(c.on({load:{scope:this,single:!0,fn:function(){if(b&&b.get&&!c.getById(b.get("id")))this.getStore().on({load:{scope:this,single:!0,fn:function(){this.loadMask.hide(),this.getSelectionModel().selectFirstRow(),this.getTopToolbar().searchById(b.get("id")),this.fireEvent("after-save",this.getSelectionModel()),this.enable()}}}),this.getStore().load({params:{query:{id:b.get("id")}}});else{this.loadMask.hide(),this.fireEvent("after-save",this.getSelectionModel()),this.enable();var d=this;setTimeout(function(){d.getView().scroller.dom.scrollTop=a},10)}}}}),c.reload())},scope:this,single:!0}}),this.getStore().save()},loadStoreWithDefaults:function(){this.filterMenu&&this.filterMenu.defaultFilter?this.filterMenu.defaultFilter.handler(this.filterMenu.defaultFilter):this.getStore().load()},selectAll:function(){if(this.disabled)return!1;var a=this.getSelectionModel(),b=this.getStore();a.getCount()===b.getCount()?a.clearSelections():a.selectAll()},focus:function(){var a=this.getSelectionModel();a.hasSelection()||a.selectFirstRow();var b=0,c=a.getSelections();c.length&&(b=this.getStore().indexOf(c[0])),this.getView().focusRow(b)},setupEvents:function(){function a(a){return!a.getTarget("input")&&!a.getTarget("textarea")&&!a.getTarget("iframe")}{var b=this.getBottomToolbar();new Ext.KeyMap(this.getEl(),[{key:"a",ctrl:!0,fn:function(b,c){a(c)&&(this.selectAll(),c.stopEvent())},scope:this},{key:Ext.EventObject.DELETE,ctrl:!0,handler:function(b,c){if(a(c)){if(Garp.dataTypes[Garp.currentModel].disableDelete||Garp.toolbar.deleteButton.disabled)return;this.fireEvent("delete"),c.stopEvent()}},scope:this},{key:Ext.EventObject.BACKSPACE,ctrl:!1,handler:function(b,c){if(a(c)){if(Garp.dataTypes[Garp.currentModel].disableDelete||Garp.toolbar.deleteButton.disabled)return;this.fireEvent("delete"),c.stopEvent()}},scope:this}]),new Ext.KeyNav(this.getEl(),{enter:this.fireEvent.createDelegate(this,["defocus"]),pageUp:function(a){a.ctrlKey||a.shiftKey?b.moveFirst():b.cursor>0&&b.movePrevious()},pageDown:function(a){a.ctrlKey||a.shiftKey?b.moveLast():b.cursor+this.getStore().getCount()<this.getStore().getTotalCount()&&b.moveNext()},scope:this})}this.on({scope:this,"new":{fn:this.newItem},"save-all":{fn:this.saveAll,buffer:200},"delete":{fn:this.deleteItems}})},initComponent:function(){function a(a,b){return a.getModifiedRecords().length?(Ext.Msg.show({animEl:Garp.viewport.getEl(),icon:Ext.MessageBox.QUESTION,title:__("Garp"),msg:__("Would you like to save your changes?"),buttons:Ext.Msg.YESNOCANCEL,fn:function(d){switch(d){case"yes":a.on({save:{single:!0,fn:function(){a.load(b)}}}),a.save();break;case"no":a.rejectChanges(),a.on({load:{single:!0,fn:function(){c.getSelectionModel().clearSelections(!1)}}}),a.load(b)}}}),!1):void 0}this.addEvents("beforesave","rowselect","beforerowselect","storeloaded","rowdblclick","selectionchange");var b=Garp.dataTypes[this.model].getStoreFieldsFromColumnModel();this.writer=new Ext.data.JsonWriter({paramsAsHash:!1,encode:!1});var c=this;this.filterMenu=new Garp.FilterMenu,this.store=new Ext.data.DirectStore({autoLoad:!1,autoSave:!1,pruneModifiedRecords:!0,remoteSort:!0,restful:!0,autoDestroy:!0,root:"rows",idProperty:"id",fields:b,listeners:{beforeload:a,load:this.fireEvent.createDelegate(this,["storeloaded"]),exception:{scope:this,fn:function(){this.loadMask.hide()}}},totalProperty:"total",sortInfo:Garp.dataTypes[this.model].sortInfo||null,baseParams:{start:0,limit:Garp.pageSize},api:{create:Garp[this.model].create||function(){return!0},read:Garp[this.model].fetch||function(){return!0},update:Garp[this.model].update||function(){return!0},destroy:Garp[this.model].destroy||function(){return!0}},writer:this.writer}),c=this,Ext.applyIf(this,{cm:new Ext.grid.ColumnModel({defaults:{sortable:!0},columns:Garp.dataTypes[this.model].columnModel,listeners:{hiddenchange:function(){setTimeout(function(){c.getView().refresh()},100)}}}),pageSize:Garp.pageSize,viewConfig:{scrollOffset:20,emptyText:Ext.PagingToolbar.prototype.emptyMsg,deferEmptyText:!1,deferRowRender:!1,enableRowBody:!0,forceFit:!0,contextRowCls:"garp-contextrow"},store:this.store,border:!1,sm:new Ext.grid.RowSelectionModel({singleSelect:!1}),bbar:new Ext.PagingToolbar({pageSize:Garp.pageSize,displayInfo:!0,store:this.store,plugins:[this.filterMenu]}),tbar:new Ext.ux.Searchbar({layout:"hbox",store:this.store,listeners:{search:{scope:this,fn:function(){this.getBottomToolbar().plugins[0].resetUI()}}}})}),this.relayEvents(this.sm,["beforerowselect","rowselect","selectionchange","rowdblclick"]),Garp.GridPanel.superclass.initComponent.call(this),this.on("render",function(){this.setupEvents()},this),this.on("headerclick",function(a,b){if(a.getColumnModel().columns[b].virtual){var c;return c=a.getColumnModel().columns[b].sortable?a.getColumnModel().columns[b].dataIndex:a.getColumnModel().columns[b].virtualSortField,c&&(a.getStore().on({load:{single:!0,scope:this,fn:function(){for(var c=0,d=a.getColumnModel().columns.length;d>c;c++){var e=Ext.get(a.getView().getHeaderCell(c));e.removeClass("sort-asc"),e.removeClass("sort-desc")}var f=a.getStore().sortInfo.direction.toLowerCase();Ext.get(a.getView().getHeaderCell(b)).addClass("sort-"+f)}}}),a.getStore().sort(c)),!1}})},setupContextMenus:function(){function a(){null!==this._previousContextedRow&&Ext.get(this.getView().getRow(this._previousContextedRow)).removeClass(this.getView().contextRowCls)}var b=this,c={iconCls:"icon-refresh",text:__("Refresh"),handler:function(){b.getStore().reload()}},d={iconCls:"icon-new",text:__("New"),handler:function(){b.newItem()}},e=new Ext.menu.Menu({items:[{iconCls:"icon-open",text:__("Open"),handler:function(){a.call(b),b.getSelectionModel().selectRow(b._previousContextedRow)}},{iconCls:"icon-open-new-window",text:__("Open in new window"),handler:function(){b.fireEvent("open-new-window")}},d,{iconCls:"icon-delete",text:__("Delete"),handler:function(){b.deleteItems()}},"-",c]}),f=new Ext.menu.Menu({items:[d,"-",c]});this.on("contextmenu",function(a){a.stopEvent(),e.hide(),f.showAt(a.getXY())}),this._previousContextedRow=null,this.getView().el.on("click",a.createDelegate(this)),this.getView().el.on("contextmenu",a.createDelegate(this)),this.on("cellcontextmenu",function(b,c,d,g){g.stopEvent();var h=b.getView();a.call(this),Ext.get(h.getRow(c)).addClass(h.contextRowCls),b._previousContextedRow=c,f.hide(),e.showAt(g.getXY())})},afterRender:function(){this.getBottomToolbar().on("defocus",this.focus.createDelegate(this)),Garp.GridPanel.superclass.afterRender.call(this),this.setupContextMenus()}}),Garp.FormPanel=Ext.extend(Ext.FormPanel,{layout:"fit",hideMode:"offsets",monitorValid:!0,trackResetOnLoad:!1,clientValidation:!0,state:null,updateUI:function(){if(this.rec&&this.formcontent.rendered&&!this.hidden){var a=1,b=2,c=4,d=8,e=16,f=32,g=this.getForm().isValid(),h=this.getForm().isDirty(),i=this.state;if(this.state=this.rec.phantom?g?a:b:h?g?e:f:g?c:d,this.state!=i){var j=this.formcontent.getTopToolbar();switch(this.state){case a:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.enable(),j.saveButton.enable(),j.saveAsDraftButton.enable(),j.cancelButton.enable(),j.previewButton.disable();break;case b:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.disable(),j.saveButton.disable(),j.saveAsDraftButton.disable(),j.cancelButton.enable(),j.previewButton.disable();break;case c:this.fireEvent("undirty"),this.enableTabs(),this.metaPanel.enable(),j.saveButton.disable(),j.saveAsDraftButton.disable(),j.cancelButton.disable(),j.previewButton.enable();break;case d:this.fireEvent("undirty"),this.enableTabs(),this.metaPanel.enable(),j.saveButton.disable(),j.saveAsDraftButton.disable(),j.cancelButton.disable(),j.previewButton.disable();break;case e:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.enable(),j.saveButton.enable(),j.saveAsDraftButton.enable(),j.cancelButton.enable(),j.previewButton.disable();break;default:this.fireEvent("dirty"),this.disableTabs(),this.metaPanel.disable(),j.saveButton.disable(),j.saveAsDraftButton.disable(),j.cancelButton.enable(),j.previewButton.disable()}}}},disableTabs:function(){this.get(0).items.each(function(a){a!=this.formcontent&&a.disable()},this)},enableTabs:function(){this.get(0).items.each(function(a){a!=this.formcontent&&a.enable()},this)},getTab:function(a){return this.get(0).items.find(function(b){return b.model==a})},newItem:function(){this.form.reset(),function(){this.stopMonitoring(),this.focusFirstField(),this.getForm().items.each(function(a){"function"==typeof a.blur&&(a.on("blur",this.startMonitoring.createDelegate(this),this,{single:!0}),a.on("keyup",this.startMonitoring.createDelegate(this),this,{single:!0}))},this),this.getForm().clearInvalid(),this.updateUI(),this.rec=Garp.gridPanel.getSelectionModel().getSelected(),this.formcontent.fireEvent("loaddata",this.rec,this)}.defer(100,this),this.getForm().clearInvalid()},getErrors:function(){var a="";return this.getForm().items.each(function(b){b.getActiveError()&&(a+=b.getActiveError()+": "+b.fieldLabel+"<br>")}),a},updateTitle:function(){if(Garp.dataTypes[Garp.currentModel].displayFieldRenderer){var a=this.items.itemAt(0).items.itemAt(0);"relationpanel"!==a.xtype&&a.setTitle(Garp.dataTypes[Garp.currentModel].displayFieldRenderer(this.rec))}},loadData:function(a){function b(){this.formcontent.rendered&&this.formcontent.fireEvent("loaddata",this.rec,this),this.metaPanel.rendered&&this.metaPanel.fireEvent("loaddata",this.rec,this),this.state=null,this.startMonitoring(),this.getForm().clearInvalid()}var c=this.getForm();if(this.stopMonitoring(),!c.isDirty()&&1==a.getCount()&&(this.rec=a.getSelected(),this.rec&&(this.state=null,c.loadRecord(this.rec),this.ownerCt))){this.updateTitle(),this.fireEvent("defocus"),b.call(this),this.formcontent.on("activate",b,this,{single:!0}),this.metaPanel.on("activate",b,this,{single:!0});var d=Garp.dataTypes[Garp.currentModel].getColumn("online_status")&&Garp.dataTypes[Garp.currentModel].getColumn("published")?!0:!1;this.formcontent.getTopToolbar().saveAsDraftButton.setVisible(d),c.unDirty()}},focusFirstField:function(){this.getForm().items.each(function(a){return!a.hidden&&!a.disabled&&a.focus&&Ext.isFunction(a.focus)?(a.focus(100),!1):!0})},afterRender:function(){var a=new Ext.KeyMap(this.getEl(),[{key:Ext.EventObject.ESC,scope:this,handler:function(){this.fireEvent("defocus")}}]);a.stopEvent=!0,this.get(0).items.each(function(a){a!=this.formcontent&&this.relayEvents(a,["dirty","undirty"])},this),Garp.FormPanel.superclass.afterRender.call(this)},initComponent:function(){this.id=Ext.id(),this.addEvents("save-all","cancel","preview","open-new-window","lock","unlock","dirty","undirty","delete"),this.on({scope:this,"new":{buffer:30,fn:this.newItem},"save-all":{fn:function(){var a=this.formcontent.getTopToolbar();a.saveButton.disable(),a.saveAsDraftButton.disable(),a.cancelButton.disable()}},"after-save":{fn:function(a){this.state=null,this.form.unDirty(),this.form.reset(),this.loadData(a),this.updateUI()}},rowselect:{buffer:100,fn:this.loadData},clientvalidation:{fn:function(a,b){this.updateUI(b)}}});var a=[];Ext.each(Garp.dataTypes[Garp.currentModel].formConfig,function(b){a.push(Ext.apply({},b))}),Ext.apply(a[0],{ref:"../formcontent",title:"&nbsp;",layout:"border"}),Ext.apply(a[0].items[0],{region:"center",autoScroll:!0,margins:"0 0 0 10"}),a[0].tbar={cls:"garp-formpanel-toolbar",items:[{text:__("Save"),iconCls:"icon-save",ref:"saveButton",disabled:!0,handler:function(){this.dirtyState=null,this.fireEvent("save-all")},scope:this},{text:__("Save as draft"),hidden:!this.draftable,iconCls:"icon-save-draft",ref:"saveAsDraftButton",disabled:!0,handler:function(){this.dirtyState=null,this.rec.set("online_status",0),this.fireEvent("save-all")},scope:this},{text:__("Cancel"),iconCls:"icon-cancel",ref:"cancelButton",disabled:!0,handler:function(){function a(){this.getForm().reset(),this.updateUI(),this.rec=null,this.fireEvent("delete")}return this.getForm().isDirty()?void Ext.Msg.confirm(__("Garp"),__("Are you sure you want to revert your changes?"),function(b){"yes"==b&&(this.rec.phantom?a.call(this):(this.getForm().reset(),this.updateUI(),this.fireEvent("cancel",this)))},this):!this.rec||this.rec.phantom?void a.call(this):void 0},scope:this}," ",{text:__("Open in new window"),iconCls:"icon-open-new-window",handler:function(){this.fireEvent("open-new-window")},scope:this}," ",{text:__("Preview"),iconCls:"icon-preview",ref:"previewButton",disabled:!0,hidden:Garp.currentModel&&!Garp.dataTypes[Garp.currentModel].previewLink,scope:this,handler:function(){this.fireEvent("preview")},listeners:{disable:function(){this.setTooltip(__("To preview, save this item first"))},enable:function(){this.setTooltip(__("Preview this item"))}}}]};var b=Garp.dataTypes[Garp.currentModel],c=Ext.apply({hidden:window.innerWidth<=Garp.SMALLSCREENWIDTH},b.metaPanelConfig?b.metaPanelConfig:{});a[0].items.push(this.metaPanel=new Garp.MetaPanel(c)),this.items={xtype:"tabpanel",deferredRender:!1,activeTab:0,resizeTabs:!0,minTabWidth:80,tabWidth:150,tabMargin:15,enableTabScroll:!0,border:!1,defaults:{border:!1,deferredRender:!1,bodyCssClass:"garp-formpanel"},items:a},this.relayEvents(this.metaPanel,["save-all","dirty","undirty"]),Garp.FormPanel.superclass.initComponent.call(this,arguments),this.stopMonitoring()}}),Ext.reg("garpformpanel",Garp.FormPanel),Garp.Toolbar=Ext.extend(Ext.Toolbar,{addColumnMenu:function(){},removeColumnMenu:function(){},initComponent:function(){Ext.apply(this,{style:"padding:0px 10px 0px 10px;border:0;",cls:"garp-main-toolbar cms-branding-small",items:[Garp.modelMenu,"-",{xtype:"tbspacer"},{text:__("New"),iconCls:"icon-new",ref:"newButton",handler:function(){this.fireEvent("new")},scope:this},{text:__("Delete"),iconCls:"icon-delete",ref:"deleteButton",handler:function(){this.fireEvent("delete")},scope:this}," ",{xtype:"tbseparator",ref:"separator"},{text:__("more"),iconCls:"icon-extra",ref:"extraMenu",menu:new Ext.menu.Menu({items:[{text:__("Import")+"&hellip;",iconCls:"icon-import",ref:"importButton",hidden:!0,handler:function(){if(Garp.currentModel){var a=new Garp.ImportWindow;a.show()}}},{text:__("Export")+"&hellip;",iconCls:"icon-export",ref:"exportButton",hidden:!0,handler:function(){if(Garp.currentModel){var a=new Garp.ExportWindow;a.show()}}},{text:__("Print"),iconCls:"icon-print",ref:"printButton",hidden:!0,handler:function(){if(Garp.currentModel)if(1==Garp.gridPanel.getSelectionModel().getCount())Ext.select("body").addClass("print-form"),Garp.gridPanel.ownerCt.collapse(),Garp.viewport.doLayout(),setTimeout(function(){window.print(),Garp.gridPanel.ownerCt.expand(),Ext.select("body").removeClass("print-form")},500);else{Ext.select("body").addClass("print-grid");var a=Garp.gridPanel.ownerCt.getWidth();Garp.gridPanel.getSelectionModel().clearSelections(),Garp.formPanel.ownerCt.collapse&&Garp.formPanel.ownerCt.collapse(),Garp.gridPanel.ownerCt.collapse(),Garp.gridPanel.ownerCt.setWidth(640),Garp.gridPanel.ownerCt.expand();var b=Ext.select(".x-grid3-scroller").first(),c=b.getStyle("width"),d=b.getStyle("height");b.setStyle({overflow:"visible",position:"fixed",height:"auto"}),setTimeout(function(){window.print(),b.first().setStyle({overflow:"auto","overflow-x":"hidden",position:"relative",width:c,height:d}),Garp.gridPanel.ownerCt.setWidth(a),Garp.formPanel.ownerCt.expand&&Garp.formPanel.ownerCt.expand(),Garp.gridPanel.ownerCt.expand(),Garp.viewport.doLayout(),Ext.select("body").removeClass("print-grid")},500)}}},"-",{hidden:!(document.fullScreenElement&&null!==document.fullScreenElement||!document.mozFullScreen&&!document.webkitIsFullScreen),text:__("Full Screen"),iconCls:"icon-fullscreen",handler:function(){var a=document,b=a.documentElement;a.mozFullScreen||a.webkitIsFullScreen?a.mozCancelFullScreen?a.mozCancelFullScreen():a.webkitCancelFullScreen&&a.webkitCancelFullScreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullScreen&&b.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}},"-",{text:__("Log out"),iconCls:"icon-logout",ref:"logoutButton",handler:function(){this.fireEvent("logout")},scope:this}]})}]}),Garp.Toolbar.superclass.initComponent.call(this)}}),Garp.InfoPanel=Ext.extend(Ext.Panel,{setInfo:function(a){this.remove(this.innerpanel),this.add([{xtype:"container",ref:"innerpanel",cls:"infopanel cms-branding",border:!1,defaults:{border:!1},items:[{html:'<div class="x-panel-header x-panel-header-noborder x-unselectable" style="-moz-user-select: none;"><img class="x-panel-inline-icon '+a.iconCls+'" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" alt=""><span class="x-panel-header-text">'+__(a.text)+"</span></div>"+(a.description?'<div class="description">'+__(a.description)+"</div>":"")},{xtype:"box",ref:"../count",cls:"total",tpl:a.countTpl}]}])},updateCount:function(a){this.count.update({count:a})},clearInfo:function(){this.update("")},html:"",bodyStyle:"padding: 30px; padding-bottom: 15px;",layout:"fit",listeners:{show:function(){Garp.history&&Garp.currentModel&&Garp.history.pushState({model:Garp.currentModel})}}}),Garp.Viewport=function(a){Garp.Viewport.superclass.constructor.call(this,Ext.applyIf(a||{},{layout:"border",stateful:!1,defaults:{split:!0,animCollapse:!1,border:!1,frame:!1},items:[{region:"north",border:!1,height:40,bodyCssClass:"garp-bg",border:!1,cls:"toolbarCt",items:Garp.toolbar=new Garp.Toolbar},{ref:"gridPanelCt",region:"west",cls:"gridPanelCt",layout:"fit",xtype:"panel",margins:"0 0 2 2",width:360,minWidth:360,height:200,minHeight:200,collapseMode:"mini",collapsible:!0,header:!1,stateful:!0,stateId:"gridPanelCt",margins:"0 0 4 4",items:[Garp.gridPanel]},{ref:"formPanelCt",region:"center",cls:"formPanelCt",layout:"card",xtype:"container",layoutConfig:{layoutOnCardChange:!0},activeItem:0,border:!1,defaults:{border:!1},margins:"0 4 4 0",items:[Garp.infoPanel=new Garp.InfoPanel({itemId:0,ref:"../infoPanel"})]}]}))},Ext.extend(Garp.Viewport,Ext.Viewport,{}),Ext.ns("Garp"),Garp.ExportWindow=Ext.extend(Ext.Window,{width:580,height:360,modal:!0,layout:"card",activeItem:0,preventBodyReset:!0,title:__("Export"),iconCls:"icon-export",border:!1,defaults:{border:!0,cls:"garp-formpanel"},proceedExport:function(){var a=this.get("page-0").getForm().getValues(),b=[];"undefined"!=typeof Garp.gridPanel.getSelectionModel().getSelected()&&Ext.each(Garp.gridPanel.getSelectionModel().getSelections(),function(a){b.push(a.id)});var c=this.get("page-2").getForm().getFieldValues().exporttype,d=Ext.util.JSON.encode(Garp.gridPanel.store.baseParams.query),e=Garp.gridPanel.getStore().sortInfo,f=Garp.gridPanel.getBottomToolbar().pageSize,g=Garp.gridPanel.getBottomToolbar().cursor,h=this.get("page-1").getForm(),i=this.get("page-0").getForm(),j=h.getValues(),k=[];if(j.__all){var l=this.getCheckboxesFromModel();for(var m in l)"function"!=typeof l[m]&&k.push(l[m].name)}else for(var n in j)k.push(n);var o={};switch(a.selection){case"currentItem":o={selection:"id",exportType:c,sortDir:e.direction,sortField:e.field};break;case"currentPage":o={selection:"page",page:Math.ceil((g+f)/f),exportType:c,pageSize:f,sortDir:e.direction,sortField:e.field,filter:d};break;case"specific":o={selection:"page",from:a.from,to:a.to,exportType:c,pageSize:f,sortDir:e.direction,sortField:e.field,filter:d};break;case"relation":o={selection:"all",filter:'{"'+Garp.currentModel+'.id":'+b[0]+"}",exportType:c};break;default:o={selection:"all",exportType:c,pageSize:f,sortDir:e.direction,sortField:e.field,filter:d}}var p;p="relation"==a.selection?Ext.urlEncode(o,BASE+"g/content/export/model/"+i.findField("model").getValue()+"?exporttype="+c):Ext.urlEncode(o,BASE+"g/content/export/model/"+Garp.currentModel+"?exporttype="+c),"currentItem"==a.selection&&(p+="&id=["+b.join(",")+"]"),("currentItem"==a.selection||"currentPage"==a.selection||"specific"==a.selection||"all"==a.selection)&&(p+="&filter="+encodeURIComponent(d),p+="&fields="+encodeURIComponent(k)),this.close(),window.location=p},navHandler:function(a){var b=this.getLayout().activeItem.id;b=parseInt(b.substr(5,b.length),10),this._prevPage=b,b+=a;var c=this.get("page-0").getForm();0>=b?(b=0,this.prevBtn.disable(),this.nextBtn.setText(__("Next")),c.findField("selection").handler.call(this)):2==b?(this.prevBtn.enable(),this.nextBtn.setText(__("Ok"))):3==b?this.proceedExport():(this.prevBtn.enable(),this.nextBtn.setText(__("Next"))),this.getLayout().setActiveItem("page-"+b)},getCheckboxesFromModel:function(){var a=[],b=Garp.gridPanel.getColumnModel().columns;return Ext.each(b,function(b){b.virtual||a.push({boxLabel:Ext.util.Format.stripTags(__(b.header)),name:b.dataIndex,checked:!b.hidden})}),a},initComponent:function(){var a={scope:this,allowBlank:!0,handler:function(){var a=this.get("page-0").getForm(),b=!0,c=!0;"specific"==a.getValues().selection&&(b=!1),"relation"==a.getValues().selection&&(c=!1),a.findField("model").setDisabled(c),a.findField("from").setDisabled(b),a.findField("to").setDisabled(b)}};this.items=[{id:"page-0",xtype:"form",items:[{xtype:"fieldset",labelWidth:200,title:__("Specify selection to export (1/3)"),defaults:a,items:[{fieldLabel:__("Currently selected item(s)"),xtype:"radio",name:"selection",checked:Garp.gridPanel.getSelectionModel().getCount()>1,disabled:!Garp.gridPanel.getSelectionModel().getSelected(),inputValue:"currentItem"},{fieldLabel:__("Current page"),xtype:"radio",name:"selection",checked:0===Garp.gridPanel.getSelectionModel().getCount(),inputValue:"currentPage"},{xtype:"compositefield",fieldLabel:__("Specific pages"),defaults:a,items:[{xtype:"radio",name:"selection",checked:1===Garp.gridPanel.getSelectionModel().getCount()&&!Garp.formPanel.items.get(0).getLayout().activeItem.model,inputValue:"specific",width:30},{xtype:"displayfield",value:__("Page")},{xtype:"numberfield",name:"from",value:1,flex:1},{xtype:"displayfield",value:__("to")},{xtype:"numberfield",name:"to",value:Math.ceil(Garp.gridPanel.getStore().getTotalCount()/Garp.gridPanel.getBottomToolbar().pageSize),flex:1}]},{xtype:"compositefield",fieldLabel:__("Related to current item"),disabled:1!==Garp.gridPanel.getSelectionModel().getCount(),hidden:!Garp.dataTypes[Garp.currentModel].getRelations().length,defaults:a,items:[{xtype:"radio",name:"selection",inputValue:"relation",checked:Garp.formPanel.items.get(0).getLayout().activeItem.model?!0:!1,width:30},{xtype:"displayfield",value:__("Kind")},{flex:1,xtype:"combo",editable:!1,name:"model",value:Garp.formPanel.items.get(0).getLayout().activeItem.model||Garp.dataTypes[Garp.currentModel].getRelations()[0]||null,store:function(){var a=[];return Ext.each(Garp.dataTypes[Garp.currentModel].getRelations(),function(b){Garp.dataTypes[b]&&a.push([b,Garp.dataTypes[b].text])}),a}()}]}]}]},{id:"page-1",xtype:"form",autoScroll:!0,listeners:{show:function(){var a=this.ownerCt;0===a._prevPage&&"relation"==a.get("page-0").getForm().getValues().selection&&a.nextBtn.handler.call(a)}},items:[{xtype:"fieldset",labelWidth:80,title:__("Select fields (2/3)"),items:[{ref:"../all",xtype:"checkbox",name:"__all",fieldLabel:__("All fields"),checked:!0,handler:function(a,b){b?this.refOwner.specific.disable():this.refOwner.specific.enable()}},{xtype:"box",cls:"separator"},{disabled:!0,xtype:"checkboxgroup",ref:"../specific",columns:3,hideLabel:!0,defaults:{xtype:"checkbox"},items:this.getCheckboxesFromModel()}]}]},{id:"page-2",xtype:"form",items:[{xtype:"fieldset",title:__("Export type (3/3)"),items:[{xtype:"combo",name:"exporttype",fieldLabel:__("Format"),allowBlank:!1,editable:!1,triggerAction:"all",typeAhead:!1,mode:"local",value:"txt",store:[["txt","Text"],["csv","CSV"],["excel","Excel"]]}]}]}],this.buttonAlign="left",this.buttons=[{text:__("Previous"),ref:"../prevBtn",handler:this.navHandler.createDelegate(this,[-1])},"->",{text:__("Cancel"),handler:this.close.createDelegate(this)},{text:__("Next"),ref:"../nextBtn",handler:this.navHandler.createDelegate(this,[1])}],Garp.ExportWindow.superclass.initComponent.call(this),this.on("show",this.navHandler.createDelegate(this,[-1]))}}),Ext.ns("Garp"),Garp.ImportWindow=Ext.extend(Ext.Window,{width:810,height:360,modal:!0,layout:"card",activeItem:0,preventBodyReset:!1,title:__("Import"),iconCls:"icon-import",maximizable:!0,border:!1,defaults:{border:!0,frame:!1,style:"background-color: #fff;",bodyStyle:"background-color: #fff;padding-top: 10px; "},navHandler:function(a){var b=this.getLayout().activeItem.id;b=parseInt(b.substr(5,b.length),10),b+=a;var c=this.get("page-1").getForm();0>=b?(b=0,this.prevBtn.disable(),this.nextBtn.setText(__("Next")),this.nextBtn.setDisabled(!c.findField("datafile").getValue())):1==b?(this.progress.reset(),this.progress.wait({text:__("Processing")}),Ext.select(".x-progress-bar").setHeight(18),this.prevBtn.disable(),this.nextBtn.disable(),c.submit()):2==b?(this.nextBtn.setText(__("Ok")),this.prevBtn.enable(),this.nextBtn.enable()):3==b?this.proceedImport():(this.prevBtn.enable(),this.nextBtn.setText(__("Next"))),this.getLayout().setActiveItem("page-"+b)},showMappingUI:function(a){var b=[],c=[];Ext.each(Garp.dataTypes[Garp.currentModel].columnModel,function(a){c.push([a.dataIndex,a.header])}),c.push(["",__("  (Ignore)")]);for(var d=a[0].length,e=function(a,b){var c=Ext.select("."+a.name,null,this.el.body);b?c.removeClass("garp-import-hidden-col"):c.addClass("garp-import-hidden-col")},f=0;d>f;f++){var g=[];g.push({name:"col-"+f,xtype:"combo",allowBlank:!1,editable:!1,triggerAction:"all",typeAhead:!1,mode:"local",store:c,submitValue:!1,value:d>f?c[f][0]:d,width:140,listeners:{select:e,scope:this}});
for(var h=0;h<a.length;h++)g.push({xtype:"box",html:(a[h][f]||"")+"",cls:"row-"+h+" col-"+f,style:"background-color: #fff; margin: 5px 10px 5px 2px;"});b.push({items:g})}var i=150*d;this.mappingColumns=new Ext.Panel({layout:"column",columns:c.length,width:i+10,items:b,defaults:{width:150}}),this.get("page-2").add({xtype:"panel",style:"margin: 10px;",frame:!0,bodyStyle:"padding:10px;",autoScroll:!0,items:this.mappingColumns}),this.get("page-2").add({xtype:"fieldset",items:[{xtype:"checkbox",fieldLabel:__("Ignore first row"),name:"ignore-first-row",checked:!1,submitValue:!1,handler:function(a,b){var c=Ext.select(".row-0",null,this.el.body);b?c.addClass("garp-import-hidden-row"):c.removeClass("garp-import-hidden-row")},scope:this},{xtype:"checkbox",fieldLabel:__("Continue on error(s)"),name:"ignoreErrors"}]}),this.getLayout().setActiveItem("page-2"),this.get("page-2").doLayout(),this.navHandler(0),this.get("page-2").getForm().findField("ignore-first-row").setValue(!0)},proceedImport:function(){var a=[],b=this.get("page-2").findByType("combo");Ext.each(b,function(b){a.push(b.getValue())});var c=this.get("page-2").getForm();Ext.apply(c.baseParams,{datafile:this.get("page-1").getForm().findField("datafile").getValue(),mapping:Ext.encode(a),firstRow:this.get("page-2").getForm().findField("ignore-first-row").checked?"1":"0"}),this.lm=new Ext.LoadMask(this.getEl()),this.lm.show(),c.submit()},initComponent:function(){this.progress=new Ext.ProgressBar({animate:!0}),this.items=[{id:"page-0",xtype:"form",timeout:0,items:[{xtype:"fieldset",labelWidth:150,title:__("Specify file to import"),style:"padding-top: 50px; ",items:[{xtype:"uploadfield",uploadURL:BASE+"g/content/upload/type/document",supportedExtensions:["xls","xlsx","xml"],allowBlank:!1,name:"filename",fieldLabel:__("Filename"),listeners:{change:function(a,b){this.get("page-1").getForm().findField("datafile").setValue(b),this.navHandler(1)},scope:this}},{xtype:"displayfield",value:__("Excel filetypes are supported")}]}]},{id:"page-1",timeout:0,xtype:"form",url:BASE+"g/content/import/",baseParams:{model:Garp.currentModel},listeners:{actioncomplete:function(a,b){b.result&&b.result.success&&this.showMappingUI(b.result.data)},actionfailed:function(a,b){var c=__("Something went wrong. Please try again.");b.result&&b.result.message&&(c+="<br>"+b.result.message),Ext.Msg.alert(__("Error"),c),this.close()},scope:this},items:[{xtype:"fieldset",labelWidth:150,title:__("Please wait"),style:"padding-top: 50px; ",items:[this.progress,{xtype:"textfield",hidden:!0,fieldLabel:__("Filename"),ref:"datafile",name:"datafile"}]}]},{id:"page-2",xtype:"form",timeout:1200,url:BASE+"g/content/import/",baseParams:{model:Garp.currentModel},listeners:{actioncomplete:function(a,b){this.lm.hide(),b.result&&b.result.success&&(this.close(),Garp.gridPanel.getStore().reload())},actionfailed:function(a,b){this.lm.hide();var c=__("Something went wrong. Please try again.");b.result.message&&(c+="<br>"+b.result.message),Ext.Msg.alert(__("Error"),c)},scope:this},items:[{xtype:"fieldset",labelWidth:0,title:__("Fields"),items:[]}]}],this.buttonAlign="left",this.buttons=[{text:__("Previous"),disabled:!0,ref:"../prevBtn",handler:this.navHandler.createDelegate(this,[-2])},"->",{text:__("Cancel"),handler:this.close.createDelegate(this)},{text:__("Next"),ref:"../nextBtn",disabled:!0,handler:this.navHandler.createDelegate(this,[1])}],Garp.ImportWindow.superclass.initComponent.call(this)}}),Ext.ns("Garp"),Garp.PasswordFieldset=Ext.extend(Ext.form.FieldSet,{callback:Ext.emptyFn,style:"margin:0;padding:0;",defaultType:"textfield",defaults:{allowBlank:!0},collapseAndHide:function(){this.showpassword.hide(),this.password.hide(),this.plaintext.hide(),this.password.setValue(""),this.password.originalValue="",this.plaintext.setValue(""),this.plaintext.originalValue=""},initComponent:function(a){this.items=[{ref:"setPasswordBtn",fieldLabel:" &nbsp; ",xtype:"button",text:__("Set password"),boxMaxWidth:64,handler:function(){var a=this.refOwner;a.showpassword.isVisible()?a.collapseAndHide():(a.showpassword.show(),a.password.show(),a.plaintext.hide(),a.password.focus(20))}},{ref:"password",fieldLabel:__("Password"),inputType:"password",hidden:!0,listeners:{change:this.callback}},{ref:"plaintext",fieldLabel:__("Password"),inputType:"text",hidden:!0,listeners:{change:this.callback}},{ref:"showpassword",fieldLabel:__("Show Password"),xtype:"checkbox",allowBlank:!0,hidden:!0,handler:function(){var a=this.refOwner,b=this.checked;a.password.setVisible(!b),a.plaintext.setVisible(b),a[b?"plaintext":"password"].setValue(a[b?"password":"plaintext"].getValue())}}];var b=this;this._interval=setInterval(function(){b.password?(b.password.isVisible()||b.plaintext.isVisible())&&(b.password.isVisible()&&b.password.isDirty()?(b.callback(b.password,b.password.getValue()),b.password.originalValue=b.password.getValue()):b.plaintext.isDirty()&&(b.callback(b.plaintext,b.plaintext.getValue()),b.plaintext.originalValue=b.plaintext.getValue())):clearInterval(this._interval)},100),Garp.PasswordFieldset.superclass.initComponent.call(this,a)}}),Ext.reg("passwordfieldset",Garp.PasswordFieldset),Ext.ux.DateTimePicker=Ext.extend(Ext.DatePicker,{showToday:!0,timeValue:"12:00",initComponent:function(){Ext.ux.DateTimePicker.superclass.initComponent.call(this)},onRender:function(a,b){Ext.ux.DateTimePicker.superclass.onRender.call(this,a,b),this.addTimeField.call(this)},addTimeField:function(){this.timeField||(this.timeField=new Ext.form.TimeField({lazyInit:!1,renderTo:this.el.child(".x-date-bottom"),value:this.timeValue,getListParent:function(){var a=this.el.up(".x-menu");return a},listeners:{select:{fn:function(){return!1}},focus:{fn:function(){return this.doDisabled(!0),!1},scope:this},blur:{fn:function(){return this.doDisabled(!1),!1},scope:this},render:function(){this.list.on("click",function(a){return a.stopPropagation(),!1})}},width:60}),Ext.select(".x-date-bottom div, .x-date-bottom table",this.el).each(function(){this.setStyle({"margin-left":"18px","float":"left"})}))}}),Ext.ns("Ext.ux.menu"),Ext.ux.menu.DateTimeMenu=Ext.extend(Ext.menu.DateMenu,{initComponent:function(){this.on("beforeshow",this.onBeforeShow,this),(this.strict=Ext.isIE7&&Ext.isStrict)&&this.on("show",this.onShow,this,{single:!0,delay:20}),Ext.apply(this,{plain:!0,showSeparator:!1,items:this.picker=new Ext.ux.DateTimePicker(Ext.applyIf({internalRender:this.strict||!Ext.isIE,ctCls:"x-menu-date-item",id:this.pickerId},this.initialConfig))}),this.picker.purgeListeners(),Ext.menu.DateMenu.superclass.initComponent.call(this),this.relayEvents(this.picker,["select"]),this.on("show",this.picker.focus,this.picker),this.on("select",this.menuHide,this),this.handler&&this.on("select",this.handler,this.scope||this)}}),Ext.ns("Garp"),Garp.DataType=Ext.extend(Ext.util.Observable,{getStoreFieldsFromColumnModel:function(){var a=[];return Ext.each(this.columnModel,function(b){var c={};b.dataIndex&&(c.name=b.dataIndex),b.convert&&(c.convert=b.convert),b.mapping&&(c.mapping=b.mapping),a.push(c)}),a},getViewTpl:function(){var a='<div class="view">';return Ext.each(this.formConfig[0].items[0].items,function(b){!b.hidden&&!b.disabled&&b.fieldLabel&&b.name&&(a+="<h2>"+__(b.fieldLabel)+"</h2>",a+="<div>{"+b.name+"}</div>")}),a+="</div>",this.viewTpl=new Ext.XTemplate(a,{compiled:!0}),this.viewTpl},setupACL:function(a){return Ext.isDefined(a.create)||Ext.apply(this,{disableCreate:!0,quickCreatable:!1}),Ext.isDefined(a.destroy)||Ext.apply(this,{disableDelete:!0}),Ext.isDefined(a.fetch)?!0:(Ext.apply(this,{hidden:!0,disabled:!0,disableCreate:!0,quickCreatable:!1}),!1)},removeColumn:function(a){this.columnModel.remove(this.getColumn(a))},getColumn:function(a){var b;return Ext.each(this.columnModel,function(c){return c.dataIndex==a?void(b=c):void 0}),b},addColumn:function(a){this.columnModel.push(a)},insertColumn:function(a,b){this.columnModel.splice(a,0,b)},removeField:function(a){this.formConfig[0].items[0].items.remove(this.getField(a))},getField:function(a){var b;return Ext.each(this.formConfig[0].items[0].items,function(c){Ext.each(c,function(c){return c.name==a?void(b=c):void 0})}),b},addField:function(a){this.formConfig[0].items[0].items.push(a)},addFields:function(a){Ext.each(a,function(a){this.addField(a)},this)},insertField:function(a,b){this.formConfig[0].items[0].items.splice(a,0,b)},getRelationPanel:function(a){var b;return Ext.each(this.formConfig,function(c){Ext.each(c,function(c){return c.model==a?void(b=c):void 0})}),b},getRelations:function(){var a=[];return Ext.each(this.formConfig,function(b){b.xtype&&"relationpanel"===b.xtype&&a.push(b.model)}),a},addRelationPanel:function(a){Ext.apply(a,{xtype:"relationpanel"}),this.formConfig.push(a)},addListener:function(a,b,c){this.setupListeners(a);var d=this.formConfig[0].listeners[a];this.formConfig[0].listeners[a]=c?function(a,c){b(a,c),d(a,c)}:function(a,c){d(a,c),b(a,c)}},setupListeners:function(){Ext.applyIf(this.formConfig[0],{listeners:{}}),Ext.applyIf(this.formConfig[0].eventName,{loaddata:function(){}})},constructor:function(a){this.addEvents("init"),this.listeners=a.listeners,this.initialCfg=Ext.apply({},a),Ext.apply(this,a),Ext.applyIf(this,{description:"",countTpl:new Ext.XTemplate([__("Total"),": {count} ",'<tpl if="count == 1">',__("item"),"</tpl>",'<tpl if="count != 1">',__("items"),"</tpl>"]),disabled:!1,disableDelete:!1,disableCreate:!1,quickCreatable:!0,displayFieldRenderer:function(a){return a.get("name")?a.get("name"):__(a.phantom?"New "+this.text:"Unnamed "+this.text)},previewItems:[],metaPanelItems:[],previewLink:null,iconCls:"icon-"+this.text.toLowerCase(),isRelationalDataType:!1}),Ext.applyIf(this.defaultData,{created:null,modified:null}),Ext.applyIf(this,{columnModel:[]}),this.isRelationalDataType&&(Ext.apply(this,{disableCreate:!0,disableDelete:!0}),this.addListener("loaddata",function(a,b){b.items.get(0).activate(1),b.items.get(0).hideTabStripItem(0)}));for(var b in this.defaultData){var c=!1;if(Ext.each(this.columnModel,function(a){a.dataIndex&&a.dataIndex==b&&(c=!0)}),!c){var d=Ext.util.Format.capitalize(b.replace("_"," "));this.columnModel.push({hidden:!0,renderer:"created"==b||"modified"==b?Garp.renderers.dateTimeRenderer:null,dataIndex:b,header:__(d)})}}Ext.each(this.columnModel,function(a){a.defaultData&&null===a.defaultData&&(a.useNull=!0),a.virtual&&(a.sortable=!1)}),Garp.DataType.superclass.constructor.call(this,a)}}),Ext.ns("Garp"),Ext.enableListenerCollection=!0,Ext.QuickTips.init(),Ext.Direct.addProvider(Garp.API),Garp.errorHandler={msg:null,win:null,handler:function(a){a||(a=__("No readable error message specified"));var b=!1;this.msg?(b=!0,this.msg=a+"<hr>"+this.msg):this.msg=a,this.win?this.win.clearBtn.show():this.win=new Ext.Window({title:__("Error"),data:{msg:__("No error")},tpl:new Ext.Template(['<div class="garp-error-dialog" style="min-height: 80px; max-height: 250px; overflow: auto; ">',"{msg}","</div>"]),width:500,buttonAlign:"center",defaultButton:"defaultButton",buttons:[{text:__("Ok"),id:"defaultButton",handler:function(){this.win.hide()},scope:this},{hidden:!0,text:__("Login again"),handler:function(){this.win.close(),window.location=BASE+"g/auth/login"},scope:this},{hidden:!b,ref:"../clearBtn",text:__("Clear messages"),handler:function(){this.msg="",this.win.update({msg:this.msg}),this.win.center()},scope:this}]}),this.win.show(),this.win.update({msg:this.msg}),this.win.center()}},window.onerror=Garp.errorHandler.handler.createDelegate(Garp.errorHandler),Ext.Direct.on({exception:{fn:function(a){var b="",c="",d="",e="",f="";throw Ext.isObject(a)&&(e=a.error?a.error.message:__(a.xhr&&403===a.xhr.status?"You've been logged out":"No connection"),f=a.tid,b=f?a.getTransaction():null,Ext.isObject(b)&&(c=b.action,d=b.method),Garp.undirty(),Garp.gridPanel&&Garp.gridPanel.loadMask&&(Garp.gridPanel.loadMask.hide(),Garp.formPanel&&(Garp.formPanel.state=0,Garp.formPanel.updateUI(),Garp.formPanel.fireEvent("dirty")))),"<b>"+(d?__("Error trying to ")+__(d):"")+" "+(Garp.dataTypes[c]?"<i>"+__(Garp.dataTypes[c].text)+"</i>":c)+"</b><br><br>"+__("Server response: ")+e||__("Nothing. Nada.")+"<br>"+(f?__("Transaction id: ")+f:"")}}}),Ext.override(Ext.ux.form.DateTime,{getValue:function(){return this.dateValue?this.dateValue.format(this.hiddenFormat):""}}),Ext.override(Ext.form.Checkbox,{getValue:function(){return this.rendered?this.el.dom.checked?"1":"0":this.checked?"1":"0"}}),Ext.override(Ext.form.DateField,{format:"d F Y",altFormats:"Y-m-d|d F Y|j F Y|d m Y|d n Y|d-m-Y|d-n-Y",invalidText:__('"{0}" is not a valid date. Valid formats are a.o. "19 2 2013" and "19-02-2013"')}),Ext.apply(Ext.form.TimeField.prototype,{altFormats:"g:ia|g:iA|g:i a|g:i A|h:i|g:i|H:i|ga|ha|gA|h a|g a|g A|gi|hi|gia|hia|g|H|H:i:s"}),Ext.apply(Ext.PagingToolbar.prototype,{beforePageText:"",displayMsg:""}),Ext.apply(Ext.ux.form.DateTime.prototype,{timeFormat:"G:i",otherToNow:!1,initDateValue:function(){this.dateValue=this.otherToNow?new Date:new Date((new Date).getFullYear(),0,1,12,0,0)},timeConfig:{increment:30},timeWidth:70}),Ext.form.VTypes.mailtoOrUrlText=__("Not a valid Url"),Ext.override(Ext.grid.RowSelectionModel,{onKeyPress:function(a,b){if(!this.grid.disabled){var c,d="up"==b,e=d?"selectPrevious":"selectNext",f=d?-1:1;!a.shiftKey||this.singleSelect?this[e](!1):this.last!==!1&&this.lastActive!==!1?(c=this.last,this.selectRange(this.last,this.lastActive+f),this.grid.getView().focusRow(this.lastActive),c!==!1&&(this.last=c)):this.selectFirstRow()}}}),Ext.override(Ext.form.BasicForm,{isValid:function(){var a=!0;return this.items.each(function(b){return b.isValid(!0)?void 0:(a=!1,!1)}),a}}),Ext.override(Ext.form.NumberField,{decimalPrecision:16}),Ext.override(Ext.form.NumberField,{setValue:function(a){return a="number"==typeof a?a:parseFloat(String(a).replace(this.decimalSeparator,".")),a=isNaN(a)?null:String(a).replace(".",this.decimalSeparator),Ext.form.NumberField.superclass.setValue.call(this,a)},parseValue:function(a){return a=parseFloat(String(a).replace(this.decimalSeparator,".")),isNaN(a)?null:a},fixPrecision:function(a){var b=isNaN(a);return this.allowDecimals&&-1!=this.decimalPrecision&&!b&&a?parseFloat(parseFloat(a).toFixed(this.decimalPrecision)):b?null:a}}),Ext.apply(Ext.form.ComboBox.prototype,{enableKeyEvents:!0,emptyText:__("(empty)"),afterRender:function(){if(Ext.form.ComboBox.superclass.afterRender.call(this),"local"==this.mode&&"timefield"!=this.xtype&&"datefield"!=this.xtype){var a=this.store.fields.items[this.store.fields.items.length-1].name,b=this.store.fields.items[this.store.fields.items.length-2>-1?this.store.fields.items.length-2:0].name;this.el.on("keypress",function(c){var d=String.fromCharCode(c.getCharCode()),e=this.view.getSelectedIndexes(),f=e.length>0?e[0]:null,g=null===f?0:++f,h=this.store.find(a,d,g,!1);if(h>-1?this.select(h):-1==h&&g>0&&(h=this.store.find(a,d,0,!1),h>-1&&this.select(h)),h>-1){var i=this.store.getAt(h);this.setValue(i.get(b))}},this)}}}),Ext.override(Ext.grid.GridView,{doRender:function(a,b,c,d,e,f){var g,h,i,j,k,l,m=this.templates,n=m.cell,o=m.row,p=e-1,q="width:"+this.getTotalWidth()+";",r=[],s=[],t={tstyle:q},u={},v=b.length;for(k=0;v>k;k++)if(i=b[k]){for(s=[],l=k+d,j=0;e>j;j++)h=a[j],u.id=h.id,u.css=0===j?"x-grid3-cell-first ":j==p?"x-grid3-cell-last ":"",u.attr=u.cellAttr="",u.style=h.style,u.value=h.renderer.call(h.scope,i.data[h.name],u,i,l,j,c,this),Ext.isEmpty(u.value)&&(u.value="&#160;"),this.markDirty&&i.dirty&&"undefined"!=typeof i.modified[h.name]&&(u.css+=" x-grid3-dirty-cell"),s[s.length]=n.apply(u);g=[],f&&(l+1)%2===0&&(g[0]="x-grid3-row-alt"),i.dirty&&(g[1]=" x-grid3-dirty-row"),t.cols=e,this.getRowClass&&(g[2]=this.getRowClass(i,l,t,c)),t.alt=g.join(" "),t.cells=s.join(""),r[r.length]=o.apply(t)}return r.join("")}}),Ext.apply(Ext.form.TextField.prototype,{minLengthText:__("You have {2} character(s) too few. The minimal length is {0}."),maxLengthText:__("You have {2} character(s) too many. The maximum length is {0}."),getErrors:function(a){var b=Ext.form.TextField.superclass.getErrors.apply(this,arguments);if(a=Ext.isDefined(a)?a:this.processValue(this.getRawValue()),Ext.isFunction(this.validator)){var c=this.validator(a);c!==!0&&b.push(c)}if(a.length<1||a===this.emptyText){if(this.allowBlank)return b;b.push(this.blankText)}if(!this.allowBlank&&(a.length<1||a===this.emptyText)&&b.push(this.blankText),a.length<this.minLength&&b.push(String.format(this.minLengthText,this.minLength,a.length,this.minLength-a.length)),a.length>this.maxLength&&b.push(String.format(this.maxLengthText,this.maxLength,a.length,a.length-this.maxLength)),this.vtype){var d=Ext.form.VTypes;d[this.vtype](a,this)||b.push(this.vtypeText||d[this.vtype+"Text"])}return this.regex&&!this.regex.test(a)&&b.push(this.regexText),b}}),Ext.apply(Ext.menu.Menu.prototype,{scrollIncrement:35,onScrollWheel:function(a){a.getWheelDelta()>0?this.onScroll(null,this.scroller.top):a.getWheelDelta()<0&&this.onScroll(null,this.scroller.bottom)}}),Ext.menu.Menu.prototype.createScrollers=Ext.menu.Menu.prototype.createScrollers.createSequence(function(){function a(a){d&&b(),d=setInterval(function(){c.onScroll(null,a)},100)}function b(){clearInterval(d),d=null}var c=this,d=null;Ext.EventManager.addListener(this.el,"mousewheel",this.onScrollWheel,this),this.on("destroy",function(){Ext.EventManager.removeListener(this.el,"mousewheel",this.onScrollWheel,this)}),this.scroller.top.on("mouseenter",a.createDelegate(this,[this.scroller.top])),this.scroller.top.on("mouseleave",b),this.scroller.bottom.on("mouseenter",a.createDelegate(this,[this.scroller.bottom])),this.scroller.bottom.on("mouseleave",b)}),Ext.lib.Dom.getXY=Ext.lib.Dom.getXY.createInterceptor(function(a){return a||!1}),Ext.lib.Region.getRegion=Ext.lib.Region.getRegion.createInterceptor(function(a){return a||!1}),window.onbeforeunload=function(){return Garp.checkForModified()?__("Are you sure you want to navigate away from Garp?"):void 0},Garp.checkForModified=function(){if(Garp.gridPanel&&Garp.gridPanel.getStore&&Garp.gridPanel.getStore()){var a=Garp.gridPanel.getStore().getModifiedRecords().length;return a}return!1},Garp.lazyLoad=function(a,b){var c=Ext.id(null,"garp");window["cb"+c]=b.createDelegate(this).createSequence(function(){delete window["cb"+c]},this);var d=document.createElement("script");d.type="text/javascript",d.src=a+"&callback=cb"+c,document.body.appendChild(d)},Garp.dirty=function(){Garp.gridPanel.disable(),Garp.toolbar.disable()},Garp.undirty=function(){Garp.gridPanel.enable(),Garp.toolbar.enable()},Garp.updateUI=function(a){if(!a||!a.getCount){if(!Garp.gridPanel)return;if(a=Garp.gridPanel.getSelectionModel?Garp.gridPanel.getSelectionModel():!1,!a)return}var b=a.getCount();if(b>1&&(b=2),window.innerWidth<=Garp.SMALLSCREENWIDTH&&1==b&&Garp.viewport.gridPanelCt.collapse(),!Garp.updateUI.prevCount||Garp.updateUI.prevCount!=b){switch(b){case 1:Garp.viewport.formPanelCt.getLayout().setActiveItem(1),Garp.formPanel.show();break;case 0:Garp.viewport.formPanelCt.getLayout().setActiveItem(0),Garp.viewport.infoPanel.setInfo(Garp.dataTypes[Garp.currentModel]),Garp.viewport.formPanelCt.doLayout(),Garp.viewport.infoPanel.updateCount(Garp.gridPanel.getStore().getTotalCount())}return Garp.updateUI.prevCount=b,!0}},Garp.history=Ext.apply(Garp.history||{},{pastModel:null,pushState:function(a){a||(a=this.getCurrentState()),a&&history.pushState&&(a.model!==Garp.history.pastModel?history.pushState(a,""+__(Garp.dataTypes[a.model].text||""),BASE+"admin/?"+Ext.urlEncode(a)):history.replaceState(a,""+__(Garp.dataTypes[a.model].text||""),BASE+"admin/?"+Ext.urlEncode(a)),Garp.history.pastModel=a.model)},getCurrentState:function(){if(Garp.gridPanel&&Garp.gridPanel.store){var a={},b=Garp.gridPanel.getBottomToolbar(),c=Garp.gridPanel.getTopToolbar(),d=Garp.gridPanel.getSelectionModel();return c&&""===c.searchField.getValue()&&(a.page=Math.ceil((b.cursor+b.pageSize)/b.pageSize)||null),a.id=d.getSelected()?parseInt(d.getSelected().get("id"),10)||null:null,a.model=Garp.currentModel,a}return null},parseState:function(a){a||(a=Ext.urlDecode(document.location.search.replace(/\?/,""))),a.model&&Garp.eventManager.fireEvent("modelchange",!1,a.model||null,a.page||null,a.id||null)},setupListeners:function(){var a=this;window.addEventListener("popstate",function(b){b&&b.state&&a.parseState(b.state?b.state:b.originalEvent.state?b.originalEvent.state:null)})}}),Garp.changeModel=function(a,b,c,d){if("undefined"==typeof Garp.dataTypes[b])return!1;if(Garp.checkForModified()>1||1==Garp.checkForModified()&&!Garp.gridPanel.getSelectionModel().getSelected().phantom){{var e=Garp.gridPanel.getStore();Garp.history.getCurrentState()}return void Ext.Msg.show({animEl:Garp.viewport.getEl(),icon:Ext.MessageBox.QUESTION,title:__("Garp"),msg:__("Would you like to save your changes?"),buttons:Ext.Msg.YESNOCANCEL,fn:function(f){switch(f){case"yes":e.on({save:{single:!0,fn:function(){Garp.changeModel(a,b,c,d)}}}),e.save();break;case"no":e.rejectChanges(),Garp.changeModel(a,b,c,d)}}})}Garp.infoPanel.clearInfo(),Garp.eventManager.purgeListeners(),Garp.setupEventManager(),Garp.currentModel=b,a&&Garp.history.pushState({model:b}),Garp.modelMenu.setIconClass(Garp.dataTypes[b].iconCls),Garp.modelMenu.setText(__(Garp.dataTypes[b].text)),Garp.gridPanel&&Garp.gridPanel.ownerCt.remove(Garp.gridPanel),Garp.formPanel&&Garp.formPanel.ownerCt&&(Garp.viewport.formPanelCt.getLayout().setActiveItem(0),Garp.viewport.formPanelCt.remove(Garp.formPanel)),Garp.formPanel=new Garp.FormPanel({previousValidFlag:!0,listeners:{cancel:function(){var a=Garp.gridPanel.getSelectionModel().getSelected();Garp.gridPanel.getSelectionModel().clearSelections(),Garp.gridPanel.getSelectionModel().selectRecords([a])},defocus:function(){Garp.gridPanel.focus.call(Garp.gridPanel)},dirty:Garp.dirty,undirty:Garp.undirty}}),Garp.viewport.formPanelCt.add(Garp.formPanel),Garp.viewport.formPanelCt.doLayout(),Garp.gridPanel=new Garp.GridPanel({model:b,listeners:{beforesave:function(){Garp.syncValues()},rowdblclick:function(){Garp.formPanel.focusFirstField()},afterdelete:function(){Garp.formPanel.hide(),Garp.gridPanel.enable(),Garp.undirty()},defocus:function(){Garp.formPanel.focusFirstField()},storeloaded:{fn:function(){this.enable(),"#selectfirst"==document.location.hash&&Garp.gridPanel.getSelectionModel().selectFirstRow(),Garp.gridPanel.on("rowselect",function(){Garp.history.pushState()},this,{buffer:500})},buffer:300,delay:300,single:!0},"after-save":function(){try{window.opener&&"undefined"!=typeof window.opener.Garp&&window.opener.Garp.eventManager.fireEvent("external-relation-save")}catch(a){}}}}),Garp.viewport.gridPanelCt.add(Garp.gridPanel),Garp.viewport.gridPanelCt.doLayout(),Garp.gridPanel.on({storeloaded:function(){if(Garp.updateUI.prevCount=-1,Garp.updateUI(),Garp.gridPanel.grid){var a=Garp.gridPanel.getSelectionModel(),b=a.getSelections();a.clearSelections(),a.selectRecords(b)}},selectionchange:{fn:Garp.updateUI,buffer:110}}),Garp.gridPanel.relayEvents(Garp.eventManager,["new","save-all","delete","clientvalidation"]),Garp.formPanel.relayEvents(Garp.eventManager,["new","rowselect","after-save"]),Garp.eventManager.relayEvents(Garp.gridPanel,["beforerowselect","rowselect","storeloaded","after-save","selectionchange","open-new-window"]),Garp.eventManager.relayEvents(Garp.formPanel,["clientvalidation","save-all","open-new-window","preview","delete"]),Garp.infoPanel.clearInfo(),d&&!c?Garp.gridPanel.getStore().load({params:{query:{id:d}},callback:function(){Garp.gridPanel.getSelectionModel().selectFirstRow(),Garp.gridPanel.getTopToolbar().searchById(d),Garp.formPanel.on({show:function(){var a=new Ext.ToolTip({target:Garp.gridPanel.getTopToolbar().items.get(1).triggers[0],anchor:"top",anchorOffset:-13,html:__("Click here to view all items again"),closable:!0,autoHide:!0});a.show()},single:!0,delay:100})}}):c?(Garp.gridPanel.getStore().on({load:function(){d&&Garp.gridPanel.getStore().on({load:function(){var a=Garp.gridPanel.getStore().find("id",d);if(a>-1){var b=Garp.gridPanel.getStore().getAt(a);Garp.gridPanel.getSelectionModel().selectRecords([b])}},scope:this,single:!0}),Garp.gridPanel.getBottomToolbar().changePage(c)},single:!0}),Garp.gridPanel.loadStoreWithDefaults()):Garp.gridPanel.loadStoreWithDefaults();var f=Garp.toolbar;f.newButton.setVisible(!Garp.dataTypes[b].disableCreate),f.deleteButton.setVisible(!Garp.dataTypes[b].disableDelete),f.separator.setVisible(!Garp.dataTypes[b].disableDelete||!Garp.dataTypes[b].disableCreate),f.extraMenu.menu.importButton.show(),f.extraMenu.menu.exportButton.show(),f.extraMenu.menu.printButton.show(),document.title=__(Garp.dataTypes[b].text)+" | "+("undefined"!=typeof APP_TITLE?APP_TITLE:""),Garp.setFavicon(Garp.dataTypes[b].iconCls)},Garp.setFavicon=function(a){var b=document,c=Ext.get("icons").dom;if(c.sheet&&c.sheet.cssRules){var d=!1;Ext.each(c.sheet.cssRules,function(){return this.selectorText=="."+a?(d=this.style.backgroundImage.trim(),d=d.substr(8,d.length-10),void(d=b.location.protocol+"//"+b.location.host+BASE+d)):void 0}),d||(d=Ext.get("favicon").dom.href);var e=b.createElement("link"),f=b.getElementById("dynamic-favicon");e.id="dynamic-favicon",e.rel="shortcut icon",e.href=d,f&&b.head.removeChild(f),b.head.appendChild(e)}},Garp.syncValues=function(){var a=Garp.formPanel;a.getForm().updateRecord(a.rec)},Garp.rebuildViewportItems=function(){Garp.infoPanel&&Garp.infoPanel.clearInfo(),Garp.gridPanel&&Garp.viewport.gridPanelCt.remove(Garp.gridPanel),Garp.formPanel&&Garp.viewport.formPanelCt.remove(Garp.formPanel),Garp.viewport.formPanelCt.add(Garp.formPanel),Garp.formPanel.hide(),Garp.viewport.gridPanelCt.add(Garp.gridPanel),Garp.viewport.gridPanelCt.doLayout()},Garp.setupEventManager=function(){Garp.eventManager=new Ext.util.Observable,Garp.eventManager.addEvents("modelchange","beforerowselect","rowselect","storeloaded","new","save-all","after-save","delete","logout","open-new-window","external-relation-save"),Garp.eventManager.on({"new":function(){Garp.updateUI.defer(20)},modelchange:Garp.changeModel,"open-new-window":function(){if(Garp.formPanel){var a=Garp.formPanel.getForm().findField("id").getValue();if(a){var b=BASE+"admin?"+Ext.urlEncode({model:Garp.currentModel,id:a});window.open(b)}}},logout:function(){window.location=BASE+"g/auth/logout"},preview:function(){var a=Garp.dataTypes[Garp.currentModel].previewLink,b=Garp.gridPanel.getSelectionModel().getSelected();if(a&&b){var c=new Ext.Template(a.urlTpl),d=c.apply([b.get(a.param)]);window.open(BASE+d)}}}),Garp.eventManager.relayEvents(Garp.toolbar,["logout","delete","new","open-new-window"])},Garp.setupGlobalKeys=function(){Garp.keyMap=new Ext.KeyMap(Ext.getBody(),[{key:Ext.EventObject.ENTER,ctrl:!0,handler:function(){Garp.formPanel.formcontent.getTopToolbar().saveButton.disabled||Garp.eventManager.fireEvent("save-all")}},{key:"N",ctrl:!0,handler:function(){Garp.dataTypes[Garp.currentModel].disableCreate||Garp.toolbar.newButton.disabled||Garp.eventManager.fireEvent("new")}}]),Garp.keyMap.stopEvent=!0},Garp.flashMessage=function(){var a=Ext.decode(Ext.util.Cookies.get("FlashMessenger")),b="";if(a.messages){for(var c in a.messages)c=a.messages[c],c&&(c=c.replace(/\+/g," "),b+=c+"<br>");if(b){var d=Ext.get("app-loader");d.update(b),d.setWidth(300),d.setHeight(20*(a.messages.length-1)+30);var e="; path=/",f=new Date;return f.setHours(f.getHours(-1)),e+=null===f?"":"; expires="+f.toGMTString(),document.cookie="FlashMessenger="+e,!0}}return!1},Garp.afterInit=function(){Garp.history.setupListeners(),Garp.history.parseState();var a=610;Garp.flashMessage()&&(a=2e3),setTimeout(function(){Ext.get("app-loader").fadeOut()},a)},Garp.setupAjaxSpinner=function(){var a=Ext.select("#icon-loading-spinner");a.hide(),Ext.Ajax.on("requestcomplete",function(){Ext.Ajax.isLoading()||a.hide.defer(200,a)}),Ext.Ajax.on("beforerequest",function(){a.show()}),Ext.Ajax.on("requestexception",function(){a.hide()})},Garp.init=function(){Garp.gridPanel=new Garp.WelcomePanel,Garp.viewport=new Garp.Viewport,Garp.setupEventManager(),Garp.setupGlobalKeys(),Garp.setupAjaxSpinner(),Garp.afterInit()};